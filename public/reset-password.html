<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nouveau mot de passe ‚Äî Genda</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ Kill mobile browser helpers ‚îÄ‚îÄ */
*{-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
html{-webkit-text-size-adjust:none;-ms-text-size-adjust:none}
body,div,span,label,p,h1,h2,h3,h4,a,button,td,th,li{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
input,textarea,select,[contenteditable]{-webkit-user-select:text!important;-moz-user-select:text!important;user-select:text!important;-webkit-touch-callout:default!important}

*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#FAFAF9;--white:#FFF;--surface:#F5F4F1;--border:#E0DDD8;--border-light:#ECEAE6;--text:#1A1816;--text-2:#3D3832;--text-3:#6B6560;--text-4:#9C958E;--primary:#E07A5F;--primary-hover:#C9684F;--primary-soft:#FDF0EC;--green:#15803D;--green-bg:#F0FDF4;--red:#DC2626;--red-bg:#FEF2F2;--serif:'DM Serif Display',Georgia,serif;--sans:'Outfit',-apple-system,sans-serif;--radius:14px;--radius-sm:10px;--radius-xs:6px}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;-webkit-font-smoothing:antialiased}
.card{width:100%;max-width:400px;background:var(--white);border-radius:var(--radius);border:1px solid var(--border-light);padding:36px;box-shadow:0 4px 20px rgba(0,0,0,0.06)}
.logo-row{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:24px}
.logo{width:36px;height:36px;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:1rem}
.wordmark{font-family:var(--serif);font-size:1.2rem;color:var(--text)}
h1{font-family:var(--serif);font-size:1.4rem;font-weight:400;text-align:center;margin-bottom:4px}
.subtitle{font-size:0.85rem;color:var(--text-3);text-align:center;margin-bottom:24px}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-2);margin-bottom:4px}
.form-input{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-xs);font-family:var(--sans);font-size:0.88rem;color:var(--text);outline:none;transition:border-color .15s}
.form-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-soft)}
.error-msg{display:none;padding:10px 14px;background:var(--red-bg);border:1px solid #FECACA;border-radius:var(--radius-xs);font-size:0.82rem;color:var(--red);margin-bottom:14px}
.error-msg.visible{display:block}
.success-msg{display:none;padding:16px;background:var(--green-bg);border:1px solid #BBF7D0;border-radius:var(--radius-sm);font-size:0.88rem;color:var(--green);text-align:center;margin-bottom:14px}
.success-msg.visible{display:block}
.btn{width:100%;padding:12px;background:var(--primary);color:white;border:none;border-radius:var(--radius-sm);font-family:var(--sans);font-size:0.9rem;font-weight:600;cursor:pointer;transition:all .15s;margin-top:4px}
.btn:hover{background:var(--primary-hover)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-outline{width:100%;padding:12px;background:var(--white);color:var(--text-2);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:var(--sans);font-size:0.9rem;font-weight:600;cursor:pointer;text-decoration:none;display:block;text-align:center;margin-top:10px;transition:all .15s}
.btn-outline:hover{background:var(--surface)}
.pw-strength{height:4px;border-radius:2px;margin-top:6px;transition:all .3s}
.pw-hint{font-size:0.72rem;color:var(--text-4);margin-top:4px}
.footer-text{text-align:center;margin-top:18px;font-size:0.8rem;color:var(--text-4)}
.footer-text a{color:var(--primary);text-decoration:none;font-weight:600}
</style>
</head>
<body>

<div class="card">
  <div class="logo-row"><div class="logo">G</div><span class="wordmark">Genda</span></div>

  <!-- STATE: No token ‚Üí request reset -->
  <div id="requestView">
    <h1>Mot de passe oubli√©</h1>
    <p class="subtitle">Entrez votre email pour recevoir un lien de r√©initialisation</p>
    <div class="error-msg" id="reqError"></div>
    <div class="success-msg" id="reqSuccess"></div>
    <form onsubmit="handleRequest(event)" id="requestForm">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" type="email" id="reqEmail" placeholder="votre@email.be" required autofocus>
      </div>
      <button class="btn" type="submit" id="reqBtn">Envoyer le lien ‚Üí</button>
    </form>
    <a href="/login.html" class="btn-outline">‚Üê Retour √† la connexion</a>
  </div>

  <!-- STATE: Has token ‚Üí set new password -->
  <div id="resetView" style="display:none">
    <h1>Nouveau mot de passe</h1>
    <p class="subtitle">Choisissez un nouveau mot de passe pour votre compte</p>
    <div class="error-msg" id="resetError"></div>
    <div class="success-msg" id="resetSuccess"></div>
    <form onsubmit="handleReset(event)" id="resetForm">
      <div class="form-group">
        <label class="form-label">Nouveau mot de passe</label>
        <input class="form-input" type="password" id="newPw" placeholder="Minimum 8 caract√®res" required minlength="8" oninput="checkStrength()">
        <div class="pw-strength" id="pwStrength"></div>
        <div class="pw-hint" id="pwHint">Minimum 8 caract√®res</div>
      </div>
      <div class="form-group">
        <label class="form-label">Confirmer</label>
        <input class="form-input" type="password" id="confirmPw" placeholder="Retapez le mot de passe" required>
      </div>
      <button class="btn" type="submit" id="resetBtn">Changer le mot de passe ‚Üí</button>
    </form>
  </div>

  <!-- STATE: Done -->
  <div id="doneView" style="display:none">
    <div style="text-align:center;padding:20px 0">
      <div style="font-size:3rem;margin-bottom:12px">‚úÖ</div>
      <h1>Mot de passe modifi√©</h1>
      <p class="subtitle">Vous pouvez maintenant vous connecter avec votre nouveau mot de passe.</p>
      <a href="/login.html" class="btn" style="display:block;text-decoration:none;text-align:center;margin-top:16px">Se connecter ‚Üí</a>
    </div>
  </div>

  <p class="footer-text" id="footerText"><a href="/login.html">Retour √† la connexion</a></p>
</div>

<script>
const token = new URLSearchParams(window.location.search).get('token');

if (token) {
  document.getElementById('requestView').style.display = 'none';
  document.getElementById('resetView').style.display = 'block';
  document.getElementById('footerText').style.display = 'none';
}

function checkStrength() {
  const pw = document.getElementById('newPw').value;
  const bar = document.getElementById('pwStrength');
  const hint = document.getElementById('pwHint');
  let score = 0;
  if (pw.length >= 8) score++;
  if (pw.length >= 12) score++;
  if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
  if (/[0-9]/.test(pw)) score++;
  if (/[^A-Za-z0-9]/.test(pw)) score++;

  const colors = ['#DC2626', '#F59E0B', '#F59E0B', '#22C55E', '#15803D'];
  const labels = ['Tr√®s faible', 'Faible', 'Moyen', 'Fort', 'Tr√®s fort'];
  const width = Math.max(20, score * 20);

  bar.style.width = width + '%';
  bar.style.background = colors[Math.min(score, 4)];
  hint.textContent = pw.length < 8 ? 'Minimum 8 caract√®res' : labels[Math.min(score, 4)];
  hint.style.color = colors[Math.min(score, 4)];
}

async function handleRequest(e) {
  e.preventDefault();
  const btn = document.getElementById('reqBtn');
  const err = document.getElementById('reqError');
  const suc = document.getElementById('reqSuccess');
  err.classList.remove('visible');
  suc.classList.remove('visible');

  const email = document.getElementById('reqEmail').value.trim();
  if (!email) { err.textContent = 'Email requis'; err.classList.add('visible'); return; }

  btn.disabled = true;
  btn.textContent = 'Envoi...';

  try {
    const r = await fetch('/api/auth/forgot-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Erreur');

    document.getElementById('requestForm').style.display = 'none';
    suc.textContent = 'üìß Si ce compte existe, un email a √©t√© envoy√©. V√©rifiez votre bo√Æte de r√©ception (et les spams).';
    suc.classList.add('visible');
  } catch (ex) {
    err.textContent = ex.message;
    err.classList.add('visible');
    btn.disabled = false;
    btn.textContent = 'Envoyer le lien ‚Üí';
  }
}

async function handleReset(e) {
  e.preventDefault();
  const btn = document.getElementById('resetBtn');
  const err = document.getElementById('resetError');
  err.classList.remove('visible');

  const pw = document.getElementById('newPw').value;
  const confirm = document.getElementById('confirmPw').value;

  if (pw.length < 8) { err.textContent = 'Minimum 8 caract√®res'; err.classList.add('visible'); return; }
  if (pw !== confirm) { err.textContent = 'Les mots de passe ne correspondent pas'; err.classList.add('visible'); return; }

  btn.disabled = true;
  btn.textContent = 'Modification...';

  try {
    const r = await fetch('/api/auth/reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, new_password: pw })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Erreur');

    // Show success state
    document.getElementById('resetView').style.display = 'none';
    document.getElementById('doneView').style.display = 'block';
  } catch (ex) {
    err.textContent = ex.message;
    err.classList.add('visible');
    btn.disabled = false;
    btn.textContent = 'Changer le mot de passe ‚Üí';
  }
}
</script>

<script>document.addEventListener('contextmenu',function(e){var t=e.target.tagName;if(t!=='INPUT'&&t!=='TEXTAREA'&&t!=='SELECT')e.preventDefault();},{passive:false});document.addEventListener('selectstart',function(e){var t=e.target.tagName;if(t!=='INPUT'&&t!=='TEXTAREA'&&t!=='SELECT')e.preventDefault();});</script>
<script>/* Kill mobile helpers */
document.addEventListener('contextmenu',function(e){var t=e.target.tagName;if(t!=='INPUT'&&t!=='TEXTAREA'&&t!=='SELECT')e.preventDefault();},{passive:false});
document.addEventListener('selectstart',function(e){var t=e.target.tagName;if(t!=='INPUT'&&t!=='TEXTAREA'&&t!=='SELECT')e.preventDefault();});
</script>
</body>
</html>
