<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äî Bookt</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#FAFAF9;--white:#FFF;--surface:#F5F4F1;--surface-2:#EDEBE8;--border:#E0DDD8;--border-light:#ECEAE6;--text:#1A1816;--text-2:#3D3832;--text-3:#6B6560;--text-4:#9C958E;--primary:#0D7377;--primary-hover:#0A5E61;--primary-light:#EFF9F8;--primary-soft:#D5EFEC;--green:#1B7A42;--green-bg:#EEFAF1;--gold:#A68B3C;--gold-bg:#FAF6EC;--red:#DC2626;--red-bg:#FEF2F2;--sidebar-bg:#1C1917;--sidebar-hover:#292524;--serif:'Instrument Serif',Georgia,serif;--sans:'Plus Jakarta Sans',-apple-system,sans-serif;--shadow:0 2px 8px rgba(0,0,0,.05);--radius:14px;--radius-sm:10px;--radius-xs:6px}
body{background:var(--bg);color:var(--text);font-family:var(--sans);-webkit-font-smoothing:antialiased}
.sidebar{position:fixed;top:0;left:0;bottom:0;width:230px;background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;z-index:50}
.sb-logo{padding:18px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-logo .l{width:30px;height:30px;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:.85rem}
.sb-logo .w{font-size:.82rem;font-weight:700;letter-spacing:.5px}
.sb-logo .plan{font-size:.55rem;font-weight:700;background:rgba(255,255,255,.12);padding:1px 5px;border-radius:3px;margin-left:4px;color:rgba(255,255,255,.5)}
.sb-nav{padding:10px 8px;flex:1}
.ni{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.5);cursor:pointer;transition:all .12s;text-decoration:none;margin-bottom:2px}
.ni:hover{background:var(--sidebar-hover);color:rgba(255,255,255,.8)}
.ni.active{background:var(--primary);color:#fff;font-weight:600}
.ni .ic{width:18px;text-align:center;font-size:.9rem}
.sb-foot{padding:14px 16px;border-top:1px solid rgba(255,255,255,.06)}
.sb-foot .nm{font-size:.78rem;font-weight:600}
.sb-foot .rl{font-size:.65rem;color:rgba(255,255,255,.35)}
.sb-foot .logout{font-size:.68rem;color:rgba(255,255,255,.3);cursor:pointer;margin-top:4px;text-decoration:underline}
.main{margin-left:230px;min-height:100vh}
.topbar{position:sticky;top:0;background:rgba(250,250,249,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--border-light);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;z-index:40}
.topbar h1{font-family:var(--serif);font-size:1.3rem;font-weight:400}
.content{padding:24px 28px;max-width:1100px}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:var(--white);border-radius:var(--radius-sm);border:1px solid var(--border-light);padding:16px}
.stat-card .label{font-size:.7rem;font-weight:600;color:var(--text-4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.stat-card .val{font-family:var(--serif);font-size:1.6rem;color:var(--text)}
.stat-card .sub{font-size:.7rem;color:var(--text-4);margin-top:2px}
.card{background:var(--white);border-radius:var(--radius);border:1px solid var(--border-light);overflow:hidden;margin-bottom:16px}
.card-h{padding:14px 18px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.card-h h3{font-size:.9rem;font-weight:700}
.badge{font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:10px}
.badge-teal{background:var(--primary-light);color:var(--primary)}
.bk-row{display:flex;align-items:center;gap:12px;padding:10px 18px;border-bottom:1px solid var(--border-light)}
.bk-row:last-child{border:none}
.bk-status{padding:3px 10px;border-radius:10px;font-size:.68rem;font-weight:600}
.bk-status.confirmed{background:var(--green-bg);color:var(--green)}
.bk-status.pending{background:var(--gold-bg);color:var(--gold)}
.bk-status.completed{background:var(--surface);color:var(--text-3)}
.bk-status.noshow{background:#FFF3CD;color:#856404}
.bk-status.cancelled{background:var(--red-bg);color:var(--red)}
.empty{padding:40px;text-align:center;color:var(--text-4);font-size:.88rem}
.qlink{background:linear-gradient(135deg,var(--primary),#0A5E61);border-radius:var(--radius-sm);padding:16px 20px;color:#fff;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.qlink .info h4{font-size:.9rem;font-weight:600;margin-bottom:2px}
.qlink .info p{font-size:.75rem;opacity:.6}
.qlink a{padding:7px 14px;background:rgba(255,255,255,.15);border-radius:var(--radius-xs);font-size:.78rem;font-weight:600;color:#fff;text-decoration:none}
.loading{text-align:center;padding:40px;color:var(--text-4)}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Agenda */
.agenda-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.agenda-nav{display:flex;align-items:center;gap:8px}
.a-btn{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center}
.a-btn:hover{background:var(--surface)}
.a-btn-text{padding:5px 12px;border-radius:6px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text-3);font-family:var(--sans)}
.agenda-label{font-size:1rem;font-weight:600;min-width:200px;text-align:center}
.view-tabs{display:flex;gap:2px;background:var(--surface);border-radius:8px;padding:2px}
.view-tab{padding:5px 14px;border-radius:6px;font-size:.75rem;font-weight:600;color:var(--text-3);cursor:pointer;border:none;background:transparent;font-family:var(--sans)}
.view-tab.active{background:var(--white);color:var(--text);box-shadow:var(--shadow)}
.bk-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-xs);padding:10px 14px;margin-bottom:6px}
.bk-card:hover{border-color:var(--primary-soft)}
.bk-card .time{font-size:.8rem;font-weight:700;color:var(--primary)}
.bk-card .client{font-size:.85rem;font-weight:600}
.bk-card .meta{font-size:.7rem;color:var(--text-4)}
.bk-card .actions{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.act-btn{padding:3px 8px;border-radius:5px;border:1px solid;cursor:pointer;font-size:.68rem;font-weight:600;font-family:var(--sans)}
.act-done{border-color:#B8E6C4;background:var(--green-bg);color:var(--green)}
.act-noshow{border-color:#E8DCBA;background:var(--gold-bg);color:var(--gold)}
.act-cancel{border-color:#FECACA;background:var(--red-bg);color:var(--red)}
.act-undo{border-color:var(--primary-border);background:var(--primary-light);color:var(--primary)}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.week-col{min-height:120px}
.week-header{text-align:center;padding:8px 4px;font-size:.72rem;font-weight:700;color:var(--text-3);border-bottom:2px solid var(--border-light);margin-bottom:6px;cursor:pointer}
.week-header.today{color:var(--primary);border-bottom-color:var(--primary)}
.week-header .num{font-size:1.1rem;display:block;color:var(--text)}
.week-header.today .num{color:var(--primary)}
.week-bk{background:var(--primary-light);border-left:3px solid var(--primary);border-radius:4px;padding:4px 6px;margin-bottom:3px;cursor:pointer;font-size:.7rem}
.week-bk:hover{background:var(--primary-soft)}
.week-bk .t{font-weight:700;color:var(--primary)}.week-bk .n{color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.week-bk.st-completed{background:var(--surface);border-color:var(--text-4)}.week-bk.st-completed .t{color:var(--text-4)}
.week-bk.st-cancelled{background:var(--red-bg);border-color:var(--red);opacity:.5}
.week-bk.st-no_show{background:#FFF3CD;border-color:#856404}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border-light);border:1px solid var(--border-light);border-radius:var(--radius-sm);overflow:hidden}
.month-header{padding:8px;text-align:center;font-size:.7rem;font-weight:700;color:var(--text-4);background:var(--surface)}
.month-cell{background:var(--white);min-height:80px;padding:4px}
.month-cell.other{background:var(--bg);opacity:.4}
.month-cell.today{background:var(--primary-light)}
.month-cell .day-num{font-size:.75rem;font-weight:700;color:var(--text-3);margin-bottom:2px;padding:2px 4px;cursor:pointer}
.month-cell.today .day-num{color:var(--primary)}
.month-dot{display:flex;align-items:center;gap:3px;padding:1px 4px;border-radius:3px;font-size:.6rem;color:var(--text-3);cursor:pointer;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.month-dot:hover{background:var(--surface)}
.month-dot .d{width:5px;height:5px;border-radius:50%;background:var(--primary);flex-shrink:0}
.month-more{font-size:.6rem;color:var(--primary);font-weight:600;padding:1px 4px;cursor:pointer}
.undo-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1C1917;color:#fff;padding:12px 20px;border-radius:10px;font-size:.85rem;display:flex;align-items:center;gap:14px;box-shadow:0 8px 30px rgba(0,0,0,.2);z-index:1000;animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.undo-toast button{padding:6px 14px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-family:var(--sans);font-size:.8rem;font-weight:700;cursor:pointer}
.undo-toast .dismiss{background:transparent;color:rgba(255,255,255,.5);font-size:.75rem;padding:4px 8px}
@media(max-width:1000px){.sidebar{width:60px}.sidebar .w,.sidebar .plan,.ni span:not(.ic),.sb-foot .nm,.sb-foot .rl,.sb-foot .logout{display:none}.main{margin-left:60px}.stats{grid-template-columns:1fr 1fr}.week-grid{grid-template-columns:repeat(3,1fr)}}
/* Theme picker */
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
/* CRUD sections */
.search-bar{display:flex;gap:8px;margin-bottom:16px}
.search-bar input{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none;transition:border-color .15s}
.search-bar input:focus{border-color:var(--primary)}
.btn-primary{padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer}
.btn-primary:hover{background:var(--primary-hover)}
.btn-outline{padding:8px 16px;background:var(--white);color:var(--text-2);border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer}
.btn-outline:hover{background:var(--surface)}
.btn-sm{padding:5px 10px;font-size:.75rem;border-radius:6px}
.btn-danger{background:var(--red-bg);color:var(--red);border-color:#FECACA}
.table{width:100%;border-collapse:collapse}
.table th{text-align:left;padding:10px 14px;font-size:.72rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border-light)}
.table td{padding:10px 14px;font-size:.85rem;border-bottom:1px solid var(--border-light)}
.table tr:hover td{background:var(--surface)}
.table .client-name{font-weight:600;cursor:pointer;color:var(--primary)}
.table .client-name:hover{text-decoration:underline}
.c-status{padding:2px 8px;border-radius:8px;font-size:.68rem;font-weight:600}
.c-status.regulier{background:var(--green-bg);color:var(--green)}
.c-status.nouveau{background:var(--primary-light);color:var(--primary)}
.c-status.no_show{background:var(--red-bg);color:var(--red)}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s}
.modal{background:var(--white);border-radius:var(--radius);width:100%;max-width:520px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.15);animation:slideUp .2s ease}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.modal-h h3{font-size:.95rem;font-weight:700}
.modal-h .close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-4);padding:4px}
.modal-body{padding:20px}
.field{margin-bottom:14px}
.field label{display:block;font-size:.78rem;font-weight:600;color:var(--text-3);margin-bottom:4px}
.field input,.field select,.field textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--primary)}
.field textarea{resize:vertical;min-height:70px}
.field-row{display:flex;gap:10px}
.field-row .field{flex:1}
.modal-foot{padding:14px 20px;border-top:1px solid var(--border-light);display:flex;justify-content:flex-end;gap:8px}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
/* Service cards */
.svc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.svc-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:16px;position:relative;border-left:4px solid var(--primary)}
.svc-card h4{font-size:.9rem;font-weight:700;margin-bottom:4px}
.svc-card .svc-meta{font-size:.78rem;color:var(--text-4);margin-bottom:8px}
.svc-card .svc-price{font-family:var(--serif);font-size:1.1rem;color:var(--primary)}
.svc-card .svc-modes{display:flex;gap:4px;margin-top:6px}
.svc-card .mode-tag{padding:2px 8px;border-radius:6px;font-size:.65rem;font-weight:600;background:var(--surface);color:var(--text-3)}
.svc-card .svc-actions{display:flex;gap:4px;margin-top:10px}
.svc-card.inactive{opacity:.5;border-left-color:var(--text-4)}
/* Hours grid */
.hours-schedule{margin-top:12px}
.pract-block{margin-bottom:20px}
.pract-block h4{font-size:.88rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.day-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-light)}
.day-row .day-name{min-width:80px;font-size:.82rem;font-weight:600}
.day-row .slots{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.slot-chip{display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--primary-light);border-radius:6px;font-size:.78rem;color:var(--primary);font-weight:600}
.slot-chip .remove-slot{background:none;border:none;cursor:pointer;font-size:.9rem;color:var(--primary);padding:0 2px;opacity:.5}
.slot-chip .remove-slot:hover{opacity:1}
.add-slot-btn{padding:4px 10px;border:1.5px dashed var(--border);border-radius:6px;font-size:.75rem;color:var(--text-4);cursor:pointer;background:transparent;font-family:var(--sans)}
.add-slot-btn:hover{border-color:var(--primary);color:var(--primary)}
.day-closed{font-size:.78rem;color:var(--text-4);font-style:italic}
.theme-card{background:var(--white);border:2px solid var(--border-light);border-radius:var(--radius);padding:0;cursor:pointer;transition:all .2s;overflow:hidden;position:relative}
.theme-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.theme-card.active{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
.theme-card.locked{opacity:.7;cursor:default}
.theme-card.locked:hover{transform:none;border-color:var(--border-light)}
.theme-preview{height:120px;position:relative;overflow:hidden}
.theme-preview .tp-nav{height:28px;display:flex;align-items:center;padding:0 10px;gap:6px}
.theme-preview .tp-nav .dot{width:14px;height:14px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.5rem;color:#fff}
.theme-preview .tp-nav .tp-name{font-size:.5rem;font-weight:700;flex:1}
.theme-preview .tp-nav .tp-cta{padding:2px 6px;border-radius:3px;font-size:.42rem;font-weight:700;color:#fff}
.theme-preview .tp-hero{padding:6px 10px}
.theme-preview .tp-hero h3{font-size:.6rem;font-weight:400;margin-bottom:2px;line-height:1.2}
.theme-preview .tp-hero p{font-size:.38rem;opacity:.5}
.theme-preview .tp-cards{display:flex;gap:4px;padding:0 10px}
.theme-preview .tp-card{flex:1;height:24px;border-radius:3px;border-width:1px;border-style:solid}
.theme-info{padding:12px 14px;border-top:1px solid var(--border-light)}
.theme-info h4{font-size:.85rem;font-weight:700;display:flex;align-items:center;gap:6px}
.theme-info p{font-size:.72rem;color:var(--text-4);margin-top:2px}
.th-badge{padding:2px 8px;border-radius:8px;font-size:.6rem;font-weight:700}
.th-free{background:var(--green-bg);color:var(--green)}
.th-pro{background:var(--gold-bg);color:var(--gold)}
.theme-card .check{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:50%;background:var(--primary);color:#fff;display:none;align-items:center;justify-content:center;font-size:.7rem;z-index:2}
.theme-card.active .check{display:flex}
.lock-icon{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,.3);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.6rem;z-index:2}
@media(max-width:800px){.theme-grid{grid-template-columns:1fr 1fr}}
@media(max-width:500px){.theme-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="sb-logo"><div class="l">B</div><span class="w">Bookt</span><span class="plan" id="planBadge">FREE</span></div>
  <nav class="sb-nav">
    <a class="ni active" href="#" data-section="home"><span class="ic">üìä</span><span>Dashboard</span></a>
    <a class="ni" href="#" data-section="bookings"><span class="ic">üìÖ</span><span>Agenda</span></a>
    <a class="ni" href="#" data-section="clients"><span class="ic">üë•</span><span>Clients</span></a>
    <a class="ni" href="#" data-section="services"><span class="ic">üìã</span><span>Prestations</span></a>
    <a class="ni" href="#" data-section="hours"><span class="ic">üïê</span><span>Disponibilit√©s</span></a>
    <a class="ni" href="#" data-section="site"><span class="ic">üåê</span><span>Mon site</span></a>
    <a class="ni" href="#" data-section="calls"><span class="ic">üìû</span><span>Appels</span></a>
    <a class="ni" href="#" data-section="settings"><span class="ic">‚öôÔ∏è</span><span>Param√®tres</span></a>
  </nav>
  <div class="sb-foot">
    <div class="nm" id="userName">‚Äî</div>
    <div class="rl" id="userRole">‚Äî</div>
    <div class="logout" onclick="doLogout()">D√©connexion</div>
  </div>
</aside>
<div class="main">
  <div class="topbar"><h1 id="pageTitle">Dashboard</h1><div><span style="font-size:.78rem;color:var(--text-4)" id="todayDate"></span></div></div>
  <div class="content" id="contentArea"><div class="loading"><div class="spinner"></div><p style="margin-top:10px">Chargement...</p></div></div>
</div>
<script src="/js/api-client.js"></script>
<script>
const api=new BooktAPI();
if(!api.isLoggedIn())window.location.href='/login.html';
const user=api.getUser(),biz=api.getBusiness();
document.getElementById('userName').textContent=user?.business_name||user?.email||'‚Äî';
document.getElementById('userRole').textContent=user?.role==='owner'?'Propri√©taire':'Staff';
document.getElementById('todayDate').textContent=new Date().toLocaleDateString('fr-BE',{weekday:'long',day:'numeric',month:'long'});
if(biz)document.getElementById('planBadge').textContent=(biz.plan||'free').toUpperCase();
if(new URLSearchParams(location.search).get('onboarding'))BooktUI.toast('üéâ Bienvenue !','success',5000);
loadDashboard();

async function loadDashboard(){
  const c=document.getElementById('contentArea');
  try{
    const[dd,sd]=await Promise.allSettled([api.getDashboard(),api.get('/api/dashboard/summary')]);
    const dash=dd.status==='fulfilled'?dd.value:{},sum=sd.status==='fulfilled'?sd.value:null;
    const slug=dash.business?.slug||biz?.slug||'';
    let h=`<div class="qlink"><div class="info"><h4>Votre page publique</h4><p>${slug}</p></div><div><a href="/${slug}" target="_blank">Voir ma page</a></div></div>`;
    if(sum){const m=sum.month||{},cl=sum.clients||{},ca=sum.calls||{};
      h+=`<div class="stats"><div class="stat-card"><div class="label">RDV aujourd'hui</div><div class="val">${sum.today?.count||0}</div></div><div class="stat-card"><div class="label">CA ce mois</div><div class="val">${m.revenue_formatted||'0 ‚Ç¨'}</div><div class="sub">${m.total_bookings||0} RDV</div></div><div class="stat-card"><div class="label">Clients</div><div class="val">${cl.total||0}</div></div><div class="stat-card"><div class="label">Appels ‚Üí RDV</div><div class="val">${ca.conversion_rate||0}%</div></div></div>`;
      h+=`<div class="card"><div class="card-h"><h3>RDV du jour</h3><span class="badge badge-teal">${sum.today?.count||0}</span></div>`;
      if(sum.today?.bookings?.length>0){sum.today.bookings.forEach(b=>{const t=new Date(b.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});h+=`<div class="bk-row"><span style="font-size:.85rem;font-weight:700;color:var(--primary);min-width:50px">${t}</span><div style="flex:1"><div style="font-size:.85rem;font-weight:600">${b.client_name}</div><div style="font-size:.72rem;color:var(--text-4)">${b.service_name} ¬∑ ${b.duration_min}min</div></div><span class="bk-status ${b.status}">${b.status==='confirmed'?'Confirm√©':b.status}</span></div>`});}
      else h+=`<div class="empty">Aucun RDV aujourd'hui</div>`;
      h+=`</div>`;
    }else{h+=`<div class="stats"><div class="stat-card"><div class="label">RDV</div><div class="val">0</div></div><div class="stat-card"><div class="label">CA</div><div class="val">0 ‚Ç¨</div></div><div class="stat-card"><div class="label">Clients</div><div class="val">0</div></div><div class="stat-card"><div class="label">Appels</div><div class="val">‚Äî</div></div></div><div class="card"><div class="card-h"><h3>RDV du jour</h3></div><div class="empty">Aucun RDV</div></div>`;}
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}<br><button onclick="loadDashboard()" style="margin-top:8px;padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--white);cursor:pointer">R√©essayer</button></div>`;}
}

// NAV
document.querySelectorAll('.ni').forEach(i=>{i.addEventListener('click',e=>{e.preventDefault();document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));i.classList.add('active');const s=i.dataset.section;document.getElementById('pageTitle').textContent={home:'Dashboard',bookings:'Agenda',clients:'Clients',services:'Prestations',hours:'Disponibilit√©s',site:'Mon site',calls:'Appels',settings:'Param√®tres'}[s]||'Dashboard';if(s==='home')loadDashboard();else if(s==='bookings'){agendaView='week';agendaDate=new Date();loadAgenda();}else if(s==='site')loadSiteSection();else if(s==='clients')loadClients();else if(s==='services')loadServices();else if(s==='hours')loadHours();else document.getElementById('contentArea').innerHTML=`<div class="empty">Section "${s}" ‚Äî Bient√¥t disponible</div>`;});});

// AGENDA
const DF=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
const DS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const MF=['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
const MS=['jan','f√©v','mar','avr','mai','jun','jul','ao√ª','sep','oct','nov','d√©c'];
const MODE_ICO={cabinet:'üè¢',visio:'üíª',phone:'üìû'};
const ST={confirmed:{l:'Confirm√©',c:'confirmed'},pending:{l:'En attente',c:'pending'},completed:{l:'Termin√©',c:'completed'},no_show:{l:'No-show',c:'noshow'},cancelled:{l:'Annul√©',c:'cancelled'}};
let agendaView='week',agendaDate=new Date(),agendaBookings=[],undoTimer=null;

function getMonday(d){const dt=new Date(d);const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);dt.setHours(0,0,0,0);return dt;}
function fmt(d){return d.toISOString().split('T')[0];}
function isToday(d){return fmt(d)===fmt(new Date());}
function fmtDay(d){return isToday(d)?"Aujourd'hui":`${DF[d.getDay()]} ${d.getDate()} ${MF[d.getMonth()]}`;}

async function loadAgenda(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  let from,to;
  if(agendaView==='day'){from=new Date(agendaDate);from.setHours(0,0,0,0);to=new Date(from);to.setDate(to.getDate()+1);}
  else if(agendaView==='week'){from=getMonday(agendaDate);to=new Date(from);to.setDate(to.getDate()+7);}
  else{from=new Date(agendaDate.getFullYear(),agendaDate.getMonth(),1);to=new Date(agendaDate.getFullYear(),agendaDate.getMonth()+1,1);}
  try{const r=await fetch(`/api/bookings?from=${from.toISOString()}&to=${to.toISOString()}`,{headers:{'Authorization':'Bearer '+api.getToken()}});const d=await r.json();agendaBookings=d.bookings||[];}catch(e){agendaBookings=[];}
  renderAgenda();
}

function renderAgenda(){
  const c=document.getElementById('contentArea');
  let label='';
  if(agendaView==='day')label=fmtDay(agendaDate);
  else if(agendaView==='week'){const m=getMonday(agendaDate),s=new Date(m);s.setDate(s.getDate()+6);label=`${m.getDate()} ${MS[m.getMonth()]} ‚Äì ${s.getDate()} ${MS[s.getMonth()]} ${s.getFullYear()}`;}
  else label=`${MF[agendaDate.getMonth()].charAt(0).toUpperCase()+MF[agendaDate.getMonth()].slice(1)} ${agendaDate.getFullYear()}`;

  let h=`<div class="agenda-toolbar"><div class="agenda-nav"><button class="a-btn" onclick="shiftAgenda(-1)">‚Äπ</button><button class="a-btn-text" onclick="agendaDate=new Date();loadAgenda()">Aujourd'hui</button><button class="a-btn" onclick="shiftAgenda(1)">‚Ä∫</button><span class="agenda-label">${label}</span></div><div class="view-tabs"><button class="view-tab ${agendaView==='day'?'active':''}" onclick="agendaView='day';loadAgenda()">Jour</button><button class="view-tab ${agendaView==='week'?'active':''}" onclick="agendaView='week';loadAgenda()">Semaine</button><button class="view-tab ${agendaView==='month'?'active':''}" onclick="agendaView='month';loadAgenda()">Mois</button></div></div>`;
  if(agendaView==='day')h+=renderDayView();
  else if(agendaView==='week')h+=renderWeekView();
  else h+=renderMonthView();
  c.innerHTML=h;
}

function renderDayView(){
  const ds=fmt(agendaDate),bks=agendaBookings.filter(b=>fmt(new Date(b.start_at))===ds);
  if(!bks.length)return`<div class="card"><div class="empty">Aucun rendez-vous ${fmtDay(agendaDate).toLowerCase()}</div></div>`;
  let h=`<div class="card"><div class="card-h"><h3>${fmtDay(agendaDate)}</h3><span class="badge badge-teal">${bks.length} RDV</span></div><div style="padding:10px 14px">`;
  bks.forEach(b=>{h+=renderBkCard(b);});
  return h+`</div></div>`;
}

function renderBkCard(b){
  const s=new Date(b.start_at),e=new Date(b.end_at);
  const t1=s.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'}),t2=e.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
  const st=ST[b.status]||{l:b.status,c:''};
  const ico=MODE_ICO[b.appointment_mode]||'';
  const acts=b.status==='confirmed'||b.status==='pending'?
    `<button class="act-btn act-done" onclick="updateStatus('${b.id}','completed','${b.status}')">‚úì Termin√©</button><button class="act-btn act-noshow" onclick="updateStatus('${b.id}','no_show','${b.status}')">‚úó No-show</button><button class="act-btn act-cancel" onclick="updateStatus('${b.id}','cancelled','${b.status}')">Annuler</button>`:
    `<button class="act-btn act-undo" onclick="updateStatus('${b.id}','confirmed','${b.status}')">‚Ü© Remettre confirm√©</button>`;
  return`<div class="bk-card"><div style="display:flex;align-items:center;gap:12px"><div style="min-width:85px"><div class="time">${t1}</div><div style="font-size:.68rem;color:var(--text-4)">${t1} ‚Äì ${t2}</div></div><div style="width:4px;height:34px;border-radius:2px;background:${b.service_color||'var(--primary)'};flex-shrink:0"></div><div style="flex:1"><div class="client">${b.client_name}</div><div class="meta">${b.service_name} ¬∑ ${b.duration_min}min ¬∑ ${ico} ${b.appointment_mode||''} ¬∑ ${b.practitioner_name}</div><div class="meta">${b.client_phone||''} ¬∑ ${b.client_email||''}</div></div><span class="bk-status ${st.c}">${st.l}</span></div><div class="actions">${acts}</div></div>`;
}

function renderWeekView(){
  const mon=getMonday(agendaDate);let h=`<div class="week-grid">`;
  for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(mon.getDate()+i);const ds=fmt(d);
    const bks=agendaBookings.filter(b=>fmt(new Date(b.start_at))===ds).sort((a,b)=>new Date(a.start_at)-new Date(b.start_at));
    const td=isToday(d)?' today':'';
    h+=`<div class="week-col"><div class="week-header${td}" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()"><div style="font-size:.65rem">${DS[d.getDay()]}</div><span class="num">${d.getDate()}</span><div style="font-size:.55rem">${MS[d.getMonth()]}</div></div>`;
    bks.forEach(b=>{const t=new Date(b.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
      h+=`<div class="week-bk st-${b.status}" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()" title="${b.client_name} ‚Äì ${b.service_name}"><div class="t">${t}</div><div class="n">${b.client_name}</div></div>`;});
    if(!bks.length)h+=`<div style="padding:6px;text-align:center;font-size:.65rem;color:var(--text-4)">‚Äî</div>`;
    h+=`</div>`;}
  return h+`</div>`;
}

function renderMonthView(){
  const y=agendaDate.getFullYear(),m=agendaDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  let so=first.getDay();if(so===0)so=7;so-=1;
  let h=`<div class="month-grid">`;
  ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].forEach(d=>{h+=`<div class="month-header">${d}</div>`;});
  const sd=new Date(first);sd.setDate(sd.getDate()-so);
  const tc=Math.ceil((so+last.getDate())/7)*7;
  for(let i=0;i<tc;i++){const d=new Date(sd);d.setDate(sd.getDate()+i);const ds=fmt(d);
    const ot=d.getMonth()!==m,td=isToday(d)?' today':'';
    const bks=agendaBookings.filter(b=>fmt(new Date(b.start_at))===ds);
    h+=`<div class="month-cell${ot?' other':''}${td}"><div class="day-num" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()">${d.getDate()}</div>`;
    bks.slice(0,3).forEach(b=>{const t=new Date(b.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
      h+=`<div class="month-dot" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()"><span class="d" style="background:${b.service_color||'var(--primary)'}"></span>${t} ${b.client_name?.split(' ')[0]||''}</div>`;});
    if(bks.length>3)h+=`<div class="month-more" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()">+${bks.length-3} de plus</div>`;
    h+=`</div>`;}
  return h+`</div>`;
}

function shiftAgenda(dir){
  if(agendaView==='day')agendaDate.setDate(agendaDate.getDate()+dir);
  else if(agendaView==='week')agendaDate.setDate(agendaDate.getDate()+dir*7);
  else agendaDate.setMonth(agendaDate.getMonth()+dir);
  loadAgenda();
}

async function updateStatus(id,ns,os){
  try{const r=await fetch(`/api/bookings/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({status:ns})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    showUndo(id,ns,os);loadAgenda();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function showUndo(id,ns,os){
  document.querySelectorAll('.undo-toast').forEach(t=>t.remove());
  if(undoTimer)clearTimeout(undoTimer);
  const labels={completed:'marqu√© termin√©',no_show:'marqu√© no-show',cancelled:'annul√©',confirmed:'remis confirm√©'};
  const t=document.createElement('div');t.className='undo-toast';
  t.innerHTML=`<span>RDV ${labels[ns]||ns}</span><button onclick="undoStatus('${id}','${os}')">‚Ü© Annuler</button><button class="dismiss" onclick="this.parentElement.remove()">‚úï</button>`;
  document.body.appendChild(t);
  undoTimer=setTimeout(()=>{t.remove();},8000);
}

async function undoStatus(id,rs){
  document.querySelectorAll('.undo-toast').forEach(t=>t.remove());
  if(undoTimer)clearTimeout(undoTimer);
  try{await fetch(`/api/bookings/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({status:rs})});
    BooktUI.toast('Statut restaur√©','success');loadAgenda();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// CLIENTS
// ============================================================
let clientSearch='';
async function loadClients(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const q=clientSearch?`?search=${encodeURIComponent(clientSearch)}`:'';
    const r=await fetch(`/api/clients${q}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const clients=d.clients||[];
    let h=`<div class="search-bar"><input type="text" placeholder="Rechercher un client..." value="${clientSearch}" id="clientSearchInput" onkeydown="if(event.key==='Enter'){clientSearch=this.value;loadClients()}"><button class="btn-primary" onclick="clientSearch=document.getElementById('clientSearchInput').value;loadClients()">Rechercher</button>${clientSearch?`<button class="btn-outline" onclick="clientSearch='';loadClients()">‚úï</button>`:''}</div>`;
    h+=`<div class="card"><div class="card-h"><h3>Tous les clients</h3><span class="badge badge-teal">${d.total||clients.length}</span></div>`;
    if(clients.length===0){h+=`<div class="empty">Aucun client${clientSearch?' trouv√©':' encore'}</div>`;}
    else{
      h+=`<div style="overflow-x:auto"><table class="table"><thead><tr><th>Nom</th><th>T√©l√©phone</th><th>Email</th><th>RDV</th><th>Derni√®re visite</th><th>Statut</th></tr></thead><tbody>`;
      clients.forEach(cl=>{
        const last=cl.last_visit?new Date(cl.last_visit).toLocaleDateString('fr-BE',{day:'numeric',month:'short',year:'numeric'}):'‚Äî';
        const stCls=cl.status==='r√©gulier'||cl.status==='regulier'?'regulier':cl.status==='no_show'?'no_show':'nouveau';
        const stLabel=cl.status==='regulier'||cl.status==='r√©gulier'?'R√©gulier':cl.status==='no_show'?'No-show':'Nouveau';
        h+=`<tr><td class="client-name" onclick="openClientDetail('${cl.id}')">${cl.full_name}</td><td>${cl.phone||'‚Äî'}</td><td style="font-size:.78rem">${cl.email||'‚Äî'}</td><td>${cl.total_bookings}</td><td style="font-size:.78rem">${last}</td><td><span class="c-status ${stCls}">${stLabel}</span></td></tr>`;
      });
      h+=`</tbody></table></div>`;
    }
    h+=`</div>`;
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function openClientDetail(id){
  try{
    const r=await fetch(`/api/clients/${id}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const cl=d.client, bks=d.bookings||[];
    let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${cl.full_name}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">`;
    m+=`<div class="field-row"><div class="field"><label>Nom</label><input id="cl_name" value="${cl.full_name||''}"></div><div class="field"><label>T√©l√©phone</label><input id="cl_phone" value="${cl.phone||''}"></div></div>`;
    m+=`<div class="field-row"><div class="field"><label>Email</label><input id="cl_email" value="${cl.email||''}"></div><div class="field"><label>N¬∞ BCE</label><input id="cl_bce" value="${cl.bce_number||''}"></div></div>`;
    m+=`<div class="field"><label>Notes</label><textarea id="cl_notes">${cl.notes||''}</textarea></div>`;
    if(bks.length>0){
      m+=`<div style="margin-top:12px"><label style="font-size:.78rem;font-weight:600;color:var(--text-3)">Historique (${bks.length} RDV)</label>`;
      bks.slice(0,10).forEach(b=>{
        const dt=new Date(b.start_at);
        const stl=b.status==='completed'?'color:var(--text-4)':b.status==='cancelled'?'color:var(--red)':'';
        m+=`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border-light);font-size:.8rem;${stl}"><span>${dt.toLocaleDateString('fr-BE',{day:'numeric',month:'short'})} ‚Äî ${b.service_name}</span><span>${b.status}</span></div>`;
      });
      m+=`</div>`;
    }
    m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Fermer</button><button class="btn-primary" onclick="saveClient('${id}')">Enregistrer</button></div></div></div>`;
    document.body.insertAdjacentHTML('beforeend',m);
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function saveClient(id){
  try{
    const r=await fetch(`/api/clients/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({full_name:document.getElementById('cl_name').value,phone:document.getElementById('cl_phone').value,email:document.getElementById('cl_email').value,bce_number:document.getElementById('cl_bce').value,notes:document.getElementById('cl_notes').value})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast('Client mis √† jour','success');loadClients();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// SERVICES (PRESTATIONS)
// ============================================================
let allPractitioners=[];
async function loadServices(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[sr,pr]=await Promise.all([
      fetch('/api/services',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/dashboard',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const sd=await sr.json(), pd=await pr.json();
    const svcs=sd.services||[];
    allPractitioners=pd.practitioners||[];
    let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-size:.95rem;font-weight:700">${svcs.length} prestation${svcs.length>1?'s':''}</h3><button class="btn-primary" onclick="openServiceModal()">+ Nouvelle prestation</button></div>`;
    if(svcs.length===0){h+=`<div class="card"><div class="empty">Aucune prestation. Cr√©ez votre premi√®re !</div></div>`;}
    else{
      h+=`<div class="svc-grid">`;
      svcs.forEach(s=>{
        const price=s.price_cents?`${(s.price_cents/100).toFixed(0)} ‚Ç¨`:(s.price_label||'Gratuit');
        const modes=(s.mode_options||['cabinet']).map(m=>`<span class="mode-tag">${{cabinet:'üè¢ Cabinet',visio:'üíª Visio',phone:'üìû T√©l'}[m]||m}</span>`).join('');
        h+=`<div class="svc-card${s.is_active===false?' inactive':''}" style="border-left-color:${s.color||'var(--primary)'}">
          <h4>${s.name}</h4>
          <div class="svc-meta">${s.duration_min}min ¬∑ Buffer: ${s.buffer_before_min||0}+${s.buffer_after_min||0}min${s.category?' ¬∑ '+s.category:''}</div>
          <div class="svc-price">${price}</div>
          <div class="svc-modes">${modes}</div>
          <div class="svc-actions">
            <button class="btn-outline btn-sm" onclick="openServiceModal('${s.id}')">‚úèÔ∏è Modifier</button>
            ${s.is_active!==false?`<button class="btn-outline btn-sm btn-danger" onclick="if(confirm('D√©sactiver cette prestation ?'))deleteService('${s.id}')">D√©sactiver</button>`:`<span style="font-size:.72rem;color:var(--text-4);padding:5px">Inactive</span>`}
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function openServiceModal(editId){
  if(editId){
    fetch(`/api/services`,{headers:{'Authorization':'Bearer '+api.getToken()}}).then(r=>r.json()).then(d=>{
      renderServiceModal(d.services.find(s=>s.id===editId));
    });
  }else{renderServiceModal(null);}
}

function renderServiceModal(svc){
  const isEdit=!!svc;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${isEdit?'Modifier la prestation':'Nouvelle prestation'}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">`;
  m+=`<div class="field"><label>Nom *</label><input id="svc_name" value="${svc?.name||''}" placeholder="Ex: Consultation initiale"></div>`;
  m+=`<div class="field-row"><div class="field"><label>Dur√©e (min) *</label><input type="number" id="svc_dur" value="${svc?.duration_min||30}" min="5" step="5"></div><div class="field"><label>Prix (‚Ç¨)</label><input type="number" id="svc_price" value="${svc?.price_cents?(svc.price_cents/100):''}" step="0.01" placeholder="Gratuit si vide"></div></div>`;
  m+=`<div class="field-row"><div class="field"><label>Buffer avant (min)</label><input type="number" id="svc_bbefore" value="${svc?.buffer_before_min||0}" min="0"></div><div class="field"><label>Buffer apr√®s (min)</label><input type="number" id="svc_bafter" value="${svc?.buffer_after_min||0}" min="0"></div></div>`;
  m+=`<div class="field"><label>Cat√©gorie</label><input id="svc_cat" value="${svc?.category||''}" placeholder="Ex: Consultation, Soin..."></div>`;
  m+=`<div class="field"><label>Couleur</label><input type="color" id="svc_color" value="${svc?.color||'#0D7377'}" style="width:50px;height:36px;border:1.5px solid var(--border);border-radius:6px;cursor:pointer"></div>`;
  const modes=svc?.mode_options||['cabinet'];
  m+=`<div class="field"><label>Modes de consultation</label><div style="display:flex;gap:8px;margin-top:4px">
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_cab" ${modes.includes('cabinet')?'checked':''}> üè¢ Cabinet</label>
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_vis" ${modes.includes('visio')?'checked':''}> üíª Visio</label>
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_tel" ${modes.includes('phone')?'checked':''}> üìû T√©l</label>
  </div></div>`;
  m+=`<div class="field"><label>Label prix (si pas de montant)</label><input id="svc_plabel" value="${svc?.price_label||''}" placeholder="Ex: Sur devis, Gratuit..."></div>`;
  m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveService(${isEdit?"'"+svc.id+"'":'null'})">${isEdit?'Enregistrer':'Cr√©er'}</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveService(id){
  const modes=[];
  if(document.getElementById('svc_m_cab').checked)modes.push('cabinet');
  if(document.getElementById('svc_m_vis').checked)modes.push('visio');
  if(document.getElementById('svc_m_tel').checked)modes.push('phone');
  const priceVal=document.getElementById('svc_price').value;
  const body={name:document.getElementById('svc_name').value,duration_min:parseInt(document.getElementById('svc_dur').value),price_cents:priceVal?Math.round(parseFloat(priceVal)*100):null,price_label:document.getElementById('svc_plabel').value||null,buffer_before_min:parseInt(document.getElementById('svc_bbefore').value)||0,buffer_after_min:parseInt(document.getElementById('svc_bafter').value)||0,category:document.getElementById('svc_cat').value||null,color:document.getElementById('svc_color').value,mode_options:modes.length?modes:['cabinet']};
  try{
    const url=id?`/api/services/${id}`:'/api/services';
    const method=id?'PATCH':'POST';
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast(id?'Prestation modifi√©e':'Prestation cr√©√©e','success');loadServices();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function deleteService(id){
  try{
    const r=await fetch(`/api/services/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    BooktUI.toast('Prestation d√©sactiv√©e','success');loadServices();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// DISPONIBILIT√âS (HOURS)
// ============================================================
const DAYS_WEEK=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
let scheduleData={};

async function loadHours(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[ar,pr,er]=await Promise.all([
      fetch('/api/availabilities',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/dashboard',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/availabilities/exceptions',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const ad=await ar.json(),pd=await pr.json(),ed=await er.json();
    const avails=ad.availabilities||{};
    const practs=pd.practitioners||[];
    const excepts=ed.exceptions||[];
    scheduleData={};
    practs.forEach(p=>{
      const pa=avails[p.id];
      scheduleData[p.id]={name:p.display_name,color:p.color,schedule:{}};
      for(let d=0;d<7;d++){scheduleData[p.id].schedule[d]=pa?.schedule?.[d]||[];}
    });

    let h=`<p style="font-size:.85rem;color:var(--text-3);margin-bottom:16px">G√©rez les cr√©neaux de disponibilit√© par praticien. Les modifications s'appliquent aux prochaines r√©servations.</p>`;
    practs.forEach(p=>{
      const sc=scheduleData[p.id].schedule;
      h+=`<div class="card pract-block" style="margin-bottom:16px"><div class="card-h"><h3 style="display:flex;align-items:center;gap:8px"><span style="width:24px;height:24px;border-radius:6px;background:${p.color||'var(--primary)'};display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-family:var(--serif)">${p.display_name?.charAt(0)||'?'}</span>${p.display_name}</h3><button class="btn-primary btn-sm" onclick="saveSchedule('${p.id}')">üíæ Enregistrer</button></div><div style="padding:14px 18px">`;
      for(let d=0;d<7;d++){
        const slots=sc[d]||[];
        h+=`<div class="day-row"><span class="day-name">${DAYS_WEEK[d]}</span><div class="slots">`;
        if(slots.length===0){h+=`<span class="day-closed">Ferm√©</span>`;}
        else{slots.forEach((s,i)=>{h+=`<span class="slot-chip">${s.start_time?.slice(0,5)} ‚Äì ${s.end_time?.slice(0,5)}<button class="remove-slot" onclick="removeSlot('${p.id}',${d},${i})">‚úï</button></span>`;});}
        h+=`<button class="add-slot-btn" onclick="addSlot('${p.id}',${d})">+ Ajouter</button></div></div>`;
      }
      h+=`</div></div>`;
    });

    h+=`<div class="card"><div class="card-h"><h3>Exceptions & cong√©s</h3><button class="btn-primary btn-sm" onclick="openExceptionModal()">+ Ajouter</button></div>`;
    if(excepts.length===0){h+=`<div class="empty">Aucune exception planifi√©e</div>`;}
    else{h+=`<div style="padding:10px 18px">`;excepts.forEach(ex=>{
      const dt=new Date(ex.date).toLocaleDateString('fr-BE',{weekday:'short',day:'numeric',month:'short'});
      h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light)"><div><span style="font-size:.85rem;font-weight:600">${dt}</span><span style="font-size:.78rem;color:var(--text-4);margin-left:8px">${ex.practitioner_name} ‚Äî ${ex.type==='closed'?'Ferm√©':ex.start_time?.slice(0,5)+' ‚Äì '+ex.end_time?.slice(0,5)}</span>${ex.note?`<span style="font-size:.72rem;color:var(--text-4);margin-left:8px">(${ex.note})</span>`:''}</div><button class="btn-outline btn-sm btn-danger" onclick="if(confirm('Supprimer ?'))deleteException('${ex.id}')">‚úï</button></div>`;
    });h+=`</div>`;}
    h+=`</div>`;
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function addSlot(pid,day){
  const last=scheduleData[pid].schedule[day].slice(-1)[0];
  const ds=last?last.end_time:'09:00:00';
  const hr=parseInt(ds.split(':')[0]);
  const de=`${String(Math.min(hr+4,20)).padStart(2,'0')}:00`;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:340px"><div class="modal-h"><h3>Cr√©neau ‚Äî ${DAYS_WEEK[day]}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">
    <div class="field-row"><div class="field"><label>D√©but</label><input type="time" id="slot_start" value="${ds.slice(0,5)}"></div><div class="field"><label>Fin</label><input type="time" id="slot_end" value="${de}"></div></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="confirmAddSlot('${pid}',${day})">Ajouter</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

function confirmAddSlot(pid,day){
  const st=document.getElementById('slot_start').value+':00',en=document.getElementById('slot_end').value+':00';
  if(!scheduleData[pid].schedule[day])scheduleData[pid].schedule[day]=[];
  scheduleData[pid].schedule[day].push({start_time:st,end_time:en});
  scheduleData[pid].schedule[day].sort((a,b)=>a.start_time.localeCompare(b.start_time));
  document.querySelector('.modal-overlay')?.remove();loadHours();
}

function removeSlot(pid,day,idx){scheduleData[pid].schedule[day].splice(idx,1);loadHours();}

async function saveSchedule(pid){
  const schedule={};
  for(let d=0;d<7;d++){const sl=scheduleData[pid].schedule[d]||[];if(sl.length>0)schedule[d]=sl.map(s=>({start_time:s.start_time?.slice(0,5),end_time:s.end_time?.slice(0,5)}));}
  try{const r=await fetch('/api/availabilities',{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({practitioner_id:pid,schedule})});
    if(!r.ok)throw new Error((await r.json()).error);BooktUI.toast('Horaires enregistr√©s','success');loadHours();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function openExceptionModal(){
  const pids=Object.entries(scheduleData).map(([id,d])=>`<option value="${id}">${d.name}</option>`).join('');
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:400px"><div class="modal-h"><h3>Nouvelle exception</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">
    <div class="field"><label>Praticien</label><select id="exc_pract">${pids}</select></div>
    <div class="field"><label>Date</label><input type="date" id="exc_date" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="field"><label>Type</label><select id="exc_type" onchange="document.getElementById('exc_times').style.display=this.value==='custom'?'flex':'none'"><option value="closed">Ferm√© toute la journ√©e</option><option value="custom">Horaires modifi√©s</option></select></div>
    <div class="field-row" id="exc_times" style="display:none"><div class="field"><label>D√©but</label><input type="time" id="exc_start" value="09:00"></div><div class="field"><label>Fin</label><input type="time" id="exc_end" value="17:00"></div></div>
    <div class="field"><label>Note</label><input id="exc_note" placeholder="Ex: Cong√©, formation..."></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveException()">Enregistrer</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveException(){
  const type=document.getElementById('exc_type').value;
  const body={practitioner_id:document.getElementById('exc_pract').value,date:document.getElementById('exc_date').value,type,note:document.getElementById('exc_note').value||null};
  if(type==='custom'){body.start_time=document.getElementById('exc_start').value;body.end_time=document.getElementById('exc_end').value;}
  try{const r=await fetch('/api/availabilities/exceptions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);document.querySelector('.modal-overlay')?.remove();BooktUI.toast('Exception ajout√©e','success');loadHours();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function deleteException(id){
  try{await fetch(`/api/availabilities/exceptions/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});BooktUI.toast('Exception supprim√©e','success');loadHours();}catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// SITE SECTION ‚Äî THEME PICKER
// ============================================================
const THEMES={
  classique:{name:'Classique',desc:'√âpur√© et professionnel. Teal + typographie √©ditoriale.',free:true,
    colors:{bg:'#FAFAF9',nav:'#FAFAF9',navText:'#1A1816',primary:'#0D7377',text:'#1A1816',card:'#FFF',cardBorder:'#ECEAE6',heroBg:'#FAFAF9'},
    heroStyle:'light'},
  prestige:{name:'Prestige',desc:'Bleu nuit + or. Id√©al avocats, notaires, consultants.',free:false,
    colors:{bg:'#F8F7F4',nav:'#1B1B1B',navText:'#FFF',primary:'#1E3A5F',text:'#1B1B1B',card:'#FFF',cardBorder:'#E0DDD8',heroBg:'#1B1B1B'},
    heroStyle:'dark'},
  zen:{name:'Zen',desc:'Vert sauge + beige. Parfait bien-√™tre, th√©rapeutes, coachs.',free:false,
    colors:{bg:'#F7F5F0',nav:'#F7F5F0',navText:'#2C2820',primary:'#6B7F5E',text:'#2C2820',card:'#FFFDF9',cardBorder:'#E5E0D6',heroBg:'#F7F5F0'},
    heroStyle:'light'},
  moderne:{name:'Moderne',desc:'Noir + blanc. G√©om√©trique, tech-forward, minimaliste.',free:false,
    colors:{bg:'#FAFAFA',nav:'#FAFAFA',navText:'#111',primary:'#111',text:'#111',card:'#FFF',cardBorder:'#E8E8E8',heroBg:'#FAFAFA'},
    heroStyle:'light'},
  chaleureux:{name:'Chaleureux',desc:'Terracotta + cr√®me. Accueillant, personnel, artisanal.',free:false,
    colors:{bg:'#FAF6F2',nav:'#FAF6F2',navText:'#2E1F14',primary:'#8B4513',text:'#2E1F14',card:'#FFFCF8',cardBorder:'#E8E0D6',heroBg:'#FAF6F2'},
    heroStyle:'light'},
  ocean:{name:'Oc√©an',desc:'Bleu profond + ciel. Frais, ouvert, m√©dical.',free:false,
    colors:{bg:'#F5F8FA',nav:'#0F2440',navText:'#FFF',primary:'#1565C0',text:'#0F2440',card:'#FFF',cardBorder:'#DCE5ED',heroBg:'#0F2440'},
    heroStyle:'dark'}
};

let currentThemePreset='classique';
let businessPlan='free';

async function loadSiteSection(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const r=await fetch('/api/business',{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const b=d.business;
    currentThemePreset=b.theme?.preset||'classique';
    businessPlan=b.plan||'free';
    const slug=b.slug||'';

    let h=`<div class="qlink"><div class="info"><h4>Votre page publique</h4><p>${slug}</p></div><div style="display:flex;gap:8px"><a href="/${slug}" target="_blank">Voir ma page</a><a href="/${slug}/book" target="_blank" style="background:rgba(255,255,255,.08)">Page booking</a></div></div>`;

    h+=`<div class="card"><div class="card-h"><h3>Th√®me du mini-site</h3><span class="badge ${businessPlan==='free'?'badge-teal':'badge-teal'}">${businessPlan==='free'?'Plan Gratuit ‚Äî 1 th√®me':'Plan '+businessPlan.charAt(0).toUpperCase()+businessPlan.slice(1)}</span></div>
    <div style="padding:18px">
      <p style="font-size:.85rem;color:var(--text-3);margin-bottom:4px">Choisissez l'identit√© visuelle de votre site. Chaque th√®me inclut typographie, palette et mise en page uniques.</p>
      ${businessPlan==='free'?'<p style="font-size:.78rem;color:var(--gold);margin-bottom:12px">üîì Passez au plan Pro pour d√©bloquer les 5 th√®mes premium + couleur personnalis√©e.</p>':''}
      <div class="theme-grid">`;

    Object.entries(THEMES).forEach(([key,t])=>{
      const isActive=key===currentThemePreset;
      const isPro=!t.free;
      const isLocked=isPro&&businessPlan==='free';
      const cls=`theme-card${isActive?' active':''}${isLocked?' locked':''}`;
      const co=t.colors;

      h+=`<div class="${cls}" onclick="${isLocked?'':'selectTheme(\''+key+'\')'}">
        <div class="check">‚úì</div>
        ${isLocked?'<div class="lock-icon">üîí</div>':''}
        <div class="theme-preview" style="background:${co.heroBg}">
          <div class="tp-nav" style="background:${co.nav}">
            <div class="dot" style="background:${co.primary}">B</div>
            <span class="tp-name" style="color:${co.navText}">Cabinet</span>
            <span class="tp-cta" style="background:${co.primary}">RDV</span>
          </div>
          <div class="tp-hero" style="color:${t.heroStyle==='dark'?'#fff':co.text}">
            <h3>Cabinet Dupont & Associ√©s</h3>
            <p>Votre sant√©, notre priorit√© depuis 2018</p>
          </div>
          <div class="tp-cards">
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
          </div>
        </div>
        <div class="theme-info">
          <h4>${t.name} <span class="th-badge ${t.free?'th-free':'th-pro'}">${t.free?'Gratuit':'Pro'}</span></h4>
          <p>${t.desc}</p>
        </div>
      </div>`;
    });

    h+=`</div></div></div>`;

    // Custom color (Pro only)
    const curColor=b.theme?.primary_color||THEMES[currentThemePreset]?.colors?.primary||'#0D7377';
    h+=`<div class="card"><div class="card-h"><h3>Couleur personnalis√©e</h3>${businessPlan==='free'?'<span class="th-badge th-pro">Pro</span>':''}</div>
      <div style="padding:18px;display:flex;align-items:center;gap:14px">
        <input type="color" id="customColor" value="${curColor}" ${businessPlan==='free'?'disabled':''} style="width:44px;height:44px;border:2px solid var(--border);border-radius:8px;cursor:${businessPlan==='free'?'not-allowed':'pointer'};padding:2px">
        <div><p style="font-size:.85rem;font-weight:600">Remplacer la couleur primaire du th√®me</p>
        <p style="font-size:.75rem;color:var(--text-4)">${businessPlan==='free'?'Disponible avec le plan Pro':'Choisissez une couleur qui repr√©sente votre marque'}</p></div>
        ${businessPlan!=='free'?'<button onclick="saveCustomColor()" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-family:var(--sans);font-size:.8rem;font-weight:600;cursor:pointer;margin-left:auto">Appliquer</button>':''}
      </div>
    </div>`;

    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function selectTheme(preset){
  if(preset===currentThemePreset)return;
  try{
    const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({theme:{preset,primary_color:THEMES[preset]?.colors?.primary}})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    currentThemePreset=preset;
    BooktUI.toast(`Th√®me "${THEMES[preset].name}" appliqu√© !`,'success');
    loadSiteSection();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function saveCustomColor(){
  const color=document.getElementById('customColor').value;
  try{
    const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({theme:{preset:currentThemePreset,primary_color:color}})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    BooktUI.toast('Couleur appliqu√©e !','success');
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function doLogout(){api.logout();}
</script>
</body>
</html>
