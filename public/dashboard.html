<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äî Bookt</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#FAFAF9;--white:#FFF;--surface:#F5F4F1;--surface-2:#EDEBE8;--border:#E0DDD8;--border-light:#ECEAE6;--text:#1A1816;--text-2:#3D3832;--text-3:#6B6560;--text-4:#9C958E;--primary:#0D7377;--primary-hover:#0A5E61;--primary-light:#EFF9F8;--primary-soft:#D5EFEC;--green:#1B7A42;--green-bg:#EEFAF1;--gold:#A68B3C;--gold-bg:#FAF6EC;--red:#DC2626;--red-bg:#FEF2F2;--sidebar-bg:#1C1917;--sidebar-hover:#292524;--serif:'Instrument Serif',Georgia,serif;--sans:'Plus Jakarta Sans',-apple-system,sans-serif;--shadow:0 2px 8px rgba(0,0,0,.05);--radius:14px;--radius-sm:10px;--radius-xs:6px}
body{background:var(--bg);color:var(--text);font-family:var(--sans);-webkit-font-smoothing:antialiased}
.sidebar{position:fixed;top:0;left:0;bottom:0;width:230px;background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;z-index:50}
.sb-logo{padding:18px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-logo .l{width:30px;height:30px;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:.85rem}
.sb-logo .w{font-size:.82rem;font-weight:700;letter-spacing:.5px}
.sb-logo .plan{font-size:.55rem;font-weight:700;background:rgba(255,255,255,.12);padding:1px 5px;border-radius:3px;margin-left:4px;color:rgba(255,255,255,.5)}
.sb-nav{padding:10px 8px;flex:1}
.ni{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.5);cursor:pointer;transition:all .12s;text-decoration:none;margin-bottom:2px}
.ni:hover{background:var(--sidebar-hover);color:rgba(255,255,255,.8)}
.ni.active{background:var(--primary);color:#fff;font-weight:600}
.ni .ic{width:18px;text-align:center;font-size:.9rem}
.sb-foot{padding:14px 16px;border-top:1px solid rgba(255,255,255,.06)}
.sb-foot .nm{font-size:.78rem;font-weight:600}
.sb-foot .rl{font-size:.65rem;color:rgba(255,255,255,.35)}
.sb-foot .logout{font-size:.68rem;color:rgba(255,255,255,.3);cursor:pointer;margin-top:4px;text-decoration:underline}
.main{margin-left:230px;min-height:100vh}
.topbar{position:sticky;top:0;background:rgba(250,250,249,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--border-light);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;z-index:40}
.topbar h1{font-family:var(--serif);font-size:1.3rem;font-weight:400}
.content{padding:24px 28px;max-width:1100px}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:var(--white);border-radius:var(--radius-sm);border:1px solid var(--border-light);padding:16px}
.stat-card .label{font-size:.7rem;font-weight:600;color:var(--text-4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.stat-card .val{font-family:var(--serif);font-size:1.6rem;color:var(--text)}
.stat-card .sub{font-size:.7rem;color:var(--text-4);margin-top:2px}
.card{background:var(--white);border-radius:var(--radius);border:1px solid var(--border-light);overflow:hidden;margin-bottom:16px}
.card-h{padding:14px 18px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.card-h h3{font-size:.9rem;font-weight:700}
.badge{font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:10px}
.badge-teal{background:var(--primary-light);color:var(--primary)}
.bk-row{display:flex;align-items:center;gap:12px;padding:10px 18px;border-bottom:1px solid var(--border-light)}
.bk-row:last-child{border:none}
.bk-status{padding:3px 10px;border-radius:10px;font-size:.68rem;font-weight:600}
.bk-status.confirmed{background:var(--green-bg);color:var(--green)}
.bk-status.pending{background:var(--gold-bg);color:var(--gold)}
.bk-status.completed{background:var(--surface);color:var(--text-3)}
.bk-status.noshow{background:#FFF3CD;color:#856404}
.bk-status.cancelled{background:var(--red-bg);color:var(--red)}
.empty{padding:40px;text-align:center;color:var(--text-4);font-size:.88rem}
.qlink{background:linear-gradient(135deg,var(--primary),#0A5E61);border-radius:var(--radius-sm);padding:16px 20px;color:#fff;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.qlink .info h4{font-size:.9rem;font-weight:600;margin-bottom:2px}
.qlink .info p{font-size:.75rem;opacity:.6}
.qlink a{padding:7px 14px;background:rgba(255,255,255,.15);border-radius:var(--radius-xs);font-size:.78rem;font-weight:600;color:#fff;text-decoration:none}
.loading{text-align:center;padding:40px;color:var(--text-4)}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Agenda */
.agenda-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.agenda-nav{display:flex;align-items:center;gap:8px}
.a-btn{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center}
.a-btn:hover{background:var(--surface)}
.a-btn-text{padding:5px 12px;border-radius:6px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text-3);font-family:var(--sans)}
.agenda-label{font-size:1rem;font-weight:600;min-width:200px;text-align:center}
.view-tabs{display:flex;gap:2px;background:var(--surface);border-radius:8px;padding:2px}
.view-tab{padding:5px 14px;border-radius:6px;font-size:.75rem;font-weight:600;color:var(--text-3);cursor:pointer;border:none;background:transparent;font-family:var(--sans)}
.view-tab.active{background:var(--white);color:var(--text);box-shadow:var(--shadow)}
.bk-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-xs);padding:10px 14px;margin-bottom:6px}
.bk-card:hover{border-color:var(--primary-soft)}
.bk-card .time{font-size:.8rem;font-weight:700;color:var(--primary)}
.bk-card .client{font-size:.85rem;font-weight:600}
.bk-card .meta{font-size:.7rem;color:var(--text-4)}
.bk-card .actions{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.act-btn{padding:3px 8px;border-radius:5px;border:1px solid;cursor:pointer;font-size:.68rem;font-weight:600;font-family:var(--sans)}
.act-done{border-color:#B8E6C4;background:var(--green-bg);color:var(--green)}
.act-noshow{border-color:#E8DCBA;background:var(--gold-bg);color:var(--gold)}
.act-cancel{border-color:#FECACA;background:var(--red-bg);color:var(--red)}
.act-undo{border-color:var(--primary-border);background:var(--primary-light);color:var(--primary)}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.week-col{min-height:120px}
.week-header{text-align:center;padding:8px 4px;font-size:.72rem;font-weight:700;color:var(--text-3);border-bottom:2px solid var(--border-light);margin-bottom:6px;cursor:pointer}
.week-header.today{color:var(--primary);border-bottom-color:var(--primary)}
.week-header .num{font-size:1.1rem;display:block;color:var(--text)}
.week-header.today .num{color:var(--primary)}
.week-bk{background:var(--primary-light);border-left:3px solid var(--primary);border-radius:4px;padding:4px 6px;margin-bottom:3px;cursor:pointer;font-size:.7rem}
.week-bk:hover{background:var(--primary-soft)}
.week-bk .t{font-weight:700;color:var(--primary)}.week-bk .n{color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.week-bk.st-completed{background:var(--surface);border-color:var(--text-4)}.week-bk.st-completed .t{color:var(--text-4)}
.week-bk.st-cancelled{background:var(--red-bg);border-color:var(--red);opacity:.5}
.week-bk.st-no_show{background:#FFF3CD;border-color:#856404}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border-light);border:1px solid var(--border-light);border-radius:var(--radius-sm);overflow:hidden}
.month-header{padding:8px;text-align:center;font-size:.7rem;font-weight:700;color:var(--text-4);background:var(--surface)}
.month-cell{background:var(--white);min-height:80px;padding:4px}
.month-cell.other{background:var(--bg);opacity:.4}
.month-cell.today{background:var(--primary-light)}
.month-cell .day-num{font-size:.75rem;font-weight:700;color:var(--text-3);margin-bottom:2px;padding:2px 4px;cursor:pointer}
.month-cell.today .day-num{color:var(--primary)}
.month-dot{display:flex;align-items:center;gap:3px;padding:1px 4px;border-radius:3px;font-size:.6rem;color:var(--text-3);cursor:pointer;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.month-dot:hover{background:var(--surface)}
.month-dot .d{width:5px;height:5px;border-radius:50%;background:var(--primary);flex-shrink:0}
.month-more{font-size:.6rem;color:var(--primary);font-weight:600;padding:1px 4px;cursor:pointer}
.undo-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1C1917;color:#fff;padding:12px 20px;border-radius:10px;font-size:.85rem;display:flex;align-items:center;gap:14px;box-shadow:0 8px 30px rgba(0,0,0,.2);z-index:1000;animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.undo-toast button{padding:6px 14px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-family:var(--sans);font-size:.8rem;font-weight:700;cursor:pointer}
.undo-toast .dismiss{background:transparent;color:rgba(255,255,255,.5);font-size:.75rem;padding:4px 8px}
@media(max-width:1000px){.sidebar{width:60px}.sidebar .w,.sidebar .plan,.ni span:not(.ic),.sb-foot .nm,.sb-foot .rl,.sb-foot .logout{display:none}.main{margin-left:60px}.stats{grid-template-columns:1fr 1fr}.week-grid{grid-template-columns:repeat(3,1fr)}}
/* Theme picker */
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
/* CRUD sections */
.search-bar{display:flex;gap:8px;margin-bottom:16px}
.search-bar input{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none;transition:border-color .15s}
.search-bar input:focus{border-color:var(--primary)}
.btn-primary{padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer}
.btn-primary:hover{background:var(--primary-hover)}
.btn-outline{padding:8px 16px;background:var(--white);color:var(--text-2);border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer}
.btn-outline:hover{background:var(--surface)}
.btn-sm{padding:5px 10px;font-size:.75rem;border-radius:6px}
.btn-danger{background:var(--red-bg);color:var(--red);border-color:#FECACA}
.table{width:100%;border-collapse:collapse}
.table th{text-align:left;padding:10px 14px;font-size:.72rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border-light)}
.table td{padding:10px 14px;font-size:.85rem;border-bottom:1px solid var(--border-light)}
.table tr:hover td{background:var(--surface)}
.table .client-name{font-weight:600;cursor:pointer;color:var(--primary)}
.table .client-name:hover{text-decoration:underline}
.c-status{padding:2px 8px;border-radius:8px;font-size:.68rem;font-weight:600}
.c-status.regulier{background:var(--green-bg);color:var(--green)}
.c-status.nouveau{background:var(--primary-light);color:var(--primary)}
.c-status.no_show{background:var(--red-bg);color:var(--red)}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s}
.modal{background:var(--white);border-radius:var(--radius);width:100%;max-width:520px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.15);animation:slideUp .2s ease}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.modal-h h3{font-size:.95rem;font-weight:700}
.modal-h .close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-4);padding:4px}
.modal-body{padding:20px}
.field{margin-bottom:14px}
.field label{display:block;font-size:.78rem;font-weight:600;color:var(--text-3);margin-bottom:4px}
.field input,.field select,.field textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--primary)}
.field textarea{resize:vertical;min-height:70px}
.field-row{display:flex;gap:10px}
.field-row .field{flex:1}
.modal-foot{padding:14px 20px;border-top:1px solid var(--border-light);display:flex;justify-content:flex-end;gap:8px}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
/* Service cards */
.svc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.svc-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:16px;position:relative;border-left:4px solid var(--primary)}
.svc-card h4{font-size:.9rem;font-weight:700;margin-bottom:4px}
.svc-card .svc-meta{font-size:.78rem;color:var(--text-4);margin-bottom:8px}
.svc-card .svc-price{font-family:var(--serif);font-size:1.1rem;color:var(--primary)}
.svc-card .svc-modes{display:flex;gap:4px;margin-top:6px}
.svc-card .mode-tag{padding:2px 8px;border-radius:6px;font-size:.65rem;font-weight:600;background:var(--surface);color:var(--text-3)}
.svc-card .svc-actions{display:flex;gap:4px;margin-top:10px}
.svc-card.inactive{opacity:.5;border-left-color:var(--text-4)}
/* Hours grid */
.hours-schedule{margin-top:12px}
.pract-block{margin-bottom:20px}
.pract-block h4{font-size:.88rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.day-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-light)}
.day-row .day-name{min-width:80px;font-size:.82rem;font-weight:600}
.day-row .slots{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.slot-chip{display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--primary-light);border-radius:6px;font-size:.78rem;color:var(--primary);font-weight:600}
.slot-chip .remove-slot{background:none;border:none;cursor:pointer;font-size:.9rem;color:var(--primary);padding:0 2px;opacity:.5}
.slot-chip .remove-slot:hover{opacity:1}
.add-slot-btn{padding:4px 10px;border:1.5px dashed var(--border);border-radius:6px;font-size:.75rem;color:var(--text-4);cursor:pointer;background:transparent;font-family:var(--sans)}
.add-slot-btn:hover{border-color:var(--primary);color:var(--primary)}
.day-closed{font-size:.78rem;color:var(--text-4);font-style:italic}
/* Analytics */
.an-period{display:flex;gap:2px;background:var(--surface);border-radius:8px;padding:2px;margin-bottom:20px}
.an-period button{padding:6px 16px;border-radius:6px;font-size:.78rem;font-weight:600;color:var(--text-3);cursor:pointer;border:none;background:transparent;font-family:var(--sans)}
.an-period button.active{background:var(--white);color:var(--text);box-shadow:var(--shadow)}
.an-kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px}
.an-kpi .kpi{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:16px;text-align:center}
.an-kpi .kpi .kv{font-family:var(--serif);font-size:1.5rem;color:var(--text)}
.an-kpi .kpi .kl{font-size:.68rem;font-weight:600;color:var(--text-4);text-transform:uppercase;letter-spacing:.4px;margin-top:2px}
.chart-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius);padding:18px;margin-bottom:14px}
.chart-card h4{font-size:.88rem;font-weight:700;margin-bottom:14px}
.chart-card canvas{width:100%;display:block}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.heatmap{display:grid;grid-template-columns:40px repeat(24,1fr);gap:1px;font-size:.55rem}
.heatmap .hl{display:flex;align-items:center;justify-content:flex-end;padding-right:4px;color:var(--text-4);font-weight:600}
.heatmap .hh{text-align:center;color:var(--text-4);font-weight:600;padding:2px 0}
.heatmap .hc{border-radius:2px;aspect-ratio:1;display:flex;align-items:center;justify-content:center;color:transparent;transition:background .15s}
.heatmap .hc:hover{color:var(--text)}
.top-svc-list{display:flex;flex-direction:column;gap:6px}
.top-svc-row{display:flex;align-items:center;gap:10px}
.top-svc-row .bar-wrap{flex:1;height:24px;background:var(--surface);border-radius:4px;overflow:hidden}
.top-svc-row .bar{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:.7rem;font-weight:600;color:#fff;min-width:20px}
.top-svc-row .sname{min-width:120px;font-size:.82rem;font-weight:600}
.top-svc-row .scount{min-width:40px;text-align:right;font-size:.82rem;color:var(--text-3)}
.status-legend{display:flex;flex-wrap:wrap;gap:12px;margin-top:10px}
.status-legend .sl{display:flex;align-items:center;gap:5px;font-size:.78rem}
.status-legend .sl .dot{width:10px;height:10px;border-radius:50%}
@media(max-width:800px){.an-kpi{grid-template-columns:repeat(2,1fr)}.chart-row{grid-template-columns:1fr}}
/* Settings */
.settings-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius);margin-bottom:16px;overflow:hidden}
.settings-card .sc-h{padding:16px 20px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.settings-card .sc-h h3{font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:8px}
.settings-card .sc-body{padding:20px}
.settings-card .sc-body .field{margin-bottom:14px}
.settings-card .sc-body .field label{display:block;font-size:.78rem;font-weight:600;color:var(--text-3);margin-bottom:4px}
.settings-card .sc-body .field input,.settings-card .sc-body .field select,.settings-card .sc-body .field textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none}
.settings-card .sc-body .field input:focus,.settings-card .sc-body .field textarea:focus{border-color:var(--primary)}
.settings-card .sc-body .field textarea{resize:vertical;min-height:80px}
.settings-card .sc-body .field-row{display:flex;gap:12px}
.settings-card .sc-body .field-row .field{flex:1}
.settings-card .sc-body .hint{font-size:.72rem;color:var(--text-4);margin-top:3px}
.settings-card .sc-foot{padding:14px 20px;border-top:1px solid var(--border-light);display:flex;justify-content:flex-end;gap:8px}
.plan-card{display:flex;gap:20px;flex-wrap:wrap}
.plan-box{flex:1;min-width:200px;padding:20px;border:2px solid var(--border-light);border-radius:var(--radius-sm);text-align:center;position:relative}
.plan-box.current{border-color:var(--primary);background:var(--primary-light)}
.plan-box .plan-name{font-family:var(--serif);font-size:1.2rem;margin-bottom:4px}
.plan-box .plan-price{font-size:1.6rem;font-weight:700;color:var(--primary)}
.plan-box .plan-price span{font-size:.78rem;font-weight:400;color:var(--text-4)}
.plan-box ul{list-style:none;text-align:left;margin:12px 0;font-size:.8rem;color:var(--text-3)}
.plan-box ul li{padding:3px 0}
.plan-box ul li::before{content:'‚úì ';color:var(--green);font-weight:700}
.plan-box .current-badge{position:absolute;top:-10px;right:12px;background:var(--primary);color:#fff;padding:2px 10px;border-radius:8px;font-size:.68rem;font-weight:700}
.danger-zone{background:var(--red-bg);border-color:#FECACA}
.danger-zone .sc-h{border-color:#FECACA}
.danger-zone .sc-h h3{color:var(--red)}
.copy-input{display:flex;gap:6px}
.copy-input input{flex:1;background:var(--surface);font-size:.78rem;font-family:monospace}
.copy-input button{flex-shrink:0}
/* Team */
.team-grid2{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
.team-member{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius);padding:20px;position:relative}
.team-member.inactive{opacity:.5}
.team-member .tm-header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
.team-member .tm-avatar{width:48px;height:48px;border-radius:14px;color:#fff;display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:1.1rem;flex-shrink:0}
.team-member .tm-info h4{font-size:.95rem;font-weight:700}
.team-member .tm-info .tm-title{font-size:.78rem;color:var(--text-3)}
.team-member .tm-info .tm-email{font-size:.72rem;color:var(--text-4)}
.team-member .tm-stats{display:flex;gap:12px;margin-bottom:10px;padding:8px 0;border-top:1px solid var(--border-light);border-bottom:1px solid var(--border-light)}
.team-member .tm-stat{text-align:center;flex:1}
.team-member .tm-stat .v{font-weight:700;font-size:.88rem}
.team-member .tm-stat .l{font-size:.65rem;color:var(--text-4);text-transform:uppercase}
.team-member .tm-badges{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px}
.team-member .tm-badge{padding:2px 8px;border-radius:6px;font-size:.65rem;font-weight:600}
.tm-badge.active{background:var(--green-bg);color:var(--green)}
.tm-badge.inactive{background:var(--red-bg);color:var(--red)}
.tm-badge.booking{background:var(--primary-light);color:var(--primary)}
.tm-badge.no-booking{background:var(--surface);color:var(--text-4)}
.tm-badge.has-login{background:var(--gold-bg);color:var(--gold)}
.team-member .tm-actions{display:flex;gap:6px;flex-wrap:wrap}
.theme-card{background:var(--white);border:2px solid var(--border-light);border-radius:var(--radius);padding:0;cursor:pointer;transition:all .2s;overflow:hidden;position:relative}
.theme-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.theme-card.active{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
.theme-card.locked{opacity:.7;cursor:default}
.theme-card.locked:hover{transform:none;border-color:var(--border-light)}
.theme-preview{height:120px;position:relative;overflow:hidden}
.theme-preview .tp-nav{height:28px;display:flex;align-items:center;padding:0 10px;gap:6px}
.theme-preview .tp-nav .dot{width:14px;height:14px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.5rem;color:#fff}
.theme-preview .tp-nav .tp-name{font-size:.5rem;font-weight:700;flex:1}
.theme-preview .tp-nav .tp-cta{padding:2px 6px;border-radius:3px;font-size:.42rem;font-weight:700;color:#fff}
.theme-preview .tp-hero{padding:6px 10px}
.theme-preview .tp-hero h3{font-size:.6rem;font-weight:400;margin-bottom:2px;line-height:1.2}
.theme-preview .tp-hero p{font-size:.38rem;opacity:.5}
.theme-preview .tp-cards{display:flex;gap:4px;padding:0 10px}
.theme-preview .tp-card{flex:1;height:24px;border-radius:3px;border-width:1px;border-style:solid}
.theme-info{padding:12px 14px;border-top:1px solid var(--border-light)}
.theme-info h4{font-size:.85rem;font-weight:700;display:flex;align-items:center;gap:6px}
.theme-info p{font-size:.72rem;color:var(--text-4);margin-top:2px}
.th-badge{padding:2px 8px;border-radius:8px;font-size:.6rem;font-weight:700}
.th-free{background:var(--green-bg);color:var(--green)}
.th-pro{background:var(--gold-bg);color:var(--gold)}
.theme-card .check{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:50%;background:var(--primary);color:#fff;display:none;align-items:center;justify-content:center;font-size:.7rem;z-index:2}
.theme-card.active .check{display:flex}
.lock-icon{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,.3);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.6rem;z-index:2}
@media(max-width:800px){.theme-grid{grid-template-columns:1fr 1fr}}
@media(max-width:500px){.theme-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="sb-logo"><div class="l">B</div><span class="w">Bookt</span><span class="plan" id="planBadge">FREE</span></div>
  <nav class="sb-nav">
    <a class="ni active" href="#" data-section="home"><span class="ic">üìä</span><span>Dashboard</span></a>
    <a class="ni" href="#" data-section="bookings"><span class="ic">üìÖ</span><span>Agenda</span></a>
    <a class="ni" href="#" data-section="clients"><span class="ic">üóÇÔ∏è</span><span>Clients</span></a>
    <a class="ni" href="#" data-section="services"><span class="ic">üìã</span><span>Prestations</span></a>
    <a class="ni" href="#" data-section="hours"><span class="ic">üïê</span><span>Disponibilit√©s</span></a>
    <a class="ni" href="#" data-section="team"><span class="ic">üë•</span><span>√âquipe</span></a>
    <a class="ni" href="#" data-section="site"><span class="ic">üåê</span><span>Mon site</span></a>
    <a class="ni" href="#" data-section="invoices"><span class="ic">üßæ</span><span>Facturation</span></a>
    <a class="ni" href="#" data-section="documents"><span class="ic">üìã</span><span>Documents</span></a>
    <a class="ni" href="#" data-section="calls"><span class="ic">üìû</span><span>Appels</span></a>
    <a class="ni" href="#" data-section="settings"><span class="ic">‚öôÔ∏è</span><span>Param√®tres</span></a>
    <div style="height:1px;background:rgba(255,255,255,.06);margin:6px 12px"></div>
    <a class="ni" href="#" data-section="analytics"><span class="ic">üìà</span><span>Statistiques</span></a>
  </nav>
  <div class="sb-foot">
    <div class="nm" id="userName">‚Äî</div>
    <div class="rl" id="userRole">‚Äî</div>
    <div class="logout" onclick="doLogout()">D√©connexion</div>
  </div>
</aside>
<div class="main">
  <div class="topbar"><h1 id="pageTitle">Dashboard</h1><div><span style="font-size:.78rem;color:var(--text-4)" id="todayDate"></span></div></div>
  <div class="content" id="contentArea"><div class="loading"><div class="spinner"></div><p style="margin-top:10px">Chargement...</p></div></div>
</div>
<script src="/js/api-client.js"></script>
<script>
const api=new BooktAPI();
if(!api.isLoggedIn())window.location.href='/login.html';
const user=api.getUser(),biz=api.getBusiness();
document.getElementById('userName').textContent=user?.business_name||user?.email||'‚Äî';
document.getElementById('userRole').textContent=user?.role==='owner'?'Propri√©taire':'Staff';
document.getElementById('todayDate').textContent=new Date().toLocaleDateString('fr-BE',{weekday:'long',day:'numeric',month:'long'});
if(biz)document.getElementById('planBadge').textContent=(biz.plan||'free').toUpperCase();
if(new URLSearchParams(location.search).get('onboarding'))BooktUI.toast('üéâ Bienvenue !','success',5000);
loadDashboard();

async function loadDashboard(){
  const c=document.getElementById('contentArea');
  try{
    const[dd,sd]=await Promise.allSettled([api.getDashboard(),api.get('/api/dashboard/summary')]);
    const dash=dd.status==='fulfilled'?dd.value:{},sum=sd.status==='fulfilled'?sd.value:null;
    const slug=dash.business?.slug||biz?.slug||'';
    let h=`<div class="qlink"><div class="info"><h4>Votre page publique</h4><p>${slug}</p></div><div><a href="/${slug}" target="_blank">Voir ma page</a></div></div>`;
    if(sum){const m=sum.month||{},cl=sum.clients||{},ca=sum.calls||{};
      h+=`<div class="stats"><div class="stat-card"><div class="label">RDV aujourd'hui</div><div class="val">${sum.today?.count||0}</div></div><div class="stat-card"><div class="label">CA ce mois</div><div class="val">${m.revenue_formatted||'0 ‚Ç¨'}</div><div class="sub">${m.total_bookings||0} RDV</div></div><div class="stat-card"><div class="label">Clients</div><div class="val">${cl.total||0}</div></div><div class="stat-card"><div class="label">Appels ‚Üí RDV</div><div class="val">${ca.conversion_rate||0}%</div></div></div>`;
      h+=`<div class="card"><div class="card-h"><h3>RDV du jour</h3><span class="badge badge-teal">${sum.today?.count||0}</span></div>`;
      if(sum.today?.bookings?.length>0){sum.today.bookings.forEach(b=>{const t=new Date(b.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});h+=`<div class="bk-row"><span style="font-size:.85rem;font-weight:700;color:var(--primary);min-width:50px">${t}</span><div style="flex:1"><div style="font-size:.85rem;font-weight:600">${b.client_name}</div><div style="font-size:.72rem;color:var(--text-4)">${b.service_name} ¬∑ ${b.duration_min}min</div></div><span class="bk-status ${b.status}">${b.status==='confirmed'?'Confirm√©':b.status}</span></div>`});}
      else h+=`<div class="empty">Aucun RDV aujourd'hui</div>`;
      h+=`</div>`;
    }else{h+=`<div class="stats"><div class="stat-card"><div class="label">RDV</div><div class="val">0</div></div><div class="stat-card"><div class="label">CA</div><div class="val">0 ‚Ç¨</div></div><div class="stat-card"><div class="label">Clients</div><div class="val">0</div></div><div class="stat-card"><div class="label">Appels</div><div class="val">‚Äî</div></div></div><div class="card"><div class="card-h"><h3>RDV du jour</h3></div><div class="empty">Aucun RDV</div></div>`;}
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}<br><button onclick="loadDashboard()" style="margin-top:8px;padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--white);cursor:pointer">R√©essayer</button></div>`;}
}

// NAV
document.querySelectorAll('.ni').forEach(i=>{i.addEventListener('click',e=>{e.preventDefault();document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));i.classList.add('active');const s=i.dataset.section;document.getElementById('pageTitle').textContent={home:'Dashboard',bookings:'Agenda',clients:'Clients',services:'Prestations',hours:'Disponibilit√©s',team:'√âquipe',site:'Mon site',calls:'Appels',invoices:'Facturation',documents:'Documents pr√©-RDV',settings:'Param√®tres',analytics:'Statistiques'}[s]||'Dashboard';if(s==='home')loadDashboard();else if(s==='bookings'){agendaView='week';agendaDate=new Date();loadAgenda();}else if(s==='site')loadSiteSection();else if(s==='clients')loadClients();else if(s==='services')loadServices();else if(s==='hours')loadHours();else if(s==='analytics')loadAnalytics();else if(s==='settings')loadSettings();else if(s==='team')loadTeam();else if(s==='invoices')loadInvoices();else if(s==='documents')loadDocuments();else if(s==='calls')loadCalls();else document.getElementById('contentArea').innerHTML=`<div class="empty">Section "${s}" ‚Äî Bient√¥t disponible</div>`;});});

// AGENDA
const DF=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
const DS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const MF=['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
const MS=['jan','f√©v','mar','avr','mai','jun','jul','ao√ª','sep','oct','nov','d√©c'];
const MODE_ICO={cabinet:'üè¢',visio:'üíª',phone:'üìû'};
const ST={confirmed:{l:'Confirm√©',c:'confirmed'},pending:{l:'En attente',c:'pending'},completed:{l:'Termin√©',c:'completed'},no_show:{l:'No-show',c:'noshow'},cancelled:{l:'Annul√©',c:'cancelled'}};
let agendaView='week',agendaDate=new Date(),agendaBookings=[],undoTimer=null;

function getMonday(d){const dt=new Date(d);const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);dt.setHours(0,0,0,0);return dt;}
function fmt(d){return d.toISOString().split('T')[0];}
function isToday(d){return fmt(d)===fmt(new Date());}
function fmtDay(d){return isToday(d)?"Aujourd'hui":`${DF[d.getDay()]} ${d.getDate()} ${MF[d.getMonth()]}`;}

async function loadAgenda(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  let from,to;
  if(agendaView==='day'){from=new Date(agendaDate);from.setHours(0,0,0,0);to=new Date(from);to.setDate(to.getDate()+1);}
  else if(agendaView==='week'){from=getMonday(agendaDate);to=new Date(from);to.setDate(to.getDate()+7);}
  else{from=new Date(agendaDate.getFullYear(),agendaDate.getMonth(),1);to=new Date(agendaDate.getFullYear(),agendaDate.getMonth()+1,1);}
  try{const r=await fetch(`/api/bookings?from=${from.toISOString()}&to=${to.toISOString()}`,{headers:{'Authorization':'Bearer '+api.getToken()}});const d=await r.json();agendaBookings=d.bookings||[];}catch(e){agendaBookings=[];}
  renderAgenda();
}

function renderAgenda(){
  const c=document.getElementById('contentArea');
  let label='';
  if(agendaView==='day')label=fmtDay(agendaDate);
  else if(agendaView==='week'){const m=getMonday(agendaDate),s=new Date(m);s.setDate(s.getDate()+6);label=`${m.getDate()} ${MS[m.getMonth()]} ‚Äì ${s.getDate()} ${MS[s.getMonth()]} ${s.getFullYear()}`;}
  else label=`${MF[agendaDate.getMonth()].charAt(0).toUpperCase()+MF[agendaDate.getMonth()].slice(1)} ${agendaDate.getFullYear()}`;

  let h=`<div class="agenda-toolbar"><div class="agenda-nav"><button class="a-btn" onclick="shiftAgenda(-1)">‚Äπ</button><button class="a-btn-text" onclick="agendaDate=new Date();loadAgenda()">Aujourd'hui</button><button class="a-btn" onclick="shiftAgenda(1)">‚Ä∫</button><span class="agenda-label">${label}</span></div><div class="view-tabs"><button class="view-tab ${agendaView==='day'?'active':''}" onclick="agendaView='day';loadAgenda()">Jour</button><button class="view-tab ${agendaView==='week'?'active':''}" onclick="agendaView='week';loadAgenda()">Semaine</button><button class="view-tab ${agendaView==='month'?'active':''}" onclick="agendaView='month';loadAgenda()">Mois</button></div></div>`;
  if(agendaView==='day')h+=renderDayView();
  else if(agendaView==='week')h+=renderWeekView();
  else h+=renderMonthView();
  c.innerHTML=h;
}

function renderDayView(){
  const ds=fmt(agendaDate),bks=agendaBookings.filter(b=>fmt(new Date(b.start_at))===ds);
  if(!bks.length)return`<div class="card"><div class="empty">Aucun rendez-vous ${fmtDay(agendaDate).toLowerCase()}</div></div>`;
  let h=`<div class="card"><div class="card-h"><h3>${fmtDay(agendaDate)}</h3><span class="badge badge-teal">${bks.length} RDV</span></div><div style="padding:10px 14px">`;
  bks.forEach(b=>{h+=renderBkCard(b);});
  return h+`</div></div>`;
}

function renderBkCard(b){
  const s=new Date(b.start_at),e=new Date(b.end_at);
  const t1=s.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'}),t2=e.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
  const st=ST[b.status]||{l:b.status,c:''};
  const ico=MODE_ICO[b.appointment_mode]||'';
  const acts=b.status==='confirmed'||b.status==='pending'?
    `<button class="act-btn act-done" onclick="updateStatus('${b.id}','completed','${b.status}')">‚úì Termin√©</button><button class="act-btn act-noshow" onclick="updateStatus('${b.id}','no_show','${b.status}')">‚úó No-show</button><button class="act-btn act-cancel" onclick="updateStatus('${b.id}','cancelled','${b.status}')">Annuler</button>`:
    `<button class="act-btn act-undo" onclick="updateStatus('${b.id}','confirmed','${b.status}')">‚Ü© Remettre confirm√©</button>${b.status==='completed'?`<button class="act-btn" onclick="createInvoiceFromBooking('${b.id}')" style="background:var(--gold-bg);color:var(--gold)">üßæ Facturer</button>`:''}`;
  return`<div class="bk-card"><div style="display:flex;align-items:center;gap:12px"><div style="min-width:85px"><div class="time">${t1}</div><div style="font-size:.68rem;color:var(--text-4)">${t1} ‚Äì ${t2}</div></div><div style="width:4px;height:34px;border-radius:2px;background:${b.service_color||'var(--primary)'};flex-shrink:0"></div><div style="flex:1"><div class="client">${b.client_name}</div><div class="meta">${b.service_name} ¬∑ ${b.duration_min}min ¬∑ ${ico} ${b.appointment_mode||''} ¬∑ ${b.practitioner_name}</div><div class="meta">${b.client_phone||''} ¬∑ ${b.client_email||''}</div></div><span class="bk-status ${st.c}">${st.l}</span></div><div class="actions">${acts}</div></div>`;
}

function renderWeekView(){
  const mon=getMonday(agendaDate);let h=`<div class="week-grid">`;
  for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(mon.getDate()+i);const ds=fmt(d);
    const bks=agendaBookings.filter(b=>fmt(new Date(b.start_at))===ds).sort((a,b)=>new Date(a.start_at)-new Date(b.start_at));
    const td=isToday(d)?' today':'';
    h+=`<div class="week-col"><div class="week-header${td}" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()"><div style="font-size:.65rem">${DS[d.getDay()]}</div><span class="num">${d.getDate()}</span><div style="font-size:.55rem">${MS[d.getMonth()]}</div></div>`;
    bks.forEach(b=>{const t=new Date(b.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
      h+=`<div class="week-bk st-${b.status}" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()" title="${b.client_name} ‚Äì ${b.service_name}"><div class="t">${t}</div><div class="n">${b.client_name}</div></div>`;});
    if(!bks.length)h+=`<div style="padding:6px;text-align:center;font-size:.65rem;color:var(--text-4)">‚Äî</div>`;
    h+=`</div>`;}
  return h+`</div>`;
}

function renderMonthView(){
  const y=agendaDate.getFullYear(),m=agendaDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  let so=first.getDay();if(so===0)so=7;so-=1;
  let h=`<div class="month-grid">`;
  ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].forEach(d=>{h+=`<div class="month-header">${d}</div>`;});
  const sd=new Date(first);sd.setDate(sd.getDate()-so);
  const tc=Math.ceil((so+last.getDate())/7)*7;
  for(let i=0;i<tc;i++){const d=new Date(sd);d.setDate(sd.getDate()+i);const ds=fmt(d);
    const ot=d.getMonth()!==m,td=isToday(d)?' today':'';
    const bks=agendaBookings.filter(b=>fmt(new Date(b.start_at))===ds);
    h+=`<div class="month-cell${ot?' other':''}${td}"><div class="day-num" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()">${d.getDate()}</div>`;
    bks.slice(0,3).forEach(b=>{const t=new Date(b.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
      h+=`<div class="month-dot" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()"><span class="d" style="background:${b.service_color||'var(--primary)'}"></span>${t} ${b.client_name?.split(' ')[0]||''}</div>`;});
    if(bks.length>3)h+=`<div class="month-more" onclick="agendaDate=new Date('${ds}');agendaView='day';loadAgenda()">+${bks.length-3} de plus</div>`;
    h+=`</div>`;}
  return h+`</div>`;
}

function shiftAgenda(dir){
  if(agendaView==='day')agendaDate.setDate(agendaDate.getDate()+dir);
  else if(agendaView==='week')agendaDate.setDate(agendaDate.getDate()+dir*7);
  else agendaDate.setMonth(agendaDate.getMonth()+dir);
  loadAgenda();
}

async function updateStatus(id,ns,os){
  try{const r=await fetch(`/api/bookings/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({status:ns})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    showUndo(id,ns,os);loadAgenda();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function showUndo(id,ns,os){
  document.querySelectorAll('.undo-toast').forEach(t=>t.remove());
  if(undoTimer)clearTimeout(undoTimer);
  const labels={completed:'marqu√© termin√©',no_show:'marqu√© no-show',cancelled:'annul√©',confirmed:'remis confirm√©'};
  const t=document.createElement('div');t.className='undo-toast';
  t.innerHTML=`<span>RDV ${labels[ns]||ns}</span><button onclick="undoStatus('${id}','${os}')">‚Ü© Annuler</button><button class="dismiss" onclick="this.parentElement.remove()">‚úï</button>`;
  document.body.appendChild(t);
  undoTimer=setTimeout(()=>{t.remove();},8000);
}

async function undoStatus(id,rs){
  document.querySelectorAll('.undo-toast').forEach(t=>t.remove());
  if(undoTimer)clearTimeout(undoTimer);
  try{await fetch(`/api/bookings/${id}/status`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({status:rs})});
    BooktUI.toast('Statut restaur√©','success');loadAgenda();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// ANALYTICS
// ============================================================
let analyticsPeriod='30d';

async function loadAnalytics(period){
  if(period)analyticsPeriod=period;
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const r=await fetch(`/api/dashboard/analytics?period=${analyticsPeriod}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    renderAnalytics(d);
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function renderAnalytics(d){
  const c=document.getElementById('contentArea');
  const t=d.totals;
  let h=`<div class="an-period">
    <button class="${analyticsPeriod==='7d'?'active':''}" onclick="loadAnalytics('7d')">7 jours</button>
    <button class="${analyticsPeriod==='30d'?'active':''}" onclick="loadAnalytics('30d')">30 jours</button>
    <button class="${analyticsPeriod==='90d'?'active':''}" onclick="loadAnalytics('90d')">90 jours</button>
  </div>`;

  // KPIs
  h+=`<div class="an-kpi">
    <div class="kpi"><div class="kv">${t.bookings}</div><div class="kl">RDV confirm√©s</div></div>
    <div class="kpi"><div class="kv">${(t.revenue/100).toFixed(0)} ‚Ç¨</div><div class="kl">Chiffre d'affaires</div></div>
    <div class="kpi"><div class="kv">${(t.avg_booking_value/100).toFixed(0)} ‚Ç¨</div><div class="kl">Panier moyen</div></div>
    <div class="kpi"><div class="kv">${t.no_show_rate}%</div><div class="kl">Taux no-show</div></div>
    <div class="kpi"><div class="kv">${d.new_clients}</div><div class="kl">Nouveaux clients</div></div>
  </div>`;

  // Charts row 1: Revenue + Bookings trend
  h+=`<div class="chart-card"><h4>√âvolution du chiffre d'affaires</h4><canvas id="chartRevenue" height="200"></canvas></div>`;
  h+=`<div class="chart-card"><h4>Rendez-vous par jour</h4><canvas id="chartBookings" height="160"></canvas></div>`;

  // Charts row 2: Top services + Status breakdown
  h+=`<div class="chart-row">`;

  // Top services
  h+=`<div class="chart-card"><h4>Top prestations</h4>`;
  if(d.top_services.length===0){h+=`<div class="empty" style="padding:20px">Pas encore de donn√©es</div>`;}
  else{
    const maxCount=Math.max(...d.top_services.map(s=>s.count),1);
    h+=`<div class="top-svc-list">`;
    d.top_services.forEach(s=>{
      const pct=Math.round(s.count/maxCount*100);
      h+=`<div class="top-svc-row"><span class="sname">${s.name}</span><div class="bar-wrap"><div class="bar" style="width:${pct}%;background:${s.color||'var(--primary)'}">${s.count}</div></div><span class="scount">${(s.revenue/100).toFixed(0)}‚Ç¨</span></div>`;
    });
    h+=`</div>`;
  }
  h+=`</div>`;

  // Status breakdown
  h+=`<div class="chart-card"><h4>R√©partition des statuts</h4><canvas id="chartStatus" height="200"></canvas>`;
  const stColors={confirmed:'#0D7377',completed:'#6B6560',pending:'#A68B3C',no_show:'#DC8C00',cancelled:'#DC2626'};
  const stLabels={confirmed:'Confirm√©',completed:'Termin√©',pending:'En attente',no_show:'No-show',cancelled:'Annul√©'};
  h+=`<div class="status-legend">`;
  d.status_breakdown.forEach(s=>{h+=`<span class="sl"><span class="dot" style="background:${stColors[s.status]||'#999'}"></span>${stLabels[s.status]||s.status}: ${s.count}</span>`;});
  h+=`</div></div>`;

  h+=`</div>`; // end chart-row

  // Peak hours heatmap
  h+=`<div class="chart-card"><h4>Heures de pointe</h4><div class="heatmap" id="heatmap"></div></div>`;

  // Monthly revenue
  if(d.monthly.length>1){
    h+=`<div class="chart-card"><h4>Revenus mensuels</h4><canvas id="chartMonthly" height="180"></canvas></div>`;
  }

  c.innerHTML=h;

  // Draw charts after DOM is ready
  setTimeout(()=>{
    drawLineChart('chartRevenue',d.daily.map(r=>r.day?.slice(5)||''),d.daily.map(r=>r.revenue/100),'‚Ç¨','#0D7377');
    drawBarChart('chartBookings',d.daily.map(r=>r.day?.slice(5)||''),d.daily.map(r=>r.bookings),'#0D7377');
    drawDonutChart('chartStatus',d.status_breakdown.map(s=>s.count),d.status_breakdown.map(s=>stColors[s.status]||'#999'));
    drawHeatmap('heatmap',d.peak_hours);
    if(d.monthly.length>1){
      const mLabels=d.monthly.map(m=>{const[y,mo]=m.month.split('-');return['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'][parseInt(mo)-1];});
      drawBarChart('chartMonthly',mLabels,d.monthly.map(m=>m.revenue/100),'#0D7377',true);
    }
  },50);
}

// ===== CHART HELPERS (Canvas) =====
function drawLineChart(id,labels,data,suffix,color){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const w=canvas.parentElement.clientWidth-36;
  canvas.width=w*dpr;canvas.height=200*dpr;canvas.style.width=w+'px';canvas.style.height='200px';
  ctx.scale(dpr,dpr);
  const pad={t:20,r:20,b:30,l:50};
  const cw=w-pad.l-pad.r,ch=200-pad.t-pad.b;
  const max=Math.max(...data,1)*1.15;
  const step=cw/(data.length-1||1);

  // Grid
  ctx.strokeStyle='#ECEAE6';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+ch-ch*(i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(w-pad.r,y);ctx.stroke();
    ctx.fillStyle='#9C958E';ctx.font='10px sans-serif';ctx.textAlign='right';
    ctx.fillText(Math.round(max*i/4)+(suffix||''),pad.l-6,y+3);
  }

  // Line
  ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.beginPath();
  data.forEach((v,i)=>{
    const x=pad.l+i*step,y=pad.t+ch-ch*(v/max);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Fill
  ctx.lineTo(pad.l+(data.length-1)*step,pad.t+ch);ctx.lineTo(pad.l,pad.t+ch);ctx.closePath();
  ctx.fillStyle=color+'18';ctx.fill();

  // Dots
  data.forEach((v,i)=>{
    const x=pad.l+i*step,y=pad.t+ch-ch*(v/max);
    ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
  });

  // X labels (show subset)
  ctx.fillStyle='#9C958E';ctx.font='9px sans-serif';ctx.textAlign='center';
  const labelStep=Math.max(1,Math.floor(labels.length/8));
  labels.forEach((l,i)=>{if(i%labelStep===0)ctx.fillText(l,pad.l+i*step,200-6);});
}

function drawBarChart(id,labels,data,color,showValues){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const w=canvas.parentElement.clientWidth-36;
  const h=parseInt(canvas.getAttribute('height'))||160;
  canvas.width=w*dpr;canvas.height=h*dpr;canvas.style.width=w+'px';canvas.style.height=h+'px';
  ctx.scale(dpr,dpr);
  const pad={t:20,r:20,b:30,l:50};
  const cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
  const max=Math.max(...data,1)*1.15;
  const barW=Math.min(cw/data.length*0.7,40);
  const gap=cw/data.length;

  // Grid
  ctx.strokeStyle='#ECEAE6';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+ch-ch*(i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(w-pad.r,y);ctx.stroke();
    ctx.fillStyle='#9C958E';ctx.font='10px sans-serif';ctx.textAlign='right';
    ctx.fillText(Math.round(max*i/4),pad.l-6,y+3);
  }

  // Bars
  data.forEach((v,i)=>{
    const x=pad.l+i*gap+(gap-barW)/2;
    const bh=ch*(v/max);
    const y=pad.t+ch-bh;
    ctx.fillStyle=color;
    ctx.beginPath();
    // Rounded top corners
    const r=Math.min(3,barW/2);
    ctx.moveTo(x,pad.t+ch);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
    ctx.lineTo(x+barW-r,y);ctx.quadraticCurveTo(x+barW,y,x+barW,y+r);
    ctx.lineTo(x+barW,pad.t+ch);ctx.fill();

    if(showValues&&v>0){ctx.fillStyle='#FFF';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.fillText(Math.round(v),x+barW/2,y+14);}
  });

  // X labels
  ctx.fillStyle='#9C958E';ctx.font='9px sans-serif';ctx.textAlign='center';
  const labelStep=Math.max(1,Math.floor(labels.length/10));
  labels.forEach((l,i)=>{if(i%labelStep===0)ctx.fillText(l,pad.l+i*gap+gap/2,h-6);});
}

function drawDonutChart(id,data,colors){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const size=200;
  canvas.width=size*dpr;canvas.height=size*dpr;canvas.style.width=size+'px';canvas.style.height=size+'px';
  ctx.scale(dpr,dpr);
  const cx=size/2,cy=size/2,r=70,inner=42;
  const total=data.reduce((a,b)=>a+b,0)||1;
  let angle=-Math.PI/2;
  data.forEach((v,i)=>{
    const sweep=v/total*Math.PI*2;
    ctx.beginPath();ctx.arc(cx,cy,r,angle,angle+sweep);ctx.arc(cx,cy,inner,angle+sweep,angle,true);ctx.closePath();
    ctx.fillStyle=colors[i]||'#999';ctx.fill();
    angle+=sweep;
  });
  // Center text
  ctx.fillStyle='#1A1816';ctx.font='bold 20px sans-serif';ctx.textAlign='center';ctx.fillText(total,cx,cy+3);
  ctx.fillStyle='#9C958E';ctx.font='10px sans-serif';ctx.fillText('Total',cx,cy+16);
}

function drawHeatmap(id,data){
  const el=document.getElementById(id);if(!el)return;
  const DAYS=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  // Map to weekday 1-7 (Mon=1, Sun=0‚Üí7)
  const grid={};let maxV=1;
  data.forEach(d=>{
    const wd=d.weekday===0?7:d.weekday; // Sun=7
    const key=`${wd}-${d.hour}`;
    grid[key]=(grid[key]||0)+d.count;
    if(grid[key]>maxV)maxV=grid[key];
  });

  let h='<div class="hl"></div>';
  // Show hours 7-20 only
  for(let hr=7;hr<=20;hr++){h+=`<div class="hh">${hr}</div>`;}
  for(let d=1;d<=7;d++){
    h+=`<div class="hl">${DAYS[d-1]}</div>`;
    for(let hr=7;hr<=20;hr++){
      const v=grid[`${d}-${hr}`]||0;
      const intensity=v/maxV;
      const bg=v===0?'var(--surface)':`rgba(13,115,119,${0.15+intensity*0.85})`;
      h+=`<div class="hc" style="background:${bg}" title="${DAYS[d-1]} ${hr}h: ${v} RDV">${v||''}</div>`;
    }
  }
  el.style.gridTemplateColumns=`40px repeat(14,1fr)`;
  el.innerHTML=h;
}

// ============================================================
// CLIENTS
// ============================================================
let clientSearch='';
let clientFilter='';
async function loadClients(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const params=new URLSearchParams();
    if(clientSearch)params.set('search',clientSearch);
    if(clientFilter)params.set('filter',clientFilter);
    const q=params.toString()?'?'+params.toString():'';
    const r=await fetch(`/api/clients${q}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const clients=d.clients||[];
    const stats=d.stats||{};
    let h=`<div class="kpis"><div class="kpi" onclick="clientFilter='';loadClients()" style="cursor:pointer"><div class="kpi-val">${stats.total||0}</div><div class="kpi-label">Total clients</div></div><div class="kpi" onclick="clientFilter='blocked';loadClients()" style="cursor:pointer"><div class="kpi-val" style="color:var(--red)">${stats.blocked||0}</div><div class="kpi-label">üö´ Bloqu√©s</div></div><div class="kpi" onclick="clientFilter='flagged';loadClients()" style="cursor:pointer"><div class="kpi-val" style="color:#B45309">${stats.flagged||0}</div><div class="kpi-label">‚ö†Ô∏è No-shows</div></div><div class="kpi"><div class="kpi-val" style="color:var(--primary)">${stats.clean||0}</div><div class="kpi-label">‚úÖ OK</div></div></div>`;
    h+=`<div class="search-bar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><input type="text" placeholder="Rechercher un client..." value="${clientSearch}" id="clientSearchInput" onkeydown="if(event.key==='Enter'){clientSearch=this.value;clientFilter='';loadClients()}" style="flex:1;min-width:200px"><button class="btn-primary" onclick="clientSearch=document.getElementById('clientSearchInput').value;clientFilter='';loadClients()">Rechercher</button>${clientSearch||clientFilter?`<button class="btn-outline" onclick="clientSearch='';clientFilter='';loadClients()">‚úï Reset</button>`:''}</div>`;
    h+=`<div style="display:flex;gap:6px;margin-bottom:12px"><button class="btn-sm ${!clientFilter?'active':''}" onclick="clientFilter='';loadClients()">Tous</button><button class="btn-sm ${clientFilter==='blocked'?'active':''}" onclick="clientFilter='blocked';loadClients()">üö´ Bloqu√©s</button><button class="btn-sm ${clientFilter==='flagged'?'active':''}" onclick="clientFilter='flagged';loadClients()">‚ö†Ô∏è No-shows</button></div>`;
    h+=`<div class="card"><div class="card-h"><h3>${clientFilter==='blocked'?'Clients bloqu√©s':clientFilter==='flagged'?'Clients avec no-shows':'Tous les clients'}</h3><span class="badge badge-teal">${d.total||clients.length}</span></div>`;
    if(clients.length===0){h+=`<div class="empty">Aucun client${clientSearch?' trouv√©':clientFilter?' dans cette cat√©gorie':' encore'}</div>`;}
    else{
      h+=`<div style="overflow-x:auto"><table class="table"><thead><tr><th>Nom</th><th>T√©l√©phone</th><th>Email</th><th>RDV</th><th>No-shows</th><th>Derni√®re visite</th><th>Statut</th></tr></thead><tbody>`;
      clients.forEach(cl=>{
        const last=cl.last_visit?new Date(cl.last_visit).toLocaleDateString('fr-BE',{day:'numeric',month:'short',year:'numeric'}):'‚Äî';
        const tagColors={'bloqu√©':'#dc2626','r√©cidiviste':'#B45309','√† surveiller':'#ca8a04','fid√®le':'#15803d','actif':'#0D7377','nouveau':'#888'};
        const tagColor=tagColors[cl.tag]||'#888';
        const nsDisplay=cl.no_show_count>0?`<span style="color:#B45309;font-weight:600">${cl.no_show_count}</span>`:'0';
        h+=`<tr${cl.is_blocked?' style="opacity:.6"':''}><td class="client-name" onclick="openClientDetail('${cl.id}')">${cl.full_name}${cl.is_blocked?' üö´':''}</td><td>${cl.phone||'‚Äî'}</td><td style="font-size:.78rem">${cl.email||'‚Äî'}</td><td>${cl.total_bookings}</td><td>${nsDisplay}</td><td style="font-size:.78rem">${last}</td><td><span style="font-size:.72rem;font-weight:600;color:${tagColor};background:${tagColor}15;padding:2px 8px;border-radius:10px">${cl.tag}</span></td></tr>`;
      });
      h+=`</tbody></table></div>`;
    }
    h+=`</div>`;
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function openClientDetail(id){
  try{
    const r=await fetch(`/api/clients/${id}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const cl=d.client, bks=d.bookings||[];
    let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${cl.full_name}${cl.is_blocked?' üö´':''}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">`;
    if(cl.is_blocked){
      m+=`<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;margin-bottom:12px;font-size:.82rem"><strong style="color:#dc2626">üö´ Client bloqu√©</strong><br><span style="color:#666">${cl.blocked_reason||'Bloqu√© manuellement'}</span><br><button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#15803d;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="unblockClient('${cl.id}')">D√©bloquer</button> <button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#666;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="resetNoShow('${cl.id}')">Reset no-shows</button></div>`;
    }else if(cl.no_show_count>0){
      m+=`<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:12px;margin-bottom:12px;font-size:.82rem"><strong style="color:#B45309">‚ö†Ô∏è ${cl.no_show_count} no-show${cl.no_show_count>1?'s':''}</strong>${cl.last_no_show_at?` <span style="color:#888">¬∑ dernier le ${new Date(cl.last_no_show_at).toLocaleDateString('fr-BE')}</span>`:''}<br><button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#dc2626;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="blockClient('${cl.id}')">Bloquer</button> <button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#666;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="resetNoShow('${cl.id}')">Reset</button></div>`;
    }
    m+=`<div class="field-row"><div class="field"><label>Nom</label><input id="cl_name" value="${cl.full_name||''}"></div><div class="field"><label>T√©l√©phone</label><input id="cl_phone" value="${cl.phone||''}"></div></div>`;
    m+=`<div class="field-row"><div class="field"><label>Email</label><input id="cl_email" value="${cl.email||''}"></div><div class="field"><label>N¬∞ BCE</label><input id="cl_bce" value="${cl.bce_number||''}"></div></div>`;
    m+=`<div class="field"><label>Notes</label><textarea id="cl_notes">${cl.notes||''}</textarea></div>`;
    if(bks.length>0){
      m+=`<div style="margin-top:12px"><label style="font-size:.78rem;font-weight:600;color:var(--text-3)">Historique (${bks.length} RDV)</label>`;
      const stColors={completed:'var(--text-4)',cancelled:'var(--red)',no_show:'#B45309',confirmed:'var(--primary)'};
      const stLabels={completed:'Termin√©',cancelled:'Annul√©',no_show:'No-show',confirmed:'Confirm√©',pending:'En attente'};
      bks.slice(0,15).forEach(b=>{
        const dt=new Date(b.start_at);
        m+=`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border-light);font-size:.8rem"><span>${dt.toLocaleDateString('fr-BE',{day:'numeric',month:'short'})} ‚Äî ${b.service_name}</span><span style="color:${stColors[b.status]||'inherit'};font-weight:${b.status==='no_show'?'600':'400'}">${stLabels[b.status]||b.status}</span></div>`;
      });
      m+=`</div>`;
    }
    if(!cl.is_blocked&&cl.no_show_count===0){
      m+=`<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-light)"><button style="font-size:.75rem;padding:4px 10px;background:transparent;color:#dc2626;border:1px solid #fecaca;border-radius:6px;cursor:pointer" onclick="blockClient('${cl.id}')">üö´ Bloquer ce client</button></div>`;
    }
    m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Fermer</button><button class="btn-primary" onclick="saveClient('${id}')">Enregistrer</button></div></div></div>`;
    document.body.insertAdjacentHTML('beforeend',m);
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function saveClient(id){
  try{
    const r=await fetch(`/api/clients/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({full_name:document.getElementById('cl_name').value,phone:document.getElementById('cl_phone').value,email:document.getElementById('cl_email').value,bce_number:document.getElementById('cl_bce').value,notes:document.getElementById('cl_notes').value})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast('Client mis √† jour','success');loadClients();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function blockClient(id){
  const reason=prompt('Raison du blocage (optionnel):');
  if(reason===null)return;
  try{
    const r=await fetch(`/api/clients/${id}/block`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({reason:reason||'Bloqu√© manuellement'})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast('Client bloqu√©','success');loadClients();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function unblockClient(id){
  if(!confirm('D√©bloquer ce client ? Il pourra √† nouveau r√©server en ligne.'))return;
  try{
    const r=await fetch(`/api/clients/${id}/unblock`,{method:'POST',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast('Client d√©bloqu√©','success');loadClients();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function resetNoShow(id){
  if(!confirm('Remettre le compteur no-show √† z√©ro et d√©bloquer ?'))return;
  try{
    const r=await fetch(`/api/clients/${id}/reset-noshow`,{method:'POST',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast('Compteur remis √† z√©ro','success');loadClients();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}
// SERVICES (PRESTATIONS)
// ============================================================
let allPractitioners=[];
async function loadServices(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[sr,pr]=await Promise.all([
      fetch('/api/services',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/dashboard',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const sd=await sr.json(), pd=await pr.json();
    const svcs=sd.services||[];
    allPractitioners=pd.practitioners||[];
    let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-size:.95rem;font-weight:700">${svcs.length} prestation${svcs.length>1?'s':''}</h3><button class="btn-primary" onclick="openServiceModal()">+ Nouvelle prestation</button></div>`;
    if(svcs.length===0){h+=`<div class="card"><div class="empty">Aucune prestation. Cr√©ez votre premi√®re !</div></div>`;}
    else{
      h+=`<div class="svc-grid">`;
      svcs.forEach(s=>{
        const price=s.price_cents?`${(s.price_cents/100).toFixed(0)} ‚Ç¨`:(s.price_label||'Gratuit');
        const modes=(s.mode_options||['cabinet']).map(m=>`<span class="mode-tag">${{cabinet:'üè¢ Cabinet',visio:'üíª Visio',phone:'üìû T√©l'}[m]||m}</span>`).join('');
        const pIds=s.practitioner_ids||[];
        const pNames=pIds.length>0?pIds.map(pid=>{const p=allPractitioners.find(x=>x.id===pid);return p?p.display_name:'?';}).join(', '):'Tous les membres';
        h+=`<div class="svc-card${s.is_active===false?' inactive':''}" style="border-left-color:${s.color||'var(--primary)'}">
          <h4>${s.name}</h4>
          <div class="svc-meta">${s.duration_min}min ¬∑ Buffer: ${s.buffer_before_min||0}+${s.buffer_after_min||0}min${s.category?' ¬∑ '+s.category:''}</div>
          <div class="svc-price">${price}</div>
          <div class="svc-modes">${modes}</div>
          <div style="font-size:.72rem;color:var(--text-4);margin-top:4px">üë§ ${pNames}</div>
          <div class="svc-actions">
            <button class="btn-outline btn-sm" onclick="openServiceModal('${s.id}')">‚úèÔ∏è Modifier</button>
            ${s.is_active!==false?`<button class="btn-outline btn-sm btn-danger" onclick="if(confirm('D√©sactiver cette prestation ?'))deleteService('${s.id}')">D√©sactiver</button>`:`<span style="font-size:.72rem;color:var(--text-4);padding:5px">Inactive</span>`}
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function openServiceModal(editId){
  if(editId){
    fetch(`/api/services`,{headers:{'Authorization':'Bearer '+api.getToken()}}).then(r=>r.json()).then(d=>{
      renderServiceModal(d.services.find(s=>s.id===editId));
    });
  }else{renderServiceModal(null);}
}

function renderServiceModal(svc){
  const isEdit=!!svc;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${isEdit?'Modifier la prestation':'Nouvelle prestation'}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">`;
  m+=`<div class="field"><label>Nom *</label><input id="svc_name" value="${svc?.name||''}" placeholder="Ex: Consultation initiale"></div>`;
  m+=`<div class="field-row"><div class="field"><label>Dur√©e (min) *</label><input type="number" id="svc_dur" value="${svc?.duration_min||30}" min="5" step="5"></div><div class="field"><label>Prix (‚Ç¨)</label><input type="number" id="svc_price" value="${svc?.price_cents?(svc.price_cents/100):''}" step="0.01" placeholder="Gratuit si vide"></div></div>`;
  m+=`<div class="field-row"><div class="field"><label>Buffer avant (min)</label><input type="number" id="svc_bbefore" value="${svc?.buffer_before_min||0}" min="0"></div><div class="field"><label>Buffer apr√®s (min)</label><input type="number" id="svc_bafter" value="${svc?.buffer_after_min||0}" min="0"></div></div>`;
  m+=`<div class="field"><label>Cat√©gorie</label><input id="svc_cat" value="${svc?.category||''}" placeholder="Ex: Consultation, Soin..."></div>`;
  m+=`<div class="field"><label>Couleur</label><input type="color" id="svc_color" value="${svc?.color||'#0D7377'}" style="width:50px;height:36px;border:1.5px solid var(--border);border-radius:6px;cursor:pointer"></div>`;
  const modes=svc?.mode_options||['cabinet'];
  m+=`<div class="field"><label>Modes de consultation</label><div style="display:flex;gap:8px;margin-top:4px">
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_cab" ${modes.includes('cabinet')?'checked':''}> üè¢ Cabinet</label>
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_vis" ${modes.includes('visio')?'checked':''}> üíª Visio</label>
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_tel" ${modes.includes('phone')?'checked':''}> üìû T√©l</label>
  </div></div>`;
  m+=`<div class="field"><label>Label prix (si pas de montant)</label><input id="svc_plabel" value="${svc?.price_label||''}" placeholder="Ex: Sur devis, Gratuit..."></div>`;
  // Practitioner assignment
  const assignedIds=svc?.practitioner_ids||[];
  if(allPractitioners.length>0){
    m+=`<div class="field"><label>Assign√© √†</label><div id="svc_practitioners" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">`;
    allPractitioners.forEach(p=>{
      const checked=assignedIds.includes(p.id)?'checked':'';
      m+=`<label style="font-size:.82rem;display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--bg-card);border:1.5px solid var(--border);border-radius:8px;cursor:pointer"><input type="checkbox" class="svc_pract_cb" value="${p.id}" ${checked}> ${p.display_name}</label>`;
    });
    m+=`</div><div style="font-size:.72rem;color:var(--text-4);margin-top:4px">Si aucun coch√©, la prestation sera disponible pour tous</div></div>`;
  }
  m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveService(${isEdit?"'"+svc.id+"'":'null'})">${isEdit?'Enregistrer':'Cr√©er'}</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveService(id){
  const modes=[];
  if(document.getElementById('svc_m_cab').checked)modes.push('cabinet');
  if(document.getElementById('svc_m_vis').checked)modes.push('visio');
  if(document.getElementById('svc_m_tel').checked)modes.push('phone');
  const priceVal=document.getElementById('svc_price').value;
  const body={name:document.getElementById('svc_name').value,duration_min:parseInt(document.getElementById('svc_dur').value),price_cents:priceVal?Math.round(parseFloat(priceVal)*100):null,price_label:document.getElementById('svc_plabel').value||null,buffer_before_min:parseInt(document.getElementById('svc_bbefore').value)||0,buffer_after_min:parseInt(document.getElementById('svc_bafter').value)||0,category:document.getElementById('svc_cat').value||null,color:document.getElementById('svc_color').value,mode_options:modes.length?modes:['cabinet'],practitioner_ids:[...document.querySelectorAll('.svc_pract_cb:checked')].map(cb=>cb.value)};
  try{
    const url=id?`/api/services/${id}`:'/api/services';
    const method=id?'PATCH':'POST';
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast(id?'Prestation modifi√©e':'Prestation cr√©√©e','success');loadServices();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function deleteService(id){
  try{
    const r=await fetch(`/api/services/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    BooktUI.toast('Prestation d√©sactiv√©e','success');loadServices();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// DISPONIBILIT√âS (HOURS)
// ============================================================
const DAYS_WEEK=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
let scheduleData={};

async function loadHours(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[ar,pr,er]=await Promise.all([
      fetch('/api/availabilities',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/dashboard',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/availabilities/exceptions',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const ad=await ar.json(),pd=await pr.json(),ed=await er.json();
    const avails=ad.availabilities||{};
    const practs=pd.practitioners||[];
    const excepts=ed.exceptions||[];
    scheduleData={};
    practs.forEach(p=>{
      const pa=avails[p.id];
      scheduleData[p.id]={name:p.display_name,color:p.color,schedule:{}};
      for(let d=0;d<7;d++){scheduleData[p.id].schedule[d]=pa?.schedule?.[d]||[];}
    });

    let h=`<p style="font-size:.85rem;color:var(--text-3);margin-bottom:16px">G√©rez les cr√©neaux de disponibilit√© par praticien. Les modifications s'appliquent aux prochaines r√©servations.</p>`;
    practs.forEach(p=>{
      const sc=scheduleData[p.id].schedule;
      h+=`<div class="card pract-block" style="margin-bottom:16px"><div class="card-h"><h3 style="display:flex;align-items:center;gap:8px"><span style="width:24px;height:24px;border-radius:6px;background:${p.color||'var(--primary)'};display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-family:var(--serif)">${p.display_name?.charAt(0)||'?'}</span>${p.display_name}</h3><button class="btn-primary btn-sm" onclick="saveSchedule('${p.id}')">üíæ Enregistrer</button></div><div style="padding:14px 18px">`;
      for(let d=0;d<7;d++){
        const slots=sc[d]||[];
        h+=`<div class="day-row"><span class="day-name">${DAYS_WEEK[d]}</span><div class="slots">`;
        if(slots.length===0){h+=`<span class="day-closed">Ferm√©</span>`;}
        else{slots.forEach((s,i)=>{h+=`<span class="slot-chip">${s.start_time?.slice(0,5)} ‚Äì ${s.end_time?.slice(0,5)}<button class="remove-slot" onclick="removeSlot('${p.id}',${d},${i})">‚úï</button></span>`;});}
        h+=`<button class="add-slot-btn" onclick="addSlot('${p.id}',${d})">+ Ajouter</button></div></div>`;
      }
      h+=`</div></div>`;
    });

    h+=`<div class="card"><div class="card-h"><h3>Exceptions & cong√©s</h3><button class="btn-primary btn-sm" onclick="openExceptionModal()">+ Ajouter</button></div>`;
    if(excepts.length===0){h+=`<div class="empty">Aucune exception planifi√©e</div>`;}
    else{h+=`<div style="padding:10px 18px">`;excepts.forEach(ex=>{
      const dt=new Date(ex.date).toLocaleDateString('fr-BE',{weekday:'short',day:'numeric',month:'short'});
      h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light)"><div><span style="font-size:.85rem;font-weight:600">${dt}</span><span style="font-size:.78rem;color:var(--text-4);margin-left:8px">${ex.practitioner_name} ‚Äî ${ex.type==='closed'?'Ferm√©':ex.start_time?.slice(0,5)+' ‚Äì '+ex.end_time?.slice(0,5)}</span>${ex.note?`<span style="font-size:.72rem;color:var(--text-4);margin-left:8px">(${ex.note})</span>`:''}</div><button class="btn-outline btn-sm btn-danger" onclick="if(confirm('Supprimer ?'))deleteException('${ex.id}')">‚úï</button></div>`;
    });h+=`</div>`;}
    h+=`</div>`;
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function addSlot(pid,day){
  const last=scheduleData[pid].schedule[day].slice(-1)[0];
  const ds=last?last.end_time:'09:00:00';
  const hr=parseInt(ds.split(':')[0]);
  const de=`${String(Math.min(hr+4,20)).padStart(2,'0')}:00`;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:340px"><div class="modal-h"><h3>Cr√©neau ‚Äî ${DAYS_WEEK[day]}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">
    <div class="field-row"><div class="field"><label>D√©but</label><input type="time" id="slot_start" value="${ds.slice(0,5)}"></div><div class="field"><label>Fin</label><input type="time" id="slot_end" value="${de}"></div></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="confirmAddSlot('${pid}',${day})">Ajouter</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

function confirmAddSlot(pid,day){
  const st=document.getElementById('slot_start').value+':00',en=document.getElementById('slot_end').value+':00';
  if(!scheduleData[pid].schedule[day])scheduleData[pid].schedule[day]=[];
  scheduleData[pid].schedule[day].push({start_time:st,end_time:en});
  scheduleData[pid].schedule[day].sort((a,b)=>a.start_time.localeCompare(b.start_time));
  document.querySelector('.modal-overlay')?.remove();loadHours();
}

function removeSlot(pid,day,idx){scheduleData[pid].schedule[day].splice(idx,1);loadHours();}

async function saveSchedule(pid){
  const schedule={};
  for(let d=0;d<7;d++){const sl=scheduleData[pid].schedule[d]||[];if(sl.length>0)schedule[d]=sl.map(s=>({start_time:s.start_time?.slice(0,5),end_time:s.end_time?.slice(0,5)}));}
  try{const r=await fetch('/api/availabilities',{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({practitioner_id:pid,schedule})});
    if(!r.ok)throw new Error((await r.json()).error);BooktUI.toast('Horaires enregistr√©s','success');loadHours();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function openExceptionModal(){
  const pids=Object.entries(scheduleData).map(([id,d])=>`<option value="${id}">${d.name}</option>`).join('');
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:400px"><div class="modal-h"><h3>Nouvelle exception</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">
    <div class="field"><label>Praticien</label><select id="exc_pract">${pids}</select></div>
    <div class="field"><label>Date</label><input type="date" id="exc_date" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="field"><label>Type</label><select id="exc_type" onchange="document.getElementById('exc_times').style.display=this.value==='custom'?'flex':'none'"><option value="closed">Ferm√© toute la journ√©e</option><option value="custom">Horaires modifi√©s</option></select></div>
    <div class="field-row" id="exc_times" style="display:none"><div class="field"><label>D√©but</label><input type="time" id="exc_start" value="09:00"></div><div class="field"><label>Fin</label><input type="time" id="exc_end" value="17:00"></div></div>
    <div class="field"><label>Note</label><input id="exc_note" placeholder="Ex: Cong√©, formation..."></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveException()">Enregistrer</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveException(){
  const type=document.getElementById('exc_type').value;
  const body={practitioner_id:document.getElementById('exc_pract').value,date:document.getElementById('exc_date').value,type,note:document.getElementById('exc_note').value||null};
  if(type==='custom'){body.start_time=document.getElementById('exc_start').value;body.end_time=document.getElementById('exc_end').value;}
  try{const r=await fetch('/api/availabilities/exceptions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);document.querySelector('.modal-overlay')?.remove();BooktUI.toast('Exception ajout√©e','success');loadHours();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function deleteException(id){
  try{await fetch(`/api/availabilities/exceptions/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});BooktUI.toast('Exception supprim√©e','success');loadHours();}catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// SITE SECTION ‚Äî THEME PICKER
// ============================================================
const THEMES={
  classique:{name:'Classique',desc:'√âpur√© et professionnel. Teal + typographie √©ditoriale.',free:true,
    colors:{bg:'#FAFAF9',nav:'#FAFAF9',navText:'#1A1816',primary:'#0D7377',text:'#1A1816',card:'#FFF',cardBorder:'#ECEAE6',heroBg:'#FAFAF9'},
    heroStyle:'light'},
  prestige:{name:'Prestige',desc:'Bleu nuit + or. Id√©al avocats, notaires, consultants.',free:false,
    colors:{bg:'#F8F7F4',nav:'#1B1B1B',navText:'#FFF',primary:'#1E3A5F',text:'#1B1B1B',card:'#FFF',cardBorder:'#E0DDD8',heroBg:'#1B1B1B'},
    heroStyle:'dark'},
  zen:{name:'Zen',desc:'Vert sauge + beige. Parfait bien-√™tre, th√©rapeutes, coachs.',free:false,
    colors:{bg:'#F7F5F0',nav:'#F7F5F0',navText:'#2C2820',primary:'#6B7F5E',text:'#2C2820',card:'#FFFDF9',cardBorder:'#E5E0D6',heroBg:'#F7F5F0'},
    heroStyle:'light'},
  moderne:{name:'Moderne',desc:'Noir + blanc. G√©om√©trique, tech-forward, minimaliste.',free:false,
    colors:{bg:'#FAFAFA',nav:'#FAFAFA',navText:'#111',primary:'#111',text:'#111',card:'#FFF',cardBorder:'#E8E8E8',heroBg:'#FAFAFA'},
    heroStyle:'light'},
  chaleureux:{name:'Chaleureux',desc:'Terracotta + cr√®me. Accueillant, personnel, artisanal.',free:false,
    colors:{bg:'#FAF6F2',nav:'#FAF6F2',navText:'#2E1F14',primary:'#8B4513',text:'#2E1F14',card:'#FFFCF8',cardBorder:'#E8E0D6',heroBg:'#FAF6F2'},
    heroStyle:'light'},
  ocean:{name:'Oc√©an',desc:'Bleu profond + ciel. Frais, ouvert, m√©dical.',free:false,
    colors:{bg:'#F5F8FA',nav:'#0F2440',navText:'#FFF',primary:'#1565C0',text:'#0F2440',card:'#FFF',cardBorder:'#DCE5ED',heroBg:'#0F2440'},
    heroStyle:'dark'}
};

let currentThemePreset='classique';
let businessPlan='free';

async function loadSiteSection(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const r=await fetch('/api/business',{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const b=d.business;
    currentThemePreset=b.theme?.preset||'classique';
    businessPlan=b.plan||'free';
    const slug=b.slug||'';

    let h=`<div class="qlink"><div class="info"><h4>Votre page publique</h4><p>${slug}</p></div><div style="display:flex;gap:8px"><a href="/${slug}" target="_blank">Voir ma page</a><a href="/${slug}/book" target="_blank" style="background:rgba(255,255,255,.08)">Page booking</a></div></div>`;

    h+=`<div class="card"><div class="card-h"><h3>Th√®me du mini-site</h3><span class="badge ${businessPlan==='free'?'badge-teal':'badge-teal'}">${businessPlan==='free'?'Plan Gratuit ‚Äî 1 th√®me':'Plan '+businessPlan.charAt(0).toUpperCase()+businessPlan.slice(1)}</span></div>
    <div style="padding:18px">
      <p style="font-size:.85rem;color:var(--text-3);margin-bottom:4px">Choisissez l'identit√© visuelle de votre site. Chaque th√®me inclut typographie, palette et mise en page uniques.</p>
      ${businessPlan==='free'?'<p style="font-size:.78rem;color:var(--gold);margin-bottom:12px">üîì Passez au plan Pro pour d√©bloquer les 5 th√®mes premium + couleur personnalis√©e.</p>':''}
      <div class="theme-grid">`;

    Object.entries(THEMES).forEach(([key,t])=>{
      const isActive=key===currentThemePreset;
      const isPro=!t.free;
      const isLocked=isPro&&businessPlan==='free';
      const cls=`theme-card${isActive?' active':''}${isLocked?' locked':''}`;
      const co=t.colors;

      h+=`<div class="${cls}" onclick="${isLocked?'':'selectTheme(\''+key+'\')'}">
        <div class="check">‚úì</div>
        ${isLocked?'<div class="lock-icon">üîí</div>':''}
        <div class="theme-preview" style="background:${co.heroBg}">
          <div class="tp-nav" style="background:${co.nav}">
            <div class="dot" style="background:${co.primary}">B</div>
            <span class="tp-name" style="color:${co.navText}">Cabinet</span>
            <span class="tp-cta" style="background:${co.primary}">RDV</span>
          </div>
          <div class="tp-hero" style="color:${t.heroStyle==='dark'?'#fff':co.text}">
            <h3>Cabinet Dupont & Associ√©s</h3>
            <p>Votre sant√©, notre priorit√© depuis 2018</p>
          </div>
          <div class="tp-cards">
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
          </div>
        </div>
        <div class="theme-info">
          <h4>${t.name} <span class="th-badge ${t.free?'th-free':'th-pro'}">${t.free?'Gratuit':'Pro'}</span></h4>
          <p>${t.desc}</p>
        </div>
      </div>`;
    });

    h+=`</div></div></div>`;

    // Custom color (Pro only)
    const curColor=b.theme?.primary_color||THEMES[currentThemePreset]?.colors?.primary||'#0D7377';
    h+=`<div class="card"><div class="card-h"><h3>Couleur personnalis√©e</h3>${businessPlan==='free'?'<span class="th-badge th-pro">Pro</span>':''}</div>
      <div style="padding:18px;display:flex;align-items:center;gap:14px">
        <input type="color" id="customColor" value="${curColor}" ${businessPlan==='free'?'disabled':''} style="width:44px;height:44px;border:2px solid var(--border);border-radius:8px;cursor:${businessPlan==='free'?'not-allowed':'pointer'};padding:2px">
        <div><p style="font-size:.85rem;font-weight:600">Remplacer la couleur primaire du th√®me</p>
        <p style="font-size:.75rem;color:var(--text-4)">${businessPlan==='free'?'Disponible avec le plan Pro':'Choisissez une couleur qui repr√©sente votre marque'}</p></div>
        ${businessPlan!=='free'?'<button onclick="saveCustomColor()" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-family:var(--sans);font-size:.8rem;font-weight:600;cursor:pointer;margin-left:auto">Appliquer</button>':''}
      </div>
    </div>`;

    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function selectTheme(preset){
  if(preset===currentThemePreset)return;
  try{
    const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({theme:{preset,primary_color:THEMES[preset]?.colors?.primary}})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    currentThemePreset=preset;
    BooktUI.toast(`Th√®me "${THEMES[preset].name}" appliqu√© !`,'success');
    loadSiteSection();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function saveCustomColor(){
  const color=document.getElementById('customColor').value;
  try{
    const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({theme:{preset:currentThemePreset,primary_color:color}})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    BooktUI.toast('Couleur appliqu√©e !','success');
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// √âQUIPE (TEAM MANAGEMENT)
// ============================================================
async function loadTeam(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const r=await fetch('/api/practitioners',{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const practs=d.practitioners||[];
    let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-size:.95rem;font-weight:700">${practs.length} membre${practs.length>1?'s':''} de l'√©quipe</h3><button class="btn-primary" onclick="openPractModal()">+ Ajouter un praticien</button></div>`;

    if(practs.length===0){h+=`<div class="card"><div class="empty">Aucun praticien. Ajoutez votre premier membre !</div></div>`;}
    else{
      h+=`<div class="team-grid2">`;
      practs.forEach(p=>{
        const initials=p.display_name?.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)||'??';
        const hasLogin=!!p.user_email;
        h+=`<div class="team-member${p.is_active?'':' inactive'}">
          <div class="tm-header">
            <div class="tm-avatar" style="background:${p.color||'var(--primary)'}">${initials}</div>
            <div class="tm-info">
              <h4>${p.display_name}</h4>
              <div class="tm-title">${p.title||'‚Äî'}${p.years_experience?' ¬∑ '+p.years_experience+' ans':''}</div>
              ${p.user_email?`<div class="tm-email">üîë ${p.user_email}</div>`:`<div class="tm-email" style="color:var(--text-4)">Pas de compte</div>`}
            </div>
          </div>
          <div class="tm-stats">
            <div class="tm-stat"><div class="v">${p.bookings_30d||0}</div><div class="l">RDV / 30j</div></div>
            <div class="tm-stat"><div class="v">${p.service_count||0}</div><div class="l">Prestations</div></div>
            <div class="tm-stat"><div class="v">${p.last_login_at?new Date(p.last_login_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short'}):'‚Äî'}</div><div class="l">Dern. connexion</div></div>
          </div>
          <div class="tm-badges">
            <span class="tm-badge ${p.is_active?'active':'inactive'}">${p.is_active?'Actif':'Inactif'}</span>
            <span class="tm-badge ${p.booking_enabled?'booking':'no-booking'}">${p.booking_enabled?'R√©servable':'Non r√©servable'}</span>
            ${hasLogin?'<span class="tm-badge has-login">Compte li√©</span>':''}
          </div>
          <div class="tm-actions">
            <button class="btn-outline btn-sm" onclick="openPractModal('${p.id}')">‚úèÔ∏è Modifier</button>
            ${!hasLogin?`<button class="btn-outline btn-sm" onclick="openInviteModal('${p.id}','${esc(p.display_name)}')">üîë Cr√©er un acc√®s</button>`:''}
            ${p.is_active?`<button class="btn-outline btn-sm btn-danger" onclick="if(confirm('D√©sactiver ${esc(p.display_name)} ?'))deactivatePract('${p.id}')">D√©sactiver</button>`:`<button class="btn-outline btn-sm" onclick="reactivatePract('${p.id}')">R√©activer</button>`}
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function openPractModal(editId){
  if(editId){
    fetch('/api/practitioners',{headers:{'Authorization':'Bearer '+api.getToken()}}).then(r=>r.json()).then(d=>{
      renderPractModal(d.practitioners.find(p=>p.id===editId));
    });
  }else{renderPractModal(null);}
}

function renderPractModal(p){
  const isEdit=!!p;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${isEdit?'Modifier le praticien':'Nouveau praticien'}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">
    <div class="field"><label>Nom complet *</label><input id="p_name" value="${p?.display_name||''}" placeholder="Ex: Dr. Sophie Laurent"></div>
    <div class="field"><label>Titre / Sp√©cialit√©</label><input id="p_title" value="${p?.title||''}" placeholder="Ex: Kin√©sith√©rapeute sportif"></div>
    <div class="field-row"><div class="field"><label>Ann√©es d'exp√©rience</label><input type="number" id="p_years" value="${p?.years_experience||''}" min="0"></div><div class="field"><label>Couleur agenda</label><input type="color" id="p_color" value="${p?.color||'#0D7377'}" style="width:50px;height:36px;border:1.5px solid var(--border);border-radius:6px;cursor:pointer"></div></div>
    <div class="field-row"><div class="field"><label>Email</label><input id="p_email" type="email" value="${p?.email||''}"></div><div class="field"><label>T√©l√©phone</label><input id="p_phone" value="${p?.phone||''}"></div></div>
    <div class="field"><label>Bio</label><textarea id="p_bio">${p?.bio||''}</textarea></div>
    <div class="field"><label>LinkedIn</label><input id="p_linkedin" value="${p?.linkedin_url||''}" placeholder="https://linkedin.com/in/..."></div>
    <div class="field"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="p_booking" ${p?.booking_enabled!==false?'checked':''}> Peut recevoir des r√©servations en ligne</label></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="savePract(${isEdit?"'"+p.id+"'":'null'})">${isEdit?'Enregistrer':'Cr√©er'}</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function savePract(id){
  const body={display_name:document.getElementById('p_name').value,title:document.getElementById('p_title').value||null,years_experience:parseInt(document.getElementById('p_years').value)||null,color:document.getElementById('p_color').value,email:document.getElementById('p_email').value||null,phone:document.getElementById('p_phone').value||null,bio:document.getElementById('p_bio').value||null,linkedin_url:document.getElementById('p_linkedin').value||null,booking_enabled:document.getElementById('p_booking').checked};
  try{
    const url=id?`/api/practitioners/${id}`:'/api/practitioners';
    const method=id?'PATCH':'POST';
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast(id?'Praticien modifi√©':'Praticien ajout√©','success');loadTeam();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function deactivatePract(id){
  try{const r=await fetch(`/api/practitioners/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);BooktUI.toast('Praticien d√©sactiv√©','success');loadTeam();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function reactivatePract(id){
  try{const r=await fetch(`/api/practitioners/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({is_active:true,booking_enabled:true})});
    if(!r.ok)throw new Error((await r.json()).error);BooktUI.toast('Praticien r√©activ√©','success');loadTeam();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function openInviteModal(practId,name){
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:420px"><div class="modal-h"><h3>Cr√©er un acc√®s ‚Äî ${name}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">
    <p style="font-size:.85rem;color:var(--text-3);margin-bottom:14px">Cr√©ez un compte staff pour que <strong>${name}</strong> puisse se connecter au dashboard et g√©rer son agenda.</p>
    <div class="field"><label>Email *</label><input id="inv_email" type="email" placeholder="email@exemple.com"></div>
    <div class="field"><label>Mot de passe temporaire *</label><input id="inv_pwd" type="text" value="${generateTempPwd()}" style="font-family:monospace"><div class="hint">Communiquez ce mot de passe au praticien. Il pourra le changer dans ses param√®tres.</div></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="sendInvite('${practId}')">Cr√©er le compte</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

function generateTempPwd(){const chars='ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';let pwd='';for(let i=0;i<10;i++)pwd+=chars[Math.floor(Math.random()*chars.length)];return pwd;}

async function sendInvite(practId){
  const email=document.getElementById('inv_email').value;
  const password=document.getElementById('inv_pwd').value;
  if(!email||!password)return BooktUI.toast('Email et mot de passe requis','error');
  try{
    const r=await fetch(`/api/practitioners/${practId}/invite`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({email,password})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast('Compte cr√©√© ! Communiquez les identifiants au praticien.','success');loadTeam();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// PARAM√àTRES
// ============================================================
async function loadSettings(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[br,ur,lr,calr]=await Promise.all([
      fetch('/api/business',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/auth/me',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/business/public-link',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/calendar/connections',{headers:{'Authorization':'Bearer '+api.getToken()}}).catch(()=>({ok:false}))
    ]);
    const bd=await br.json(),ud=await ur.json(),ld=await lr.json();
    const calData=calr.ok?await calr.json():{connections:[]};
    const calConns=calData.connections||[];
    const b=bd.business, u=ud.user, lk=ld;
    let h='';

    // 1. Infos cabinet
    h+=`<div class="settings-card"><div class="sc-h"><h3>üè¢ Informations du cabinet</h3></div><div class="sc-body">
      <div class="field-row"><div class="field"><label>Nom du cabinet *</label><input id="s_name" value="${esc(b.name||'')}"></div><div class="field"><label>URL personnalis√©e</label><div class="copy-input"><span style="padding:9px 0;font-size:.85rem;color:var(--text-4)">bookt.be/</span><input id="s_slug" value="${esc(b.slug||'')}" style="flex:1"></div><div class="hint">Modifie l'URL de votre page publique</div></div></div>
      <div class="field-row"><div class="field"><label>Email professionnel</label><input id="s_email" type="email" value="${esc(b.email||'')}"></div><div class="field"><label>T√©l√©phone</label><input id="s_phone" value="${esc(b.phone||'')}"></div></div>
      <div class="field"><label>Adresse</label><input id="s_address" value="${esc(b.address||'')}" placeholder="Ex: Rue de la Loi 42, 1000 Bruxelles"></div>
      <div class="field-row"><div class="field"><label>N¬∞ BCE / TVA</label><input id="s_bce" value="${esc(b.bce_number||'')}" placeholder="BE 0xxx.xxx.xxx"></div><div class="field"><label>Accr√©ditation</label><input id="s_accred" value="${esc(b.accreditation||'')}" placeholder="Ex: Barreau de Bruxelles"></div></div>
      <div class="field"><label>Tagline</label><input id="s_tagline" value="${esc(b.tagline||'')}" placeholder="Phrase d'accroche affich√©e sur votre page"></div>
      <div class="field"><label>Description</label><textarea id="s_desc">${esc(b.description||'')}</textarea></div>
      <div class="field-row"><div class="field"><label>Ann√©e de fondation</label><input id="s_year" type="number" value="${b.founded_year||''}"></div><div class="field"><label>Langues</label><input id="s_langs" value="${esc(b.languages_spoken||'')}" placeholder="FR, NL, EN"></div></div>
      <div class="field"><label>Info parking</label><input id="s_parking" value="${esc(b.parking_info||'')}" placeholder="Ex: Parking gratuit √† 50m"></div>
      <div style="height:1px;background:var(--border);margin:10px 0"></div>
      <div style="font-size:.75rem;font-weight:700;color:var(--text-3);text-transform:uppercase;margin-bottom:6px">Facturation</div>
      <div class="field-row"><div class="field"><label>IBAN</label><input id="s_iban" value="${esc(b.settings?.iban||'')}" placeholder="BE00 0000 0000 0000"></div><div class="field"><label>BIC</label><input id="s_bic" value="${esc(b.settings?.bic||'')}" placeholder="GEBABEBB"></div></div>
      <div class="field"><label>Pied de page facture</label><input id="s_inv_footer" value="${esc(b.settings?.invoice_footer||'')}" placeholder="Ex: Petit entrepreneur - TVA non applicable art. 56bis CTVA"></div>
    </div><div class="sc-foot"><button class="btn-primary" onclick="saveBusiness()">Enregistrer</button></div></div>`;

    // 2. SEO
    h+=`<div class="settings-card"><div class="sc-h"><h3>üîç SEO & R√©f√©rencement</h3></div><div class="sc-body">
      <div class="field"><label>Titre SEO</label><input id="s_seo_title" value="${esc(b.seo_title||'')}" placeholder="Titre affich√© dans Google (max 60 car.)"><div class="hint">Par d√©faut : "[Nom] ‚Äî [Tagline]"</div></div>
      <div class="field"><label>Meta description</label><textarea id="s_seo_desc" style="min-height:60px">${esc(b.seo_description||'')}</textarea><div class="hint">Description affich√©e dans Google (max 160 car.)</div></div>
    </div><div class="sc-foot"><button class="btn-primary" onclick="saveSEO()">Enregistrer</button></div></div>`;

    // 3. Lien public & widget
    h+=`<div class="settings-card"><div class="sc-h"><h3>üîó Lien public & Widget</h3></div><div class="sc-body">
      <div class="field"><label>URL de r√©servation</label><div class="copy-input"><input id="s_url" value="${lk.booking_url||''}" readonly><button class="btn-outline btn-sm" onclick="copyField('s_url')">üìã Copier</button></div></div>
      <div class="field"><label>Code widget embeddable</label><div class="copy-input"><input id="s_widget" value='${esc(lk.widget_code||'')}' readonly style="font-size:.72rem"><button class="btn-outline btn-sm" onclick="copyField('s_widget')">üìã Copier</button></div><div class="hint">Collez ce code sur votre site existant pour ajouter un bouton de r√©servation</div></div>
      <div class="field"><label>QR Code</label><div class="hint">Scannez pour acc√©der √† votre page publique</div><div style="margin-top:8px;padding:16px;background:var(--surface);border-radius:8px;text-align:center"><canvas id="qrCanvas" width="160" height="160" style="width:160px;height:160px"></canvas><div style="margin-top:8px"><button class="btn-outline btn-sm" onclick="downloadQR()">‚¨áÔ∏è T√©l√©charger PNG</button></div></div></div>
    </div></div>`;

    // 4. S√©curit√©
    h+=`<div class="settings-card"><div class="sc-h"><h3>üîí S√©curit√©</h3></div><div class="sc-body">
      <p style="font-size:.85rem;color:var(--text-3);margin-bottom:14px">Connect√© en tant que <strong>${u.email}</strong> ¬∑ R√¥le : ${u.role==='owner'?'Propri√©taire':'Staff'}${u.last_login_at?' ¬∑ Derni√®re connexion : '+new Date(u.last_login_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}):''}</p>
      <div class="field"><label>Mot de passe actuel</label><input id="s_pwd_current" type="password"></div>
      <div class="field-row"><div class="field"><label>Nouveau mot de passe</label><input id="s_pwd_new" type="password" placeholder="Min. 8 caract√®res"></div><div class="field"><label>Confirmer</label><input id="s_pwd_confirm" type="password"></div></div>
    </div><div class="sc-foot"><button class="btn-primary" onclick="changePassword()">Changer le mot de passe</button></div></div>`;

    // 5. Plan & facturation
    const plan=b.plan||'free';
    h+=`<div class="settings-card"><div class="sc-h"><h3>üí≥ Plan & Facturation</h3></div><div class="sc-body">
      <div class="plan-card">
        <div class="plan-box${plan==='free'?' current':''}">
          ${plan==='free'?'<span class="current-badge">Actuel</span>':''}
          <div class="plan-name">Gratuit</div>
          <div class="plan-price">0 ‚Ç¨<span>/mois</span></div>
          <ul><li>Mini-site public</li><li>1 th√®me (Classique)</li><li>Booking en ligne</li><li>Agenda basique</li><li>5 clients max</li></ul>
        </div>
        <div class="plan-box${plan==='pro'?' current':''}">
          ${plan==='pro'?'<span class="current-badge">Actuel</span>':''}
          <div class="plan-name">Pro</div>
          <div class="plan-price">39 ‚Ç¨<span>/mois</span></div>
          <ul><li>Tout du Gratuit +</li><li>6 th√®mes + couleur custom</li><li>Clients illimit√©s</li><li>Rappels email + SMS</li><li>Statistiques avanc√©es</li><li>Widget embeddable</li><li>QR code dynamique</li></ul>
          ${plan!=='pro'?'<button class="btn-primary" style="width:100%;margin-top:8px" onclick="BooktUI.toast(\'Bient√¥t disponible ‚Äî contactez-nous !\',\'info\')">Passer au Pro ‚Üí</button>':''}
        </div>
        <div class="plan-box${plan==='premium'?' current':''}">
          ${plan==='premium'?'<span class="current-badge">Actuel</span>':''}
          <div class="plan-name">Premium</div>
          <div class="plan-price">79 ‚Ç¨<span>/mois</span></div>
          <ul><li>Tout du Pro +</li><li>Filtre d'appels IA</li><li>Google Cal + Outlook sync</li><li>Paiement en ligne</li><li>Facturation auto PDF</li><li>Domaine personnalis√©</li><li>Support prioritaire</li></ul>
          ${plan!=='premium'?'<button class="btn-outline" style="width:100%;margin-top:8px" onclick="BooktUI.toast(\'Bient√¥t disponible ‚Äî contactez-nous !\',\'info\')">Contacter</button>':''}
        </div>
      </div>
    </div></div>`;

    // 6. Synchronisation calendrier
    const gConn=calConns.find(c=>c.provider==='google');
    const oConn=calConns.find(c=>c.provider==='outlook');
    h+=`<div class="settings-card"><div class="sc-h"><h3>üìÖ Synchronisation calendrier</h3></div><div class="sc-body">
      <p style="font-size:.82rem;color:var(--text-3);margin-bottom:16px">Synchronisez vos rendez-vous Bookt avec votre agenda externe. Les cr√©neaux occup√©s dans votre calendrier bloqueront automatiquement les r√©servations.</p>

      <div style="display:grid;gap:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface)">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:36px;height:36px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 1px 3px rgba(0,0,0,.08)">üìÜ</div>
            <div>
              <div style="font-size:.88rem;font-weight:600">Google Calendar</div>
              ${gConn?`<div style="font-size:.72rem;color:var(--green)">‚úì Connect√© ‚Äî ${esc(gConn.email||'')}${gConn.last_sync_at?' ¬∑ Derni√®re synchro: '+new Date(gConn.last_sync_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):''}</div>`
              :`<div style="font-size:.72rem;color:var(--text-4)">Non connect√©</div>`}
            </div>
          </div>
          <div style="display:flex;gap:6px">
            ${gConn?`
              <button onclick="syncCalendar('${gConn.id}')" class="btn-outline btn-sm">üîÑ Sync</button>
              <button onclick="disconnectCalendar('${gConn.id}','google')" class="btn-outline btn-sm btn-danger">D√©connecter</button>
            `:`<button onclick="connectCalendar('google')" class="btn-outline btn-sm" style="color:var(--primary);border-color:var(--primary)">Connecter</button>`}
          </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface)">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:36px;height:36px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 1px 3px rgba(0,0,0,.08)">üìß</div>
            <div>
              <div style="font-size:.88rem;font-weight:600">Outlook / Microsoft 365</div>
              ${oConn?`<div style="font-size:.72rem;color:var(--green)">‚úì Connect√© ‚Äî ${esc(oConn.email||'')}${oConn.last_sync_at?' ¬∑ Derni√®re synchro: '+new Date(oConn.last_sync_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):''}</div>`
              :`<div style="font-size:.72rem;color:var(--text-4)">Non connect√©</div>`}
            </div>
          </div>
          <div style="display:flex;gap:6px">
            ${oConn?`
              <button onclick="syncCalendar('${oConn.id}')" class="btn-outline btn-sm">üîÑ Sync</button>
              <button onclick="disconnectCalendar('${oConn.id}','outlook')" class="btn-outline btn-sm btn-danger">D√©connecter</button>
            `:`<button onclick="connectCalendar('outlook')" class="btn-outline btn-sm" style="color:var(--primary);border-color:var(--primary)">Connecter</button>`}
          </div>
        </div>
      </div>

      ${calConns.length>0?`<div style="margin-top:14px;padding:12px;background:var(--primary-light);border-radius:var(--radius-xs)">
        <div style="font-size:.78rem;color:var(--text-2)">
          <strong>Direction de synchro :</strong>
          <select onchange="updateCalSyncDirection(this.value)" style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:.78rem;margin-left:6px">
            <option value="both" ${(gConn||oConn)?.sync_direction==='both'?'selected':''}>‚Üî Bidirectionnelle (push + pull)</option>
            <option value="push" ${(gConn||oConn)?.sync_direction==='push'?'selected':''}>‚Üí Push uniquement (Bookt ‚Üí Calendrier)</option>
            <option value="pull" ${(gConn||oConn)?.sync_direction==='pull'?'selected':''}>‚Üê Pull uniquement (Calendrier ‚Üí Bookt)</option>
          </select>
        </div>
        <div style="font-size:.7rem;color:var(--text-4);margin-top:4px">Push = vos RDV Bookt apparaissent dans votre agenda. Pull = les cr√©neaux occup√©s de votre agenda bloquent les r√©servations.</div>
      </div>`:''}
    </div></div>`;

    // 7. Danger zone
    h+=`<div class="settings-card danger-zone"><div class="sc-h"><h3>‚ö†Ô∏è Zone danger</h3></div><div class="sc-body">
      <p style="font-size:.85rem;color:var(--text-2);margin-bottom:12px">Supprimer d√©finitivement votre compte et toutes les donn√©es associ√©es. Cette action est irr√©versible.</p>
      <button class="btn-outline btn-danger" onclick="confirmDeleteAccount()">Supprimer mon compte</button>
    </div></div>`;

    c.innerHTML=h;

    // Draw QR code
    setTimeout(()=>drawQR(lk.qr_data||lk.booking_url||''),50);
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

async function saveBusiness(){
  const body={name:document.getElementById('s_name').value,slug:document.getElementById('s_slug').value,email:document.getElementById('s_email').value,phone:document.getElementById('s_phone').value,address:document.getElementById('s_address').value,bce_number:document.getElementById('s_bce').value,accreditation:document.getElementById('s_accred').value,tagline:document.getElementById('s_tagline').value,description:document.getElementById('s_desc').value,founded_year:document.getElementById('s_year').value||null,languages_spoken:document.getElementById('s_langs').value,parking_info:document.getElementById('s_parking').value,settings_iban:document.getElementById('s_iban').value,settings_bic:document.getElementById('s_bic').value,settings_invoice_footer:document.getElementById('s_inv_footer').value};
  try{const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);BooktUI.toast('Informations enregistr√©es','success');
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function saveSEO(){
  const body={seo_title:document.getElementById('s_seo_title').value,seo_description:document.getElementById('s_seo_desc').value};
  try{const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);BooktUI.toast('SEO enregistr√©','success');
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function changePassword(){
  const cur=document.getElementById('s_pwd_current').value;
  const nw=document.getElementById('s_pwd_new').value;
  const cnf=document.getElementById('s_pwd_confirm').value;
  if(!cur||!nw)return BooktUI.toast('Remplissez tous les champs','error');
  if(nw!==cnf)return BooktUI.toast('Les mots de passe ne correspondent pas','error');
  if(nw.length<8)return BooktUI.toast('Minimum 8 caract√®res','error');
  try{const r=await fetch('/api/auth/change-password',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({current_password:cur,new_password:nw})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.getElementById('s_pwd_current').value='';document.getElementById('s_pwd_new').value='';document.getElementById('s_pwd_confirm').value='';
    BooktUI.toast('Mot de passe modifi√©','success');
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function copyField(id){
  const el=document.getElementById(id);el.select();navigator.clipboard.writeText(el.value);
  BooktUI.toast('Copi√© !','success');
}

function confirmDeleteAccount(){
  const name=prompt('Tapez le nom de votre cabinet pour confirmer la suppression :');
  if(!name)return;
  BooktUI.toast('Suppression de compte ‚Äî contactez support@bookt.be','info');
}

// ===== QR Code (simple canvas) =====
function drawQR(data){
  const canvas=document.getElementById('qrCanvas');if(!canvas||!data)return;
  // Minimal QR-like pattern (for real QR use a library like qrcode.js)
  // We'll draw a placeholder with the URL text + a styled square
  const ctx=canvas.getContext('2d');
  const s=160;canvas.width=s;canvas.height=s;
  ctx.fillStyle='#FFF';ctx.fillRect(0,0,s,s);
  // Border
  ctx.strokeStyle='#1A1816';ctx.lineWidth=4;ctx.strokeRect(8,8,s-16,s-16);
  // Corner squares
  [12,s-36].forEach(x=>{[12,s-36].forEach(y=>{
    if(x===s-36&&y===s-36)return; // skip bottom-right
    ctx.fillStyle='#1A1816';ctx.fillRect(x,y,24,24);
    ctx.fillStyle='#FFF';ctx.fillRect(x+4,y+4,16,16);
    ctx.fillStyle='#1A1816';ctx.fillRect(x+8,y+8,8,8);
  });});
  // Simple pattern from data hash
  let hash=0;for(let i=0;i<data.length;i++)hash=((hash<<5)-hash)+data.charCodeAt(i);
  for(let i=0;i<8;i++)for(let j=0;j<8;j++){
    if((hash>>(i*8+j))&1){ctx.fillStyle='#1A1816';ctx.fillRect(40+i*10,40+j*10,8,8);}
  }
  // Center logo
  ctx.fillStyle='var(--primary)';ctx.fillRect(s/2-14,s/2-14,28,28);
  ctx.fillStyle='#FFF';ctx.font='bold 14px sans-serif';ctx.textAlign='center';ctx.fillText('B',s/2,s/2+5);
}

function downloadQR(){
  const canvas=document.getElementById('qrCanvas');if(!canvas)return;
  const link=document.createElement('a');link.download='bookt-qr.png';link.href=canvas.toDataURL();link.click();
  BooktUI.toast('QR t√©l√©charg√©','success');
}

function doLogout(){api.logout();}

// ============================================================
// FACTURATION
// ============================================================
let invoiceFilter='all',invoiceType='all';

async function loadInvoices(){
  const c=document.getElementById('contentArea');
  c.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  try{
    const params=new URLSearchParams();
    if(invoiceFilter!=='all')params.set('status',invoiceFilter);
    if(invoiceType!=='all')params.set('type',invoiceType);
    const data=await api.get(`/api/invoices?${params}`);
    const inv=data.invoices||[];
    const st=data.stats||{};
    let h='';

    // KPIs
    h+=`<div class="stats" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card"><div class="label">Brouillons</div><div class="val">${st.drafts||0}</div></div>
      <div class="stat-card"><div class="label">En attente</div><div class="val" style="color:var(--gold)">${fmtEur(parseInt(st.total_pending||0))}</div><div class="sub">${(parseInt(st.sent||0)+parseInt(st.overdue||0))} factures</div></div>
      <div class="stat-card"><div class="label">Pay√©es</div><div class="val" style="color:var(--green)">${fmtEur(parseInt(st.total_paid||0))}</div><div class="sub">${st.paid||0} factures</div></div>
      <div class="stat-card"><div class="label">En retard</div><div class="val" style="color:var(--red)">${st.overdue||0}</div></div>
    </div>`;

    // Actions bar
    h+=`<div class="card" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:12px 16px">
      <button onclick="openInvoiceModal()" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Nouvelle facture</button>
      <button onclick="openInvoiceModal('quote')" style="padding:8px 16px;background:var(--gold);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Devis</button>
      <div style="flex:1"></div>
      <select onchange="invoiceType=this.value;loadInvoices()" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem">
        <option value="all" ${invoiceType==='all'?'selected':''}>Tous types</option>
        <option value="invoice" ${invoiceType==='invoice'?'selected':''}>Factures</option>
        <option value="quote" ${invoiceType==='quote'?'selected':''}>Devis</option>
        <option value="credit_note" ${invoiceType==='credit_note'?'selected':''}>Notes de cr√©dit</option>
      </select>
      <select onchange="invoiceFilter=this.value;loadInvoices()" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem">
        <option value="all" ${invoiceFilter==='all'?'selected':''}>Tous statuts</option>
        <option value="draft" ${invoiceFilter==='draft'?'selected':''}>Brouillons</option>
        <option value="sent" ${invoiceFilter==='sent'?'selected':''}>Envoy√©es</option>
        <option value="paid" ${invoiceFilter==='paid'?'selected':''}>Pay√©es</option>
        <option value="overdue" ${invoiceFilter==='overdue'?'selected':''}>En retard</option>
        <option value="cancelled" ${invoiceFilter==='cancelled'?'selected':''}>Annul√©es</option>
      </select>
    </div>`;

    // Table
    if(inv.length===0){
      h+=`<div class="card"><div class="empty">Aucune facture. Cr√©ez votre premi√®re facture ou devis !</div></div>`;
    }else{
      h+=`<div class="card" style="padding:0;overflow:auto"><table style="width:100%;border-collapse:collapse;font-size:.82rem">
        <thead><tr style="background:var(--surface);border-bottom:1px solid var(--border)">
          <th style="padding:10px 14px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">N¬∞</th>
          <th style="padding:10px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Type</th>
          <th style="padding:10px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Client</th>
          <th style="padding:10px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Date</th>
          <th style="padding:10px;text-align:right;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Montant TTC</th>
          <th style="padding:10px;text-align:center;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Statut</th>
          <th style="padding:10px;text-align:right;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Actions</th>
        </tr></thead><tbody>`;
      inv.forEach(f=>{
        const statusColors={draft:'var(--text-4)',sent:'var(--gold)',paid:'var(--green)',overdue:'var(--red)',cancelled:'var(--text-4)'};
        const statusLabels={draft:'Brouillon',sent:'Envoy√©e',paid:'Pay√©e',overdue:'En retard',cancelled:'Annul√©e'};
        const typeLabels={invoice:'Facture',quote:'Devis',credit_note:'Note cr√©dit'};
        const typeColors={invoice:'var(--primary)',quote:'var(--gold)',credit_note:'var(--text-3)'};
        const sc=statusColors[f.status]||'var(--text-4)';
        const d=new Date(f.issue_date).toLocaleDateString('fr-BE');
        h+=`<tr style="border-bottom:1px solid var(--border-light)">
          <td style="padding:10px 14px;font-weight:600">${esc(f.invoice_number)}</td>
          <td style="padding:10px"><span style="font-size:.7rem;padding:2px 8px;border-radius:10px;background:${typeColors[f.type]}15;color:${typeColors[f.type]};font-weight:600">${typeLabels[f.type]||f.type}</span></td>
          <td style="padding:10px">${esc(f.client_name)}</td>
          <td style="padding:10px;color:var(--text-3)">${d}</td>
          <td style="padding:10px;text-align:right;font-weight:600">${fmtEur(f.total_cents)}</td>
          <td style="padding:10px;text-align:center"><span style="font-size:.72rem;padding:3px 10px;border-radius:10px;background:${sc}12;color:${sc};font-weight:600">${statusLabels[f.status]||f.status}</span></td>
          <td style="padding:10px;text-align:right">
            <button onclick="downloadInvoicePDF('${f.id}')" title="T√©l√©charger PDF" style="background:none;border:none;cursor:pointer;font-size:1rem">üìÑ</button>
            ${f.status==='draft'?`<button onclick="changeInvoiceStatus('${f.id}','sent')" title="Marquer envoy√©e" style="background:none;border:none;cursor:pointer;font-size:1rem">üì®</button>`:''}
            ${f.status==='sent'||f.status==='overdue'?`<button onclick="changeInvoiceStatus('${f.id}','paid')" title="Marquer pay√©e" style="background:none;border:none;cursor:pointer;font-size:1rem">‚úÖ</button>`:''}
            ${f.status==='draft'?`<button onclick="deleteInvoice('${f.id}')" title="Supprimer" style="background:none;border:none;cursor:pointer;font-size:1rem">üóëÔ∏è</button>`:''}
          </td>
        </tr>`;
      });
      h+=`</tbody></table></div>`;
    }

    // IBAN/BIC reminder
    const bizData=api.getBusiness();
    if(!bizData?.settings?.iban){
      h+=`<div class="card" style="background:var(--gold-bg);border:1px solid #E0D4A8;margin-top:14px;padding:14px 18px">
        <p style="font-size:.82rem;color:var(--text-2);margin:0">üí° <strong>Ajoutez votre IBAN</strong> dans Param√®tres ‚Üí Infos cabinet pour l'afficher sur vos factures et g√©n√©rer la communication structur√©e belge.</p>
      </div>`;
    }

    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function fmtEur(cents){return((cents||0)/100).toFixed(2).replace('.',',')+' ‚Ç¨';}

// Invoice creation modal
async function openInvoiceModal(type='invoice'){
  // Fetch clients for dropdown
  let clients=[];
  try{const r=await api.get('/api/clients');clients=r.clients||r||[];}catch(e){}

  const isQuote=type==='quote';
  const title=isQuote?'Nouveau devis':'Nouvelle facture';

  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;display:flex;align-items:center;justify-content:center';
  modal.innerHTML=`<div style="background:var(--white);border-radius:var(--radius);padding:28px;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <h3 style="font-size:1.1rem;font-weight:700;color:var(--text);margin:0">${title}</h3>
      <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer">‚úï</button>
    </div>

    <div style="display:grid;gap:12px">
      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Client</label>
        <select id="invClient" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
          <option value="">‚Äî S√©lectionner un client ‚Äî</option>
          ${clients.map(c=>`<option value="${c.id}">${esc(c.full_name)}${c.email?' ('+esc(c.email)+')':''}</option>`).join('')}
        </select>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Taux TVA (%)</label>
          <select id="invVat" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
            <option value="21">21% (standard)</option>
            <option value="6">6% (r√©duit)</option>
            <option value="0">0% (exempt√©)</option>
          </select>
        </div>
        <div>
          <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">${isQuote?'Validit√© (jours)':'√âch√©ance (jours)'}</label>
          <input id="invDueDays" type="number" value="${isQuote?'30':'30'}" min="0" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
        </div>
      </div>

      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">TVA client (optionnel)</label>
        <input id="invClientBce" placeholder="BE0XXX.XXX.XXX" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
      </div>

      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:6px">Lignes</label>
        <div id="invLines"></div>
        <button onclick="addInvoiceLine()" style="margin-top:6px;padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem;cursor:pointer">+ Ajouter une ligne</button>
      </div>

      <div id="invTotals" style="text-align:right;padding:10px 0;border-top:1px solid var(--border)"></div>

      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Notes</label>
        <textarea id="invNotes" rows="2" placeholder="Conditions, remarques..." style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem;resize:vertical"></textarea>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
      <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:9px 18px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;cursor:pointer">Annuler</button>
      <button onclick="saveInvoice('${type}')" style="padding:9px 22px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.82rem;font-weight:600;cursor:pointer">${isQuote?'Cr√©er le devis':'Cr√©er la facture'}</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  addInvoiceLine();
  updateInvTotals();
}

function addInvoiceLine(){
  const container=document.getElementById('invLines');
  if(!container)return;
  const idx=container.children.length;
  const row=document.createElement('div');
  row.style.cssText='display:grid;grid-template-columns:1fr 60px 100px 30px;gap:8px;align-items:center;margin-bottom:6px';
  row.innerHTML=`
    <input class="inv-desc" placeholder="Description prestation" style="padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem">
    <input class="inv-qty" type="number" value="1" min="1" onchange="updateInvTotals()" style="padding:8px 6px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;text-align:center">
    <input class="inv-price" type="number" step="0.01" placeholder="Prix ‚Ç¨" onchange="updateInvTotals()" style="padding:8px 6px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;text-align:right">
    <button onclick="this.parentElement.remove();updateInvTotals()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:1rem">‚úï</button>`;
  container.appendChild(row);
}

function updateInvTotals(){
  const container=document.getElementById('invLines');
  const totalsDiv=document.getElementById('invTotals');
  if(!container||!totalsDiv)return;
  const vatRate=parseFloat(document.getElementById('invVat')?.value||21);
  let subtotal=0;
  container.querySelectorAll(':scope > div').forEach(row=>{
    const qty=parseFloat(row.querySelector('.inv-qty')?.value||1);
    const price=parseFloat(row.querySelector('.inv-price')?.value||0);
    subtotal+=qty*price*100;
  });
  const vat=Math.round(subtotal*vatRate/100);
  const total=subtotal+vat;
  totalsDiv.innerHTML=`
    <div style="font-size:.82rem;color:var(--text-3)">Sous-total HT : <strong>${fmtEur(subtotal)}</strong></div>
    <div style="font-size:.82rem;color:var(--text-3)">TVA (${vatRate}%) : <strong>${fmtEur(vat)}</strong></div>
    <div style="font-size:1rem;font-weight:700;color:var(--text);margin-top:4px">Total TTC : ${fmtEur(total)}</div>`;
}

async function saveInvoice(type){
  const clientId=document.getElementById('invClient')?.value;
  if(!clientId){BooktUI.toast('S√©lectionnez un client','error');return;}

  const container=document.getElementById('invLines');
  const items=[];
  container.querySelectorAll(':scope > div').forEach(row=>{
    const desc=row.querySelector('.inv-desc')?.value?.trim();
    const qty=parseFloat(row.querySelector('.inv-qty')?.value||1);
    const price=parseFloat(row.querySelector('.inv-price')?.value||0);
    if(desc&&price>0)items.push({description:desc,quantity:qty,unit_price_cents:Math.round(price*100)});
  });
  if(items.length===0){BooktUI.toast('Ajoutez au moins une ligne','error');return;}

  try{
    const body={
      client_id:clientId,
      type:type||'invoice',
      items,
      vat_rate:parseFloat(document.getElementById('invVat')?.value||21),
      due_days:parseInt(document.getElementById('invDueDays')?.value||30),
      client_bce:document.getElementById('invClientBce')?.value?.trim()||undefined,
      notes:document.getElementById('invNotes')?.value?.trim()||undefined
    };
    const r=await api.post('/api/invoices',body);
    document.querySelector('div[style*="position:fixed"][style*="inset:0"]')?.remove();
    BooktUI.toast(type==='quote'?'Devis cr√©√© !':'Facture cr√©√©e !','success');
    loadInvoices();
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

async function changeInvoiceStatus(id,status){
  const labels={sent:'Marquer comme envoy√©e ?',paid:'Marquer comme pay√©e ?'};
  if(!confirm(labels[status]||`Changer le statut en "${status}" ?`))return;
  try{
    await api.patch(`/api/invoices/${id}/status`,{status});
    BooktUI.toast('Statut mis √† jour','success');
    loadInvoices();
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

async function deleteInvoice(id){
  if(!confirm('Supprimer ce brouillon ?'))return;
  try{
    await api.delete(`/api/invoices/${id}`);
    BooktUI.toast('Brouillon supprim√©','success');
    loadInvoices();
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

function downloadInvoicePDF(id){
  const token=localStorage.getItem('bookt_token');
  window.open(`/api/invoices/${id}/pdf?token=${token}`,'_blank');
}

async function createInvoiceFromBooking(bookingId){
  if(!confirm('Cr√©er une facture pour ce rendez-vous ?'))return;
  try{
    const r=await api.post('/api/invoices',{booking_id:bookingId,type:'invoice'});
    BooktUI.toast('Facture cr√©√©e ! Retrouvez-la dans Facturation.','success');
    // Switch to invoices section
    document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
    document.querySelector('[data-section="invoices"]')?.classList.add('active');
    document.getElementById('pageTitle').textContent='Facturation';
    loadInvoices();
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

// ============================================================
// DOCUMENTS PR√â-RDV
// ============================================================

async function loadDocuments(){
  const c=document.getElementById('contentArea');
  c.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  try{
    const[tRes,sRes]=await Promise.all([api.get('/api/documents'),api.get('/api/services')]);
    const templates=tRes.templates||[];
    const services=sRes.services||sRes||[];
    let h='';

    h+=`<div class="card" style="padding:18px 22px;background:var(--primary-light);border:1px solid var(--primary-soft)">
      <p style="font-size:.85rem;color:var(--text-2);margin:0">
        <strong>üìã Documents pr√©-rendez-vous</strong> ‚Äî Cr√©ez des fiches d'information, formulaires d'anamn√®se ou consentements √©clair√©s. Envoi automatique par email J-2 (configurable) aux clients ayant un RDV confirm√©.</p>
    </div>`;

    h+=`<div style="display:flex;gap:10px;margin:14px 0;flex-wrap:wrap">
      <button onclick="openDocModal('info')" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Fiche d'info</button>
      <button onclick="openDocModal('form')" style="padding:8px 16px;background:var(--gold);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Formulaire</button>
      <button onclick="openDocModal('consent')" style="padding:8px 16px;background:var(--red);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Consentement</button>
    </div>`;

    if(templates.length===0){
      h+=`<div class="card"><div class="empty" style="padding:40px">Aucun document configur√©. Cr√©ez votre premier template !</div></div>`;
    }else{
      h+=`<div style="display:grid;gap:12px">`;
      templates.forEach(t=>{
        const typeLabels={info:'üìÑ Info',form:'üìù Formulaire',consent:'‚úçÔ∏è Consentement'};
        const typeBg={info:'var(--primary-light)',form:'var(--gold-bg)',consent:'var(--red-bg)'};
        const typeColor={info:'var(--primary)',form:'var(--gold)',consent:'var(--red)'};
        const fields=t.form_fields||[];
        h+=`<div class="card" style="padding:0;overflow:hidden">
          <div style="display:flex;align-items:center;gap:14px;padding:16px 20px">
            <div style="width:42px;height:42px;border-radius:10px;background:${typeBg[t.type]};display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">
              ${t.type==='info'?'üìÑ':t.type==='form'?'üìù':'‚úçÔ∏è'}
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-size:.92rem;font-weight:700;color:var(--text)">${esc(t.name)}</div>
              <div style="font-size:.75rem;color:var(--text-3);margin-top:2px">
                <span style="padding:2px 6px;border-radius:6px;background:${typeBg[t.type]};color:${typeColor[t.type]};font-weight:600;font-size:.68rem">${typeLabels[t.type]||t.type}</span>
                ${t.service_name?` ¬∑ ${esc(t.service_name)}`:' ¬∑ Toutes prestations'}
                ¬∑ J-${t.send_days_before}
                ${fields.length>0?` ¬∑ ${fields.length} champ${fields.length>1?'s':''}`:''} 
              </div>
            </div>
            <div style="text-align:right">
              <span style="font-size:.72rem;color:${t.is_active?'var(--green)':'var(--text-4)'};font-weight:600">${t.is_active?'Actif':'Inactif'}</span>
              <div style="font-size:.68rem;color:var(--text-4)">${t.sends_count||0} envois ¬∑ ${t.completed_count||0} compl√©t√©s</div>
            </div>
          </div>
          <div style="border-top:1px solid var(--border-light);padding:8px 20px;display:flex;gap:8px;justify-content:flex-end">
            <button onclick="openDocModal('${t.type}','${t.id}')" style="font-size:.78rem;padding:5px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);cursor:pointer">‚úèÔ∏è Modifier</button>
            <button onclick="toggleDocActive('${t.id}',${!t.is_active})" style="font-size:.78rem;padding:5px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);cursor:pointer">${t.is_active?'‚è∏ D√©sactiver':'‚ñ∂Ô∏è Activer'}</button>
            <button onclick="deleteDoc('${t.id}')" style="font-size:.78rem;padding:5px 12px;background:var(--red-bg);border:1px solid #F5C6C6;border-radius:var(--radius-xs);cursor:pointer;color:var(--red)">üóëÔ∏è</button>
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    c.innerHTML=h;
    window._docServices=services;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function openDocModal(type,editId){
  let existing=null;
  if(editId){try{const r=await api.get('/api/documents');existing=(r.templates||[]).find(t=>t.id===editId);}catch(e){}}
  const services=window._docServices||[];
  const isEdit=!!existing;
  const title=isEdit?'Modifier le document':type==='info'?"Nouvelle fiche d'info":type==='form'?'Nouveau formulaire':'Nouveau consentement';
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;display:flex;align-items:center;justify-content:center';
  modal.innerHTML=`<div style="background:var(--white);border-radius:var(--radius);padding:28px;width:620px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <h3 style="font-size:1.1rem;font-weight:700;margin:0">${title}</h3>
      <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer">&times;</button>
    </div>
    <div style="display:grid;gap:12px">
      <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Nom du document *</label>
        <input id="docName" value="${esc(existing?.name||'')}" placeholder="Ex: Fiche anamn&egrave;se premi&egrave;re consultation" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Prestation li&eacute;e</label>
          <select id="docService" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
            <option value="">Toutes les prestations</option>
            ${services.map(s=>`<option value="${s.id}" ${existing?.service_id===s.id?'selected':''}>${esc(s.name)}</option>`).join('')}
          </select></div>
        <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Envoyer J-</label>
          <input id="docDays" type="number" min="1" max="14" value="${existing?.send_days_before||2}" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
          <div style="font-size:.68rem;color:var(--text-4);margin-top:2px">Jours avant le RDV</div></div>
      </div>
      <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Objet email (optionnel)</label>
        <input id="docSubject" value="${esc(existing?.subject||'')}" placeholder="Par d&eacute;faut: nom du document + nom du cabinet" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem"></div>
      <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Contenu *</label>
        <textarea id="docContent" rows="6" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem;resize:vertical;font-family:inherit">${esc(existing?.content_html||'')}</textarea>
        <div style="font-size:.68rem;color:var(--text-4);margin-top:2px">HTML accept&eacute; : h2, p, ul, li, strong</div></div>
      ${type!=='info'?`<div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:6px">Champs du formulaire</label>
        <div id="docFields"></div>
        <button onclick="addDocField()" style="margin-top:6px;padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem;cursor:pointer">+ Ajouter un champ</button></div>`:''}
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
      <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:9px 18px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;cursor:pointer">Annuler</button>
      <button onclick="saveDoc('${type}','${editId||''}')" style="padding:9px 22px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.82rem;font-weight:600;cursor:pointer">${isEdit?'Enregistrer':'Cr&eacute;er'}</button>
    </div></div>`;
  document.body.appendChild(modal);
  if(type!=='info'&&existing?.form_fields?.length>0){existing.form_fields.forEach(f=>addDocField(f));}
}

let _docFieldIdx=0;
function addDocField(preset){
  const container=document.getElementById('docFields');if(!container)return;
  const idx=_docFieldIdx++;const fid=preset?.id||('f'+idx);
  const row=document.createElement('div');
  row.style.cssText='display:grid;grid-template-columns:1fr 120px 30px 30px;gap:6px;align-items:center;margin-bottom:6px';
  row.innerHTML=`<input class="df-label" value="${esc(preset?.label||'')}" placeholder="Libell&eacute; du champ" data-fid="${fid}" style="padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem">
    <select class="df-type" style="padding:7px 6px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem">
      <option value="text" ${preset?.type==='text'?'selected':''}>Texte</option>
      <option value="textarea" ${preset?.type==='textarea'?'selected':''}>Zone texte</option>
      <option value="checkbox" ${preset?.type==='checkbox'?'selected':''}>Case</option>
      <option value="select" ${preset?.type==='select'?'selected':''}>Choix</option>
      <option value="date" ${preset?.type==='date'?'selected':''}>Date</option>
      <option value="email" ${preset?.type==='email'?'selected':''}>Email</option>
      <option value="phone" ${preset?.type==='phone'?'selected':''}>T&eacute;l</option>
    </select>
    <label style="font-size:.7rem;color:var(--text-4);display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" class="df-req" ${preset?.required?'checked':''} style="width:14px;height:14px">*</label>
    <button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:1rem">&times;</button>`;
  container.appendChild(row);
}

function collectDocFields(){
  const container=document.getElementById('docFields');if(!container)return[];
  const fields=[];
  container.querySelectorAll(':scope > div').forEach(row=>{
    const label=row.querySelector('.df-label')?.value?.trim();
    const type=row.querySelector('.df-type')?.value||'text';
    const required=row.querySelector('.df-req')?.checked||false;
    const fid=row.querySelector('.df-label')?.dataset.fid||('f'+Math.random().toString(36).slice(2,6));
    if(label)fields.push({id:fid,label,type,required});
  });
  return fields;
}

async function saveDoc(type,editId){
  const name=document.getElementById('docName')?.value?.trim();
  const content_html=document.getElementById('docContent')?.value?.trim();
  if(!name){BooktUI.toast('Nom requis','error');return;}
  if(!content_html){BooktUI.toast('Contenu requis','error');return;}
  const body={name,type,service_id:document.getElementById('docService')?.value||null,
    subject:document.getElementById('docSubject')?.value?.trim()||null,content_html,
    send_days_before:parseInt(document.getElementById('docDays')?.value||2),
    form_fields:type!=='info'?collectDocFields():[]};
  try{
    if(editId){await api.patch(`/api/documents/${editId}`,body);}
    else{await api.post('/api/documents',body);}
    document.querySelector('div[style*="position:fixed"][style*="inset:0"]')?.remove();
    BooktUI.toast(editId?'Document modifi&eacute;':'Document cr&eacute;&eacute; !','success');loadDocuments();
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

async function toggleDocActive(id,active){
  try{await api.patch(`/api/documents/${id}`,{is_active:active});BooktUI.toast(active?'Activ&eacute;':'D&eacute;sactiv&eacute;','success');loadDocuments();}catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

async function deleteDoc(id){
  if(!confirm('Supprimer ce document ?'))return;
  try{await api.delete(`/api/documents/${id}`);BooktUI.toast('Supprim&eacute;','success');loadDocuments();}catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

// ============================================================
// CALENDAR SYNC
// ============================================================

async function connectCalendar(provider){
  try{
    const r=await api.get(`/api/calendar/${provider}/connect`);
    if(r.url)window.location.href=r.url;
    else BooktUI.toast('Erreur de connexion','error');
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

async function disconnectCalendar(connId,provider){
  if(!confirm('D\u00e9connecter '+(provider==='google'?'Google Calendar':'Outlook')+' ?'))return;
  try{
    await api.delete(`/api/calendar/connections/${connId}`);
    BooktUI.toast('Calendrier d\u00e9connect\u00e9','success');
    loadSettings();
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

async function syncCalendar(connId){
  try{
    BooktUI.toast('Synchronisation en cours...','info');
    const r=await api.post(`/api/calendar/connections/${connId}/sync`);
    BooktUI.toast('Synchro termin\u00e9e : '+(r.pushed||0)+' pouss\u00e9s, '+(r.pulled||0)+' r\u00e9cup\u00e9r\u00e9s','success');
    loadSettings();
  }catch(e){BooktUI.toast(e.message||'Erreur synchro','error');}
}

async function updateCalSyncDirection(direction){
  try{
    const r=await api.get('/api/calendar/connections');
    const conns=r.connections||[];
    for(const c of conns){await api.patch('/api/calendar/connections/'+c.id,{sync_direction:direction});}
    BooktUI.toast('Direction de synchro mise \u00e0 jour','success');
  }catch(e){BooktUI.toast(e.message||'Erreur','error');}
}

// Handle OAuth callback params on page load
(function(){
  const p=new URLSearchParams(location.search);
  if(p.get('cal_connected')){
    const prov=p.get('cal_connected')==='google'?'Google Calendar':'Outlook';
    setTimeout(function(){BooktUI.toast(prov+' connect\u00e9 !','success');},500);
    history.replaceState(null,'','/dashboard');
    setTimeout(function(){
      document.querySelectorAll('.ni').forEach(function(n){n.classList.remove('active');});
      var el=document.querySelector('[data-section="settings"]');if(el)el.classList.add('active');
      document.getElementById('pageTitle').textContent='Param\u00e8tres';
      loadSettings();
    },600);
  }
  if(p.get('cal_error')){
    setTimeout(function(){BooktUI.toast('Erreur calendrier: '+p.get('cal_error'),'error');},500);
    history.replaceState(null,'','/dashboard');
  }
})();

// ============================================================
// APPELS (CALL FILTER)
// ============================================================
let callTab='logs';
async function loadCalls(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[setR,wlR,logR]=await Promise.all([
      fetch('/api/calls/settings',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/calls/whitelist',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/calls/logs',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const setD=await setR.json(), wlD=await wlR.json(), logD=await logR.json();
    const cs=setD.settings||{};
    const wl=wlD.whitelist||[];
    const logs=logD.logs||[];
    const st=logD.stats||{};

    // KPIs
    let h=`<div class="kpis">`;
    h+=`<div class="kpi"><div class="kpi-val">${st.total||0}</div><div class="kpi-label">Appels ce mois</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:var(--primary)">${st.filtered||0}</div><div class="kpi-label">üì± SMS envoy√©s</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:#15803d">${st.vip||0}</div><div class="kpi-label">‚≠ê VIP pass√©s</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:#B45309">${st.urgent||0}</div><div class="kpi-label">üö® Urgents</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:var(--primary)">${st.total>0?Math.round((st.converted||0)/st.total*100):0}%</div><div class="kpi-label">üìÖ Convertis</div></div>`;
    h+=`</div>`;

    // Tabs
    h+=`<div style="display:flex;gap:6px;margin-bottom:16px">`;
    h+=`<button class="btn-sm ${callTab==='logs'?'active':''}" onclick="callTab='logs';loadCalls()">üìã Journal</button>`;
    h+=`<button class="btn-sm ${callTab==='config'?'active':''}" onclick="callTab='config';loadCalls()">‚öôÔ∏è Configuration</button>`;
    h+=`<button class="btn-sm ${callTab==='whitelist'?'active':''}" onclick="callTab='whitelist';loadCalls()">‚≠ê VIP (${wl.length})</button>`;
    h+=`</div>`;

    if(callTab==='logs') h+=renderCallLogs(logs);
    else if(callTab==='config') h+=renderCallConfig(cs);
    else if(callTab==='whitelist') h+=renderCallWhitelist(wl);

    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function renderCallLogs(logs){
  let h=`<div class="card"><div class="card-h"><h3>Journal d'appels</h3><span class="badge badge-teal">${logs.length}</span></div>`;
  if(logs.length===0){
    h+=`<div class="empty">Aucun appel enregistr√©.<br><span style="font-size:.8rem;color:var(--text-4)">Les appels appara√Ætront ici une fois le filtre Twilio activ√©.</span></div>`;
  }else{
    const actionLabels={'whitelist_pass':'‚≠ê VIP','played_message':'üîä Message','forwarded':'üìû Transf√©r√©','sent_sms':'üì± SMS','urgent_key':'üö® Urgent','voicemail':'üìù Messagerie','hung_up':'‚ùå Raccroch√©'};
    const resultLabels={'ok':'‚úÖ','failed':'‚ùå','no_answer':'‚è≥'};
    h+=`<div style="overflow-x:auto"><table class="table"><thead><tr><th>Date</th><th>Num√©ro</th><th>Action</th><th>R√©sultat</th><th>Dur√©e</th><th>RDV</th></tr></thead><tbody>`;
    logs.forEach(l=>{
      const dt=new Date(l.created_at);
      const dateStr=dt.toLocaleDateString('fr-BE',{day:'numeric',month:'short'})+' '+dt.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
      const durStr=l.duration_sec>0?`${Math.floor(l.duration_sec/60)}:${String(l.duration_sec%60).padStart(2,'0')}`:'‚Äî';
      const booking=l.booking_id?'<span style="color:var(--primary)">üìÖ Oui</span>':'‚Äî';
      h+=`<tr><td style="font-size:.78rem;white-space:nowrap">${dateStr}</td><td style="font-family:monospace;font-size:.78rem">${l.from_phone_masked||l.from_phone||'‚Äî'}</td><td>${actionLabels[l.action]||l.action}</td><td>${resultLabels[l.result]||l.result}</td><td>${durStr}</td><td>${booking}</td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }
  h+=`</div>`;
  return h;
}

function renderCallConfig(cs){
  const mode=cs.filter_mode||'off';
  let h=`<div class="card"><div class="card-h"><h3>‚öôÔ∏è Configuration du filtre d'appels</h3></div>`;

  // Mode
  h+=`<div class="field"><label>Mode de filtrage</label><select id="call_mode" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:.88rem">`;
  h+=`<option value="off" ${mode==='off'?'selected':''}>üî¥ D√©sactiv√© ‚Äî Pas de filtrage</option>`;
  h+=`<option value="soft" ${mode==='soft'?'selected':''}>üü° Soft ‚Äî Message + option de transfert</option>`;
  h+=`<option value="strict" ${mode==='strict'?'selected':''}>üü¢ Strict ‚Äî SMS avec lien de r√©servation, pas de transfert</option>`;
  h+=`<option value="schedule_based" ${mode==='schedule_based'?'selected':''}>üìÖ Horaires ‚Äî Filtre actif hors disponibilit√©s</option>`;
  h+=`</select></div>`;

  // Explanation
  h+=`<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:.8rem;color:var(--text-4)">`;
  h+=`<strong>Comment √ßa fonctionne :</strong><br>`;
  h+=`Quand le filtre est actif, les appels entrants entendent un message vocal. Ils re√ßoivent un SMS avec votre lien de r√©servation. Les num√©ros VIP passent directement. En mode Soft, l'appelant peut taper 1 pour une urgence.`;
  h+=`</div>`;

  // Forward phone
  h+=`<div class="field-row"><div class="field"><label>üìû Num√©ro de transfert</label><input id="call_forward" value="${cs.forward_default_phone||''}" placeholder="+32 470 12 34 56"><div style="font-size:.72rem;color:var(--text-4);margin-top:2px">O√π transf√©rer les appels VIP et urgents</div></div>`;
  h+=`<div class="field"><label>üö® Num√©ro urgences</label><input id="call_urgent_phone" value="${cs.urgent_target_phone||''}" placeholder="Idem si vide"><div style="font-size:.72rem;color:var(--text-4);margin-top:2px">O√π vont les "Tapez 1" (par d√©faut = transfert)</div></div></div>`;

  // Toggles
  h+=`<div style="display:flex;flex-direction:column;gap:12px;margin:16px 0">`;
  h+=`<label style="display:flex;align-items:center;gap:10px;font-size:.85rem;cursor:pointer"><input type="checkbox" id="call_keypress" ${cs.allow_keypress_urgent!==false?'checked':''}><span><strong>Touche 1 = Urgence</strong><br><span style="font-size:.75rem;color:var(--text-4)">"Si c'est urgent, tapez 1 pour √™tre transf√©r√©"</span></span></label>`;
  h+=`<label style="display:flex;align-items:center;gap:10px;font-size:.85rem;cursor:pointer"><input type="checkbox" id="call_sms" ${cs.sms_after_call!==false?'checked':''}><span><strong>SMS automatique</strong><br><span style="font-size:.75rem;color:var(--text-4)">Envoie le lien de r√©servation par SMS apr√®s l'appel</span></span></label>`;
  h+=`<label style="display:flex;align-items:center;gap:10px;font-size:.85rem;cursor:pointer"><input type="checkbox" id="call_voicemail" ${cs.voicemail_enabled?'checked':''} onchange="document.getElementById('call_vm_texts').style.display=this.checked?'block':'none'"><span><strong>Messagerie vocale</strong><br><span style="font-size:.75rem;color:var(--text-4)">Permet de laisser un message vocal</span></span></label>`;
  h+=`</div>`;

  // Voicemail texts
  h+=`<div id="call_vm_texts" style="display:${cs.voicemail_enabled?'block':'none'}">`;
  h+=`<div class="field"><label>üá´üá∑ Message vocal FR</label><textarea id="call_vm_fr" rows="2" placeholder="Bonjour, vous √™tes bien chez [cabinet]. Nous ne pouvons pas prendre votre appel. R√©servez en ligne via le SMS que vous allez recevoir.">${cs.voicemail_text_fr||''}</textarea></div>`;
  h+=`<div class="field"><label>üá≥üá± Message vocal NL</label><textarea id="call_vm_nl" rows="2" placeholder="Goedendag, u bent verbonden met [kabinet]. We kunnen uw oproep niet beantwoorden...">${cs.voicemail_text_nl||''}</textarea></div>`;
  h+=`</div>`;

  h+=`<button class="btn-primary" onclick="saveCallSettings()" style="margin-top:8px">üíæ Enregistrer</button>`;
  h+=`</div>`;
  return h;
}

function renderCallWhitelist(wl){
  let h=`<div class="card"><div class="card-h"><h3>‚≠ê Num√©ros VIP</h3><button class="btn-primary btn-sm" onclick="addWhitelistEntry()">+ Ajouter</button></div>`;
  h+=`<div style="font-size:.8rem;color:var(--text-4);margin-bottom:12px">Ces num√©ros ne sont jamais filtr√©s ‚Äî l'appel passe directement sur votre t√©l√©phone.</div>`;
  if(wl.length===0){
    h+=`<div class="empty">Aucun num√©ro VIP configur√©</div>`;
  }else{
    h+=`<div style="overflow-x:auto"><table class="table"><thead><tr><th>Num√©ro</th><th>Label</th><th>Actif</th><th></th></tr></thead><tbody>`;
    wl.forEach(w=>{
      h+=`<tr><td style="font-family:monospace;font-size:.85rem">${w.phone_e164}</td><td>${w.label||'‚Äî'}</td><td>${w.is_active?'‚úÖ':'‚ùå'}</td>`;
      h+=`<td style="text-align:right"><button class="btn-outline btn-sm" onclick="editWhitelistEntry('${w.id}','${w.phone_e164}','${(w.label||'').replace(/'/g,"\\'")}',${w.is_active})">‚úèÔ∏è</button> <button class="btn-outline btn-sm btn-danger" onclick="if(confirm('Supprimer ce num√©ro VIP ?'))deleteWhitelistEntry('${w.id}')">üóëÔ∏è</button></td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }
  h+=`</div>`;
  return h;
}

async function saveCallSettings(){
  try{
    const body={
      filter_mode:document.getElementById('call_mode').value,
      forward_default_phone:document.getElementById('call_forward').value||null,
      urgent_target_phone:document.getElementById('call_urgent_phone').value||null,
      allow_keypress_urgent:document.getElementById('call_keypress').checked,
      sms_after_call:document.getElementById('call_sms').checked,
      voicemail_enabled:document.getElementById('call_voicemail').checked,
      voicemail_text_fr:document.getElementById('call_vm_fr')?.value||null,
      voicemail_text_nl:document.getElementById('call_vm_nl')?.value||null
    };
    const r=await fetch('/api/calls/settings',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    BooktUI.toast('Configuration sauvegard√©e','success');
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

function addWhitelistEntry(){
  const phone=prompt('Num√©ro au format international (ex: +32 470 12 34 56):');
  if(!phone)return;
  const label=prompt('Label (ex: Labo, Pharmacie, Urgences):');
  fetch('/api/calls/whitelist',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({phone_e164:phone.replace(/\s/g,''),label:label||null})})
    .then(r=>{if(!r.ok)throw new Error('Erreur');BooktUI.toast('Num√©ro VIP ajout√©','success');loadCalls();})
    .catch(e=>BooktUI.toast('Erreur: '+e.message,'error'));
}

function editWhitelistEntry(id,phone,label,active){
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>Modifier num√©ro VIP</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="modal-body">`;
  m+=`<div class="field"><label>Num√©ro</label><input id="wl_phone" value="${phone}"></div>`;
  m+=`<div class="field"><label>Label</label><input id="wl_label" value="${label}"></div>`;
  m+=`<label style="display:flex;align-items:center;gap:8px;margin-top:8px;font-size:.85rem"><input type="checkbox" id="wl_active" ${active?'checked':''}> Actif</label>`;
  m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveWhitelistEntry('${id}')">Enregistrer</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveWhitelistEntry(id){
  try{
    const body={phone_e164:document.getElementById('wl_phone').value.replace(/\s/g,''),label:document.getElementById('wl_label').value||null,is_active:document.getElementById('wl_active').checked};
    const r=await fetch(`/api/calls/whitelist/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    BooktUI.toast('Num√©ro VIP modifi√©','success');loadCalls();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}

async function deleteWhitelistEntry(id){
  try{
    const r=await fetch(`/api/calls/whitelist/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    BooktUI.toast('Num√©ro VIP supprim√©','success');loadCalls();
  }catch(e){BooktUI.toast('Erreur: '+e.message,'error');}
}
</script>
</body>
</html>
