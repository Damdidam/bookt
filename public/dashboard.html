<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard — Genda</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#F8F7F5;--white:#FFF;--bg-card:#FAFAF8;--surface:#F2F0ED;--surface-2:#E8E5E1;--border:#DDD9D3;--border-light:#E8E5E0;
  --text:#1A1816;--text-2:#3D3832;--text-3:#6B6560;--text-4:#9C958E;
  --primary:#0D7377;--primary-hover:#0A5E61;--primary-light:#EDF8F7;--primary-soft:#CCEBE8;
  --green:#1B7A42;--green-bg:#EEFAF1;--gold:#A68B3C;--gold-bg:#FAF6EC;--red:#C62828;--red-bg:#FEF2F2;
  --sidebar-bg:#181613;--sidebar-hover:#252220;--sidebar-active:rgba(13,115,119,.9);
  --serif:'Instrument Serif',Georgia,serif;--sans:'Plus Jakarta Sans',-apple-system,sans-serif;
  --shadow-xs:0 1px 2px rgba(0,0,0,.04);--shadow:0 2px 8px rgba(0,0,0,.06);--shadow-md:0 4px 16px rgba(0,0,0,.08);--shadow-lg:0 8px 32px rgba(0,0,0,.1);
  --radius:14px;--radius-sm:10px;--radius-xs:6px;
  --transition:all .2s cubic-bezier(.4,0,.2,1)
}
body{background:var(--bg);color:var(--text);font-family:var(--sans);-webkit-font-smoothing:antialiased;line-height:1.5}

/* ===== SIDEBAR ===== */
.sidebar{position:fixed;top:0;left:0;bottom:0;width:234px;background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;z-index:50;border-right:1px solid rgba(255,255,255,.04)}
.sb-logo{padding:20px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-logo .l{width:32px;height:32px;border-radius:9px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:.9rem;font-weight:400;box-shadow:0 2px 8px rgba(13,115,119,.35)}
.sb-logo .w{font-size:.85rem;font-weight:700;letter-spacing:.3px}
.sb-logo .plan{font-size:.55rem;font-weight:700;background:rgba(255,255,255,.1);padding:2px 6px;border-radius:4px;margin-left:auto;color:rgba(255,255,255,.4);letter-spacing:.5px}
.sb-nav{padding:12px 10px;flex:1;overflow-y:auto}
.sb-nav::-webkit-scrollbar{width:0}
.sb-label{font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,.2);padding:14px 12px 6px;user-select:none}
.ni{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.45);cursor:pointer;transition:var(--transition);text-decoration:none;margin-bottom:1px;position:relative}
.ni:hover{background:var(--sidebar-hover);color:rgba(255,255,255,.85)}
.ni.active{background:var(--sidebar-active);color:#fff;font-weight:600;box-shadow:0 2px 8px rgba(13,115,119,.2)}
.ni .ic{width:18px;text-align:center;font-size:.88rem;flex-shrink:0}
.sb-foot{padding:16px 18px;border-top:1px solid rgba(255,255,255,.06);background:rgba(0,0,0,.15)}
.sb-foot .nm{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-foot .rl{font-size:.65rem;color:rgba(255,255,255,.3);margin-top:1px}
.sb-foot .logout{font-size:.68rem;color:rgba(255,255,255,.25);cursor:pointer;margin-top:6px;text-decoration:none;transition:color .15s;display:inline-block}
.sb-foot .logout:hover{color:rgba(255,255,255,.6)}

/* ===== MAIN + TOPBAR ===== */
.main{margin-left:234px;min-height:100vh}
.topbar{position:sticky;top:0;background:rgba(248,247,245,.88);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--border-light);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;z-index:40}
.topbar h1{font-family:var(--serif);font-size:1.35rem;font-weight:400;color:var(--text)}
.content{padding:28px 32px;max-width:1120px}

/* ===== STAT CARDS (Home) ===== */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.stat-card{background:var(--white);border-radius:var(--radius-sm);border:1px solid var(--border-light);padding:18px 20px;transition:var(--transition)}
.stat-card:hover{box-shadow:var(--shadow);border-color:var(--border)}
.stat-card .label{font-size:.68rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
.stat-card .val{font-family:var(--serif);font-size:1.7rem;color:var(--text);line-height:1}
.stat-card .sub{font-size:.7rem;color:var(--text-4);margin-top:4px}

/* ===== KPI CARDS (Clients, Calls, reusable) ===== */
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.kpi{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:16px 18px;text-align:center;transition:var(--transition);cursor:default}
.kpi:hover{box-shadow:var(--shadow);border-color:var(--border)}
.kpi-val{font-family:var(--serif);font-size:1.6rem;line-height:1;color:var(--text)}
.kpi-label{font-size:.68rem;font-weight:600;color:var(--text-4);text-transform:uppercase;letter-spacing:.4px;margin-top:6px}

/* ===== CARDS ===== */
.card{background:var(--white);border-radius:var(--radius);border:1px solid var(--border-light);overflow:hidden;margin-bottom:16px;transition:var(--transition)}
.card:hover{box-shadow:var(--shadow-xs)}
.card-h{padding:16px 20px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.card-h h3{font-size:.9rem;font-weight:700;color:var(--text)}
.badge{font-size:.68rem;font-weight:700;padding:3px 9px;border-radius:10px}
.badge-teal{background:var(--primary-light);color:var(--primary)}

/* ===== QUICK LINK ===== */
.qlink{background:linear-gradient(135deg,#0D7377 0%,#0A5E61 60%,#084547 100%);border-radius:var(--radius);padding:18px 22px;color:#fff;display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;box-shadow:0 4px 20px rgba(13,115,119,.2)}
.qlink .info h4{font-size:.9rem;font-weight:600;margin-bottom:2px}
.qlink .info p{font-size:.75rem;opacity:.55}
.qlink a{padding:8px 16px;background:rgba(255,255,255,.15);border-radius:var(--radius-xs);font-size:.78rem;font-weight:600;color:#fff;text-decoration:none;transition:var(--transition);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.1)}
.qlink a:hover{background:rgba(255,255,255,.25)}

/* ===== BOOKINGS / ROWS ===== */
.bk-row{display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid var(--border-light);transition:background .1s}
.bk-row:last-child{border:none}
.bk-row:hover{background:var(--surface)}
.bk-status{padding:3px 10px;border-radius:10px;font-size:.68rem;font-weight:600;white-space:nowrap}
.bk-status.confirmed{background:var(--green-bg);color:var(--green)}
.bk-status.pending{background:var(--gold-bg);color:var(--gold)}
.bk-status.completed{background:var(--surface);color:var(--text-3)}
.bk-status.noshow{background:#FFF3CD;color:#856404}
.bk-status.cancelled{background:var(--red-bg);color:var(--red)}
.empty{padding:44px 20px;text-align:center;color:var(--text-4);font-size:.88rem;line-height:1.6}
.loading{text-align:center;padding:48px;color:var(--text-4)}
.spinner{display:inline-block;width:26px;height:26px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== BUTTONS ===== */
.btn-primary{padding:9px 18px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:6px}
.btn-primary:hover{background:var(--primary-hover);box-shadow:0 2px 8px rgba(13,115,119,.25)}
.btn-outline{padding:9px 18px;background:var(--white);color:var(--text-2);border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn-outline:hover{background:var(--surface);border-color:var(--border)}
.btn-sm{padding:6px 12px;font-size:.75rem;border-radius:7px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-family:var(--sans);font-weight:600;color:var(--text-3);transition:var(--transition)}
.btn-sm:hover{background:var(--surface);border-color:var(--border)}
.btn-sm.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 2px 6px rgba(13,115,119,.2)}
.btn-danger{background:var(--red-bg);color:var(--red);border-color:#FECACA}
.btn-danger:hover{background:#FEE2E2}

/* ===== TABLES ===== */
.table{width:100%;border-collapse:collapse}
.table th{text-align:left;padding:11px 16px;font-size:.7rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border-light);background:var(--surface)}
.table td{padding:11px 16px;font-size:.84rem;border-bottom:1px solid var(--border-light);vertical-align:middle}
.table tr:hover td{background:rgba(13,115,119,.02)}
.table .client-name{font-weight:600;cursor:pointer;color:var(--primary);transition:color .15s}
.table .client-name:hover{color:var(--primary-hover);text-decoration:underline}
.c-status{padding:2px 8px;border-radius:8px;font-size:.68rem;font-weight:600}
.c-status.regulier{background:var(--green-bg);color:var(--green)}
.c-status.nouveau{background:var(--primary-light);color:var(--primary)}
.c-status.no_show{background:var(--red-bg);color:var(--red)}

/* ===== SEARCH BAR ===== */
.search-bar{display:flex;gap:8px;margin-bottom:16px}
.search-bar input{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none;transition:var(--transition)}
.search-bar input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,115,119,.08)}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(24,22,19,.5);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s}
.modal{background:var(--white);border-radius:16px;width:100%;max-width:540px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .25s cubic-bezier(.4,0,.2,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-h{padding:18px 22px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.modal-h h3{font-size:.95rem;font-weight:700}
.modal-h .close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-4);padding:4px 6px;border-radius:6px;transition:var(--transition)}
.modal-h .close:hover{background:var(--surface);color:var(--text)}
.modal-body{padding:22px}
.modal-foot{padding:16px 22px;border-top:1px solid var(--border-light);display:flex;justify-content:flex-end;gap:8px;background:var(--surface)}
.field{margin-bottom:14px}
.field label{display:block;font-size:.78rem;font-weight:600;color:var(--text-3);margin-bottom:5px}
.field input,.field select,.field textarea{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none;transition:var(--transition)}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,115,119,.08)}
.field textarea{resize:vertical;min-height:72px}
.field-row{display:flex;gap:12px}
.field-row .field{flex:1}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* ===== FULLCALENDAR AGENDA ===== */
.prac-filters{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
/* Agenda sticky toolbar: elements stick below the topbar during page scroll */
.content.agenda-active{padding-bottom:0}
.content.agenda-active .prac-filters{position:sticky;top:57px;z-index:30;background:var(--surface);padding:10px 0 8px;margin-bottom:0}
.content.agenda-active .fc .fc-header-toolbar{position:sticky;top:99px;z-index:29;background:var(--surface);padding:6px 0;margin-bottom:0!important}
.content.agenda-active .fc .fc-scrollgrid-section-header{position:sticky;top:139px;z-index:28}
.content.agenda-active .fc .fc-scrollgrid-section-header>*{position:sticky!important;top:139px!important;z-index:28;background:var(--white)}
.content.agenda-active .fc .fc-col-header{background:var(--white)}
.prac-pill{padding:6px 14px;border-radius:100px;font-size:.73rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border-light);background:var(--white);color:var(--text-3);transition:var(--transition);display:flex;align-items:center;gap:6px}
.prac-pill:hover{border-color:var(--text-4)}
.prac-pill.active{border-color:var(--primary-soft);background:var(--primary-light);color:var(--primary)}
.prac-pill .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.fc{font-family:var(--sans)}.fc .fc-toolbar-title{font-family:var(--serif);font-size:1.2rem!important;font-weight:400;color:var(--text)}
.fc .fc-button{font-family:var(--sans);font-weight:600;font-size:.78rem;text-transform:none;padding:6px 14px;border-radius:var(--radius-xs);border:1.5px solid var(--border);background:var(--white);color:var(--text-2);box-shadow:none}
.fc .fc-button:hover{background:var(--surface);border-color:var(--text-4)}
.fc .fc-button-active,.fc .fc-button:active{background:var(--primary-light)!important;color:var(--primary)!important;border-color:var(--primary-soft)!important;box-shadow:none!important}
.fc .fc-button-primary:not(:disabled):active,.fc .fc-button-primary:not(:disabled).fc-button-active{background:var(--primary-light);color:var(--primary);border-color:var(--primary-soft)}
.fc .fc-today-button{background:var(--primary);color:#fff;border-color:var(--primary)}.fc .fc-today-button:hover{background:var(--primary-hover)}.fc .fc-today-button:disabled{opacity:.5}
.fc .fc-col-header-cell{font-size:.72rem;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px;padding:10px 0}
.fc .fc-scrollgrid{border:1px solid var(--border-light);border-radius:var(--radius)}
.fc td,.fc th{border-color:var(--border-light)}
.fc .fc-day-today{background:var(--primary-light)!important}
.fc .fc-timegrid-slot{height:18px}
.fc .fc-timegrid-slot-label-cushion{font-size:.7rem;color:var(--text-4);font-weight:500}
.fc .fc-timegrid-now-indicator-line{border-color:var(--primary);border-width:2px}
.fc .fc-timegrid-now-indicator-arrow{border-color:var(--primary)}
.fc .fc-event{border:none;border-radius:6px;padding:2px 6px;font-size:.72rem;cursor:pointer;transition:transform .1s,box-shadow .1s;overflow:hidden}
.fc .fc-event:hover{transform:scale(1.02);box-shadow:0 2px 8px rgba(0,0,0,.12);z-index:10!important}
.fc .fc-event-dragging{box-shadow:var(--shadow-md);opacity:.9}
.fc .fc-timegrid-event .fc-event-main{padding:4px 6px}
.fc .fc-daygrid-event{margin:1px 3px}
/* Month view compact pills */
.ev-month-pill{font-size:.68rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;padding:1px 4px;line-height:1.4}
.ev-month-pill strong{font-weight:700}
.fc .fc-daygrid-day-frame{min-height:80px}
.fc .fc-daygrid-day-top{display:flex;justify-content:flex-end}
.fc .fc-daygrid-day-number{font-size:.78rem;font-weight:600;color:var(--text-3);padding:4px 8px;cursor:pointer;text-decoration:none}
.fc .fc-daygrid-day-number:hover{color:var(--primary)}
.fc .fc-day-today .fc-daygrid-day-number{background:var(--primary);color:#fff;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;padding:0;margin:4px 4px 0 0}
.fc .fc-daygrid-more-link{font-size:.68rem;font-weight:600;color:var(--primary);padding:2px 6px}
.fc .fc-daygrid-event-harness{margin-bottom:1px}
/* Popover for "+X more" */
.fc .fc-popover{border-radius:var(--radius);border:1px solid var(--border-light);box-shadow:0 4px 16px rgba(0,0,0,.1)}
.fc .fc-popover-header{font-size:.78rem;font-weight:600;padding:8px 12px;background:var(--surface);border-radius:var(--radius) var(--radius) 0 0}
.fc .fc-popover-body{padding:4px 8px}

/* Event inner */
.ev-inner{display:flex;flex-direction:column;gap:1px;overflow:hidden;position:relative}
.ev-inner .ev-client{font-weight:700;font-size:.72rem;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ev-inner .ev-service{font-size:.62rem;opacity:.75;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ev-inner .ev-badges{position:absolute;top:2px;right:2px;display:flex;gap:2px}
.ev-inner .ev-badge{width:6px;height:6px;border-radius:50%;opacity:.8}
.ev-inner .ev-badge-note{background:#fff}.ev-inner .ev-badge-todo{background:#FBBF24}.ev-inner .ev-badge-mod{background:#D97706}

/* Event status borders */
.ev-pending{border-left:3px solid var(--gold)!important}
.ev-confirmed{border-left:3px solid var(--green)!important}
.ev-modified_pending{border-left:3px solid #D97706!important;background-image:repeating-linear-gradient(135deg,transparent,transparent 4px,rgba(217,119,6,.07) 4px,rgba(217,119,6,.07) 8px)!important}
.ev-completed{border-left:3px solid var(--text-4)!important;opacity:.6}
.ev-no_show{border-left:3px solid var(--red)!important;opacity:.5}
.ev-cancelled{border-left:3px solid var(--red)!important;opacity:.3;text-decoration:line-through}
.ev-group-badge{display:inline-block;font-size:.55rem;background:rgba(255,255,255,.25);color:#fff;padding:0 4px;border-radius:3px;margin-left:4px;vertical-align:middle}
/* Multi-service quick create */
.qc-svc-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg-card);border:1.5px solid var(--border);border-radius:8px;margin-bottom:6px}
/* Group visual: thin divider between services */
.ev-group-first .fc-event-main{border-top-left-radius:6px;border-top-right-radius:6px}
.ev-group-mid .fc-event-main{border-radius:0}
.ev-group-last .fc-event-main{border-bottom-left-radius:6px;border-bottom-right-radius:6px}
.ev-group-first,.ev-group-mid{margin-bottom:0!important}
.ev-grouped{position:relative}
.ev-grouped:not(.ev-group-first)::before{content:'';position:absolute;top:0;left:4px;right:4px;height:1px;background:rgba(255,255,255,.35);z-index:1}
/* Ghost block during group drag */
.ev-group-ghost{opacity:.3!important;pointer-events:none!important;transition:none!important}
.qc-svc-item select{flex:1;font-size:.82rem;padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg)}
.qc-svc-item .qc-svc-dur{font-size:.72rem;color:var(--text-4);white-space:nowrap;min-width:50px}
.qc-svc-item .qc-svc-color{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.qc-svc-item .qc-svc-rm{background:none;border:none;cursor:pointer;font-size:.9rem;color:var(--text-4);padding:2px 6px;border-radius:4px}
.qc-svc-item .qc-svc-rm:hover{background:var(--red);color:#fff}
.qc-svc-item .qc-svc-handle{cursor:grab;color:var(--text-4);font-size:.75rem;user-select:none}

/* ===== COLOR SWATCHES (replaces color pickers) ===== */
.csw{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.csw-dot{width:24px;height:24px;border-radius:8px;cursor:pointer;border:2.5px solid transparent;transition:all .12s;flex-shrink:0;position:relative}
.csw-dot:hover{transform:scale(1.15)}
.csw-dot.active{border-color:var(--text);box-shadow:0 0 0 2px var(--white),0 0 0 4px currentColor}
.csw-inline{display:inline-flex;gap:4px;flex-wrap:wrap;align-items:center;vertical-align:middle}
.csw-inline .csw-dot{width:20px;height:20px;border-radius:6px;border-width:2px}

/* ===== CALENDAR DETAIL MODAL ===== */
.cal-modal-overlay{position:fixed;inset:0;background:rgba(24,22,19,.45);backdrop-filter:blur(4px);z-index:300;display:none;align-items:center;justify-content:center;padding:24px}
.cal-modal-overlay.open{display:flex}
.cal-modal{background:var(--white);border-radius:18px;width:100%;max-width:540px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .35s cubic-bezier(.22,1,.36,1)}
@keyframes modalIn{from{opacity:0;transform:translateY(12px) scale(.98)}to{opacity:1;transform:none}}
#calDetailModal .cal-modal{overflow:hidden;display:flex;flex-direction:column}
.cal-modal-body{padding:20px 24px 0;overflow-y:auto;flex:1;min-height:0}
#calDetailModal .cal-modal-body{padding-bottom:16px}
.cal-panel{display:none}.cal-panel.active{display:block}

/* ── Header with color gradient ── */
.m-header{position:relative;overflow:hidden;flex-shrink:0}
.m-header-bg{height:72px;position:relative}
.m-header-bg::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,transparent 20%,var(--white) 100%)}
.m-header-content{padding:0 24px;position:relative;margin-top:-36px;z-index:2}
.m-close{position:absolute;top:14px;right:14px;z-index:10;width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.85rem;color:var(--text-3);transition:all .15s}
.m-close:hover{background:var(--white);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.1)}

/* ── Client hero ── */
.m-client-hero{display:flex;align-items:flex-end;gap:14px;margin-bottom:16px}
.m-avatar{width:52px;height:52px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1rem;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.15);flex-shrink:0;border:3px solid var(--white)}
.m-client-info{flex:1;min-width:0}
.m-client-name{font-family:var(--serif);font-size:1.35rem;font-weight:400;color:var(--text);line-height:1.2;display:flex;align-items:center;gap:8px}
.m-client-name a{color:inherit;text-decoration:none}.m-client-name a:hover{color:var(--primary)}
.m-client-meta{font-size:.72rem;color:var(--text-4);margin-top:2px;display:flex;gap:8px;align-items:center}
.m-client-meta a{color:var(--text-4);text-decoration:none}.m-client-meta a:hover{color:var(--primary)}
.m-free-tag{font-size:.55rem;font-family:var(--sans);font-weight:800;padding:2px 7px;border-radius:5px;letter-spacing:.5px}
.m-quick-actions{display:flex;gap:4px;margin-left:auto;flex-shrink:0;align-self:center}
.m-qbtn{width:32px;height:32px;border-radius:50%;border:1.5px solid var(--border-light);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.78rem;color:var(--text-3);transition:all .15s;text-decoration:none}
.m-qbtn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}

/* ── Status strip ── */
.m-status-strip{display:flex;align-items:center;gap:8px;padding:10px 16px;margin:0 24px 16px;background:var(--surface);border-radius:10px;flex-shrink:0}
.m-st-current{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:100px;font-size:.72rem;font-weight:700}
.m-st-dot{width:7px;height:7px;border-radius:50%}
.m-st-actions{display:flex;gap:4px;margin-left:auto;flex-wrap:wrap}
.m-st-btn{padding:5px 12px;border-radius:100px;font-size:.68rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border-light);background:var(--white);color:var(--text-3);transition:all .15s;font-family:var(--sans)}
.m-st-btn:hover{border-color:var(--text-4)}
.m-st-btn.green{color:var(--green);border-color:#B8E6C8;background:var(--green-bg)}.m-st-btn.green:hover{background:#D4F0DC}
.m-st-btn.red{color:var(--red);border-color:#F5C4C4;background:var(--red-bg)}.m-st-btn.red:hover{background:#FDE8E8}
.st-pending{background:var(--gold-bg);color:var(--gold)}.st-confirmed{background:var(--green-bg);color:var(--green)}.st-modified_pending{background:#FFF7ED;color:#D97706}.st-completed{background:var(--surface);color:var(--text-4)}.st-cancelled,.st-no_show{background:var(--red-bg);color:var(--red)}

/* ── Tabs ── */
.m-tabs{display:flex;gap:0;padding:0 24px;border-bottom:1px solid var(--border-light);flex-shrink:0}
.m-tab{padding:10px 16px;font-size:.75rem;font-weight:600;color:var(--text-4);cursor:pointer;border-bottom:2.5px solid transparent;transition:all .15s;position:relative;margin-bottom:-1px;white-space:nowrap}
.m-tab:hover{color:var(--text-2)}.m-tab.active{color:var(--primary);border-bottom-color:var(--primary)}
.tab-count{position:absolute;top:5px;right:2px;width:16px;height:16px;border-radius:50%;background:var(--primary);color:#fff;font-size:.55rem;font-weight:800;display:flex;align-items:center;justify-content:center}

/* ── Service card ── */
.m-svc-card{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--surface);border-radius:10px;margin-bottom:16px;border-left:4px solid}
.m-svc-name{font-size:.88rem;font-weight:700;color:var(--text)}
.m-svc-meta{font-size:.72rem;color:var(--text-4)}
.m-svc-price{margin-left:auto;font-size:.88rem;font-weight:700;color:var(--text)}

/* ── Freestyle card ── */
.m-free-card{padding:12px 16px;background:#FFFEF5;border:1.5px dashed #E8D48B;border-radius:10px;margin-bottom:16px}
.m-free-badge{padding:3px 8px;border-radius:6px;font-size:.62rem;font-weight:800;background:#F5ECD0;color:#8B6914;letter-spacing:.5px}
.m-free-title{flex:1;font-size:.88rem;font-weight:700;color:var(--text);border:none;background:transparent;outline:none;font-family:var(--sans)}
.m-free-color{width:24px;height:24px;border-radius:8px;border:2px solid rgba(0,0,0,.08);cursor:pointer;flex-shrink:0;padding:0}

/* ── Sections ── */
.m-sec{margin-bottom:16px}
.m-sec-head{display:flex;align-items:center;gap:6px;margin-bottom:8px;padding-bottom:4px}
.m-sec-title{font-size:.68rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.6px}
.m-sec-line{flex:1;height:1px;background:var(--border-light);margin-left:8px}

/* ── Inputs ── */
.m-row{display:grid;gap:8px;margin-bottom:8px}
.m-row-3{grid-template-columns:1fr 1fr 1fr}
.m-row-2{grid-template-columns:1fr 1fr}
.m-field-label{font-size:.62rem;font-weight:700;color:var(--text-4);margin-bottom:3px;text-transform:uppercase;letter-spacing:.3px}
.m-input{width:100%;padding:9px 12px;border:1.5px solid var(--border-light);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none;color:var(--text);transition:all .15s}
.m-input:hover{border-color:var(--border)}.m-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,115,119,.06)}
textarea.m-input{resize:vertical;min-height:38px}
.m-input-note{background:#FFFEF5;border-color:#E8D48B}.m-input-note:focus{border-color:#C5A43E;box-shadow:0 0 0 3px rgba(166,139,60,.06)}

/* ── Duration chips ── */
.m-chips{display:flex;gap:4px;flex-wrap:wrap}
.m-chip{padding:5px 11px;border-radius:100px;font-size:.72rem;font-weight:600;background:var(--surface);color:var(--text-3);cursor:pointer;border:1.5px solid transparent;transition:all .12s}
.m-chip:hover{border-color:var(--border);background:var(--surface-2)}
.m-chip.active{background:var(--primary-light);color:var(--primary);border-color:var(--primary-soft)}

/* ── Practitioner dropdown ── */
.m-prac-wrap{position:relative}
.m-prac-dot{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:8px;height:8px;border-radius:50%;z-index:1}
.m-prac-wrap .m-input{padding-left:26px}

/* ── Group siblings ── */
.m-group-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;margin-bottom:3px;font-size:.78rem;border:1px solid var(--border-light)}
.m-group-item.current{background:var(--primary);color:#fff;border-color:var(--primary)}
.m-group-item .g-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.m-group-item .g-time{margin-left:auto;font-size:.72rem;opacity:.7}

/* ── Diff banner ── */
.diff{padding:3px 10px;border-radius:5px;font-size:.78rem;font-weight:600}
.diff-old{background:var(--red-bg);color:var(--red);text-decoration:line-through}
.diff-new{background:var(--green-bg);color:var(--green)}
.diff-arrow{color:var(--text-4);font-size:.9rem}

/* ── Notify panel ── */
.notify-panel{margin-top:16px;padding:16px;background:var(--surface);border-radius:var(--radius-sm);display:none}
.notify-panel h4{font-size:.82rem;font-weight:700;margin-bottom:10px}
.notify-options{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px}
.notify-opt{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 8px;border-radius:var(--radius-xs);border:1.5px solid var(--border-light);background:var(--white);cursor:pointer;font-size:.72rem;font-weight:600;color:var(--text-3);transition:all .15s}
.notify-opt:hover{border-color:var(--text-4)}
.notify-opt.selected{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
.notify-opt svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.notify-actions{display:flex;gap:8px;justify-content:flex-end}

/* ── Bottom bar ── */
.m-bottom{position:sticky;bottom:0;padding:14px 24px;margin:0 -24px;background:linear-gradient(180deg,rgba(255,255,255,0),var(--white) 20%);display:flex;gap:8px;align-items:center}
.m-btn{padding:10px 20px;border-radius:10px;font-size:.8rem;font-weight:700;cursor:pointer;border:none;transition:all .15s;font-family:var(--sans)}
.m-btn-primary{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(13,115,119,.25)}
.m-btn-primary:hover{background:var(--primary-hover);box-shadow:0 4px 16px rgba(13,115,119,.3)}
.m-btn-ghost{background:transparent;color:var(--text-3);padding:10px 14px}.m-btn-ghost:hover{color:var(--text);background:var(--surface)}
.m-btn-danger{background:transparent;color:var(--red);margin-left:auto;padding:10px 12px;font-size:.72rem}.m-btn-danger:hover{background:var(--red-bg)}

/* ── Legacy compat for sub-tabs + Quick Create ── */
.cal-modal-head{padding:22px 24px 0;display:flex;align-items:flex-start;justify-content:space-between}
.cal-modal-head h2{font-family:var(--serif);font-size:1.25rem;font-weight:400}
.cal-close{width:32px;height:32px;border-radius:8px;background:var(--surface);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text-3);transition:all .15s}
.cal-close:hover{background:var(--surface-2);color:var(--text)}
.cal-btn{padding:8px 16px;border-radius:var(--radius-xs);font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:var(--white);color:var(--text-2);transition:all .15s}
.cal-btn:hover{border-color:var(--text-4);background:var(--surface)}
.cal-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}.cal-btn.primary:hover{background:var(--primary-hover)}
.cal-btn.cal-green{background:var(--green);color:#fff;border-color:var(--green)}

/* Notes tab */
.note-card{position:relative;padding:12px;border-radius:var(--radius-xs);border:1px solid var(--border-light);margin-bottom:8px;transition:var(--transition)}
.note-card:hover{border-color:var(--primary-soft)}
.note-card.pinned{border-left:3px solid var(--primary);background:var(--primary-light)}
.note-content{font-size:.85rem;color:var(--text);line-height:1.5}
.note-meta{font-size:.68rem;color:var(--text-4);margin-top:6px}
.note-delete{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:5px;background:transparent;border:none;cursor:pointer;color:var(--text-4);font-size:.7rem;transition:var(--transition);display:flex;align-items:center;justify-content:center}
.note-delete:hover{background:var(--red-bg);color:var(--red)}
.add-note{margin-top:12px}
.add-note textarea{width:100%;padding:10px;border:1.5px solid var(--border);border-radius:var(--radius-xs);font-family:var(--sans);font-size:.85rem;resize:vertical;min-height:70px;outline:none;transition:var(--transition)}
.add-note textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,115,119,.08)}
.add-note-actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px}

/* Todos tab */
.todo-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--radius-xs);transition:var(--transition);margin-bottom:4px}
.todo-item:hover{background:var(--surface)}
.todo-item.done{opacity:.5}
.todo-item.done .todo-text{text-decoration:line-through}
.todo-check{width:22px;height:22px;border-radius:6px;border:2px solid var(--border);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:var(--primary);flex-shrink:0;transition:var(--transition)}
.todo-check:hover{border-color:var(--primary);background:var(--primary-light)}
.todo-text{font-size:.85rem;flex:1;color:var(--text)}
.todo-delete{width:22px;height:22px;border-radius:5px;background:transparent;border:none;cursor:pointer;color:var(--text-4);font-size:.7rem;transition:var(--transition);display:flex;align-items:center;justify-content:center}
.todo-delete:hover{background:var(--red-bg);color:var(--red)}
.add-todo{display:flex;gap:8px;margin-top:12px}
.add-todo input{flex:1;padding:10px;border:1.5px solid var(--border);border-radius:var(--radius-xs);font-family:var(--sans);font-size:.85rem;outline:none;transition:var(--transition)}
.add-todo input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,115,119,.08)}

/* Reminders tab */
.reminder-card{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--radius-xs);border:1px solid var(--border-light);margin-bottom:6px}
.reminder-icon{font-size:1rem}
.ri-time{font-size:.85rem;font-weight:600;color:var(--text)}.ri-channel{font-size:.72rem;color:var(--text-4)}
.reminder-delete{margin-left:auto;width:22px;height:22px;border-radius:5px;background:transparent;border:none;cursor:pointer;color:var(--text-4);font-size:.7rem;transition:var(--transition);display:flex;align-items:center;justify-content:center}
.reminder-delete:hover{background:var(--red-bg);color:var(--red)}
.add-reminder{display:flex;gap:8px;align-items:center;margin-top:12px}
.add-reminder select{padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius-xs);font-family:var(--sans);font-size:.85rem;outline:none;background:var(--white)}

/* Quick create */
.qc-row{margin-bottom:14px}
.qc-label{font-size:.72rem;font-weight:600;color:var(--text-3);margin-bottom:5px}
.qc-input{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none;transition:var(--transition)}
.qc-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,115,119,.08)}
.qc-row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.color-dots{display:flex;gap:6px}
.color-dot{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:var(--transition)}
.color-dot:hover{transform:scale(1.15)}.color-dot.active{border-color:var(--text);box-shadow:0 0 0 2px var(--white),0 0 0 4px var(--text)}
.qc-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}

/* Autocomplete */
.ac-results{position:absolute;top:100%;left:0;right:0;background:var(--white);border:1.5px solid var(--border);border-radius:0 0 8px 8px;max-height:180px;overflow-y:auto;z-index:10;box-shadow:var(--shadow)}
.ac-item{padding:9px 13px;cursor:pointer;font-size:.82rem;transition:background .1s}
.ac-item:hover{background:var(--primary-light)}
.ac-item .ac-name{font-weight:600;color:var(--text)}.ac-item .ac-meta{font-size:.72rem;color:var(--text-4)}
.ac-new{color:var(--primary);font-weight:600;font-style:italic}

/* Empty state */
.cal-empty{text-align:center;padding:24px;color:var(--text-4)}
.cal-empty .cal-empty-icon{font-size:1.4rem;margin-bottom:6px}

/* Toast */
.g-toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--sidebar-bg);color:#fff;padding:14px 22px;border-radius:12px;font-size:.85rem;display:flex;align-items:center;gap:14px;box-shadow:var(--shadow-lg);z-index:400;animation:toastIn .3s cubic-bezier(.4,0,.2,1)}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.g-toast button{padding:7px 14px;background:var(--primary);color:#fff;border:none;border-radius:7px;font-family:var(--sans);font-size:.8rem;font-weight:700;cursor:pointer;transition:var(--transition)}
.g-toast button:hover{background:var(--primary-hover)}
.g-toast .dismiss{background:transparent;color:rgba(255,255,255,.4);font-size:.75rem;padding:4px 8px}

/* ===== SERVICES ===== */
.svc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(285px,1fr));gap:14px}
.svc-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:18px;position:relative;border-left:4px solid var(--primary);transition:var(--transition)}
.svc-card:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
.svc-card h4{font-size:.9rem;font-weight:700;margin-bottom:5px;color:var(--text)}
.svc-card .svc-meta{font-size:.78rem;color:var(--text-4);margin-bottom:8px}
.svc-card .svc-price{font-family:var(--serif);font-size:1.15rem;color:var(--primary)}
.svc-card .svc-modes{display:flex;gap:4px;margin-top:8px}
.svc-card .mode-tag{padding:3px 9px;border-radius:6px;font-size:.65rem;font-weight:600;background:var(--surface);color:var(--text-3)}
.svc-card .svc-actions{display:flex;gap:5px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border-light)}
.svc-card.inactive{opacity:.45;border-left-color:var(--text-4)}

/* ===== HOURS / AVAILABILITY ===== */
.hours-schedule{margin-top:12px}
.pract-block{margin-bottom:24px}
.pract-block h4{font-size:.88rem;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.day-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border-light)}
.day-row .day-name{min-width:85px;font-size:.82rem;font-weight:600;color:var(--text-2)}
.day-row .slots{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.slot-chip{display:flex;align-items:center;gap:5px;padding:5px 12px;background:var(--primary-light);border-radius:7px;font-size:.78rem;color:var(--primary);font-weight:600;transition:var(--transition)}
.slot-chip:hover{background:var(--primary-soft)}
.slot-chip .remove-slot{background:none;border:none;cursor:pointer;font-size:.9rem;color:var(--primary);padding:0 2px;opacity:.4;transition:opacity .15s}
.slot-chip .remove-slot:hover{opacity:1}
.add-slot-btn{padding:5px 12px;border:1.5px dashed var(--border);border-radius:7px;font-size:.75rem;color:var(--text-4);cursor:pointer;background:transparent;font-family:var(--sans);transition:var(--transition)}
.add-slot-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
.day-closed{font-size:.78rem;color:var(--text-4);font-style:italic}

/* ===== ANALYTICS ===== */
.an-period{display:flex;gap:2px;background:var(--surface);border-radius:9px;padding:3px;margin-bottom:22px}
.an-period button{padding:7px 18px;border-radius:7px;font-size:.78rem;font-weight:600;color:var(--text-3);cursor:pointer;border:none;background:transparent;font-family:var(--sans);transition:var(--transition)}
.an-period button.active{background:var(--white);color:var(--text);box-shadow:var(--shadow-xs)}
.an-kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:22px}
.an-kpi .kpi{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:18px;text-align:center;transition:var(--transition)}
.an-kpi .kpi:hover{box-shadow:var(--shadow)}
.an-kpi .kpi .kv{font-family:var(--serif);font-size:1.5rem;color:var(--text);line-height:1}
.an-kpi .kpi .kl{font-size:.66rem;font-weight:600;color:var(--text-4);text-transform:uppercase;letter-spacing:.4px;margin-top:6px}
.chart-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius);padding:20px;margin-bottom:14px;transition:var(--transition)}
.chart-card:hover{box-shadow:var(--shadow-xs)}
.chart-card h4{font-size:.88rem;font-weight:700;margin-bottom:16px}
.chart-card canvas{width:100%;display:block}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.heatmap{display:grid;grid-template-columns:40px repeat(24,1fr);gap:1px;font-size:.55rem}
.heatmap .hl{display:flex;align-items:center;justify-content:flex-end;padding-right:4px;color:var(--text-4);font-weight:600}
.heatmap .hh{text-align:center;color:var(--text-4);font-weight:600;padding:2px 0}
.heatmap .hc{border-radius:3px;aspect-ratio:1;display:flex;align-items:center;justify-content:center;color:transparent;transition:var(--transition)}
.heatmap .hc:hover{color:var(--text);transform:scale(1.2)}
.top-svc-list{display:flex;flex-direction:column;gap:8px}
.top-svc-row{display:flex;align-items:center;gap:10px}
.top-svc-row .bar-wrap{flex:1;height:26px;background:var(--surface);border-radius:5px;overflow:hidden}
.top-svc-row .bar{height:100%;border-radius:5px;display:flex;align-items:center;padding-left:8px;font-size:.7rem;font-weight:600;color:#fff;min-width:20px}
.top-svc-row .sname{min-width:120px;font-size:.82rem;font-weight:600}
.top-svc-row .scount{min-width:40px;text-align:right;font-size:.82rem;color:var(--text-3)}
.status-legend{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
.status-legend .sl{display:flex;align-items:center;gap:5px;font-size:.78rem}
.status-legend .sl .dot{width:10px;height:10px;border-radius:50%}

/* ===== SETTINGS ===== */
.settings-card{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius);margin-bottom:16px;overflow:hidden;transition:var(--transition)}
.settings-card:hover{box-shadow:var(--shadow-xs)}
.settings-card .sc-h{padding:18px 22px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.settings-card .sc-h h3{font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:8px}
.settings-card .sc-body{padding:22px}
.settings-card .sc-body .field{margin-bottom:14px}
.settings-card .sc-body .field label{display:block;font-size:.78rem;font-weight:600;color:var(--text-3);margin-bottom:5px}
.settings-card .sc-body .field input,.settings-card .sc-body .field select,.settings-card .sc-body .field textarea{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:8px;font-family:var(--sans);font-size:.85rem;background:var(--white);outline:none;transition:var(--transition)}
.settings-card .sc-body .field input:focus,.settings-card .sc-body .field textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,115,119,.08)}
.settings-card .sc-body .field textarea{resize:vertical;min-height:80px}
.settings-card .sc-body .field-row{display:flex;gap:12px}
.settings-card .sc-body .field-row .field{flex:1}
.settings-card .sc-body .hint{font-size:.72rem;color:var(--text-4);margin-top:3px}
.settings-card .sc-foot{padding:14px 22px;border-top:1px solid var(--border-light);display:flex;justify-content:flex-end;gap:8px;background:var(--surface)}
.plan-card{display:flex;gap:20px;flex-wrap:wrap}
.plan-box{flex:1;min-width:200px;padding:22px;border:2px solid var(--border-light);border-radius:var(--radius-sm);text-align:center;position:relative;transition:var(--transition)}
.plan-box:hover{box-shadow:var(--shadow)}
.plan-box.current{border-color:var(--primary);background:var(--primary-light)}
.plan-box .plan-name{font-family:var(--serif);font-size:1.25rem;margin-bottom:4px}
.plan-box .plan-price{font-size:1.7rem;font-weight:700;color:var(--primary)}
.plan-box .plan-price span{font-size:.78rem;font-weight:400;color:var(--text-4)}
.plan-box ul{list-style:none;text-align:left;margin:12px 0;font-size:.8rem;color:var(--text-3)}
.plan-box ul li{padding:4px 0}
.plan-box ul li::before{content:'✓ ';color:var(--green);font-weight:700}
.plan-box .current-badge{position:absolute;top:-10px;right:12px;background:var(--primary);color:#fff;padding:2px 10px;border-radius:8px;font-size:.68rem;font-weight:700}
.danger-zone{background:var(--red-bg);border-color:#FECACA}
.danger-zone .sc-h{border-color:#FECACA}
.danger-zone .sc-h h3{color:var(--red)}
.copy-input{display:flex;gap:6px}
.copy-input input{flex:1;background:var(--surface);font-size:.78rem;font-family:monospace}
.copy-input button{flex-shrink:0}

/* ===== TEAM ===== */
.team-grid2{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
.team-member{background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius);padding:22px;position:relative;transition:var(--transition)}
.team-member:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
.team-member.inactive{opacity:.45}
.team-member .tm-header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.team-member .tm-avatar{width:50px;height:50px;border-radius:14px;color:#fff;display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:1.15rem;flex-shrink:0;box-shadow:var(--shadow-xs);overflow:hidden}
.team-member .tm-info h4{font-size:.95rem;font-weight:700;color:var(--text)}
.team-member .tm-info .tm-title{font-size:.78rem;color:var(--text-3)}
.team-member .tm-info .tm-email{font-size:.72rem;color:var(--text-4)}
.team-member .tm-stats{display:flex;gap:12px;margin-bottom:12px;padding:10px 0;border-top:1px solid var(--border-light);border-bottom:1px solid var(--border-light)}
.team-member .tm-stat{text-align:center;flex:1}
.team-member .tm-stat .v{font-weight:700;font-size:.9rem;color:var(--text)}
.team-member .tm-stat .l{font-size:.63rem;color:var(--text-4);text-transform:uppercase;letter-spacing:.3px}
.team-member .tm-badges{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
.team-member .tm-badge{padding:3px 9px;border-radius:6px;font-size:.65rem;font-weight:600}
.tm-badge.active{background:var(--green-bg);color:var(--green)}
.tm-badge.inactive{background:var(--red-bg);color:var(--red)}
.tm-badge.booking{background:var(--primary-light);color:var(--primary)}
.tm-badge.no-booking{background:var(--surface);color:var(--text-4)}
.tm-badge.has-login{background:var(--gold-bg);color:var(--gold)}
.team-member .tm-actions{display:flex;gap:6px;flex-wrap:wrap}

/* ===== THEME PICKER ===== */
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
.theme-card{background:var(--white);border:2px solid var(--border-light);border-radius:var(--radius);padding:0;cursor:pointer;transition:var(--transition);overflow:hidden;position:relative}
.theme-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.theme-card.active{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
.theme-card.locked{opacity:.6;cursor:default}
.theme-card.locked:hover{transform:none;border-color:var(--border-light);box-shadow:none}
.theme-preview{height:120px;position:relative;overflow:hidden}
.theme-preview .tp-nav{height:28px;display:flex;align-items:center;padding:0 10px;gap:6px}
.theme-preview .tp-nav .dot{width:14px;height:14px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.5rem;color:#fff}
.theme-preview .tp-nav .tp-name{font-size:.5rem;font-weight:700;flex:1}
.theme-preview .tp-nav .tp-cta{padding:2px 6px;border-radius:3px;font-size:.42rem;font-weight:700;color:#fff}
.theme-preview .tp-hero{padding:6px 10px}
.theme-preview .tp-hero h3{font-size:.6rem;font-weight:400;margin-bottom:2px;line-height:1.2}
.theme-preview .tp-hero p{font-size:.38rem;opacity:.5}
.theme-preview .tp-cards{display:flex;gap:4px;padding:0 10px}
.theme-preview .tp-card{flex:1;height:24px;border-radius:3px;border-width:1px;border-style:solid}
.theme-info{padding:12px 14px;border-top:1px solid var(--border-light)}
.theme-info h4{font-size:.85rem;font-weight:700;display:flex;align-items:center;gap:6px}
.theme-info p{font-size:.72rem;color:var(--text-4);margin-top:2px}
.th-badge{padding:2px 8px;border-radius:8px;font-size:.6rem;font-weight:700}
.th-free{background:var(--green-bg);color:var(--green)}
.th-pro{background:var(--gold-bg);color:var(--gold)}
.theme-card .check{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:50%;background:var(--primary);color:#fff;display:none;align-items:center;justify-content:center;font-size:.7rem;z-index:2}
.theme-card.active .check{display:flex}
.lock-icon{position:absolute;top:8px;right:8px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,.3);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.6rem;z-index:2}

/* ===== RESPONSIVE ===== */
@media(max-width:1000px){
  .sidebar{width:60px}
  .sidebar .w,.sidebar .plan,.ni span:not(.ic),.sb-foot .nm,.sb-foot .rl,.sb-foot .logout,.sb-label{display:none}
  .main{margin-left:60px}
  .content{padding:20px 16px}
  .topbar{padding:14px 16px}
  .stats{grid-template-columns:1fr 1fr}
  .kpis{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:800px){
  .an-kpi{grid-template-columns:repeat(2,1fr)}
  .chart-row{grid-template-columns:1fr}
  .theme-grid{grid-template-columns:1fr 1fr}
  .field-row{flex-direction:column;gap:0}
  .team-grid2{grid-template-columns:1fr}
  .plan-card{flex-direction:column}
  /* Calendar modal → almost full screen */
  .cal-modal{max-width:100%;border-radius:14px 14px 0 0;max-height:95vh}
  .cal-modal-body{padding:16px}
  .m-row-3{grid-template-columns:1fr 1fr}
  .notify-options{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:500px){
  .theme-grid{grid-template-columns:1fr}
  .stats{grid-template-columns:1fr}
}

/* ===== MOBILE CALENDAR OPTIMIZATIONS ===== */
@media(max-width:768px){
  /* Smaller FC buttons */
  .fc .fc-toolbar{flex-direction:column;gap:8px}
  .fc .fc-toolbar-chunk{display:flex;justify-content:center}
  .fc .fc-toolbar-title{font-size:1rem!important}
  .fc .fc-button{padding:5px 10px;font-size:.72rem}
  .fc .fc-timegrid-slot{height:18px}
  .fc .fc-timegrid-slot-label-cushion{font-size:.62rem}
  .fc .fc-col-header-cell{font-size:.6rem;padding:6px 0}

  /* Practitioner pills → scrollable row */
  .prac-filters{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;scrollbar-width:none}
  .prac-filters::-webkit-scrollbar{display:none}
  .prac-pill{flex-shrink:0;font-size:.68rem;padding:5px 11px}
  .content.agenda-active .prac-filters{top:49px;padding:6px 0}
  .content.agenda-active .fc .fc-header-toolbar{top:85px}
  .content.agenda-active .fc .fc-scrollgrid-section-header>*{top:125px!important}

  /* Modal → full screen bottom sheet */
  .cal-modal-overlay{padding:0;align-items:flex-end}
  .cal-modal{max-width:100%;max-height:92vh;border-radius:18px 18px 0 0;animation:slideUp .3s cubic-bezier(.4,0,.2,1)}
  @keyframes slideUp{from{opacity:0;transform:translateY(100%)}to{opacity:1;transform:translateY(0)}}
  .cal-modal-head{padding:16px 18px 0}
  .cal-modal-head h2{font-size:1.1rem}
  .m-tabs{padding:0 18px}
  .m-tab{padding:8px 10px;font-size:.72rem}
  .cal-modal-body{padding:16px 18px}
  .m-row-3{grid-template-columns:1fr}
  .m-status-strip{margin:0 18px 12px;flex-wrap:wrap}
  .m-st-actions{margin-left:0;width:100%;margin-top:6px}
  .m-st-btn{flex:1;text-align:center;font-size:.68rem;padding:7px 8px}
  .m-header-content{padding:0 18px}
  .m-client-hero{flex-wrap:wrap;gap:10px}
  .m-quick-actions{margin-left:0}
  .m-bottom{padding:14px 18px;margin:0 -18px}

  /* FAB — floating action button */
  .cal-fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--primary);color:#fff;border:none;font-size:1.6rem;cursor:pointer;box-shadow:0 4px 16px rgba(13,115,119,.4);z-index:100;display:flex;align-items:center;justify-content:center;transition:transform .15s,box-shadow .15s}
  .cal-fab:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(13,115,119,.5)}
  .cal-fab:active{transform:scale(.95)}

  /* Mobile list view */
  .mob-view-toggle{display:flex;gap:2px;background:var(--surface);border-radius:8px;padding:2px;margin-bottom:12px}
  .mob-vt{flex:1;padding:7px;border-radius:6px;font-size:.72rem;font-weight:600;text-align:center;cursor:pointer;border:none;background:transparent;color:var(--text-3);font-family:var(--sans);transition:var(--transition)}
  .mob-vt.active{background:var(--white);color:var(--text);box-shadow:var(--shadow-xs)}

  .mob-list{display:none}
  .mob-list.active{display:block}
  .mob-list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .mob-list-date{font-family:var(--serif);font-size:1.1rem;color:var(--text)}
  .mob-list-count{font-size:.72rem;font-weight:700;background:var(--primary-light);color:var(--primary);padding:3px 10px;border-radius:100px}
  .mob-list-nav{display:flex;gap:6px;margin-bottom:12px}
  .mob-nav-btn{width:36px;height:36px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;color:var(--text-3);transition:var(--transition)}
  .mob-nav-btn:hover{background:var(--surface);color:var(--text)}
  .mob-today-btn{padding:6px 14px;border-radius:7px;border:1.5px solid var(--border);background:var(--white);font-size:.72rem;font-weight:600;color:var(--text-3);cursor:pointer;font-family:var(--sans)}

  .mob-bk{display:flex;gap:12px;padding:14px;background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-xs);margin-bottom:8px;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden}
  .mob-bk:hover{border-color:var(--primary-soft);box-shadow:var(--shadow-xs)}
  .mob-bk:active{transform:scale(.985)}
  .mob-bk::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
  .mob-bk.st-confirmed::before{background:var(--green)}
  .mob-bk.st-pending::before{background:var(--gold)}
  .mob-bk.st-modified_pending::before{background:#D97706}
  .mob-bk.st-completed::before{background:var(--text-4)}
  .mob-bk.st-cancelled::before,.mob-bk.st-no_show::before{background:var(--red)}
  .mob-bk.st-completed,.mob-bk.st-cancelled{opacity:.5}
  .mob-bk-time{min-width:52px;text-align:center;flex-shrink:0}
  .mob-bk-time .t{font-size:.88rem;font-weight:700;color:var(--primary);line-height:1.2}
  .mob-bk-time .dur{font-size:.62rem;color:var(--text-4)}
  .mob-bk-info{flex:1;min-width:0}
  .mob-bk-info .name{font-size:.88rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mob-bk-info .svc{font-size:.72rem;color:var(--text-4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mob-bk-info .prac{font-size:.65rem;color:var(--text-4);margin-top:2px;display:flex;align-items:center;gap:4px}
  .mob-bk-info .prac .pdot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
  .mob-bk-status{font-size:.62rem;font-weight:700;padding:2px 8px;border-radius:100px;align-self:center;flex-shrink:0;white-space:nowrap}
  .mob-bk-badges{position:absolute;top:6px;right:6px;display:flex;gap:3px}
  .mob-bk-badges span{font-size:.55rem}

  .mob-empty{text-align:center;padding:40px 20px;color:var(--text-4)}
  .mob-empty-icon{font-size:2rem;margin-bottom:8px}
  .mob-empty-text{font-size:.88rem}
  .mob-empty-sub{font-size:.78rem;margin-top:4px}
}
/* Hide FAB and mobile toggle on desktop */
@media(min-width:769px){
  .cal-fab{display:none!important}
  .mob-view-toggle{display:none!important}
  .mob-list{display:none!important}
}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="sb-logo"><div class="l">G</div><span class="w">Genda</span><span class="plan" id="planBadge">FREE</span></div>
  <nav class="sb-nav">
    <a class="ni active" href="#" data-section="home"><span class="ic">📊</span><span>Dashboard</span></a>
    <div class="sb-label">Planning</div>
    <a class="ni" href="#" data-section="bookings"><span class="ic">📅</span><span>Agenda</span></a>
    <a class="ni" href="#" data-section="clients"><span class="ic">👤</span><span>Clients</span></a>
    <a class="ni" href="#" data-section="services"><span class="ic">💼</span><span>Prestations</span></a>
    <a class="ni" href="#" data-section="hours"><span class="ic">🕐</span><span>Disponibilités</span></a>
    <div class="sb-label">Cabinet</div>
    <a class="ni" href="#" data-section="team"><span class="ic">👥</span><span>Équipe</span></a>
    <a class="ni" href="#" data-section="site"><span class="ic">🌐</span><span>Mon site</span></a>
    <a class="ni" href="#" data-section="calls"><span class="ic">📞</span><span>Appels</span></a>
    <div class="sb-label">Admin</div>
    <a class="ni" href="#" data-section="invoices"><span class="ic">🧾</span><span>Facturation</span></a>
    <a class="ni" href="#" data-section="documents"><span class="ic">📄</span><span>Documents</span></a>
    <a class="ni" href="#" data-section="analytics"><span class="ic">📈</span><span>Statistiques</span></a>
    <a class="ni" href="#" data-section="settings"><span class="ic">⚙️</span><span>Paramètres</span></a>
  </nav>
  <div class="sb-foot">
    <div class="nm" id="userName">—</div>
    <div class="rl" id="userRole">—</div>
    <div class="logout" onclick="doLogout()">Déconnexion</div>
  </div>
</aside>
<div class="main">
  <div class="topbar"><h1 id="pageTitle">Dashboard</h1><div><span style="font-size:.78rem;color:var(--text-4)" id="todayDate"></span></div></div>
  <div class="content" id="contentArea"><div class="loading"><div class="spinner"></div><p style="margin-top:10px">Chargement...</p></div></div>
</div>
<!-- CALENDAR DETAIL MODAL -->
<div class="cal-modal-overlay" id="calDetailModal">
  <div class="cal-modal">
    <!-- Color gradient header -->
    <div class="m-header">
      <div class="m-header-bg" id="mHeaderBg"></div>
      <button class="m-close" onclick="closeCalModal('calDetailModal')">✕</button>
      <div class="m-header-content">
        <div class="m-client-hero" id="mClientHero"></div>
      </div>
    </div>
    <!-- Status strip -->
    <div class="m-status-strip" id="mStatusStrip"></div>
    <!-- Tabs -->
    <div class="m-tabs">
      <div class="m-tab active" data-tab="rdv" onclick="switchCalTab(this,'rdv')">RDV</div>
      <div class="m-tab" data-tab="notes" onclick="switchCalTab(this,'notes')">Notes<span class="tab-count" id="mCountNotes" style="display:none"></span></div>
      <div class="m-tab" data-tab="todos" onclick="switchCalTab(this,'todos')">Tâches<span class="tab-count" id="mCountTodos" style="display:none"></span></div>
      <div class="m-tab" data-tab="reminders" onclick="switchCalTab(this,'reminders')">Rappels</div>
    </div>
    <!-- Body (scrollable) -->
    <div class="cal-modal-body">
      <!-- UNIFIED RDV TAB -->
      <div class="cal-panel active" id="calPanelRdv">
        <!-- Service card (normal) -->
        <div class="m-svc-card" id="mSvcCard" style="display:none"></div>
        <!-- Freestyle card -->
        <div class="m-free-card" id="mFreeCard" style="display:none">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span class="m-free-badge">✦ LIBRE</span>
              <input class="m-free-title" id="uFreeLabel" placeholder="Intitulé du RDV...">
            </div>
            <div id="uFreeColorWrap"></div>
          </div>
        </div>
        <!-- Group siblings -->
        <div id="mGroupSiblings" style="display:none"></div>
        <!-- Horaire -->
        <div class="m-sec">
          <div class="m-sec-head"><span class="m-sec-title">🕐 Horaire</span><span class="m-sec-line"></span></div>
          <div class="m-row m-row-3">
            <div><div class="m-field-label">Date</div><input type="date" class="m-input" id="calEditDate"></div>
            <div><div class="m-field-label">Début</div><input type="time" class="m-input" id="calEditStart"></div>
            <div><div class="m-field-label">Fin</div><input type="time" class="m-input" id="calEditEnd"></div>
          </div>
          <div class="m-chips" id="calDurChips">
            <span class="m-chip" onclick="calSetDuration(15,this)">15</span>
            <span class="m-chip" onclick="calSetDuration(30,this)">30</span>
            <span class="m-chip" onclick="calSetDuration(45,this)">45</span>
            <span class="m-chip" onclick="calSetDuration(60,this)">1h</span>
            <span class="m-chip" onclick="calSetDuration(90,this)">1h30</span>
            <span class="m-chip" onclick="calSetDuration(120,this)">2h</span>
          </div>
        </div>
        <!-- Praticien -->
        <div class="m-sec">
          <div class="m-sec-head"><span class="m-sec-title">👤 Praticien</span><span class="m-sec-line"></span></div>
          <div class="m-prac-wrap">
            <span class="m-prac-dot" id="mPracDot"></span>
            <select class="m-input" id="uPracSelect"></select>
          </div>
        </div>
        <!-- Buffers (freestyle only) -->
        <div class="m-sec" id="mBufferSec" style="display:none">
          <div class="m-sec-head"><span class="m-sec-title">⏸️ Buffers</span><span class="m-sec-line"></span></div>
          <div class="m-row m-row-2">
            <div><div class="m-field-label">Avant (min)</div><input class="m-input" type="number" id="uBufBefore" value="0" min="0" step="5"></div>
            <div><div class="m-field-label">Après (min)</div><input class="m-input" type="number" id="uBufAfter" value="0" min="0" step="5"></div>
          </div>
        </div>
        <!-- Commentaire -->
        <div class="m-sec">
          <div class="m-sec-head"><span class="m-sec-title">💬 Commentaire</span><span class="m-sec-line"></span></div>
          <textarea class="m-input" id="uComment" rows="2" placeholder="Ajouter un commentaire..." style="resize:vertical"></textarea>
        </div>
        <!-- Note interne -->
        <div class="m-sec">
          <div class="m-sec-head"><span class="m-sec-title">📝 Note interne</span><span class="m-sec-line"></span></div>
          <textarea class="m-input m-input-note" id="calIntNote" rows="2" placeholder="Note visible uniquement par l'équipe..." style="resize:vertical"></textarea>
        </div>
        <!-- Diff banner -->
        <div id="calEditDiff" style="display:none;margin:8px 0"></div>
        <!-- Notify panel -->
        <div class="notify-panel" id="calNotifyPanel">
          <h4>📨 Prévenir le client ?</h4>
          <div class="notify-options">
            <div class="notify-opt" onclick="calSelectNotify('email',this)"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email</div>
            <div class="notify-opt" onclick="calSelectNotify('sms',this)"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>SMS</div>
            <div class="notify-opt" onclick="calSelectNotify('both',this)"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Les deux</div>
            <div class="notify-opt" onclick="calSelectNotify('none',this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>Non</div>
          </div>
          <div class="notify-actions"><button class="cal-btn" onclick="calCloseNotify()">Terminé</button><button class="cal-btn cal-green" id="calSendNotifyBtn" onclick="calSendNotification()" style="display:none">Envoyer</button></div>
        </div>
        <!-- Bottom bar -->
        <div class="m-bottom" id="mBottom">
          <button class="m-btn m-btn-primary" id="mBtnSave" onclick="calSaveAll()">Enregistrer</button>
          <button class="m-btn m-btn-ghost" id="mBtnNotify" onclick="document.getElementById('calNotifyPanel').style.display='block';document.getElementById('calNotifyPanel').scrollIntoView({behavior:'smooth',block:'nearest'})">Notifier</button>
          <button class="m-btn m-btn-danger" id="mBtnCancel" onclick="fcSetStatus('cancelled')">Annuler le RDV</button>
          <button class="m-btn m-btn-danger" id="mBtnPurge" onclick="fcPurgeBooking()" style="display:none">🗑️ Supprimer définitivement</button>
        </div>
      </div>
      <!-- NOTES TAB -->
      <div class="cal-panel" id="calPanelNotes"><div id="calNoteList"></div><div class="add-note"><textarea id="calNewNote" placeholder="Ajouter une note..."></textarea><div class="add-note-actions"><label style="font-size:.75rem;color:var(--text-4);display:flex;align-items:center;gap:4px"><input type="checkbox" id="calNotePinned"> Épinglée</label><button class="cal-btn primary" onclick="calAddNote()" style="padding:6px 14px;font-size:.78rem">Ajouter</button></div></div></div>
      <!-- TODOS TAB -->
      <div class="cal-panel" id="calPanelTodos"><div id="calTodoList"></div><div class="add-todo"><input id="calNewTodo" placeholder="Nouvelle tâche..." onkeydown="if(event.key==='Enter')calAddTodo()"><button class="cal-btn primary" onclick="calAddTodo()" style="padding:6px 14px;font-size:.78rem">+</button></div></div>
      <!-- REMINDERS TAB -->
      <div class="cal-panel" id="calPanelReminders"><div id="calReminderList"></div><div class="add-reminder"><select id="calReminderOffset"><option value="15">15 min</option><option value="30" selected>30 min</option><option value="60">1 heure</option><option value="120">2 heures</option><option value="1440">La veille</option></select><select id="calReminderChannel"><option value="browser">Notif</option><option value="email">Email</option><option value="both">Les deux</option></select><button class="cal-btn primary" onclick="calAddReminder()" style="padding:6px 14px;font-size:.78rem">Ajouter</button></div></div>
    </div>
  </div>
</div>

<!-- QUICK CREATE MODAL -->
<div class="cal-modal-overlay" id="calCreateModal">
  <div class="cal-modal" style="max-width:500px">
    <div class="cal-modal-head"><h2>Nouveau rendez-vous</h2><button class="cal-close" onclick="closeCalModal('calCreateModal')">✕</button></div>
    <div style="padding:20px 24px 24px">
      <div class="qc-row" style="position:relative"><div class="qc-label">Client</div><input class="qc-input" id="qcClient" placeholder="Rechercher un client..." autocomplete="off" oninput="calSearchClients(this.value)"><div id="qcAcResults" class="ac-results" style="display:none"></div><input type="hidden" id="qcClientId"></div>
      <div class="qc-row qc-row-2"><div><div class="qc-label">Date</div><input class="qc-input" type="date" id="qcDate"></div><div><div class="qc-label">Heure</div><input class="qc-input" type="time" id="qcTime" value="09:00"></div></div>
      <!-- Mode libre toggle -->
      <div class="qc-row" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--text-3)">
          <input type="checkbox" id="qcFreestyle" onchange="qcToggleFreestyle()" style="accent-color:var(--primary);width:16px;height:16px"> Mode libre <span style="font-weight:400;color:var(--text-4)">(sans prestation prédéfinie)</span>
        </label>
      </div>
      <!-- Normal: service picker -->
      <div class="qc-row" id="qcNormalMode">
        <div class="qc-label">Prestations</div>
        <div id="qcServiceList"></div>
        <button class="btn-outline" style="margin-top:6px;font-size:.78rem;padding:5px 12px" onclick="qcAddService()">+ Ajouter une prestation</button>
        <div id="qcTotalDuration" style="font-size:.75rem;color:var(--text-4);margin-top:6px"></div>
      </div>
      <!-- Freestyle: manual fields -->
      <div id="qcFreestyleMode" style="display:none">
        <div class="qc-row"><div class="qc-label">Intitulé du RDV</div><input class="qc-input" id="qcFreeLabel" placeholder="ex: Urgence dossier Martin, Remplacement créneau..."></div>
        <div class="qc-row qc-row-2"><div><div class="qc-label">Heure fin</div><input class="qc-input" type="time" id="qcFreeEnd" value="10:00"></div><div><div class="qc-label">Couleur</div><div id="qcFreeColorWrap"></div></div></div>
        <div class="qc-row qc-row-2"><div><div class="qc-label">Buffer avant (min)</div><input class="qc-input" type="number" id="qcFreeBufBefore" value="0" min="0" step="5"></div><div><div class="qc-label">Buffer après (min)</div><input class="qc-input" type="number" id="qcFreeBufAfter" value="0" min="0" step="5"></div></div>
        <div id="qcFreeDuration" style="font-size:.75rem;color:var(--text-4);margin-top:2px;margin-bottom:10px"></div>
      </div>
      <div class="qc-row"><div class="qc-label">Praticien</div><select class="qc-input" id="qcPrac"></select></div>
      <div class="qc-row" id="qcModeRow"><div class="qc-label">Mode</div><select class="qc-input" id="qcMode"><option value="cabinet">🏢 Cabinet</option></select></div>
      <div class="qc-row"><div class="qc-label">Commentaire (optionnel)</div><input class="qc-input" id="qcComment" placeholder="Note ou contexte..."></div>
      <div class="qc-actions"><button class="cal-btn" onclick="closeCalModal('calCreateModal')">Annuler</button><button class="cal-btn primary" onclick="calCreateBooking()">Créer le RDV</button></div>
    </div>
  </div>
</div>

<div id="gToast" class="g-toast" style="display:none"></div>

<script src="/js/api-client.js"></script>
<script>
const api=new GendaAPI();
if(!api.isLoggedIn())window.location.href='/login.html';
const user=api.getUser(),biz=api.getBusiness();

// ===== RBAC CONFIG =====
const ROLE_ACCESS={
  owner:['home','bookings','clients','services','hours','team','site','calls','invoices','documents','analytics','settings'],
  manager:['home','bookings','clients','services','hours','documents','analytics'],
  receptionist:['home','bookings','clients'],
  practitioner:['home','bookings','clients']
};

const SECTOR_LABELS={
  coiffeur:{owner:'Gérant·e',practitioner:'Coiffeur·se',manager:'Responsable salon',receptionist:'Réceptionniste'},
  esthetique:{owner:'Gérant·e',practitioner:'Esthéticien·ne',manager:'Responsable',receptionist:'Réceptionniste'},
  bien_etre:{owner:'Gérant·e',practitioner:'Praticien·ne',manager:'Responsable',receptionist:'Réceptionniste'},
  osteopathe:{owner:'Gérant·e',practitioner:'Ostéopathe',manager:'Responsable',receptionist:'Secrétaire'},
  veterinaire:{owner:'Gérant·e',practitioner:'Vétérinaire',manager:'Responsable',receptionist:'Secrétaire'},
  photographe:{owner:'Gérant·e',practitioner:'Photographe',manager:'Responsable',receptionist:'Assistant·e'},
  medecin:{owner:'Gérant·e',practitioner:'Médecin',manager:'Responsable',receptionist:'Secrétaire médicale'},
  dentiste:{owner:'Gérant·e',practitioner:'Dentiste',manager:'Responsable',receptionist:'Secrétaire'},
  kine:{owner:'Gérant·e',practitioner:'Kinésithérapeute',manager:'Responsable',receptionist:'Secrétaire'},
  comptable:{owner:'Gérant·e',practitioner:'Collaborateur·rice',manager:'Office Manager',receptionist:'Secrétaire'},
  avocat:{owner:'Associé·e gérant·e',practitioner:'Avocat·e',manager:'Office Manager',receptionist:'Secrétaire juridique'},
  autre:{owner:'Gérant·e',practitioner:'Membre',manager:'Responsable',receptionist:'Réceptionniste'}
};

const userRole=user?.role||'owner';
const userSector=biz?.sector||'autre';
const sectorLabels=SECTOR_LABELS[userSector]||SECTOR_LABELS.autre;
const allowedSections=ROLE_ACCESS[userRole]||ROLE_ACCESS.owner;

// Display user info in sidebar
document.getElementById('userName').textContent=user?.business_name||user?.email||'—';
document.getElementById('userRole').textContent=sectorLabels[userRole]||userRole;

// Hide sidebar items not allowed for this role
document.querySelectorAll('.ni[data-section]').forEach(item=>{
  const section=item.dataset.section;
  if(!allowedSections.includes(section)){
    item.style.display='none';
  }
});
// Hide empty sidebar groups (if all children are hidden)
document.querySelectorAll('.sb-label').forEach(label=>{
  let next=label.nextElementSibling;
  let hasVisible=false;
  while(next&&!next.classList.contains('sb-label')){
    if(next.classList.contains('ni')&&next.style.display!=='none')hasVisible=true;
    next=next.nextElementSibling;
  }
  if(!hasVisible)label.style.display='none';
});
document.getElementById('todayDate').textContent=new Date().toLocaleDateString('fr-BE',{weekday:'long',day:'numeric',month:'long'});
if(biz)document.getElementById('planBadge').textContent=(biz.plan||'free').toUpperCase();
if(new URLSearchParams(location.search).get('onboarding'))GendaUI.toast('🎉 Bienvenue !','success',5000);
loadDashboard();

async function loadDashboard(){
  const c=document.getElementById('contentArea');
  try{
    const[dd,sd]=await Promise.allSettled([api.getDashboard(),api.get('/api/dashboard/summary')]);
    const dash=dd.status==='fulfilled'?dd.value:{},sum=sd.status==='fulfilled'?sd.value:null;
    const slug=dash.business?.slug||biz?.slug||'';
    let h=`<div class="qlink"><div class="info"><h4>Votre page publique</h4><p>${slug}</p></div><div><a href="/${slug}" target="_blank">Voir ma page</a></div></div>`;
    if(sum){const m=sum.month||{},cl=sum.clients||{},ca=sum.calls||{};
      h+=`<div class="stats"><div class="stat-card"><div class="label">RDV aujourd'hui</div><div class="val">${sum.today?.count||0}</div></div><div class="stat-card"><div class="label">CA ce mois</div><div class="val">${m.revenue_formatted||'0 €'}</div><div class="sub">${m.total_bookings||0} RDV</div></div><div class="stat-card"><div class="label">Clients</div><div class="val">${cl.total||0}</div></div><div class="stat-card"><div class="label">Appels → RDV</div><div class="val">${ca.conversion_rate||0}%</div></div></div>`;
      h+=`<div class="card"><div class="card-h"><h3>RDV du jour</h3><span class="badge badge-teal">${sum.today?.count||0}</span></div>`;
      if(sum.today?.bookings?.length>0){sum.today.bookings.forEach(b=>{const t=new Date(b.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});h+=`<div class="bk-row"><span style="font-size:.85rem;font-weight:700;color:var(--primary);min-width:50px">${t}</span><div style="flex:1"><div style="font-size:.85rem;font-weight:600">${b.client_name}</div><div style="font-size:.72rem;color:var(--text-4)">${b.service_name} · ${b.duration_min}min</div></div><span class="bk-status ${b.status}">${b.status==='confirmed'?'Confirmé':b.status}</span></div>`});}
      else h+=`<div class="empty">Aucun RDV aujourd'hui</div>`;
      h+=`</div>`;
    }else{h+=`<div class="stats"><div class="stat-card"><div class="label">RDV</div><div class="val">0</div></div><div class="stat-card"><div class="label">CA</div><div class="val">0 €</div></div><div class="stat-card"><div class="label">Clients</div><div class="val">0</div></div><div class="stat-card"><div class="label">Appels</div><div class="val">—</div></div></div><div class="card"><div class="card-h"><h3>RDV du jour</h3></div><div class="empty">Aucun RDV</div></div>`;}
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}<br><button onclick="loadDashboard()" style="margin-top:8px;padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--white);cursor:pointer">Réessayer</button></div>`;}
}

// NAV
document.querySelectorAll('.ni').forEach(i=>{i.addEventListener('click',e=>{e.preventDefault();document.getElementById('contentArea').classList.remove('agenda-active');document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));i.classList.add('active');const s=i.dataset.section;document.getElementById('pageTitle').textContent={home:'Dashboard',bookings:'Agenda',clients:'Clients',services:'Prestations',hours:'Disponibilités',team:'Équipe',site:'Mon site',calls:'Appels',invoices:'Facturation',documents:'Documents pré-RDV',settings:'Paramètres',analytics:'Statistiques'}[s]||'Dashboard';if(s==='home')loadDashboard();else if(s==='bookings'){loadAgenda();}else if(s==='site')loadSiteSection();else if(s==='clients')loadClients();else if(s==='services')loadServices();else if(s==='hours')loadHours();else if(s==='analytics')loadAnalytics();else if(s==='settings')loadSettings();else if(s==='team')loadTeam();else if(s==='invoices')loadInvoices();else if(s==='documents')loadDocuments();else if(s==='calls')loadCalls();else document.getElementById('contentArea').innerHTML=`<div class="empty">Section "${s}" — Bientôt disponible</div>`;});});

// ============================================================
// FULLCALENDAR AGENDA
// ============================================================
let fcCal=null, fcCalOptions=null, fcPractitioners=[], fcServices=[], fcCurrentFilter='all', fcCurrentEventId=null;
let fcEditOriginal={}, fcSelectedNotifyChannel=null, fcDetailData={notes:[],todos:[],reminders:[]};
let fcClientSearchTimer=null, fcSlotMin='08:00:00', fcSlotMax='19:00:00';
let fcHiddenDays=[], fcBusinessHours=[], fcAllowOverlap=false, fcPracBusinessHours={};
let fcMobileView='grid'; // 'grid' or 'list'
let fcMobileDate=new Date(); // for list view navigation
let fcAllBookings=[]; // cache for list view

const fcIsMobile=()=>window.innerWidth<=768;
const fcIsTablet=()=>window.innerWidth>768&&window.innerWidth<=1180&&('ontouchstart' in window||navigator.maxTouchPoints>0);
const fcIsTouch='ontouchstart' in window||navigator.maxTouchPoints>0;

const MODE_ICO={cabinet:'🏢',visio:'💻',phone:'📞'};
const ST_LABELS={pending:'En attente',confirmed:'Confirmé',completed:'Terminé',cancelled:'Annulé',no_show:'No-show',modified_pending:'Modifié · en attente'};
const DAY_NAMES=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
const MONTH_NAMES=['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];

function gToast(msg,type){
  const t=document.getElementById('gToast');t.textContent=msg;t.style.display='flex';
  t.className='g-toast'+(type?' '+type:'');
  clearTimeout(t._tm);t._tm=setTimeout(()=>{t.style.display='none';},3500);
}

async function loadAgenda(){
  const c=document.getElementById('contentArea');
  c.classList.add('agenda-active');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const [prRes,svRes,avRes,bizRes]=await Promise.all([
      fetch('/api/practitioners',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/services',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/availabilities',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/business',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const prD=await prRes.json(), svD=await svRes.json(), avD=await avRes.json(), bizD=await bizRes.json();
    fcPractitioners=prD.practitioners||[];
    fcServices=svD.services||[];
    fcAllowOverlap=!!(bizD.business?.settings?.allow_overlap);

    // Compute calendar bounds from availability data
    const avails=avD.availabilities||{};
    const allStarts=[],allEnds=[];
    for(const pracId of Object.keys(avails)){
      const sched=avails[pracId].schedule||{};
      for(const day of Object.keys(sched)){
        for(const slot of sched[day]){
          if(slot.start_time)allStarts.push(slot.start_time);
          if(slot.end_time)allEnds.push(slot.end_time);
        }
      }
    }
    if(allStarts.length>0){
      allStarts.sort();allEnds.sort();
      const minH=Math.max(0,parseInt(allStarts[0].split(':')[0])-1);
      const maxH=Math.min(23,parseInt(allEnds[allEnds.length-1].split(':')[0])+1);
      fcSlotMin=String(minH).padStart(2,'0')+':00:00';
      fcSlotMax=String(maxH).padStart(2,'0')+':00:00';
    }else{
      fcSlotMin='08:00:00';fcSlotMax='19:00:00';
    }

    // Compute hidden days (no availability at all) and business hours
    // DB weekday: 0=Monday...6=Sunday. FullCalendar: 0=Sunday...6=Saturday
    const dbDayToFcDay = d => (d + 1) % 7; // 0(Mon)→1, 4(Fri)→5, 6(Sun)→0
    const normTime = t => { if(!t)return '09:00'; const s=String(t); return s.slice(0,5); }; // "09:00:00" → "09:00"
    const activeDays=new Set();
    fcBusinessHours=[];
    fcPracBusinessHours={};
    for(const pracId of Object.keys(avails)){
      const sched=avails[pracId].schedule||{};
      if(!fcPracBusinessHours[pracId])fcPracBusinessHours[pracId]=[];
      for(const day of Object.keys(sched)){
        const slots=sched[day].filter(s=>s.is_active!==false);
        if(slots.length>0){
          const fcDay=dbDayToFcDay(parseInt(day));
          activeDays.add(fcDay);
          slots.forEach(s=>{
            const entry={daysOfWeek:[fcDay],startTime:normTime(s.start_time),endTime:normTime(s.end_time)};
            fcBusinessHours.push(entry);
            fcPracBusinessHours[pracId].push(entry);
          });
        }
      }
    }
    // Days 0-6 not in activeDays → hidden
    fcHiddenDays=[];
    for(let d=0;d<7;d++){if(!activeDays.has(d))fcHiddenDays.push(d);}
  }catch(e){fcPractitioners=[];fcServices=[];}

  // Build filter pills
  let pills=`<div class="prac-filters"><div class="prac-pill active" onclick="fcFilterPractitioner('all',this)"><span class="dot" style="background:var(--primary)"></span>Tous</div>`;
  fcPractitioners.forEach(p=>{pills+=`<div class="prac-pill" onclick="fcFilterPractitioner('${p.id}',this)"><span class="dot" style="background:${p.color||'var(--primary)'}"></span>${p.display_name}</div>`;});
  pills+=`</div>`;

  // Mobile: view toggle + list container
  const mobile=fcIsMobile();
  let mobToggle='';
  if(mobile){
    mobToggle=`<div class="mob-view-toggle"><button class="mob-vt ${fcMobileView==='list'?'active':''}" onclick="fcSwitchMobView('list')">📋 Liste</button><button class="mob-vt ${fcMobileView==='grid'?'active':''}" onclick="fcSwitchMobView('grid')">📅 Grille</button></div>`;
  }

  c.innerHTML=pills+mobToggle+`<div id="fcCalendar" style="${mobile&&fcMobileView==='list'?'display:none':''}"></div><div id="fcMobList" class="mob-list ${mobile&&fcMobileView==='list'?'active':''}"></div>`+
    (mobile?`<button class="cal-fab" onclick="fcOpenQuickCreate()" title="Nouveau RDV">+</button>`:'');

  // Compute initial slot increment from all practitioners
  const allIncs=fcPractitioners.map(p=>p.slot_increment_min||15);
  const initInc=allIncs.length>0?Math.min(...allIncs):15;
  const initSlotDur=fcSlotDuration(initInc);

  // Init FullCalendar
  fcCalOptions={
    locale:'fr',
    initialView:mobile?'timeGridDay':'timeGridWeek',
    headerToolbar:{left:'prev,today,next',center:'title',right:mobile?'':'timeGridDay,timeGridWeek,dayGridMonth'},
    buttonText:{today:"Aujourd'hui",day:'Jour',week:'Semaine',month:'Mois'},
    slotMinTime:fcSlotMin,slotMaxTime:fcSlotMax,
    hiddenDays:fcHiddenDays,
    businessHours:fcBusinessHours.length>0?fcBusinessHours:{daysOfWeek:[1,2,3,4,5],startTime:'09:00',endTime:'17:00'},
    // businessHours: visual indicator only, not a constraint for manual bookings
    slotDuration:initSlotDur,slotLabelInterval:'01:00:00',
    allDaySlot:false,nowIndicator:true,navLinks:true,
    height:'auto',stickyHeaderDates:true,firstDay:1,
    dayMaxEvents:3, // month view: show max 3 events, then "+X more"
    editable:true,eventDurationEditable:!fcIsTouch||fcIsTablet(),eventStartEditable:true,snapDuration:initSlotDur,
    selectable:false,
    slotEventOverlap:false,
    longPressDelay:500, // all touch devices: hold 500ms to drag

    // Block overlap for same practitioner
    eventOverlap:function(stillEvent,movingEvent){
      // Business allows overlap → always permit
      if(fcAllowOverlap)return true;
      // Same group → always allow (they chain sequentially)
      const sg=stillEvent.extendedProps?.group_id, mg=movingEvent?.extendedProps?.group_id;
      if(sg&&mg&&sg===mg)return true;
      const sp=stillEvent.extendedProps?.practitioner_id;
      const mp=movingEvent?.extendedProps?.practitioner_id;
      if(sp&&mp&&sp!==mp)return true;
      const st=stillEvent.extendedProps?.status;
      if(['cancelled','completed','no_show'].includes(st))return true;
      return false;
    },

    // Full collision check before allowing drop
    eventAllow:function(dropInfo,draggedEvent){
      // Block drag in month view
      if(fcCal?.view?.type==='dayGridMonth')return false;
      // Block drop on closed days
      const dropDay=dropInfo.start.getDay();
      if(fcHiddenDays.includes(dropDay))return false;

      // For groups: calculate where the FIRST and LAST member would land
      const myGroup=draggedEvent.extendedProps?.group_id;
      let effectiveStart=dropInfo.start;
      let effectiveEnd=dropInfo.end;
      if(myGroup){
        const allEvts=fcCal.getEvents().filter(e=>e.extendedProps?.group_id===myGroup);
        allEvts.sort((a,b)=>a.start-b.start);
        if(allEvts.length>0){
          const delta=dropInfo.start.getTime()-draggedEvent.start.getTime();
          effectiveStart=new Date(allEvts[0].start.getTime()+delta);
          effectiveEnd=new Date(allEvts[allEvts.length-1].end.getTime()+delta);
        }
      }

      // Block if range doesn't fit in practitioner's work slot (respects lunch break)
      // NOTE: Removed — practitioners can manually place bookings during breaks.
      // Business hours are visual indicators only; public booking API enforces availability.

      // Business allows overlap → only block past
      if(fcAllowOverlap)return effectiveStart>=new Date();
      const myPrac=draggedEvent.extendedProps?.practitioner_id;
      if(!myPrac)return true;
      if(effectiveStart<new Date())return false;
      const newStart=dropInfo.start,newEnd=dropInfo.end;
      const allEvents=fcCal.getEvents();
      for(const ev of allEvents){
        if(ev.id===draggedEvent.id)continue;
        if(myGroup&&ev.extendedProps?.group_id===myGroup)continue;
        if(ev.extendedProps?.practitioner_id!==myPrac)continue;
        const st=ev.extendedProps?.status;
        if(st==='cancelled'||st==='no_show'||st==='completed')continue;
        if(myGroup){
          if(ev.start<effectiveEnd&&ev.end>effectiveStart)return false;
        }else{
          if(ev.start<newEnd&&ev.end>newStart)return false;
        }
      }
      return true;
    },

    // Fetch events from API
    events:function(info,successCb,failCb){
      const params=new URLSearchParams({from:info.startStr,to:info.endStr});
      if(fcCurrentFilter!=='all')params.set('practitioner_id',fcCurrentFilter);
      fetch('/api/bookings?'+params.toString(),{headers:{'Authorization':'Bearer '+api.getToken()}})
        .then(r=>r.json()).then(d=>{
          const events=(d.bookings||[]).map(b=>{
            const frozen=['completed','cancelled','no_show'].includes(b.status);
            let bgColor=b.service_color||b.booking_color||b.practitioner_color||'#0D7377';
            return {
            id:b.id,
            title:b.client_name||'Sans nom',
            start:b.start_at,
            end:b.end_at,
            backgroundColor:bgColor,
            borderColor:bgColor,
            editable:!frozen,
            durationEditable:!frozen&&!b.group_id,
            extendedProps:{...b}
          }});
          // Unified color for groups: first service's color for all members
          const groupColors={};
          events.forEach(ev=>{
            const gid=ev.extendedProps.group_id;
            if(!gid)return;
            if(!groupColors[gid])groupColors[gid]=ev.backgroundColor;
          });
          events.forEach(ev=>{
            const gid=ev.extendedProps.group_id;
            if(gid&&groupColors[gid]){
              ev.backgroundColor=groupColors[gid];
              ev.borderColor=groupColors[gid];
            }
          });
          successCb(events);
        }).catch(e=>failCb(e));
    },

    // Custom event rendering with badges
    eventContent:function(arg){
      const p=arg.event.extendedProps;
      const isMonth=arg.view.type==='dayGridMonth';
      if(isMonth){
        // Compact pill: "09:00 Dupont"
        const t=arg.event.start?arg.event.start.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'}):'';
        const name=(p.client_name||arg.event.title||'').split(' ')[0]; // first name only
        const freeIco=!p.service_name?' ✦':'';
        return{html:`<span class="ev-month-pill">${t} <strong>${name}</strong>${freeIco}</span>`};
      }
      // Week/Day: full rendering
      const svcLabel=p.service_name||p.custom_label||'RDV libre';
      const badges=[(p.internal_note?'<span class="ev-badge ev-badge-note"></span>':''),(p.status==='modified_pending'?'<span class="ev-badge ev-badge-mod"></span>':'')].filter(Boolean).join('');
      const groupTag=p.group_id?'<span class="ev-group-badge">🔗</span>':'';
      const freeTag=!p.service_name?'<span style="font-size:.58rem;opacity:.7;margin-left:3px">✦</span>':'';
      return{html:`<div class="ev-inner"><span class="ev-client">${p.client_name||arg.event.title}${groupTag}${freeTag}</span><span class="ev-service">${svcLabel}</span>${badges?'<div class="ev-badges">'+badges+'</div>':''}</div>`};
    },

    // Status-based CSS classes
    eventClassNames:function(arg){
      const p=arg.event.extendedProps;
      const cls=['ev-'+(p.status||'confirmed')];
      if(p.group_id){
        cls.push('ev-grouped');
        // Find group bounds from all calendar events
        const allEvts=fcCal.getEvents().filter(e=>e.extendedProps.group_id===p.group_id);
        const maxOrder=Math.max(...allEvts.map(e=>e.extendedProps.group_order||0));
        if(p.group_order===0)cls.push('ev-group-first');
        else if(p.group_order===maxOrder)cls.push('ev-group-last');
        else cls.push('ev-group-mid');
      }
      return cls;
    },

    // Double-click / double-tap → open detail modal (single click reserved for drag)
    eventClick:function(){}, // absorb single click (no-op)

    // Click day number in month view → switch to day view
    navLinkDayClick:function(date){
      fcCal.changeView('timeGridDay',date);
    },

    // Stamp event IDs on DOM + attach dblclick/doubletap
    eventDidMount:function(info){
      info.el.setAttribute('data-eid',info.event.id);
      const gid=info.event.extendedProps?.group_id;
      if(gid)info.el.setAttribute('data-gid',gid);

      // Desktop: native dblclick
      info.el.addEventListener('dblclick',function(e){
        e.stopPropagation();
        fcOpenDetail(info.event.id);
      });

      // Mobile: double-tap detection
      let lastTap=0;
      info.el.addEventListener('touchend',function(e){
        const now=Date.now();
        if(now-lastTap<600){
          e.preventDefault();
          fcOpenDetail(info.event.id);
          lastTap=0;
        }else{
          lastTap=now;
        }
      },{passive:false});
    },

    // Double-click / double-tap on empty slot → quick create
    dateClick:function(info){
      if(fcCal?.view?.type==='dayGridMonth')return;
      const now=Date.now();
      if(window._fcLastDateClick&&now-window._fcLastDateClick<600&&window._fcLastDateClickDate===info.dateStr){
        fcOpenQuickCreate(info.dateStr);
        window._fcLastDateClick=0;
      }else{
        window._fcLastDateClick=now;
        window._fcLastDateClickDate=info.dateStr;
      }
    },

    // Group drag: ghost siblings during drag (skip in month view)
    eventDragStart:function(info){
      if(fcCal.view.type==='dayGridMonth')return;
      const gid=info.event.extendedProps?.group_id;
      if(!gid)return;
      document.querySelectorAll(`.fc-event[data-gid="${gid}"]`).forEach(el=>{
        if(el.getAttribute('data-eid')!==info.event.id){
          el.classList.add('ev-group-ghost');
        }
      });
    },

    // Always clean up ghosts when drag ends (drop, cancel, or revert)
    eventDragStop:function(){
      document.querySelectorAll('.ev-group-ghost').forEach(el=>el.classList.remove('ev-group-ghost'));
    },

    // Drag & drop → move booking
    eventDrop:async function(info){
      document.querySelectorAll('.ev-group-ghost').forEach(el=>el.classList.remove('ev-group-ghost'));
      const ev=info.event,p=ev.extendedProps;
      try{
        const r=await fetch(`/api/bookings/${ev.id}/move`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
          body:JSON.stringify({start_at:ev.start.toISOString(),end_at:ev.end.toISOString(),practitioner_id:p.practitioner_id})
        });
        if(!r.ok){const d=await r.json();throw new Error(d.error||'Erreur');}
        const result=await r.json();
        gToast(result.group_moved?`${p.client_name||'Client'} — ${result.count} prestations déplacées`:(p.client_name||'RDV')+' déplacé','success');
        fcCal.refetchEvents(); // Sync recalculated duration from backend
      }catch(e){info.revert();gToast(e.message.includes('hevauche')||e.message.includes('pris')?'🚫 Créneau occupé — impossible de déplacer ici':e.message,'error');}
    },

    // Resize → update duration
    eventResize:async function(info){
      const ev=info.event;
      try{
        const r=await fetch(`/api/bookings/${ev.id}/resize`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
          body:JSON.stringify({end_at:ev.end.toISOString()})
        });
        if(!r.ok){const d=await r.json();throw new Error(d.error||'Erreur');}
        const dur=Math.round((ev.end-ev.start)/60000);
        gToast('Durée → '+dur+' min','success');
      }catch(e){info.revert();gToast(e.message.includes('hevauche')||e.message.includes('créneau')?'🚫 Chevauchement — durée non modifiée':e.message,'error');}
    }
  };
  fcCal=new FullCalendar.Calendar(document.getElementById('fcCalendar'),fcCalOptions);
  fcCal.render();

  // ── SSE: real-time calendar updates ──
  if(window.fcEventSource){try{window.fcEventSource.close();}catch(e){}}
  try{
    window.fcEventSource=new EventSource('/api/events/stream?token='+encodeURIComponent(api.getToken()));
    window.fcEventSource.addEventListener('booking_update',function(){
      fcRefresh();
    });
    window.fcEventSource.onerror=function(){
      // Browser auto-reconnects, nothing to do
    };
  }catch(e){}

  // Touch devices: setup swipe navigation
  if(fcIsTouch){
    if(fcIsMobile()){
      fcMobileDate=new Date();
      fcLoadMobileList();

      // Sync list date when calendar navigates
      fcCal.on('datesSet',function(info){
        fcMobileDate=info.start;
        if(fcMobileView==='list')fcLoadMobileList();
      });
    }
    fcSetupSwipe();
  }
}

// ── Mobile: Switch grid/list view ──
function fcSwitchMobView(view){
  fcMobileView=view;
  document.querySelectorAll('.mob-vt').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.mob-vt:${view==='list'?'first':'last'}-child`)?.classList.add('active');
  const cal=document.getElementById('fcCalendar');
  const list=document.getElementById('fcMobList');
  if(view==='list'){
    cal.style.display='none';
    list.classList.add('active');
    fcLoadMobileList();
  }else{
    cal.style.display='';
    list.classList.remove('active');
    fcCal.updateSize();
  }
}

// ── Mobile: List view ──
async function fcLoadMobileList(){
  const el=document.getElementById('fcMobList');
  if(!el)return;
  const ds=fcMobileDate.toISOString().split('T')[0];
  const from=ds+'T00:00:00',to=ds+'T23:59:59';
  try{
    const params=new URLSearchParams({from,to});
    if(fcCurrentFilter!=='all')params.set('practitioner_id',fcCurrentFilter);
    const r=await fetch('/api/bookings?'+params.toString(),{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    fcAllBookings=d.bookings||[];
  }catch(e){fcAllBookings=[];}

  const isToday=ds===new Date().toISOString().split('T')[0];
  const dayLabel=isToday?"Aujourd'hui":`${DAY_NAMES[fcMobileDate.getDay()]} ${fcMobileDate.getDate()} ${MONTH_NAMES[fcMobileDate.getMonth()]}`;

  let h=`<div class="mob-list-nav"><button class="mob-nav-btn" onclick="fcMobShift(-1)">‹</button><button class="mob-today-btn" onclick="fcMobToday()">Aujourd'hui</button><button class="mob-nav-btn" onclick="fcMobShift(1)">›</button></div>`;
  h+=`<div class="mob-list-header"><span class="mob-list-date">${dayLabel}</span><span class="mob-list-count">${fcAllBookings.length} RDV</span></div>`;

  if(!fcAllBookings.length){
    h+=`<div class="mob-empty"><div class="mob-empty-icon">📅</div><div class="mob-empty-text">Aucun rendez-vous</div><div class="mob-empty-sub">${dayLabel}</div></div>`;
  }else{
    const sorted=[...fcAllBookings].sort((a,b)=>new Date(a.start_at)-new Date(b.start_at));
    sorted.forEach(b=>{
      const s=new Date(b.start_at),e=new Date(b.end_at);
      const t1=s.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
      const dur=Math.round((e-s)/60000);
      const prac=fcPractitioners.find(p=>p.id===b.practitioner_id);
      const stLabel=ST_LABELS[b.status]||b.status;
      const stClass='st-'+b.status;
      const badges=[(b.internal_note?'📝':''),(b.status==='modified_pending'?'⚠️':''),(b.group_id?'🔗':'')].filter(Boolean);
      h+=`<div class="mob-bk ${stClass}" onclick="fcOpenDetail('${b.id}')">
        ${badges.length?'<div class="mob-bk-badges">'+badges.map(x=>'<span>'+x+'</span>').join('')+'</div>':''}
        <div class="mob-bk-time"><div class="t">${t1}</div><div class="dur">${dur}min</div></div>
        <div class="mob-bk-info"><div class="name">${escH(b.client_name)}</div><div class="svc">${b.service_name||b.custom_label||'RDV libre'} · ${MODE_ICO[b.appointment_mode]||''}</div><div class="prac"><span class="pdot" style="background:${prac?.color||'var(--primary)'}"></span>${prac?.display_name||b.practitioner_name||''}</div></div>
        <div class="mob-bk-status status-badge ${stClass}">${stLabel}</div>
      </div>`;
    });
  }
  el.innerHTML=h;
}

function fcMobShift(dir){
  fcMobileDate.setDate(fcMobileDate.getDate()+dir);
  fcLoadMobileList();
  // Sync calendar too
  fcCal.gotoDate(fcMobileDate);
}

function fcMobToday(){
  fcMobileDate=new Date();
  fcLoadMobileList();
  fcCal.today();
}

// ── Mobile: Swipe navigation ──
function fcSetupSwipe(){
  let startX=0,startY=0,swiping=false;
  const content=document.getElementById('contentArea');
  content.addEventListener('touchstart',e=>{
    // Don't swipe if touching an event (user might be dragging)
    if(e.target.closest('.fc-event'))return;
    startX=e.touches[0].clientX;startY=e.touches[0].clientY;swiping=true;
  },{passive:true});
  content.addEventListener('touchmove',e=>{
    if(!swiping)return;
    const dy=Math.abs(e.touches[0].clientY-startY);
    // If scrolling vertically, cancel swipe
    if(dy>30)swiping=false;
  },{passive:true});
  content.addEventListener('touchend',e=>{
    if(!swiping)return;swiping=false;
    const dx=e.changedTouches[0].clientX-startX;
    if(Math.abs(dx)<80)return; // too short
    if(dx<-80){
      // Swipe left → next
      if(fcIsMobile()&&fcMobileView==='list'){fcMobShift(1);}else{fcCal.next();}
    }else if(dx>80){
      // Swipe right → prev
      if(fcIsMobile()&&fcMobileView==='list'){fcMobShift(-1);}else{fcCal.prev();}
    }
  },{passive:true});
}

// ── Practitioner filter ──
function fcRefresh(){fcCal.refetchEvents();if(fcIsMobile()&&fcMobileView==='list')fcLoadMobileList();}

function fcSlotDuration(min){
  const h=String(Math.floor(min/60)).padStart(2,'0');
  const m=String(min%60).padStart(2,'0');
  return h+':'+m+':00';
}

function fcFilterPractitioner(id,el){
  fcCurrentFilter=id;
  document.querySelectorAll('.prac-pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');

  // Adapt slot grid to practitioner's increment
  let inc=15;
  if(id==='all'){
    // Use smallest increment across all practitioners
    const incs=fcPractitioners.map(p=>p.slot_increment_min||15);
    if(incs.length>0)inc=Math.min(...incs);
  }else{
    const prac=fcPractitioners.find(p=>p.id===id);
    inc=prac?.slot_increment_min||15;
  }
  const dur=fcSlotDuration(inc);
  fcCal.setOption('slotDuration',dur);
  fcCal.setOption('snapDuration',dur);

  fcRefresh();
}

// ── Color Swatches (replaces native color pickers) ──
const CSW_PALETTE=['#0D7377','#2196F3','#3F51B5','#9C27B0','#E91E63','#F44336','#FF9800','#FFB300','#4CAF50','#00BCD4','#795548','#607D8B'];
function cswHTML(hiddenId,selected,inline){
  const cls=inline?'csw-inline':'csw';
  let h=`<div class="${cls}">`;
  CSW_PALETTE.forEach(c=>{
    const act=c.toLowerCase()===((selected||'#0D7377').toLowerCase())?'active':'';
    h+=`<span class="csw-dot ${act}" style="background:${c}" data-color="${c}" onclick="cswPick(this,'${hiddenId}')"></span>`;
  });
  h+=`</div><input type="hidden" id="${hiddenId}" value="${selected||'#0D7377'}">`;
  return h;
}
function cswPick(el,hiddenId){
  el.closest('.csw,.csw-inline').querySelectorAll('.csw-dot').forEach(d=>d.classList.remove('active'));
  el.classList.add('active');
  const inp=document.getElementById(hiddenId);
  if(inp)inp.value=el.dataset.color;
  // Trigger change event for any listeners
  inp?.dispatchEvent(new Event('change'));
}
function cswSelect(hiddenId,color){
  const inp=document.getElementById(hiddenId);
  if(inp)inp.value=color||'#0D7377';
  const wrap=inp?.previousElementSibling;
  if(!wrap)return;
  wrap.querySelectorAll('.csw-dot').forEach(d=>{
    d.classList.toggle('active',d.dataset.color.toLowerCase()===(color||'#0D7377').toLowerCase());
  });
}

// ── Detail Modal (Unified) ──
let fcCurrentBooking=null; // store booking data for save
async function fcOpenDetail(bookingId){
  fcCurrentEventId=bookingId;
  const modal=document.getElementById('calDetailModal');
  try{
    const r=await fetch(`/api/bookings/${bookingId}/detail`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error('RDV introuvable');
    const d=await r.json();
    fcDetailData={notes:d.notes||[],todos:d.todos||[],reminders:d.reminders||[]};
    const b=d.booking;
    fcCurrentBooking=b;
    const isFreestyle=!b.service_name;
    const s=new Date(b.start_at),e=new Date(b.end_at);

    // ── Color: from service, freestyle custom, or practitioner fallback ──
    const accentColor=isFreestyle
      ?(b.booking_color||b.practitioner_color||'#0D7377')
      :(b.service_color||b.practitioner_color||'#0D7377');

    // ── Header gradient ──
    const hdrBg=document.getElementById('mHeaderBg');
    hdrBg.style.background=`linear-gradient(135deg,${accentColor} 0%,${accentColor}AA 60%,${accentColor}55 100%)`;

    // ── Client hero ──
    const initials=(b.client_name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const heroEl=document.getElementById('mClientHero');
    const freeTag=isFreestyle?`<span class="m-free-tag" style="background:${accentColor}18;color:${accentColor}">✦ LIBRE</span>`:'';
    heroEl.innerHTML=`
      <div class="m-avatar" style="background:linear-gradient(135deg,${accentColor},${accentColor}CC)">${initials}</div>
      <div class="m-client-info">
        <div class="m-client-name">
          <a href="#" onclick="event.preventDefault();closeCalModal('calDetailModal');openClientDetail('${b.client_id}')">${escH(b.client_name||'—')}</a>
          ${freeTag}
        </div>
        <div class="m-client-meta">
          ${b.client_phone?`<a href="tel:${b.client_phone}">${escH(b.client_phone)}</a>`:''}
          ${b.client_phone&&b.client_email?'<span>·</span>':''}
          ${b.client_email?`<a href="mailto:${b.client_email}">${escH(b.client_email)}</a>`:''}
        </div>
      </div>
      <div class="m-quick-actions">
        ${b.client_phone?`<a class="m-qbtn" href="tel:${b.client_phone}" title="Appeler">📞</a>`:''}
        ${b.client_email?`<a class="m-qbtn" href="mailto:${b.client_email}" title="Email">✉️</a>`:''}
        <button class="m-qbtn" onclick="closeCalModal('calDetailModal');openClientDetail('${b.client_id}')" title="Fiche client">👤</button>
      </div>`;

    // ── Status strip ──
    const stMap={pending:{bg:'var(--gold-bg)',c:'var(--gold)',l:'En attente'},confirmed:{bg:'var(--green-bg)',c:'var(--green)',l:'Confirmé'},modified_pending:{bg:'#FFF7ED',c:'#D97706',l:'Modifié'},completed:{bg:'var(--surface)',c:'var(--text-4)',l:'Terminé'},cancelled:{bg:'var(--red-bg)',c:'var(--red)',l:'Annulé'},no_show:{bg:'var(--red-bg)',c:'var(--red)',l:'No-show'}};
    const st=stMap[b.status]||stMap.confirmed;
    const acts=[];
    if(b.status==='pending')acts.push('<button class="m-st-btn green" onclick="fcSetStatus(\'confirmed\')">✓ Confirmer</button>');
    if(b.status==='confirmed')acts.push('<button class="m-st-btn green" onclick="fcSetStatus(\'completed\')">✓ Terminé</button>');
    if(b.status==='modified_pending')acts.push('<button class="m-st-btn green" onclick="fcSetStatus(\'confirmed\')">✓ Forcer confirmation</button>');
    if(!['cancelled','completed'].includes(b.status)){acts.push('<button class="m-st-btn red" onclick="fcSetStatus(\'no_show\')">✗ No-show</button>');acts.push('<button class="m-st-btn red" onclick="fcSetStatus(\'cancelled\')">Annuler</button>');}
    if(['completed','cancelled','no_show'].includes(b.status))acts.push('<button class="m-st-btn" onclick="fcSetStatus(\'confirmed\')">↩ Rétablir</button>');
    document.getElementById('mStatusStrip').innerHTML=`
      <span class="m-st-current" style="background:${st.bg};color:${st.c}">
        <span class="m-st-dot" style="background:${st.c}"></span>
        ${st.l}
      </span>
      <div class="m-st-actions">${acts.join('')}</div>`;

    // ── Tab counts ──
    const cNotes=document.getElementById('mCountNotes');
    const cTodos=document.getElementById('mCountTodos');
    if(fcDetailData.notes.length>0){cNotes.textContent=fcDetailData.notes.length;cNotes.style.display='flex';}else{cNotes.style.display='none';}
    const openTodos=(fcDetailData.todos||[]).filter(t=>!t.done).length;
    if(openTodos>0){cTodos.textContent=openTodos;cTodos.style.display='flex';}else{cTodos.style.display='none';}

    // ── Freestyle vs Normal cards ──
    const freeCard=document.getElementById('mFreeCard');
    const svcCard=document.getElementById('mSvcCard');
    const bufSec=document.getElementById('mBufferSec');
    if(isFreestyle){
      freeCard.style.display='block';
      svcCard.style.display='none';
      bufSec.style.display='';
      document.getElementById('uFreeLabel').value=b.custom_label||'';
      const freeColor=b.booking_color||b.practitioner_color||'#0D7377';
      document.getElementById('uFreeColorWrap').innerHTML=cswHTML('uFreeColor',freeColor,false);
      // Live update header + save button on color change
      document.getElementById('uFreeColor').addEventListener('change',function(){
        const c=this.value;
        document.getElementById('mHeaderBg').style.background=`linear-gradient(135deg,${c} 0%,${c}AA 60%,${c}55 100%)`;
        document.querySelector('.m-avatar').style.background=`linear-gradient(135deg,${c},${c}CC)`;
        const sb=document.getElementById('mBtnSave');
        sb.style.background=c;sb.style.boxShadow=`0 2px 8px ${c}40`;
      });
      document.getElementById('uBufBefore').value=0;
      document.getElementById('uBufAfter').value=0;
    }else{
      freeCard.style.display='none';
      bufSec.style.display='none';
      svcCard.style.display='flex';
      svcCard.style.borderLeftColor=accentColor;
      const dur=b.duration_min||Math.round((e-s)/60000);
      const priceStr=b.price_cents?' · '+(b.price_cents/100).toFixed(2)+'€':'';
      svcCard.innerHTML=`
        <div>
          <div class="m-svc-name">${escH(b.service_name)}</div>
          <div class="m-svc-meta">${dur} min${b.buffer_after_min?' · buffer '+b.buffer_after_min+' min après':''}${priceStr?'':''}</div>
        </div>
        ${b.price_cents?'<div class="m-svc-price">'+(b.price_cents/100).toFixed(2)+'€</div>':''}`;
    }

    // ── Save button color (freestyle = accent color) ──
    const saveBtn=document.getElementById('mBtnSave');
    if(isFreestyle){
      saveBtn.style.background=accentColor;
      saveBtn.style.boxShadow=`0 2px 8px ${accentColor}40`;
    }else{
      saveBtn.style.background='';
      saveBtn.style.boxShadow='';
    }

    // ── Group siblings ──
    const siblings=d.group_siblings||[];
    const groupEl=document.getElementById('mGroupSiblings');
    if(siblings.length>1){
      let gh=`<div class="m-sec"><div class="m-sec-head"><span class="m-sec-title">🔗 Groupe (${siblings.length} prestations)</span><span class="m-sec-line"></span></div><div style="display:flex;flex-direction:column;gap:3px">`;
      siblings.forEach(sib=>{
        const isCur=sib.id===bookingId;
        const sT=new Date(sib.start_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
        const eT=new Date(sib.end_at).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
        gh+=`<div class="m-group-item${isCur?' current':''}">
          <span class="g-dot" style="background:${sib.service_color||'var(--primary)'}"></span>
          <span style="font-weight:${isCur?'700':'400'}">${sib.service_name||'RDV libre'}</span>
          <span class="g-time">${sT} – ${eT}</span>
        </div>`;
      });
      gh+='</div></div>';
      groupEl.innerHTML=gh;
      groupEl.style.display='block';
    }else{groupEl.style.display='none';}

    // ── Horaire ──
    const ds=s.toISOString().split('T')[0],stm=s.toTimeString().slice(0,5),etm=e.toTimeString().slice(0,5);
    document.getElementById('calEditDate').value=ds;
    document.getElementById('calEditStart').value=stm;
    document.getElementById('calEditEnd').value=etm;
    fcEditOriginal={date:ds,start:stm,end:etm,practitioner_id:b.practitioner_id,comment:b.comment_client||'',internal_note:b.internal_note||'',custom_label:b.custom_label||'',color:b.booking_color||''};
    const dm=Math.round((e-s)/60000);
    document.querySelectorAll('.m-chip').forEach(c=>c.classList.toggle('active',parseInt(c.textContent)===dm||({'1h':60,'1h30':90,'2h':120}[c.textContent.trim()]===dm)));
    document.getElementById('calEditDiff').style.display='none';
    document.getElementById('calNotifyPanel').style.display='none';
    fcSelectedNotifyChannel=null;

    // ── Praticien dropdown with color dot ──
    const pracSel=document.getElementById('uPracSelect');
    pracSel.innerHTML=fcPractitioners.map(p=>`<option value="${p.id}"${p.id===b.practitioner_id?' selected':''}>${p.display_name}</option>`).join('');
    const curPrac=fcPractitioners.find(p=>p.id===b.practitioner_id);
    document.getElementById('mPracDot').style.background=curPrac?.color||'var(--primary)';
    pracSel.onchange=function(){
      const sel=fcPractitioners.find(p=>p.id===this.value);
      document.getElementById('mPracDot').style.background=sel?.color||'var(--primary)';
    };

    // ── Comment ──
    document.getElementById('uComment').value=b.comment_client||'';

    // ── Internal note ──
    document.getElementById('calIntNote').value=b.internal_note||'';

    // ── Render sub-tabs ──
    fcRenderNotes();fcRenderTodos();fcRenderReminders();

    // ── Bottom bar: show/hide buttons based on status ──
    const isFrozen=['cancelled','no_show'].includes(b.status);
    document.getElementById('mBtnSave').style.display=isFrozen?'none':'';
    document.getElementById('mBtnNotify').style.display=isFrozen?'none':'';
    document.getElementById('mBtnCancel').style.display=isFrozen?'none':'';
    document.getElementById('mBtnPurge').style.display=isFrozen?'':'none';

    // ── Show modal ──
    switchCalTab(document.querySelector('.m-tab[data-tab="rdv"]'),'rdv');
    modal.classList.add('open');
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

function closeCalModal(id){
  const modal=document.getElementById(id);
  modal.classList.remove('open');
  // Auto-save internal note on close
  if(id==='calDetailModal'&&fcCurrentEventId){
    const note=document.getElementById('calIntNote')?.value;
    if(note!==undefined){
      fetch(`/api/bookings/${fcCurrentEventId}/note`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
        body:JSON.stringify({internal_note:note})
      }).catch(()=>{});
    }
  }
}

function switchCalTab(el,tab){
  document.querySelectorAll('.m-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.cal-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  const panelMap={rdv:'calPanelRdv',notes:'calPanelNotes',todos:'calPanelTodos',reminders:'calPanelReminders'};
  document.getElementById(panelMap[tab])?.classList.add('active');
}

// ── Status change ──
async function fcSetStatus(newStatus){
  try{
    const r=await fetch(`/api/bookings/${fcCurrentEventId}/status`,{
      method:'PATCH',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({status:newStatus})
    });
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    gToast('Statut mis à jour','success');
    closeCalModal('calDetailModal');
    fcRefresh();
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

async function fcPurgeBooking(){
  if(!confirm('Supprimer définitivement ce RDV ? Cette action est irréversible.'))return;
  try{
    const r=await fetch(`/api/bookings/${fcCurrentEventId}`,{
      method:'DELETE',
      headers:{'Authorization':'Bearer '+api.getToken()}
    });
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    gToast('RDV supprimé définitivement','success');
    closeCalModal('calDetailModal');
    fcRefresh();
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

// ── Edit tab: duration chips, diff, save ──
function calSetDuration(min,el){
  document.querySelectorAll('.m-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');
  const sv=document.getElementById('calEditStart').value;if(!sv)return;
  const[h,m]=sv.split(':').map(Number),em=h*60+m+min;
  document.getElementById('calEditEnd').value=String(Math.floor(em/60)).padStart(2,'0')+':'+String(em%60).padStart(2,'0');
  fcUpdateEditDiff();
}

function fcTimeDiffMin(s,e){const[sh,sm]=s.split(':').map(Number),[eh,em]=e.split(':').map(Number);return(eh*60+em)-(sh*60+sm);}

function fcUpdateEditDiff(){
  const nd=document.getElementById('calEditDate').value,ns=document.getElementById('calEditStart').value,ne=document.getElementById('calEditEnd').value;
  const d=document.getElementById('calEditDiff');
  const ch=nd!==fcEditOriginal.date||ns!==fcEditOriginal.start||ne!==fcEditOriginal.end;
  if(!ch){d.style.display='none';return;}
  let p=[];
  if(nd!==fcEditOriginal.date)p.push(`Date: ${fcEditOriginal.date} → ${nd}`);
  if(ns!==fcEditOriginal.start||ne!==fcEditOriginal.end)p.push(`Horaire: ${fcEditOriginal.start}–${fcEditOriginal.end} → ${ns}–${ne}`);
  const od=fcTimeDiffMin(fcEditOriginal.start,fcEditOriginal.end),nw=fcTimeDiffMin(ns,ne);
  if(od!==nw)p.push(`Durée: ${od} min → ${nw} min`);
  d.innerHTML=p.map(x=>{const[l,v]=x.split(': '),vs=v.split(' → ');return`<div style="margin-bottom:4px"><span style="font-size:.72rem;font-weight:600;color:var(--text-3)">${l}:</span> <span class="diff diff-old">${vs[0]}</span> <span class="diff-arrow">→</span> <span class="diff diff-new">${vs[1]}</span></div>`;}).join('');
  d.style.display='block';
}

async function calSaveAll(){
  const nd=document.getElementById('calEditDate').value;
  const ns=document.getElementById('calEditStart').value;
  const ne=document.getElementById('calEditEnd').value;
  if(!nd||!ns||!ne)return;
  if(fcTimeDiffMin(ns,ne)<=0){gToast("Fin doit être après début","error");return;}

  const newPrac=document.getElementById('uPracSelect').value;
  const newComment=document.getElementById('uComment').value.trim();
  const newNote=document.getElementById('calIntNote').value.trim();
  const isFreestyle=!fcCurrentBooking?.service_name;
  const newLabel=isFreestyle?document.getElementById('uFreeLabel').value.trim():'';
  const newColor=isFreestyle?document.getElementById('uFreeColor').value:'';

  // Check if time changed (needs notify flow)
  const timeChanged=nd!==fcEditOriginal.date||ns!==fcEditOriginal.start||ne!==fcEditOriginal.end;

  // Build edit payload (non-time fields)
  const editPayload={};
  if(newPrac!==fcEditOriginal.practitioner_id)editPayload.practitioner_id=newPrac;
  if(newComment!==(fcEditOriginal.comment||''))editPayload.comment=newComment;
  if(newNote!==(fcEditOriginal.internal_note||''))editPayload.internal_note=newNote;
  if(isFreestyle){
    if(newLabel!==(fcEditOriginal.custom_label||''))editPayload.custom_label=newLabel;
    if(newColor!==(fcEditOriginal.color||''))editPayload.color=newColor;
  }

  const hasFieldChanges=Object.keys(editPayload).length>0;

  // Save non-time fields first
  if(hasFieldChanges){
    try{
      const r=await fetch(`/api/bookings/${fcCurrentEventId}/edit`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
        body:JSON.stringify(editPayload)
      });
      if(!r.ok){const d=await r.json();throw new Error(d.error||'Erreur');}
    }catch(e){gToast('Erreur: '+e.message,'error');return;}
  }

  // If time changed → show notify panel
  if(timeChanged){
    document.getElementById('calNotifyPanel').style.display='block';
    document.getElementById('calNotifyPanel').scrollIntoView({behavior:'smooth',block:'nearest'});
    fcSelectedNotifyChannel=null;
    document.querySelectorAll('.notify-opt').forEach(o=>o.classList.remove('selected'));
    document.getElementById('calSendNotifyBtn').style.display='none';
    return; // Wait for notify selection
  }

  // No time change → just close
  if(hasFieldChanges)gToast('RDV mis à jour','success');
  else gToast('Aucun changement');
  closeCalModal('calDetailModal');
  fcRefresh();
}

// Keep old alias for backward compat
function calSaveTimeChange(){calSaveAll();}

function calSelectNotify(ch,el){
  fcSelectedNotifyChannel=ch;
  document.querySelectorAll('.notify-opt').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('calSendNotifyBtn').style.display=ch==='none'?'none':'inline-flex';
  // If "none", auto-save without notification
  if(ch==='none')calDoSaveTime(false,null);
}

function calCloseNotify(){document.getElementById('calNotifyPanel').style.display='none';}

async function calSendNotification(){
  if(!fcSelectedNotifyChannel||fcSelectedNotifyChannel==='none')return;
  await calDoSaveTime(true,fcSelectedNotifyChannel);
}

// Helper: check if a time range fits within business hours for a given day
// Uses practitioner-specific hours if pracId provided, otherwise global
function fcCheckBusinessHours(startDate,endDate,pracId){
  const bh=pracId&&fcPracBusinessHours[pracId]?fcPracBusinessHours[pracId]:fcBusinessHours;
  if(bh.length===0)return true;
  const day=startDate.getDay();
  const dayBH=bh.filter(b=>b.daysOfWeek.includes(day));
  if(dayBH.length===0)return false;
  const startH=startDate.getHours()+startDate.getMinutes()/60;
  const endH=endDate.getHours()+endDate.getMinutes()/60;
  const slots=dayBH.map(b=>({
    s:parseInt(b.startTime.split(':')[0])+parseInt(b.startTime.split(':')[1]||0)/60,
    e:parseInt(b.endTime.split(':')[0])+parseInt(b.endTime.split(':')[1]||0)/60
  })).sort((a,b)=>a.s-b.s);
  const merged=[];
  for(const sl of slots){
    if(merged.length>0&&sl.s<=merged[merged.length-1].e){
      merged[merged.length-1].e=Math.max(merged[merged.length-1].e,sl.e);
    }else{
      merged.push({s:sl.s,e:sl.e});
    }
  }
  return merged.some(sl=>startH>=sl.s&&endH<=sl.e);
}

async function calDoSaveTime(notify,channel){
  const nd=document.getElementById('calEditDate').value,ns=document.getElementById('calEditStart').value,ne=document.getElementById('calEditEnd').value;
  // Build proper ISO strings (browser local → UTC) so backend delta calc is correct
  const start_at=new Date(nd+'T'+ns).toISOString();
  const end_at=new Date(nd+'T'+ne).toISOString();
  try{
    const isGrouped=!!fcCurrentBooking?.group_id;

    // NOTE: Business hours validation removed for manual bookings.
    // Practitioners can place bookings during breaks at their discretion.
    // Public booking API enforces availability constraints for clients.

    // ── Save ──
    let r;
    if(isGrouped){
      r=await fetch(`/api/bookings/${fcCurrentEventId}/move`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
        body:JSON.stringify({start_at,end_at,practitioner_id:fcCurrentBooking.practitioner_id})
      });
    }else{
      r=await fetch(`/api/bookings/${fcCurrentEventId}/modify`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
        body:JSON.stringify({start_at,end_at,notify:!!notify,notify_channel:channel})
      });
    }
    if(!r.ok){const d=await r.json();throw new Error(d.error||'Erreur');}
    const result=await r.json();
    const label=isGrouped
      ?`Groupe déplacé (${result.count||fcCurrentBooking.group_order+1} prestations)`
      :(notify?{email:'Email envoyé',sms:'SMS envoyé',both:'Email + SMS envoyés'}[channel]:'Horaire mis à jour');
    gToast(label,'success');
    calCloseNotify();
    closeCalModal('calDetailModal');
    fcRefresh();
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

// ── Notes CRUD ──
function fcRenderNotes(){
  const n=fcDetailData.notes,el=document.getElementById('calNoteList');
  if(!n.length){el.innerHTML='<div class="cal-empty"><div class="cal-empty-icon">📝</div>Aucune note</div>';return;}
  el.innerHTML=n.map(x=>`<div class="note-card ${x.is_pinned?'pinned':''}"><div class="note-content">${escH(x.content)}</div><div class="note-meta">${x.author_email||'Vous'} · ${new Date(x.created_at).toLocaleDateString('fr-BE')}${x.is_pinned?' · 📌':''}</div><button class="note-delete" onclick="fcDeleteNote('${x.id}')">✕</button></div>`).join('');
}

async function calAddNote(){
  const c=document.getElementById('calNewNote').value.trim();if(!c)return;
  const p=document.getElementById('calNotePinned').checked;
  try{
    const r=await fetch(`/api/bookings/${fcCurrentEventId}/notes`,{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({content:c,is_pinned:p})
    });
    if(!r.ok)throw new Error('Erreur');
    const d=await r.json();
    fcDetailData.notes.unshift(d.note);
    document.getElementById('calNewNote').value='';document.getElementById('calNotePinned').checked=false;
    fcRenderNotes();gToast('Note ajoutée','success');
    fcRefresh();
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

async function fcDeleteNote(noteId){
  try{
    await fetch(`/api/bookings/${fcCurrentEventId}/notes/${noteId}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    fcDetailData.notes=fcDetailData.notes.filter(n=>n.id!==noteId);
    fcRenderNotes();
  }catch(e){gToast('Erreur','error');}
}

// ── Todos CRUD ──
function fcRenderTodos(){
  const t=fcDetailData.todos,el=document.getElementById('calTodoList');
  if(!t.length){el.innerHTML='<div class="cal-empty"><div class="cal-empty-icon">☑️</div>Aucune tâche</div>';return;}
  el.innerHTML=t.map(x=>`<div class="todo-item ${x.is_done?'done':''}"><div class="todo-check" onclick="fcToggleTodo('${x.id}',${!x.is_done})">${x.is_done?'✓':''}</div><span class="todo-text">${escH(x.content)}</span><button class="todo-delete" onclick="fcDeleteTodo('${x.id}')">✕</button></div>`).join('');
}

async function calAddTodo(){
  const c=document.getElementById('calNewTodo').value.trim();if(!c)return;
  try{
    const r=await fetch(`/api/bookings/${fcCurrentEventId}/todos`,{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({content:c})
    });
    if(!r.ok)throw new Error('Erreur');
    const d=await r.json();
    fcDetailData.todos.push(d.todo);
    document.getElementById('calNewTodo').value='';
    fcRenderTodos();gToast('Tâche ajoutée','success');
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

async function fcToggleTodo(todoId,isDone){
  try{
    await fetch(`/api/bookings/${fcCurrentEventId}/todos/${todoId}`,{
      method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({is_done:isDone})
    });
    const todo=fcDetailData.todos.find(t=>t.id===todoId);
    if(todo)todo.is_done=isDone;
    fcRenderTodos();
  }catch(e){gToast('Erreur','error');}
}

async function fcDeleteTodo(todoId){
  try{
    await fetch(`/api/bookings/${fcCurrentEventId}/todos/${todoId}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    fcDetailData.todos=fcDetailData.todos.filter(t=>t.id!==todoId);
    fcRenderTodos();
  }catch(e){gToast('Erreur','error');}
}

// ── Reminders CRUD ──
function fcRenderReminders(){
  const r=fcDetailData.reminders,el=document.getElementById('calReminderList');
  const lbl={15:'15 min',30:'30 min',60:'1h',120:'2h',1440:'Veille'};
  const ch={browser:'🖥 Notif',email:'✉️ Email',both:'🖥+✉️'};
  if(!r.length){el.innerHTML='<div class="cal-empty"><div class="cal-empty-icon">🔔</div>Aucun rappel</div>';return;}
  el.innerHTML=r.map(x=>`<div class="reminder-card"><div class="reminder-icon">🔔</div><div><div class="ri-time">${lbl[x.offset_minutes]||x.offset_minutes+' min'} avant</div><div class="ri-channel">${ch[x.channel]||x.channel}${x.is_sent?' · ✓ envoyé':''}</div></div><button class="reminder-delete" onclick="fcDeleteReminder('${x.id}')">✕</button></div>`).join('');
}

async function calAddReminder(){
  const offset=parseInt(document.getElementById('calReminderOffset').value);
  const channel=document.getElementById('calReminderChannel').value;
  try{
    const r=await fetch(`/api/bookings/${fcCurrentEventId}/reminders`,{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({offset_minutes:offset,channel:channel})
    });
    if(!r.ok)throw new Error('Erreur');
    const d=await r.json();
    fcDetailData.reminders.push(d.reminder);
    fcRenderReminders();gToast('Rappel ajouté','success');
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

async function fcDeleteReminder(remId){
  try{
    await fetch(`/api/bookings/${fcCurrentEventId}/reminders/${remId}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    fcDetailData.reminders=fcDetailData.reminders.filter(r=>r.id!==remId);
    fcRenderReminders();
  }catch(e){gToast('Erreur','error');}
}

// ── Quick Create ──
let qcServiceCount=0;

function fcOpenQuickCreate(startStr,endStr){
  let d;
  if(startStr){d=new Date(startStr);}
  else{
    d=new Date(fcIsMobile()?fcMobileDate:new Date());
    const now=new Date();
    if(d.toDateString()===now.toDateString()){
      d.setHours(now.getHours()+1,0,0,0);
    }else{d.setHours(9,0,0,0);}
  }
  document.getElementById('qcDate').value=d.toISOString().split('T')[0];
  document.getElementById('qcTime').value=d.toTimeString().slice(0,5);
  document.getElementById('qcClient').value='';
  document.getElementById('qcClientId').value='';
  document.getElementById('qcComment').value='';
  document.getElementById('qcAcResults').style.display='none';
  // Reset freestyle mode
  document.getElementById('qcFreestyle').checked=false;
  document.getElementById('qcNormalMode').style.display='';
  document.getElementById('qcFreestyleMode').style.display='none';
  document.getElementById('qcFreeLabel').value='';
  document.getElementById('qcFreeBufBefore').value='0';
  document.getElementById('qcFreeBufAfter').value='0';
  document.getElementById('qcFreeColorWrap').innerHTML=cswHTML('qcFreeColor','#0D7377',false);

  // Populate practitioners dropdown
  const prSel=document.getElementById('qcPrac');
  prSel.innerHTML=fcPractitioners.map(p=>`<option value="${p.id}">${p.display_name}</option>`).join('');

  // Init service list with one entry
  qcServiceCount=0;
  document.getElementById('qcServiceList').innerHTML='';
  qcAddService();

  document.getElementById('calCreateModal').classList.add('open');
}

function qcToggleFreestyle(){
  const on=document.getElementById('qcFreestyle').checked;
  document.getElementById('qcNormalMode').style.display=on?'none':'';
  document.getElementById('qcFreestyleMode').style.display=on?'':'none';
  document.getElementById('qcModeRow').style.display=on?'none':'';
  if(on){
    // Auto-set end time = start + 1h
    const t=document.getElementById('qcTime').value;
    if(t){
      const [h,m]=t.split(':').map(Number);
      const endH=Math.min(h+1,23);
      document.getElementById('qcFreeEnd').value=String(endH).padStart(2,'0')+':'+String(m).padStart(2,'0');
    }
    qcUpdateFreeDuration();
  }
}

function qcUpdateFreeDuration(){
  const t=document.getElementById('qcTime').value;
  const e=document.getElementById('qcFreeEnd').value;
  if(!t||!e)return;
  const [sh,sm]=t.split(':').map(Number);
  const [eh,em]=e.split(':').map(Number);
  let dur=(eh*60+em)-(sh*60+sm);
  if(dur<=0)dur+=24*60;
  const bb=parseInt(document.getElementById('qcFreeBufBefore').value)||0;
  const ba=parseInt(document.getElementById('qcFreeBufAfter').value)||0;
  const total=dur+bb+ba;
  const el=document.getElementById('qcFreeDuration');
  const h=Math.floor(dur/60),m=dur%60;
  el.innerHTML=`⏱ Durée : <strong>${h?h+'h':''}${m?m+'min':''}</strong>${(bb||ba)?' + buffers '+(bb?bb+'min avant ':' ')+(ba?ba+'min après':''):''}`;
}

// Auto-update freestyle duration on input changes
document.addEventListener('change',e=>{
  if(['qcFreeEnd','qcFreeBufBefore','qcFreeBufAfter'].includes(e.target?.id))qcUpdateFreeDuration();
});
document.addEventListener('input',e=>{
  if(e.target?.id==='qcTime'&&document.getElementById('qcFreestyle')?.checked)qcUpdateFreeDuration();
});

function qcAddService(){
  const idx=qcServiceCount++;
  const opts=fcServices.filter(s=>s.is_active!==false).map(s=>`<option value="${s.id}" data-dur="${s.duration_min}" data-buf="${(s.buffer_before_min||0)+(s.buffer_after_min||0)}" data-color="${s.color||'#0D7377'}">${s.name} (${s.duration_min} min)</option>`).join('');
  const html=`<div class="qc-svc-item" id="qcSvc${idx}">
    <span class="qc-svc-handle">☰</span>
    <span class="qc-svc-color" id="qcSvcCol${idx}"></span>
    <select onchange="qcUpdateTotal()" id="qcSvcSel${idx}">${opts}</select>
    <span class="qc-svc-dur" id="qcSvcDur${idx}"></span>
    <button class="qc-svc-rm" onclick="qcRemoveService(${idx})" title="Retirer">✕</button>
  </div>`;
  document.getElementById('qcServiceList').insertAdjacentHTML('beforeend',html);
  qcUpdateTotal();
}

function qcRemoveService(idx){
  const el=document.getElementById('qcSvc'+idx);
  if(el)el.remove();
  // Must keep at least one
  if(document.querySelectorAll('.qc-svc-item').length===0)qcAddService();
  else qcUpdateTotal();
}

function qcUpdateTotal(){
  let total=0;
  const svcItems=document.querySelectorAll('.qc-svc-item');
  // Collect mode_options intersection
  let availModes=null;
  svcItems.forEach(item=>{
    const sel=item.querySelector('select');
    if(!sel)return;
    const opt=sel.options[sel.selectedIndex];
    const dur=parseInt(opt?.dataset.dur||30);
    const buf=parseInt(opt?.dataset.buf||0);
    const color=opt?.dataset.color||'#0D7377';
    total+=dur+buf;
    const durEl=item.querySelector('.qc-svc-dur');
    if(durEl)durEl.textContent=dur+'min';
    const colEl=item.querySelector('.qc-svc-color');
    if(colEl)colEl.style.background=color;
    // Get this service's mode_options
    const svcId=sel.value;
    const svc=fcServices.find(s=>s.id===svcId);
    const modes=svc?.mode_options||['cabinet'];
    if(!availModes)availModes=new Set(modes);
    else availModes=new Set([...availModes].filter(m=>modes.includes(m)));
  });
  // Update total display
  const el=document.getElementById('qcTotalDuration');
  if(svcItems.length>1){
    const h=Math.floor(total/60),m=total%60;
    el.innerHTML=`⏱ Durée totale : <strong>${h?h+'h':''}${m?m+'min':''}</strong> · ${svcItems.length} prestations (groupe lié)`;
  }else{
    el.innerHTML=`⏱ ${total} min`;
  }
  // Update mode selector
  const modeRow=document.getElementById('qcModeRow');
  const modeSel=document.getElementById('qcMode');
  const modes=availModes?[...availModes]:['cabinet'];
  if(modes.length<=1&&modes[0]==='cabinet'){
    modeRow.style.display='none';
    modeSel.value='cabinet';
  }else{
    modeRow.style.display='';
    const curVal=modeSel.value;
    modeSel.innerHTML=modes.map(m=>`<option value="${m}">${{cabinet:'🏢 Cabinet',visio:'💻 Visio',phone:'📞 Téléphone'}[m]||m}</option>`).join('');
    if(modes.includes(curVal))modeSel.value=curVal;
  }
}

// Client autocomplete
function calSearchClients(q){
  clearTimeout(fcClientSearchTimer);
  const res=document.getElementById('qcAcResults');
  if(q.length<2){res.style.display='none';return;}
  fcClientSearchTimer=setTimeout(async()=>{
    try{
      const r=await fetch(`/api/clients?search=${encodeURIComponent(q)}&limit=6`,{headers:{'Authorization':'Bearer '+api.getToken()}});
      const d=await r.json();
      const clients=d.clients||[];
      let h=clients.map(c=>`<div class="ac-item" onclick="calPickClient('${c.id}','${escH(c.full_name)}')">`+
        `<div class="ac-name">${escH(c.full_name)}</div><div class="ac-meta">${c.phone||''} ${c.email||''}</div></div>`).join('');
      h+=`<div class="ac-item ac-new" onclick="calNewClient()">+ Nouveau client : "${escH(q)}"</div>`;
      res.innerHTML=h;res.style.display='block';
    }catch(e){res.style.display='none';}
  },300);
}

function calPickClient(id,name){
  document.getElementById('qcClient').value=name;
  document.getElementById('qcClientId').value=id;
  document.getElementById('qcAcResults').style.display='none';
}

function calNewClient(){
  document.getElementById('qcClientId').value='NEW';
  document.getElementById('qcAcResults').style.display='none';
}

async function calCreateBooking(){
  const clientName=document.getElementById('qcClient').value.trim();
  const clientId=document.getElementById('qcClientId').value;
  const pracId=document.getElementById('qcPrac').value;
  const date=document.getElementById('qcDate').value;
  const time=document.getElementById('qcTime').value;
  const mode=document.getElementById('qcMode').value;
  const comment=document.getElementById('qcComment').value.trim();
  const isFreestyle=document.getElementById('qcFreestyle').checked;

  if(!clientName){gToast('Nom du client requis','error');return;}
  if(!date||!time){gToast('Date et heure requises','error');return;}

  const start_at=new Date(date+'T'+time).toISOString();

  try{
    let actualClientId=clientId;
    if(!clientId||clientId==='NEW'){
      const cr=await fetch('/api/clients',{
        method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
        body:JSON.stringify({full_name:clientName})
      });
      if(!cr.ok){const d=await cr.json();throw new Error(d.error||'Erreur création client');}
      const cd=await cr.json();
      actualClientId=cd.client?.id;
    }

    let body;
    if(isFreestyle){
      const endTime=document.getElementById('qcFreeEnd').value;
      if(!endTime){gToast('Heure de fin requise','error');return;}
      const end_at=new Date(date+'T'+endTime).toISOString();
      body={
        freestyle:true,
        practitioner_id:pracId,
        client_id:actualClientId,
        start_at,
        end_at,
        buffer_before_min:parseInt(document.getElementById('qcFreeBufBefore').value)||0,
        buffer_after_min:parseInt(document.getElementById('qcFreeBufAfter').value)||0,
        custom_label:document.getElementById('qcFreeLabel').value.trim()||null,
        color:document.getElementById('qcFreeColor').value,
        appointment_mode:'cabinet',
        comment:comment||null
      };
    }else{
      // Collect all services
      const serviceItems=document.querySelectorAll('.qc-svc-item select');
      const services=[...serviceItems].map(sel=>({service_id:sel.value}));
      if(services.length===0){gToast('Choisissez au moins une prestation','error');return;}

      body={
        practitioner_id:pracId,
        client_id:actualClientId,
        start_at,
        appointment_mode:mode,
        comment:comment||null
      };
      if(services.length===1){
        body.service_id=services[0].service_id;
      }else{
        body.services=services;
      }
    }

    const r=await fetch('/api/bookings/manual',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify(body)
    });
    if(!r.ok){const d=await r.json();throw new Error(d.error||'Erreur');}
    const result=await r.json();
    const count=result.bookings?.length||1;
    gToast(isFreestyle?`${clientName} — RDV libre créé !`:count>1?`${clientName} — ${count} prestations créées !`:`${clientName} — RDV créé !`,'success');
    closeCalModal('calCreateModal');
    fcRefresh();
  }catch(e){gToast('Erreur: '+e.message,'error');}
}

// Escape HTML helper
function escH(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''}

// Close modals on overlay click / Escape
document.querySelectorAll('.cal-modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeCalModal(o.id);}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.cal-modal-overlay.open').forEach(m=>closeCalModal(m.id));});

// ============================================================
// ANALYTICS
// ============================================================
let analyticsPeriod='30d';

async function loadAnalytics(period){
  if(period)analyticsPeriod=period;
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const r=await fetch(`/api/dashboard/analytics?period=${analyticsPeriod}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    renderAnalytics(d);
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function renderAnalytics(d){
  const c=document.getElementById('contentArea');
  const t=d.totals;
  let h=`<div class="an-period">
    <button class="${analyticsPeriod==='7d'?'active':''}" onclick="loadAnalytics('7d')">7 jours</button>
    <button class="${analyticsPeriod==='30d'?'active':''}" onclick="loadAnalytics('30d')">30 jours</button>
    <button class="${analyticsPeriod==='90d'?'active':''}" onclick="loadAnalytics('90d')">90 jours</button>
  </div>`;

  // KPIs
  h+=`<div class="an-kpi">
    <div class="kpi"><div class="kv">${t.bookings}</div><div class="kl">RDV confirmés</div></div>
    <div class="kpi"><div class="kv">${(t.revenue/100).toFixed(0)} €</div><div class="kl">Chiffre d'affaires</div></div>
    <div class="kpi"><div class="kv">${(t.avg_booking_value/100).toFixed(0)} €</div><div class="kl">Panier moyen</div></div>
    <div class="kpi"><div class="kv">${t.no_show_rate}%</div><div class="kl">Taux no-show</div></div>
    <div class="kpi"><div class="kv">${d.new_clients}</div><div class="kl">Nouveaux clients</div></div>
  </div>`;

  // Charts row 1: Revenue + Bookings trend
  h+=`<div class="chart-card"><h4>Évolution du chiffre d'affaires</h4><canvas id="chartRevenue" height="200"></canvas></div>`;
  h+=`<div class="chart-card"><h4>Rendez-vous par jour</h4><canvas id="chartBookings" height="160"></canvas></div>`;

  // Charts row 2: Top services + Status breakdown
  h+=`<div class="chart-row">`;

  // Top services
  h+=`<div class="chart-card"><h4>Top prestations</h4>`;
  if(d.top_services.length===0){h+=`<div class="empty" style="padding:20px">Pas encore de données</div>`;}
  else{
    const maxCount=Math.max(...d.top_services.map(s=>s.count),1);
    h+=`<div class="top-svc-list">`;
    d.top_services.forEach(s=>{
      const pct=Math.round(s.count/maxCount*100);
      h+=`<div class="top-svc-row"><span class="sname">${s.name}</span><div class="bar-wrap"><div class="bar" style="width:${pct}%;background:${s.color||'var(--primary)'}">${s.count}</div></div><span class="scount">${(s.revenue/100).toFixed(0)}€</span></div>`;
    });
    h+=`</div>`;
  }
  h+=`</div>`;

  // Status breakdown
  h+=`<div class="chart-card"><h4>Répartition des statuts</h4><canvas id="chartStatus" height="200"></canvas>`;
  const stColors={confirmed:'#0D7377',completed:'#6B6560',pending:'#A68B3C',no_show:'#DC8C00',cancelled:'#DC2626'};
  const stLabels={confirmed:'Confirmé',completed:'Terminé',pending:'En attente',no_show:'No-show',cancelled:'Annulé'};
  h+=`<div class="status-legend">`;
  d.status_breakdown.forEach(s=>{h+=`<span class="sl"><span class="dot" style="background:${stColors[s.status]||'#999'}"></span>${stLabels[s.status]||s.status}: ${s.count}</span>`;});
  h+=`</div></div>`;

  h+=`</div>`; // end chart-row

  // Peak hours heatmap
  h+=`<div class="chart-card"><h4>Heures de pointe</h4><div class="heatmap" id="heatmap"></div></div>`;

  // Monthly revenue
  if(d.monthly.length>1){
    h+=`<div class="chart-card"><h4>Revenus mensuels</h4><canvas id="chartMonthly" height="180"></canvas></div>`;
  }

  c.innerHTML=h;

  // Draw charts after DOM is ready
  setTimeout(()=>{
    drawLineChart('chartRevenue',d.daily.map(r=>r.day?.slice(5)||''),d.daily.map(r=>r.revenue/100),'€','#0D7377');
    drawBarChart('chartBookings',d.daily.map(r=>r.day?.slice(5)||''),d.daily.map(r=>r.bookings),'#0D7377');
    drawDonutChart('chartStatus',d.status_breakdown.map(s=>s.count),d.status_breakdown.map(s=>stColors[s.status]||'#999'));
    drawHeatmap('heatmap',d.peak_hours);
    if(d.monthly.length>1){
      const mLabels=d.monthly.map(m=>{const[y,mo]=m.month.split('-');return['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'][parseInt(mo)-1];});
      drawBarChart('chartMonthly',mLabels,d.monthly.map(m=>m.revenue/100),'#0D7377',true);
    }
  },50);
}

// ===== CHART HELPERS (Canvas) =====
function drawLineChart(id,labels,data,suffix,color){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const w=canvas.parentElement.clientWidth-36;
  canvas.width=w*dpr;canvas.height=200*dpr;canvas.style.width=w+'px';canvas.style.height='200px';
  ctx.scale(dpr,dpr);
  const pad={t:20,r:20,b:30,l:50};
  const cw=w-pad.l-pad.r,ch=200-pad.t-pad.b;
  const max=Math.max(...data,1)*1.15;
  const step=cw/(data.length-1||1);

  // Grid
  ctx.strokeStyle='#ECEAE6';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+ch-ch*(i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(w-pad.r,y);ctx.stroke();
    ctx.fillStyle='#9C958E';ctx.font='10px sans-serif';ctx.textAlign='right';
    ctx.fillText(Math.round(max*i/4)+(suffix||''),pad.l-6,y+3);
  }

  // Line
  ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.beginPath();
  data.forEach((v,i)=>{
    const x=pad.l+i*step,y=pad.t+ch-ch*(v/max);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Fill
  ctx.lineTo(pad.l+(data.length-1)*step,pad.t+ch);ctx.lineTo(pad.l,pad.t+ch);ctx.closePath();
  ctx.fillStyle=color+'18';ctx.fill();

  // Dots
  data.forEach((v,i)=>{
    const x=pad.l+i*step,y=pad.t+ch-ch*(v/max);
    ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
  });

  // X labels (show subset)
  ctx.fillStyle='#9C958E';ctx.font='9px sans-serif';ctx.textAlign='center';
  const labelStep=Math.max(1,Math.floor(labels.length/8));
  labels.forEach((l,i)=>{if(i%labelStep===0)ctx.fillText(l,pad.l+i*step,200-6);});
}

function drawBarChart(id,labels,data,color,showValues){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const w=canvas.parentElement.clientWidth-36;
  const h=parseInt(canvas.getAttribute('height'))||160;
  canvas.width=w*dpr;canvas.height=h*dpr;canvas.style.width=w+'px';canvas.style.height=h+'px';
  ctx.scale(dpr,dpr);
  const pad={t:20,r:20,b:30,l:50};
  const cw=w-pad.l-pad.r,ch=h-pad.t-pad.b;
  const max=Math.max(...data,1)*1.15;
  const barW=Math.min(cw/data.length*0.7,40);
  const gap=cw/data.length;

  // Grid
  ctx.strokeStyle='#ECEAE6';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+ch-ch*(i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(w-pad.r,y);ctx.stroke();
    ctx.fillStyle='#9C958E';ctx.font='10px sans-serif';ctx.textAlign='right';
    ctx.fillText(Math.round(max*i/4),pad.l-6,y+3);
  }

  // Bars
  data.forEach((v,i)=>{
    const x=pad.l+i*gap+(gap-barW)/2;
    const bh=ch*(v/max);
    const y=pad.t+ch-bh;
    ctx.fillStyle=color;
    ctx.beginPath();
    // Rounded top corners
    const r=Math.min(3,barW/2);
    ctx.moveTo(x,pad.t+ch);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
    ctx.lineTo(x+barW-r,y);ctx.quadraticCurveTo(x+barW,y,x+barW,y+r);
    ctx.lineTo(x+barW,pad.t+ch);ctx.fill();

    if(showValues&&v>0){ctx.fillStyle='#FFF';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.fillText(Math.round(v),x+barW/2,y+14);}
  });

  // X labels
  ctx.fillStyle='#9C958E';ctx.font='9px sans-serif';ctx.textAlign='center';
  const labelStep=Math.max(1,Math.floor(labels.length/10));
  labels.forEach((l,i)=>{if(i%labelStep===0)ctx.fillText(l,pad.l+i*gap+gap/2,h-6);});
}

function drawDonutChart(id,data,colors){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const size=200;
  canvas.width=size*dpr;canvas.height=size*dpr;canvas.style.width=size+'px';canvas.style.height=size+'px';
  ctx.scale(dpr,dpr);
  const cx=size/2,cy=size/2,r=70,inner=42;
  const total=data.reduce((a,b)=>a+b,0)||1;
  let angle=-Math.PI/2;
  data.forEach((v,i)=>{
    const sweep=v/total*Math.PI*2;
    ctx.beginPath();ctx.arc(cx,cy,r,angle,angle+sweep);ctx.arc(cx,cy,inner,angle+sweep,angle,true);ctx.closePath();
    ctx.fillStyle=colors[i]||'#999';ctx.fill();
    angle+=sweep;
  });
  // Center text
  ctx.fillStyle='#1A1816';ctx.font='bold 20px sans-serif';ctx.textAlign='center';ctx.fillText(total,cx,cy+3);
  ctx.fillStyle='#9C958E';ctx.font='10px sans-serif';ctx.fillText('Total',cx,cy+16);
}

function drawHeatmap(id,data){
  const el=document.getElementById(id);if(!el)return;
  const DAYS=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  // Map to weekday 1-7 (Mon=1, Sun=0→7)
  const grid={};let maxV=1;
  data.forEach(d=>{
    const wd=d.weekday===0?7:d.weekday; // Sun=7
    const key=`${wd}-${d.hour}`;
    grid[key]=(grid[key]||0)+d.count;
    if(grid[key]>maxV)maxV=grid[key];
  });

  let h='<div class="hl"></div>';
  // Show hours 7-20 only
  for(let hr=7;hr<=20;hr++){h+=`<div class="hh">${hr}</div>`;}
  for(let d=1;d<=7;d++){
    h+=`<div class="hl">${DAYS[d-1]}</div>`;
    for(let hr=7;hr<=20;hr++){
      const v=grid[`${d}-${hr}`]||0;
      const intensity=v/maxV;
      const bg=v===0?'var(--surface)':`rgba(13,115,119,${0.15+intensity*0.85})`;
      h+=`<div class="hc" style="background:${bg}" title="${DAYS[d-1]} ${hr}h: ${v} RDV">${v||''}</div>`;
    }
  }
  el.style.gridTemplateColumns=`40px repeat(14,1fr)`;
  el.innerHTML=h;
}

// ============================================================
// CLIENTS
// ============================================================
let clientSearch='';
let clientFilter='';
async function loadClients(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const params=new URLSearchParams();
    if(clientSearch)params.set('search',clientSearch);
    if(clientFilter)params.set('filter',clientFilter);
    const q=params.toString()?'?'+params.toString():'';
    const r=await fetch(`/api/clients${q}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const clients=d.clients||[];
    const stats=d.stats||{};
    let h=`<div class="kpis"><div class="kpi" onclick="clientFilter='';loadClients()" style="cursor:pointer"><div class="kpi-val">${stats.total||0}</div><div class="kpi-label">Total clients</div></div><div class="kpi" onclick="clientFilter='blocked';loadClients()" style="cursor:pointer"><div class="kpi-val" style="color:var(--red)">${stats.blocked||0}</div><div class="kpi-label">🚫 Bloqués</div></div><div class="kpi" onclick="clientFilter='flagged';loadClients()" style="cursor:pointer"><div class="kpi-val" style="color:#B45309">${stats.flagged||0}</div><div class="kpi-label">⚠️ No-shows</div></div><div class="kpi"><div class="kpi-val" style="color:var(--primary)">${stats.clean||0}</div><div class="kpi-label">✅ OK</div></div></div>`;
    h+=`<div class="search-bar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><input type="text" placeholder="Rechercher un client..." value="${clientSearch}" id="clientSearchInput" onkeydown="if(event.key==='Enter'){clientSearch=this.value;clientFilter='';loadClients()}" style="flex:1;min-width:200px"><button class="btn-primary" onclick="clientSearch=document.getElementById('clientSearchInput').value;clientFilter='';loadClients()">Rechercher</button>${clientSearch||clientFilter?`<button class="btn-outline" onclick="clientSearch='';clientFilter='';loadClients()">✕ Reset</button>`:''}</div>`;
    h+=`<div style="display:flex;gap:6px;margin-bottom:12px"><button class="btn-sm ${!clientFilter?'active':''}" onclick="clientFilter='';loadClients()">Tous</button><button class="btn-sm ${clientFilter==='blocked'?'active':''}" onclick="clientFilter='blocked';loadClients()">🚫 Bloqués</button><button class="btn-sm ${clientFilter==='flagged'?'active':''}" onclick="clientFilter='flagged';loadClients()">⚠️ No-shows</button></div>`;
    h+=`<div class="card"><div class="card-h"><h3>${clientFilter==='blocked'?'Clients bloqués':clientFilter==='flagged'?'Clients avec no-shows':'Tous les clients'}</h3><span class="badge badge-teal">${d.total||clients.length}</span></div>`;
    if(clients.length===0){h+=`<div class="empty">Aucun client${clientSearch?' trouvé':clientFilter?' dans cette catégorie':' encore'}</div>`;}
    else{
      h+=`<div style="overflow-x:auto"><table class="table"><thead><tr><th>Nom</th><th>Téléphone</th><th>Email</th><th>RDV</th><th>No-shows</th><th>Dernière visite</th><th>Statut</th></tr></thead><tbody>`;
      clients.forEach(cl=>{
        const last=cl.last_visit?new Date(cl.last_visit).toLocaleDateString('fr-BE',{day:'numeric',month:'short',year:'numeric'}):'—';
        const tagColors={'bloqué':'#dc2626','récidiviste':'#B45309','à surveiller':'#ca8a04','fidèle':'#15803d','actif':'#0D7377','nouveau':'#888'};
        const tagColor=tagColors[cl.tag]||'#888';
        const nsDisplay=cl.no_show_count>0?`<span style="color:#B45309;font-weight:600">${cl.no_show_count}</span>`:'0';
        h+=`<tr${cl.is_blocked?' style="opacity:.6"':''}><td class="client-name" onclick="openClientDetail('${cl.id}')">${cl.full_name}${cl.is_blocked?' 🚫':''}</td><td>${cl.phone||'—'}</td><td style="font-size:.78rem">${cl.email||'—'}</td><td>${cl.total_bookings}</td><td>${nsDisplay}</td><td style="font-size:.78rem">${last}</td><td><span style="font-size:.72rem;font-weight:600;color:${tagColor};background:${tagColor}15;padding:2px 8px;border-radius:10px">${cl.tag}</span></td></tr>`;
      });
      h+=`</tbody></table></div>`;
    }
    h+=`</div>`;
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function openClientDetail(id){
  try{
    const r=await fetch(`/api/clients/${id}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const cl=d.client, bks=d.bookings||[];
    let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${cl.full_name}${cl.is_blocked?' 🚫':''}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">`;
    if(cl.is_blocked){
      m+=`<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;margin-bottom:12px;font-size:.82rem"><strong style="color:#dc2626">🚫 Client bloqué</strong><br><span style="color:#666">${cl.blocked_reason||'Bloqué manuellement'}</span><br><button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#15803d;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="unblockClient('${cl.id}')">Débloquer</button> <button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#666;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="resetNoShow('${cl.id}')">Reset no-shows</button></div>`;
    }else if(cl.no_show_count>0){
      m+=`<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:12px;margin-bottom:12px;font-size:.82rem"><strong style="color:#B45309">⚠️ ${cl.no_show_count} no-show${cl.no_show_count>1?'s':''}</strong>${cl.last_no_show_at?` <span style="color:#888">· dernier le ${new Date(cl.last_no_show_at).toLocaleDateString('fr-BE')}</span>`:''}<br><button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#dc2626;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="blockClient('${cl.id}')">Bloquer</button> <button style="margin-top:6px;font-size:.75rem;padding:4px 10px;background:#666;color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="resetNoShow('${cl.id}')">Reset</button></div>`;
    }
    m+=`<div class="field-row"><div class="field"><label>Nom</label><input id="cl_name" value="${cl.full_name||''}"></div><div class="field"><label>Téléphone</label><input id="cl_phone" value="${cl.phone||''}"></div></div>`;
    m+=`<div class="field-row"><div class="field"><label>Email</label><input id="cl_email" value="${cl.email||''}"></div><div class="field"><label>N° BCE</label><input id="cl_bce" value="${cl.bce_number||''}"></div></div>`;
    m+=`<div class="field"><label>Notes</label><textarea id="cl_notes">${cl.notes||''}</textarea></div>`;
    m+=`</div><div class="modal-foot">`;
    if(bks.length>0){
      m+=`<div style="margin-top:12px"><label style="font-size:.78rem;font-weight:600;color:var(--text-3)">Historique (${bks.length} RDV)</label>`;
      const stColors={completed:'var(--text-4)',cancelled:'var(--red)',no_show:'#B45309',confirmed:'var(--primary)'};
      const stLabels={completed:'Terminé',cancelled:'Annulé',no_show:'No-show',confirmed:'Confirmé',pending:'En attente'};
      bks.slice(0,15).forEach(b=>{
        const dt=new Date(b.start_at);
        m+=`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border-light);font-size:.8rem"><span>${dt.toLocaleDateString('fr-BE',{day:'numeric',month:'short'})} — ${b.service_name}</span><span style="color:${stColors[b.status]||'inherit'};font-weight:${b.status==='no_show'?'600':'400'}">${stLabels[b.status]||b.status}</span></div>`;
      });
      m+=`</div>`;
    }
    if(!cl.is_blocked&&cl.no_show_count===0){
      m+=`<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-light)"><button style="font-size:.75rem;padding:4px 10px;background:transparent;color:#dc2626;border:1px solid #fecaca;border-radius:6px;cursor:pointer" onclick="blockClient('${cl.id}')">🚫 Bloquer ce client</button></div>`;
    }
    m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Fermer</button><button class="btn-primary" onclick="saveClient('${id}')">Enregistrer</button></div></div></div>`;
    document.body.insertAdjacentHTML('beforeend',m);
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function saveClient(id){
  try{
    const r=await fetch(`/api/clients/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({full_name:document.getElementById('cl_name').value,phone:document.getElementById('cl_phone').value,email:document.getElementById('cl_email').value,bce_number:document.getElementById('cl_bce').value,notes:document.getElementById('cl_notes').value})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast('Client mis à jour','success');loadClients();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function blockClient(id){
  const reason=prompt('Raison du blocage (optionnel):');
  if(reason===null)return;
  try{
    const r=await fetch(`/api/clients/${id}/block`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({reason:reason||'Bloqué manuellement'})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast('Client bloqué','success');loadClients();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function unblockClient(id){
  if(!confirm('Débloquer ce client ? Il pourra à nouveau réserver en ligne.'))return;
  try{
    const r=await fetch(`/api/clients/${id}/unblock`,{method:'POST',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast('Client débloqué','success');loadClients();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function resetNoShow(id){
  if(!confirm('Remettre le compteur no-show à zéro et débloquer ?'))return;
  try{
    const r=await fetch(`/api/clients/${id}/reset-noshow`,{method:'POST',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast('Compteur remis à zéro','success');loadClients();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}
// SERVICES (PRESTATIONS)
// ============================================================
let allPractitioners=[];
async function loadServices(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[sr,pr]=await Promise.all([
      fetch('/api/services',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/dashboard',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const sd=await sr.json(), pd=await pr.json();
    const svcs=sd.services||[];
    allPractitioners=pd.practitioners||[];
    let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-size:.95rem;font-weight:700">${svcs.length} prestation${svcs.length>1?'s':''}</h3><button class="btn-primary" onclick="openServiceModal()">+ Nouvelle prestation</button></div>`;
    if(svcs.length===0){h+=`<div class="card"><div class="empty">Aucune prestation. Créez votre première !</div></div>`;}
    else{
      h+=`<div class="svc-grid">`;
      svcs.forEach(s=>{
        const price=s.price_cents?`${(s.price_cents/100).toFixed(0)} €`:(s.price_label||'Gratuit');
        const modes=(s.mode_options||['cabinet']).map(m=>`<span class="mode-tag">${{cabinet:'🏢 Cabinet',visio:'💻 Visio',phone:'📞 Tél'}[m]||m}</span>`).join('');
        const physOnly=['coiffeur','esthetique','kine','dentiste','veterinaire'].includes(userSector);
        const pIds=s.practitioner_ids||[];
        const pNames=pIds.length>0?pIds.map(pid=>{const p=allPractitioners.find(x=>x.id===pid);return p?p.display_name:'?';}).join(', '):'Tous les membres';
        h+=`<div class="svc-card${s.is_active===false?' inactive':''}" style="border-left-color:${s.color||'var(--primary)'}">
          <h4>${s.name}</h4>
          <div class="svc-meta">${s.duration_min}min · Buffer: ${s.buffer_before_min||0}+${s.buffer_after_min||0}min${s.category?' · '+s.category:''}</div>
          <div class="svc-price">${price}</div>
          ${physOnly?'':`<div class="svc-modes">${modes}</div>`}
          <div style="font-size:.72rem;color:var(--text-4);margin-top:4px">👤 ${pNames}</div>
          <div class="svc-actions">
            <button class="btn-outline btn-sm" onclick="openServiceModal('${s.id}')">✏️ Modifier</button>
            ${s.is_active!==false?`<button class="btn-outline btn-sm btn-danger" onclick="if(confirm('Désactiver cette prestation ?'))deleteService('${s.id}')">Désactiver</button>`:`<span style="font-size:.72rem;color:var(--text-4);padding:5px">Inactive</span>`}
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function openServiceModal(editId){
  if(editId){
    fetch(`/api/services`,{headers:{'Authorization':'Bearer '+api.getToken()}}).then(r=>r.json()).then(d=>{
      renderServiceModal(d.services.find(s=>s.id===editId));
    });
  }else{renderServiceModal(null);}
}

function renderServiceModal(svc){
  const isEdit=!!svc;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${isEdit?'Modifier la prestation':'Nouvelle prestation'}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">`;
  m+=`<div class="field"><label>Nom *</label><input id="svc_name" value="${svc?.name||''}" placeholder="Ex: Consultation initiale"></div>`;
  m+=`<div class="field-row"><div class="field"><label>Durée (min) *</label><input type="number" id="svc_dur" value="${svc?.duration_min||30}" min="5" step="5"></div><div class="field"><label>Prix (€)</label><input type="number" id="svc_price" value="${svc?.price_cents?(svc.price_cents/100):''}" step="0.01" placeholder="Gratuit si vide"></div></div>`;
  m+=`<div class="field-row"><div class="field"><label>Buffer avant (min)</label><input type="number" id="svc_bbefore" value="${svc?.buffer_before_min||0}" min="0"></div><div class="field"><label>Buffer après (min)</label><input type="number" id="svc_bafter" value="${svc?.buffer_after_min||0}" min="0"></div></div>`;
  m+=`<div class="field"><label>Catégorie</label><input id="svc_cat" value="${svc?.category||''}" placeholder="Ex: Consultation, Soin..."></div>`;
  m+=`<div class="field"><label>Couleur</label><div id="svc_color_wrap"></div></div>`;
  const modes=svc?.mode_options||['cabinet'];
  // Only show mode options for sectors that can do remote consultations
  const physicalOnlySectors=['coiffeur','esthetique','kine','dentiste','veterinaire'];
  const showModes=!physicalOnlySectors.includes(userSector);
  if(showModes){
  m+=`<div class="field"><label>Modes de consultation</label><div style="display:flex;gap:8px;margin-top:4px">
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_cab" ${modes.includes('cabinet')?'checked':''}> 🏢 Cabinet</label>
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_vis" ${modes.includes('visio')?'checked':''}> 💻 Visio</label>
    <label style="font-size:.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="svc_m_tel" ${modes.includes('phone')?'checked':''}> 📞 Tél</label>
  </div></div>`;
  }else{
  // Physical-only sector: modes handled in saveService()
  }
  m+=`<div class="field"><label>Label prix (si pas de montant)</label><input id="svc_plabel" value="${svc?.price_label||''}" placeholder="Ex: Sur devis, Gratuit..."></div>`;
  // Practitioner assignment
  const assignedIds=svc?.practitioner_ids||[];
  if(allPractitioners.length>0){
    m+=`<div class="field"><label>Assigné à</label><div id="svc_practitioners" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">`;
    allPractitioners.forEach(p=>{
      const checked=assignedIds.includes(p.id)?'checked':'';
      m+=`<label style="font-size:.82rem;display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--bg-card);border:1.5px solid var(--border);border-radius:8px;cursor:pointer"><input type="checkbox" class="svc_pract_cb" value="${p.id}" ${checked}> ${p.display_name}</label>`;
    });
    m+=`</div><div style="font-size:.72rem;color:var(--text-4);margin-top:4px">Si aucun coché, la prestation sera disponible pour tous</div></div>`;
  }
  m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveService(${isEdit?"'"+svc.id+"'":'null'})">${isEdit?'Enregistrer':'Créer'}</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
  document.getElementById('svc_color_wrap').innerHTML=cswHTML('svc_color',svc?.color||'#0D7377',false);
}

async function saveService(id){
  const physicalOnlySectors=['coiffeur','esthetique','kine','dentiste','veterinaire'];
  let modes;
  if(physicalOnlySectors.includes(userSector)){
    modes=['cabinet'];
  }else{
    modes=[];
    if(document.getElementById('svc_m_cab')?.checked)modes.push('cabinet');
    if(document.getElementById('svc_m_vis')?.checked)modes.push('visio');
    if(document.getElementById('svc_m_tel')?.checked)modes.push('phone');
  }
  const priceVal=document.getElementById('svc_price').value;
  const body={name:document.getElementById('svc_name').value,duration_min:parseInt(document.getElementById('svc_dur').value),price_cents:priceVal?Math.round(parseFloat(priceVal)*100):null,price_label:document.getElementById('svc_plabel').value||null,buffer_before_min:parseInt(document.getElementById('svc_bbefore').value)||0,buffer_after_min:parseInt(document.getElementById('svc_bafter').value)||0,category:document.getElementById('svc_cat').value||null,color:document.getElementById('svc_color').value,mode_options:modes.length?modes:['cabinet'],practitioner_ids:[...document.querySelectorAll('.svc_pract_cb:checked')].map(cb=>cb.value)};
  try{
    const url=id?`/api/services/${id}`:'/api/services';
    const method=id?'PATCH':'POST';
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast(id?'Prestation modifiée':'Prestation créée','success');loadServices();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function deleteService(id){
  try{
    const r=await fetch(`/api/services/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    GendaUI.toast('Prestation désactivée','success');loadServices();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// DISPONIBILITÉS (HOURS)
// ============================================================
const DAYS_WEEK=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
let scheduleData={};

async function loadHours(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[ar,pr,er]=await Promise.all([
      fetch('/api/availabilities',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/dashboard',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/availabilities/exceptions',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const ad=await ar.json(),pd=await pr.json(),ed=await er.json();
    const avails=ad.availabilities||{};
    const practs=pd.practitioners||[];
    const excepts=ed.exceptions||[];
    scheduleData={};
    practs.forEach(p=>{
      const pa=avails[p.id];
      scheduleData[p.id]={name:p.display_name,color:p.color,schedule:{}};
      for(let d=0;d<7;d++){scheduleData[p.id].schedule[d]=pa?.schedule?.[d]||[];}
    });

    let h=`<p style="font-size:.85rem;color:var(--text-3);margin-bottom:16px">Gérez les créneaux de disponibilité par praticien. Les modifications s'appliquent aux prochaines réservations.</p>`;
    practs.forEach(p=>{
      const sc=scheduleData[p.id].schedule;
      h+=`<div class="card pract-block" style="margin-bottom:16px"><div class="card-h"><h3 style="display:flex;align-items:center;gap:8px"><span style="width:24px;height:24px;border-radius:6px;background:${p.color||'var(--primary)'};display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-family:var(--serif)">${p.display_name?.charAt(0)||'?'}</span>${p.display_name}</h3><button class="btn-primary btn-sm" onclick="saveSchedule('${p.id}')">💾 Enregistrer</button></div><div style="padding:14px 18px">`;
      for(let d=0;d<7;d++){
        const slots=sc[d]||[];
        h+=`<div class="day-row"><span class="day-name">${DAYS_WEEK[d]}</span><div class="slots">`;
        if(slots.length===0){h+=`<span class="day-closed">Fermé</span>`;}
        else{slots.forEach((s,i)=>{h+=`<span class="slot-chip">${s.start_time?.slice(0,5)} – ${s.end_time?.slice(0,5)}<button class="remove-slot" onclick="removeSlot('${p.id}',${d},${i})">✕</button></span>`;});}
        h+=`<button class="add-slot-btn" onclick="addSlot('${p.id}',${d})">+ Ajouter</button></div></div>`;
      }
      h+=`</div></div>`;
    });

    h+=`<div class="card"><div class="card-h"><h3>Exceptions & congés</h3><button class="btn-primary btn-sm" onclick="openExceptionModal()">+ Ajouter</button></div>`;
    if(excepts.length===0){h+=`<div class="empty">Aucune exception planifiée</div>`;}
    else{h+=`<div style="padding:10px 18px">`;excepts.forEach(ex=>{
      const dt=new Date(ex.date).toLocaleDateString('fr-BE',{weekday:'short',day:'numeric',month:'short'});
      h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light)"><div><span style="font-size:.85rem;font-weight:600">${dt}</span><span style="font-size:.78rem;color:var(--text-4);margin-left:8px">${ex.practitioner_name} — ${ex.type==='closed'?'Fermé':ex.start_time?.slice(0,5)+' – '+ex.end_time?.slice(0,5)}</span>${ex.note?`<span style="font-size:.72rem;color:var(--text-4);margin-left:8px">(${ex.note})</span>`:''}</div><button class="btn-outline btn-sm btn-danger" onclick="if(confirm('Supprimer ?'))deleteException('${ex.id}')">✕</button></div>`;
    });h+=`</div>`;}
    h+=`</div>`;
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function addSlot(pid,day){
  const last=scheduleData[pid].schedule[day].slice(-1)[0];
  const ds=last?last.end_time:'09:00:00';
  const hr=parseInt(ds.split(':')[0]);
  const de=`${String(Math.min(hr+4,20)).padStart(2,'0')}:00`;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:340px"><div class="modal-h"><h3>Créneau — ${DAYS_WEEK[day]}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">
    <div class="field-row"><div class="field"><label>Début</label><input type="time" id="slot_start" value="${ds.slice(0,5)}"></div><div class="field"><label>Fin</label><input type="time" id="slot_end" value="${de}"></div></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="confirmAddSlot('${pid}',${day})">Ajouter</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

function confirmAddSlot(pid,day){
  const st=document.getElementById('slot_start').value+':00',en=document.getElementById('slot_end').value+':00';
  if(!scheduleData[pid].schedule[day])scheduleData[pid].schedule[day]=[];
  scheduleData[pid].schedule[day].push({start_time:st,end_time:en});
  scheduleData[pid].schedule[day].sort((a,b)=>a.start_time.localeCompare(b.start_time));
  document.querySelector('.modal-overlay')?.remove();loadHours();
}

function removeSlot(pid,day,idx){scheduleData[pid].schedule[day].splice(idx,1);loadHours();}

async function saveSchedule(pid){
  const schedule={};
  for(let d=0;d<7;d++){const sl=scheduleData[pid].schedule[d]||[];if(sl.length>0)schedule[d]=sl.map(s=>({start_time:s.start_time?.slice(0,5),end_time:s.end_time?.slice(0,5)}));}
  try{const r=await fetch('/api/availabilities',{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({practitioner_id:pid,schedule})});
    if(!r.ok)throw new Error((await r.json()).error);GendaUI.toast('Horaires enregistrés','success');loadHours();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

function openExceptionModal(){
  const pids=Object.entries(scheduleData).map(([id,d])=>`<option value="${id}">${d.name}</option>`).join('');
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:400px"><div class="modal-h"><h3>Nouvelle exception</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">
    <div class="field"><label>Praticien</label><select id="exc_pract">${pids}</select></div>
    <div class="field"><label>Date</label><input type="date" id="exc_date" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="field"><label>Type</label><select id="exc_type" onchange="document.getElementById('exc_times').style.display=this.value==='custom'?'flex':'none'"><option value="closed">Fermé toute la journée</option><option value="custom">Horaires modifiés</option></select></div>
    <div class="field-row" id="exc_times" style="display:none"><div class="field"><label>Début</label><input type="time" id="exc_start" value="09:00"></div><div class="field"><label>Fin</label><input type="time" id="exc_end" value="17:00"></div></div>
    <div class="field"><label>Note</label><input id="exc_note" placeholder="Ex: Congé, formation..."></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveException()">Enregistrer</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveException(){
  const type=document.getElementById('exc_type').value;
  const body={practitioner_id:document.getElementById('exc_pract').value,date:document.getElementById('exc_date').value,type,note:document.getElementById('exc_note').value||null};
  if(type==='custom'){body.start_time=document.getElementById('exc_start').value;body.end_time=document.getElementById('exc_end').value;}
  try{const r=await fetch('/api/availabilities/exceptions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);document.querySelector('.modal-overlay')?.remove();GendaUI.toast('Exception ajoutée','success');loadHours();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function deleteException(id){
  try{await fetch(`/api/availabilities/exceptions/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});GendaUI.toast('Exception supprimée','success');loadHours();}catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// SITE SECTION — THEME PICKER
// ============================================================
const THEMES={
  classique:{name:'Classique',desc:'Épuré et professionnel. Teal + typographie éditoriale.',free:true,
    colors:{bg:'#FAFAF9',nav:'#FAFAF9',navText:'#1A1816',primary:'#0D7377',text:'#1A1816',card:'#FFF',cardBorder:'#ECEAE6',heroBg:'#FAFAF9'},
    heroStyle:'light'},
  prestige:{name:'Prestige',desc:'Bleu nuit + or. Idéal avocats, notaires, consultants.',free:false,
    colors:{bg:'#F8F7F4',nav:'#1B1B1B',navText:'#FFF',primary:'#1E3A5F',text:'#1B1B1B',card:'#FFF',cardBorder:'#E0DDD8',heroBg:'#1B1B1B'},
    heroStyle:'dark'},
  zen:{name:'Zen',desc:'Vert sauge + beige. Parfait bien-être, thérapeutes, coachs.',free:false,
    colors:{bg:'#F7F5F0',nav:'#F7F5F0',navText:'#2C2820',primary:'#6B7F5E',text:'#2C2820',card:'#FFFDF9',cardBorder:'#E5E0D6',heroBg:'#F7F5F0'},
    heroStyle:'light'},
  moderne:{name:'Moderne',desc:'Noir + blanc. Géométrique, tech-forward, minimaliste.',free:false,
    colors:{bg:'#FAFAFA',nav:'#FAFAFA',navText:'#111',primary:'#111',text:'#111',card:'#FFF',cardBorder:'#E8E8E8',heroBg:'#FAFAFA'},
    heroStyle:'light'},
  chaleureux:{name:'Chaleureux',desc:'Terracotta + crème. Accueillant, personnel, artisanal.',free:false,
    colors:{bg:'#FAF6F2',nav:'#FAF6F2',navText:'#2E1F14',primary:'#8B4513',text:'#2E1F14',card:'#FFFCF8',cardBorder:'#E8E0D6',heroBg:'#FAF6F2'},
    heroStyle:'light'},
  ocean:{name:'Océan',desc:'Bleu profond + ciel. Frais, ouvert, médical.',free:false,
    colors:{bg:'#F5F8FA',nav:'#0F2440',navText:'#FFF',primary:'#1565C0',text:'#0F2440',card:'#FFF',cardBorder:'#DCE5ED',heroBg:'#0F2440'},
    heroStyle:'dark'}
};

let currentThemePreset='classique';
let businessPlan='free';

async function loadSiteSection(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const r=await fetch('/api/business',{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const b=d.business;
    currentThemePreset=b.theme?.preset||'classique';
    businessPlan=b.plan||'free';
    const slug=b.slug||'';

    let h=`<div class="qlink"><div class="info"><h4>Votre page publique</h4><p>${slug}</p></div><div style="display:flex;gap:8px"><a href="/${slug}" target="_blank">Voir ma page</a><a href="/${slug}/book" target="_blank" style="background:rgba(255,255,255,.08)">Page booking</a></div></div>`;

    h+=`<div class="card"><div class="card-h"><h3>Thème du mini-site</h3><span class="badge ${businessPlan==='free'?'badge-teal':'badge-teal'}">${businessPlan==='free'?'Plan Gratuit — 1 thème':'Plan '+businessPlan.charAt(0).toUpperCase()+businessPlan.slice(1)}</span></div>
    <div style="padding:18px">
      <p style="font-size:.85rem;color:var(--text-3);margin-bottom:4px">Choisissez l'identité visuelle de votre site. Chaque thème inclut typographie, palette et mise en page uniques.</p>
      ${businessPlan==='free'?'<p style="font-size:.78rem;color:var(--gold);margin-bottom:12px">🔓 Passez au plan Pro pour débloquer les 5 thèmes premium + couleur personnalisée.</p>':''}
      <div class="theme-grid">`;

    Object.entries(THEMES).forEach(([key,t])=>{
      const isActive=key===currentThemePreset;
      const isPro=!t.free;
      const isLocked=isPro&&businessPlan==='free';
      const cls=`theme-card${isActive?' active':''}${isLocked?' locked':''}`;
      const co=t.colors;

      h+=`<div class="${cls}" onclick="${isLocked?'':'selectTheme(\''+key+'\')'}">
        <div class="check">✓</div>
        ${isLocked?'<div class="lock-icon">🔒</div>':''}
        <div class="theme-preview" style="background:${co.heroBg}">
          <div class="tp-nav" style="background:${co.nav}">
            <div class="dot" style="background:${co.primary}">G</div>
            <span class="tp-name" style="color:${co.navText}">Cabinet</span>
            <span class="tp-cta" style="background:${co.primary}">RDV</span>
          </div>
          <div class="tp-hero" style="color:${t.heroStyle==='dark'?'#fff':co.text}">
            <h3>Cabinet Dupont & Associés</h3>
            <p>Votre santé, notre priorité depuis 2018</p>
          </div>
          <div class="tp-cards">
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
            <div class="tp-card" style="background:${co.card};border-color:${co.cardBorder}"></div>
          </div>
        </div>
        <div class="theme-info">
          <h4>${t.name} <span class="th-badge ${t.free?'th-free':'th-pro'}">${t.free?'Gratuit':'Pro'}</span></h4>
          <p>${t.desc}</p>
        </div>
      </div>`;
    });

    h+=`</div></div></div>`;

    // Custom color (Pro only)
    const curColor=b.theme?.primary_color||THEMES[currentThemePreset]?.colors?.primary||'#0D7377';
    h+=`<div class="card"><div class="card-h"><h3>Couleur personnalisée</h3>${businessPlan==='free'?'<span class="th-badge th-pro">Pro</span>':''}</div>
      <div style="padding:18px">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px">
        <div><p style="font-size:.85rem;font-weight:600">Remplacer la couleur primaire du thème</p>
        <p style="font-size:.75rem;color:var(--text-4)">${businessPlan==='free'?'Disponible avec le plan Pro':'Choisissez une couleur qui représente votre marque'}</p></div>
        ${businessPlan!=='free'?'<button onclick="saveCustomColor()" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-family:var(--sans);font-size:.8rem;font-weight:600;cursor:pointer;margin-left:auto">Appliquer</button>':''}
        </div>
        <div id="customColor_wrap"></div>
      </div>
    </div>`;

    c.innerHTML=h;
    // Init branding color swatches
    const cwWrap=document.getElementById('customColor_wrap');
    if(cwWrap){
      cwWrap.innerHTML=cswHTML('customColor',curColor,false);
      if(businessPlan==='free'){cwWrap.style.opacity='.4';cwWrap.style.pointerEvents='none';}
    }
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function selectTheme(preset){
  if(preset===currentThemePreset)return;
  try{
    const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({theme:{preset,primary_color:THEMES[preset]?.colors?.primary}})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    currentThemePreset=preset;
    GendaUI.toast(`Thème "${THEMES[preset].name}" appliqué !`,'success');
    loadSiteSection();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function saveCustomColor(){
  const color=document.getElementById('customColor').value;
  try{
    const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({theme:{preset:currentThemePreset,primary_color:color}})});
    if(!r.ok){const d=await r.json();throw new Error(d.error);}
    GendaUI.toast('Couleur appliquée !','success');
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// ÉQUIPE (TEAM MANAGEMENT)
// ============================================================
async function loadTeam(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const r=await fetch('/api/practitioners',{headers:{'Authorization':'Bearer '+api.getToken()}});
    const d=await r.json();
    const practs=d.practitioners||[];
    let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-size:.95rem;font-weight:700">${practs.length} membre${practs.length>1?'s':''} de l'équipe</h3><button class="btn-primary" onclick="openPractModal()">+ Ajouter un praticien</button></div>`;

    if(practs.length===0){h+=`<div class="card"><div class="empty">Aucun praticien. Ajoutez votre premier membre !</div></div>`;}
    else{
      h+=`<div class="team-grid2">`;
      practs.forEach(p=>{
        const initials=p.display_name?.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)||'??';
        const hasLogin=!!p.user_email;
        const avatarContent=p.photo_url
          ?`<img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit">`
          :initials;
        h+=`<div class="team-member${p.is_active?'':' inactive'}">
          <div class="tm-header">
            <div class="tm-avatar" style="background:${p.color||'var(--primary)'}">${avatarContent}</div>
            <div class="tm-info">
              <h4>${p.display_name}</h4>
              <div class="tm-title">${p.title||'—'}${p.years_experience?' · '+p.years_experience+' ans':''}</div>
              ${p.user_email?`<div class="tm-email">🔑 ${p.user_email}</div>`:`<div class="tm-email" style="color:var(--text-4)">Pas de compte</div>`}
            </div>
          </div>
          <div class="tm-stats">
            <div class="tm-stat"><div class="v">${p.bookings_30d||0}</div><div class="l">RDV / 30j</div></div>
            <div class="tm-stat"><div class="v">${p.service_count||0}</div><div class="l">Prestations</div></div>
            <div class="tm-stat"><div class="v">${p.last_login_at?new Date(p.last_login_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short'}):'—'}</div><div class="l">Dern. connexion</div></div>
          </div>
          <div class="tm-badges">
            <span class="tm-badge ${p.is_active?'active':'inactive'}">${p.is_active?'Actif':'Inactif'}</span>
            <span class="tm-badge ${p.booking_enabled?'booking':'no-booking'}">${p.booking_enabled?'Réservable':'Non réservable'}</span>
            ${hasLogin?`<span class="tm-badge has-login">${sectorLabels[p.user_role]||p.user_role||'Compte lié'}</span>`:''}
          </div>
          <div class="tm-actions">
            <button class="btn-outline btn-sm" onclick="openPracTasks('${p.id}','${esc(p.display_name)}')">📋 Tâches</button>
            <button class="btn-outline btn-sm" onclick="openPractModal('${p.id}')">✏️ Modifier</button>
            ${hasLogin?`<button class="btn-outline btn-sm" onclick="openRoleModal('${p.id}','${esc(p.display_name)}','${p.user_role||'practitioner'}')">🎭 Rôle</button>`:''}
            ${!hasLogin?`<button class="btn-outline btn-sm" onclick="openInviteModal('${p.id}','${esc(p.display_name)}')">🔑 Créer un accès</button>`:''}
            ${p.is_active?`<button class="btn-outline btn-sm btn-danger" onclick="if(confirm('Désactiver ${esc(p.display_name)} ?'))deactivatePract('${p.id}')">Désactiver</button>`:`<button class="btn-outline btn-sm" onclick="reactivatePract('${p.id}')">Réactiver</button>`}
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function openPractModal(editId){
  if(editId){
    fetch('/api/practitioners',{headers:{'Authorization':'Bearer '+api.getToken()}}).then(r=>r.json()).then(d=>{
      renderPractModal(d.practitioners.find(p=>p.id===editId));
    });
  }else{renderPractModal(null);}
}

function renderPractModal(p){
  pPendingPhoto=null;
  const isEdit=!!p;
  const photoSrc=p?.photo_url||'';
  const initials=p?.display_name?p.display_name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase():'';
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>${isEdit?'Modifier le praticien':'Nouveau praticien'}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">
    <div style="text-align:center;margin-bottom:16px">
      <div id="p_photo_preview" style="width:80px;height:80px;border-radius:50%;margin:0 auto 10px;overflow:hidden;background:${p?.color||'var(--primary)'};display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative" onclick="document.getElementById('p_photo_input').click()" title="Cliquer pour changer la photo">
        ${photoSrc?`<img src="${photoSrc}" style="width:100%;height:100%;object-fit:cover">`:`<span style="color:#fff;font-size:1.5rem;font-weight:600">${initials||'+'}</span>`}
      </div>
      <input type="file" id="p_photo_input" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="pPhotoPreview(this)">
      <div style="font-size:.7rem;color:var(--text-4)">Cliquer pour ${photoSrc?'changer':'ajouter'} la photo</div>
      ${photoSrc?`<button onclick="pRemovePhoto('${p.id}')" style="font-size:.7rem;color:var(--red);background:none;border:none;cursor:pointer;margin-top:4px">Supprimer la photo</button>`:''}
    </div>
    <div class="field"><label>Nom complet *</label><input id="p_name" value="${p?.display_name||''}" placeholder="Ex: Dr. Sophie Laurent"></div>
    <div class="field"><label>Titre / Spécialité</label><input id="p_title" value="${p?.title||''}" placeholder="Ex: Kinésithérapeute sportif"></div>
    <div class="field-row"><div class="field"><label>Années d'expérience</label><input type="number" id="p_years" value="${p?.years_experience||''}" min="0"></div><div class="field"><label>Couleur agenda</label><div id="p_color_wrap"></div></div></div>
    <div class="field"><label>Incrément agenda</label><select id="p_slot_inc" style="width:100%;padding:8px 12px;border:1.5px solid var(--border-light);border-radius:8px;font-size:.85rem">
      ${[5,10,15,20,30,45,60].map(v=>`<option value="${v}"${(p?.slot_increment_min||15)===v?' selected':''}>${v} min</option>`).join('')}
    </select><span style="font-size:.7rem;color:var(--text-4)">Granularité de la grille horaire pour ce praticien</span></div>
    <div class="field-row"><div class="field"><label>Email</label><input id="p_email" type="email" value="${p?.email||''}"></div><div class="field"><label>Téléphone</label><input id="p_phone" value="${p?.phone||''}"></div></div>
    <div class="field"><label>Bio</label><textarea id="p_bio">${p?.bio||''}</textarea></div>
    <div class="field"><label>LinkedIn</label><input id="p_linkedin" value="${p?.linkedin_url||''}" placeholder="https://linkedin.com/in/..."></div>
    <div class="field"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="p_booking" ${p?.booking_enabled!==false?'checked':''}> Peut recevoir des réservations en ligne</label></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="savePract(${isEdit?"'"+p.id+"'":'null'})">${isEdit?'Enregistrer':'Créer'}</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
  document.getElementById('p_color_wrap').innerHTML=cswHTML('p_color',p?.color||'#0D7377',false);
}

let pPendingPhoto=null; // base64 data URI to upload after save

function pPhotoPreview(input){
  const file=input.files[0];
  if(!file)return;
  if(file.size>2*1024*1024){GendaUI.toast('Photo trop lourde (max 2 Mo)','error');return;}
  const reader=new FileReader();
  reader.onload=function(e){
    pPendingPhoto=e.target.result;
    document.getElementById('p_photo_preview').innerHTML=`<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover">`;
  };
  reader.readAsDataURL(file);
}

async function pRemovePhoto(id){
  if(!confirm('Supprimer la photo ?'))return;
  try{
    await fetch(`/api/practitioners/${id}/photo`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    GendaUI.toast('Photo supprimée','success');
    document.querySelector('.modal-overlay')?.remove();
    loadTeam();
  }catch(e){GendaUI.toast('Erreur','error');}
}

async function savePract(id){
  const body={display_name:document.getElementById('p_name').value,title:document.getElementById('p_title').value||null,years_experience:parseInt(document.getElementById('p_years').value)||null,color:document.getElementById('p_color').value,email:document.getElementById('p_email').value||null,phone:document.getElementById('p_phone').value||null,bio:document.getElementById('p_bio').value||null,linkedin_url:document.getElementById('p_linkedin').value||null,booking_enabled:document.getElementById('p_booking').checked,slot_increment_min:parseInt(document.getElementById('p_slot_inc').value)||15};
  try{
    const url=id?`/api/practitioners/${id}`:'/api/practitioners';
    const method=id?'PATCH':'POST';
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    const data=await r.json();
    const pracId=id||data.practitioner?.id;

    // Upload photo if one was selected
    if(pPendingPhoto&&pracId){
      await fetch(`/api/practitioners/${pracId}/photo`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
        body:JSON.stringify({photo:pPendingPhoto})
      });
      pPendingPhoto=null;
    }

    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast(id?'Praticien modifié':'Praticien ajouté','success');loadTeam();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function deactivatePract(id){

}

async function openPracTasks(pracId,pracName){
  try{
    const r=await fetch(`/api/practitioners/${pracId}/tasks`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error('Erreur');
    const data=await r.json();
    const todos=data.todos||[], reminders=data.reminders||[];
    const pendingTodos=todos.filter(t=>!t.is_done), doneTodos=todos.filter(t=>t.is_done);
    const pendingReminders=reminders.filter(r=>!r.is_sent), sentReminders=reminders.filter(r=>r.is_sent);

    let h=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:560px"><div class="modal-h"><h3>📋 ${pracName}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto">`;

    // Todos
    h+=`<div style="font-size:.82rem;font-weight:700;margin-bottom:8px">Tâches en cours (${pendingTodos.length})</div>`;
    if(pendingTodos.length===0){h+=`<div style="font-size:.8rem;color:var(--text-4);margin-bottom:16px">Aucune tâche en cours</div>`;}
    else{pendingTodos.forEach(t=>{
      const dt=t.booking_start?new Date(t.booking_start).toLocaleDateString('fr-BE',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):'';
      h+=`<div style="padding:8px 0;border-bottom:1px solid var(--border-light);display:flex;gap:10px;align-items:flex-start">
        <input type="checkbox" onchange="togglePracTodo('${t.id}','${t.booking_id}',this.checked,'${pracId}','${esc(pracName)}')" style="margin-top:3px">
        <div style="flex:1;min-width:0">
          <div style="font-size:.82rem">${escH(t.content)}</div>
          <div style="font-size:.7rem;color:var(--text-4)">${t.client_name||''} ${t.service_name?'· '+t.service_name:''} ${dt?'· '+dt:''}</div>
        </div>
      </div>`;
    });}

    if(doneTodos.length>0){
      h+=`<div style="font-size:.82rem;font-weight:700;margin:16px 0 8px;color:var(--text-4)">Terminées (${doneTodos.length})</div>`;
      doneTodos.slice(0,10).forEach(t=>{
        h+=`<div style="padding:6px 0;border-bottom:1px solid var(--border-light);opacity:.5">
          <div style="font-size:.8rem;text-decoration:line-through">${escH(t.content)}</div>
          <div style="font-size:.68rem;color:var(--text-4)">${t.client_name||''} · ${t.done_at?new Date(t.done_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short'}):''}</div>
        </div>`;
      });
      if(doneTodos.length>10)h+=`<div style="font-size:.72rem;color:var(--text-4);padding:4px 0">+ ${doneTodos.length-10} autres</div>`;
    }

    // Reminders
    h+=`<div style="font-size:.82rem;font-weight:700;margin:20px 0 8px">Rappels à venir (${pendingReminders.length})</div>`;
    if(pendingReminders.length===0){h+=`<div style="font-size:.8rem;color:var(--text-4)">Aucun rappel en attente</div>`;}
    else{pendingReminders.forEach(r=>{
      const dt=new Date(r.remind_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
      const ch=r.channel==='email'?'📧':r.channel==='both'?'📧+🔔':'🔔';
      h+=`<div style="padding:8px 0;border-bottom:1px solid var(--border-light)">
        <div style="font-size:.82rem">${ch} ${dt}</div>
        <div style="font-size:.7rem;color:var(--text-4)">${r.client_name||''} ${r.service_name?'· '+r.service_name:''} ${r.message?'· '+escH(r.message):''}</div>
      </div>`;
    });}

    if(sentReminders.length>0){
      h+=`<div style="font-size:.72rem;color:var(--text-4);margin-top:8px">${sentReminders.length} rappel${sentReminders.length>1?'s':''} déjà envoyé${sentReminders.length>1?'s':''}</div>`;
    }

    h+=`</div></div></div>`;
    document.body.insertAdjacentHTML('beforeend',h);
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function togglePracTodo(todoId,bookingId,done,pracId,pracName){
  try{
    await fetch(`/api/bookings/${bookingId}/todos/${todoId}`,{
      method:'PATCH',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},
      body:JSON.stringify({is_done:done})
    });
    // Refresh the modal
    document.querySelector('.modal-overlay')?.remove();
    openPracTasks(pracId,pracName);
  }catch(e){GendaUI.toast('Erreur','error');}
}
  try{const r=await fetch(`/api/practitioners/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);GendaUI.toast('Praticien désactivé','success');loadTeam();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function reactivatePract(id){
  try{const r=await fetch(`/api/practitioners/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({is_active:true,booking_enabled:true})});
    if(!r.ok)throw new Error((await r.json()).error);GendaUI.toast('Praticien réactivé','success');loadTeam();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

function openInviteModal(practId,name){
  const sl=SECTOR_LABELS[userSector]||SECTOR_LABELS.autre;
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:440px"><div class="modal-h"><h3>Créer un accès — ${name}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">
    <p style="font-size:.85rem;color:var(--text-3);margin-bottom:14px">Créez un compte pour que <strong>${name}</strong> puisse se connecter au dashboard.</p>
    <div class="field"><label>Email *</label><input id="inv_email" type="email" placeholder="email@exemple.com"></div>
    <div class="field"><label>Mot de passe temporaire *</label><input id="inv_pwd" type="text" value="${generateTempPwd()}" style="font-family:monospace"><div class="hint">Communiquez ce mot de passe. Il pourra être changé plus tard.</div></div>
    <div class="field"><label>Rôle *</label><select id="inv_role" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem">
      <option value="practitioner">${sl.practitioner} — Voit uniquement son propre agenda et ses clients</option>
      <option value="receptionist">${sl.receptionist} — Voit l'agenda de tous, gère les RDV et clients</option>
      <option value="manager">${sl.manager} — Agenda de tous, clients, documents, statistiques</option>
    </select></div>
  </div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="sendInvite('${practId}')">Créer le compte</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

function generateTempPwd(){const chars='ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';let pwd='';for(let i=0;i<10;i++)pwd+=chars[Math.floor(Math.random()*chars.length)];return pwd;}

async function sendInvite(practId){
  const email=document.getElementById('inv_email').value;
  const password=document.getElementById('inv_pwd').value;
  const role=document.getElementById('inv_role').value;
  if(!email||!password)return GendaUI.toast('Email et mot de passe requis','error');
  try{
    const r=await fetch(`/api/practitioners/${practId}/invite`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({email,password,role})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast('Compte créé ! Communiquez les identifiants.','success');loadTeam();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

function openRoleModal(practId,name,currentRole){
  const sl=SECTOR_LABELS[userSector]||SECTOR_LABELS.autre;
  const roles=[
    {value:'practitioner',label:sl.practitioner,desc:'Voit uniquement son propre agenda et ses clients'},
    {value:'receptionist',label:sl.receptionist,desc:'Voit l\'agenda de tous, gère les RDV et clients'},
    {value:'manager',label:sl.manager,desc:'Agenda de tous, clients, documents, statistiques'}
  ];
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:460px"><div class="modal-h"><h3>Modifier le rôle — ${name}</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">`;
  m+=`<div style="display:flex;flex-direction:column;gap:8px">`;
  roles.forEach(r=>{
    const checked=r.value===currentRole?'checked':'';
    const borderColor=r.value===currentRole?'var(--primary)':'var(--border)';
    m+=`<label style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border:1.5px solid ${borderColor};border-radius:10px;cursor:pointer;transition:all .15s" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='${r.value===currentRole?'var(--primary)':'var(--border)'}'" onclick="this.parentElement.querySelectorAll('label').forEach(l=>l.style.borderColor='var(--border)');this.style.borderColor='var(--primary)'">
      <input type="radio" name="role_pick" value="${r.value}" ${checked} style="margin-top:2px">
      <div><div style="font-size:.88rem;font-weight:600">${r.label}</div><div style="font-size:.75rem;color:var(--text-4);margin-top:2px">${r.desc}</div></div>
    </label>`;
  });
  m+=`</div>`;
  m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveRole('${practId}')">Enregistrer</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveRole(practId){
  const picked=document.querySelector('input[name="role_pick"]:checked');
  if(!picked)return GendaUI.toast('Sélectionnez un rôle','error');
  try{
    const r=await fetch(`/api/practitioners/${practId}/role`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({role:picked.value})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast('Rôle modifié','success');loadTeam();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

// ============================================================
// PARAMÈTRES
// ============================================================
async function loadSettings(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[br,ur,lr,calr]=await Promise.all([
      fetch('/api/business',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/auth/me',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/business/public-link',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/calendar/connections',{headers:{'Authorization':'Bearer '+api.getToken()}}).catch(()=>({ok:false}))
    ]);
    const bd=await br.json(),ud=await ur.json(),ld=await lr.json();
    const calData=calr.ok?await calr.json():{connections:[]};
    const calConns=calData.connections||[];
    const b=bd.business, u=ud.user, lk=ld;
    let h='';

    // 1. Infos cabinet
    h+=`<div class="settings-card"><div class="sc-h"><h3>🏢 Informations du cabinet</h3></div><div class="sc-body">
      <div class="field-row"><div class="field"><label>Nom du cabinet *</label><input id="s_name" value="${esc(b.name||'')}"></div><div class="field"><label>URL personnalisée</label><div class="copy-input"><span style="padding:9px 0;font-size:.85rem;color:var(--text-4)">genda.be/</span><input id="s_slug" value="${esc(b.slug||'')}" style="flex:1"></div><div class="hint">Modifie l'URL de votre page publique</div></div></div>
      <div class="field-row"><div class="field"><label>Email professionnel</label><input id="s_email" type="email" value="${esc(b.email||'')}"></div><div class="field"><label>Téléphone</label><input id="s_phone" value="${esc(b.phone||'')}"></div></div>
      <div class="field"><label>Adresse</label><input id="s_address" value="${esc(b.address||'')}" placeholder="Ex: Rue de la Loi 42, 1000 Bruxelles"></div>
      <div class="field-row"><div class="field"><label>N° BCE / TVA</label><input id="s_bce" value="${esc(b.bce_number||'')}" placeholder="BE 0xxx.xxx.xxx"></div><div class="field"><label>Accréditation</label><input id="s_accred" value="${esc(b.accreditation||'')}" placeholder="Ex: Barreau de Bruxelles"></div></div>
      <div class="field"><label>Tagline</label><input id="s_tagline" value="${esc(b.tagline||'')}" placeholder="Phrase d'accroche affichée sur votre page"></div>
      <div class="field"><label>Description</label><textarea id="s_desc">${esc(b.description||'')}</textarea></div>
      <div class="field-row"><div class="field"><label>Année de fondation</label><input id="s_year" type="number" value="${b.founded_year||''}"></div><div class="field"><label>Langues</label><input id="s_langs" value="${esc(b.languages_spoken||'')}" placeholder="FR, NL, EN"></div></div>
      <div class="field"><label>Info parking</label><input id="s_parking" value="${esc(b.parking_info||'')}" placeholder="Ex: Parking gratuit à 50m"></div>
      <div style="height:1px;background:var(--border);margin:10px 0"></div>
      <div style="font-size:.75rem;font-weight:700;color:var(--text-3);text-transform:uppercase;margin-bottom:6px">Facturation</div>
      <div class="field-row"><div class="field"><label>IBAN</label><input id="s_iban" value="${esc(b.settings?.iban||'')}" placeholder="BE00 0000 0000 0000"></div><div class="field"><label>BIC</label><input id="s_bic" value="${esc(b.settings?.bic||'')}" placeholder="GEBABEBB"></div></div>
      <div class="field"><label>Pied de page facture</label><input id="s_inv_footer" value="${esc(b.settings?.invoice_footer||'')}" placeholder="Ex: Petit entrepreneur - TVA non applicable art. 56bis CTVA"></div>
    </div><div class="sc-foot"><button class="btn-primary" onclick="saveBusiness()">Enregistrer</button></div></div>`;

    // 2. SEO
    h+=`<div class="settings-card"><div class="sc-h"><h3>🔍 SEO & Référencement</h3></div><div class="sc-body">
      <div class="field"><label>Titre SEO</label><input id="s_seo_title" value="${esc(b.seo_title||'')}" placeholder="Titre affiché dans Google (max 60 car.)"><div class="hint">Par défaut : "[Nom] — [Tagline]"</div></div>
      <div class="field"><label>Meta description</label><textarea id="s_seo_desc" style="min-height:60px">${esc(b.seo_description||'')}</textarea><div class="hint">Description affichée dans Google (max 160 car.)</div></div>
    </div><div class="sc-foot"><button class="btn-primary" onclick="saveSEO()">Enregistrer</button></div></div>`;

    // 3. Politique agenda
    const overlapOn=!!(b.settings?.allow_overlap);
    h+=`<div class="settings-card"><div class="sc-h"><h3>📅 Politique agenda</h3></div><div class="sc-body">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface)">
        <div>
          <div style="font-size:.88rem;font-weight:600">Autoriser les chevauchements</div>
          <div style="font-size:.75rem;color:var(--text-4);margin-top:2px">Permet de placer plusieurs RDV en même temps pour le même praticien (ex: coloration + soin en parallèle)</div>
        </div>
        <label style="position:relative;display:inline-flex;width:44px;height:24px;flex-shrink:0;margin-left:16px">
          <input type="checkbox" id="s_overlap" ${overlapOn?'checked':''} onchange="saveOverlapPolicy()" style="opacity:0;width:0;height:0">
          <span style="position:absolute;inset:0;border-radius:100px;background:${overlapOn?'var(--primary)':'var(--border)'};transition:all .2s;cursor:pointer"></span>
          <span style="position:absolute;left:${overlapOn?'22px':'2px'};top:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.15)"></span>
        </label>
      </div>
    </div></div>`;

    // 4. Lien public & widget
    h+=`<div class="settings-card"><div class="sc-h"><h3>🔗 Lien public & Widget</h3></div><div class="sc-body">
      <div class="field"><label>URL de réservation</label><div class="copy-input"><input id="s_url" value="${lk.booking_url||''}" readonly><button class="btn-outline btn-sm" onclick="copyField('s_url')">📋 Copier</button></div></div>
      <div class="field"><label>Code widget embeddable</label><div class="copy-input"><input id="s_widget" value='${esc(lk.widget_code||'')}' readonly style="font-size:.72rem"><button class="btn-outline btn-sm" onclick="copyField('s_widget')">📋 Copier</button></div><div class="hint">Collez ce code sur votre site existant pour ajouter un bouton de réservation</div></div>
      <div class="field"><label>QR Code</label><div class="hint">Scannez pour accéder à votre page publique</div><div style="margin-top:8px;padding:16px;background:var(--surface);border-radius:8px;text-align:center"><canvas id="qrCanvas" width="160" height="160" style="width:160px;height:160px"></canvas><div style="margin-top:8px"><button class="btn-outline btn-sm" onclick="downloadQR()">⬇️ Télécharger PNG</button></div></div></div>
    </div></div>`;

    // 4. Sécurité
    h+=`<div class="settings-card"><div class="sc-h"><h3>🔒 Sécurité</h3></div><div class="sc-body">
      <p style="font-size:.85rem;color:var(--text-3);margin-bottom:14px">Connecté en tant que <strong>${u.email}</strong> · Rôle : ${sectorLabels[u.role]||u.role}${u.last_login_at?' · Dernière connexion : '+new Date(u.last_login_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}):''}</p>
      <div class="field"><label>Mot de passe actuel</label><input id="s_pwd_current" type="password"></div>
      <div class="field-row"><div class="field"><label>Nouveau mot de passe</label><input id="s_pwd_new" type="password" placeholder="Min. 8 caractères"></div><div class="field"><label>Confirmer</label><input id="s_pwd_confirm" type="password"></div></div>
    </div><div class="sc-foot"><button class="btn-primary" onclick="changePassword()">Changer le mot de passe</button></div></div>`;

    // 5. Plan & facturation
    const plan=b.plan||'free';
    h+=`<div class="settings-card"><div class="sc-h"><h3>💳 Plan & Facturation</h3></div><div class="sc-body">
      <div class="plan-card">
        <div class="plan-box${plan==='free'?' current':''}">
          ${plan==='free'?'<span class="current-badge">Actuel</span>':''}
          <div class="plan-name">Gratuit</div>
          <div class="plan-price">0 €<span>/mois</span></div>
          <ul><li>Mini-site public</li><li>1 thème (Classique)</li><li>Booking en ligne</li><li>Agenda basique</li><li>5 clients max</li></ul>
        </div>
        <div class="plan-box${plan==='pro'?' current':''}">
          ${plan==='pro'?'<span class="current-badge">Actuel</span>':''}
          <div class="plan-name">Pro</div>
          <div class="plan-price">39 €<span>/mois</span></div>
          <ul><li>Tout du Gratuit +</li><li>6 thèmes + couleur custom</li><li>Clients illimités</li><li>Rappels email + SMS</li><li>Statistiques avancées</li><li>Widget embeddable</li><li>QR code dynamique</li></ul>
          ${plan!=='pro'?'<button class="btn-primary" style="width:100%;margin-top:8px" onclick="GendaUI.toast(\'Bientôt disponible — contactez-nous !\',\'info\')">Passer au Pro →</button>':''}
        </div>
        <div class="plan-box${plan==='premium'?' current':''}">
          ${plan==='premium'?'<span class="current-badge">Actuel</span>':''}
          <div class="plan-name">Premium</div>
          <div class="plan-price">79 €<span>/mois</span></div>
          <ul><li>Tout du Pro +</li><li>Filtre d'appels IA</li><li>Google Cal + Outlook sync</li><li>Paiement en ligne</li><li>Facturation auto PDF</li><li>Domaine personnalisé</li><li>Support prioritaire</li></ul>
          ${plan!=='premium'?'<button class="btn-outline" style="width:100%;margin-top:8px" onclick="GendaUI.toast(\'Bientôt disponible — contactez-nous !\',\'info\')">Contacter</button>':''}
        </div>
      </div>
    </div></div>`;

    // 6. Synchronisation calendrier
    const gConn=calConns.find(c=>c.provider==='google');
    const oConn=calConns.find(c=>c.provider==='outlook');
    h+=`<div class="settings-card"><div class="sc-h"><h3>📅 Synchronisation calendrier</h3></div><div class="sc-body">
      <p style="font-size:.82rem;color:var(--text-3);margin-bottom:16px">Synchronisez vos rendez-vous Genda avec votre agenda externe. Les créneaux occupés dans votre calendrier bloqueront automatiquement les réservations.</p>

      <div style="display:grid;gap:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface)">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:36px;height:36px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 1px 3px rgba(0,0,0,.08)">📆</div>
            <div>
              <div style="font-size:.88rem;font-weight:600">Google Calendar</div>
              ${gConn?`<div style="font-size:.72rem;color:var(--green)">✓ Connecté — ${esc(gConn.email||'')}${gConn.last_sync_at?' · Dernière synchro: '+new Date(gConn.last_sync_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):''}</div>`
              :`<div style="font-size:.72rem;color:var(--text-4)">Non connecté</div>`}
            </div>
          </div>
          <div style="display:flex;gap:6px">
            ${gConn?`
              <button onclick="syncCalendar('${gConn.id}')" class="btn-outline btn-sm">🔄 Sync</button>
              <button onclick="disconnectCalendar('${gConn.id}','google')" class="btn-outline btn-sm btn-danger">Déconnecter</button>
            `:`<button onclick="connectCalendar('google')" class="btn-outline btn-sm" style="color:var(--primary);border-color:var(--primary)">Connecter</button>`}
          </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface)">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:36px;height:36px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 1px 3px rgba(0,0,0,.08)">📧</div>
            <div>
              <div style="font-size:.88rem;font-weight:600">Outlook / Microsoft 365</div>
              ${oConn?`<div style="font-size:.72rem;color:var(--green)">✓ Connecté — ${esc(oConn.email||'')}${oConn.last_sync_at?' · Dernière synchro: '+new Date(oConn.last_sync_at).toLocaleDateString('fr-BE',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):''}</div>`
              :`<div style="font-size:.72rem;color:var(--text-4)">Non connecté</div>`}
            </div>
          </div>
          <div style="display:flex;gap:6px">
            ${oConn?`
              <button onclick="syncCalendar('${oConn.id}')" class="btn-outline btn-sm">🔄 Sync</button>
              <button onclick="disconnectCalendar('${oConn.id}','outlook')" class="btn-outline btn-sm btn-danger">Déconnecter</button>
            `:`<button onclick="connectCalendar('outlook')" class="btn-outline btn-sm" style="color:var(--primary);border-color:var(--primary)">Connecter</button>`}
          </div>
        </div>
      </div>

      ${calConns.length>0?`<div style="margin-top:14px;padding:12px;background:var(--primary-light);border-radius:var(--radius-xs)">
        <div style="font-size:.78rem;color:var(--text-2)">
          <strong>Direction de synchro :</strong>
          <select onchange="updateCalSyncDirection(this.value)" style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:.78rem;margin-left:6px">
            <option value="both" ${(gConn||oConn)?.sync_direction==='both'?'selected':''}>↔ Bidirectionnelle (push + pull)</option>
            <option value="push" ${(gConn||oConn)?.sync_direction==='push'?'selected':''}>→ Push uniquement (Genda → Calendrier)</option>
            <option value="pull" ${(gConn||oConn)?.sync_direction==='pull'?'selected':''}>← Pull uniquement (Calendrier → Genda)</option>
          </select>
        </div>
        <div style="font-size:.7rem;color:var(--text-4);margin-top:4px">Push = vos RDV Genda apparaissent dans votre agenda. Pull = les créneaux occupés de votre agenda bloquent les réservations.</div>
      </div>`:''}
    </div></div>`;

    // 7. Danger zone
    h+=`<div class="settings-card danger-zone"><div class="sc-h"><h3>⚠️ Zone danger</h3></div><div class="sc-body">
      <p style="font-size:.85rem;color:var(--text-2);margin-bottom:12px">Supprimer définitivement votre compte et toutes les données associées. Cette action est irréversible.</p>
      <button class="btn-outline btn-danger" onclick="confirmDeleteAccount()">Supprimer mon compte</button>
    </div></div>`;

    c.innerHTML=h;

    // Draw QR code
    setTimeout(()=>drawQR(lk.qr_data||lk.booking_url||''),50);
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

async function saveOverlapPolicy(){
  const on=document.getElementById('s_overlap').checked;
  try{
    const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({settings_allow_overlap:on})});
    if(!r.ok)throw new Error((await r.json()).error);
    fcAllowOverlap=on;
    GendaUI.toast(on?'Chevauchements autorisés':'Chevauchements bloqués','success');
    // Update toggle visual
    const span=document.getElementById('s_overlap').parentElement;
    span.querySelector('span:nth-child(2)').style.background=on?'var(--primary)':'var(--border)';
    span.querySelector('span:nth-child(3)').style.left=on?'22px':'2px';
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function saveBusiness(){
  const body={name:document.getElementById('s_name').value,slug:document.getElementById('s_slug').value,email:document.getElementById('s_email').value,phone:document.getElementById('s_phone').value,address:document.getElementById('s_address').value,bce_number:document.getElementById('s_bce').value,accreditation:document.getElementById('s_accred').value,tagline:document.getElementById('s_tagline').value,description:document.getElementById('s_desc').value,founded_year:document.getElementById('s_year').value||null,languages_spoken:document.getElementById('s_langs').value,parking_info:document.getElementById('s_parking').value,settings_iban:document.getElementById('s_iban').value,settings_bic:document.getElementById('s_bic').value,settings_invoice_footer:document.getElementById('s_inv_footer').value};
  try{const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);GendaUI.toast('Informations enregistrées','success');
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function saveSEO(){
  const body={seo_title:document.getElementById('s_seo_title').value,seo_description:document.getElementById('s_seo_desc').value};
  try{const r=await fetch('/api/business',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);GendaUI.toast('SEO enregistré','success');
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function changePassword(){
  const cur=document.getElementById('s_pwd_current').value;
  const nw=document.getElementById('s_pwd_new').value;
  const cnf=document.getElementById('s_pwd_confirm').value;
  if(!cur||!nw)return GendaUI.toast('Remplissez tous les champs','error');
  if(nw!==cnf)return GendaUI.toast('Les mots de passe ne correspondent pas','error');
  if(nw.length<8)return GendaUI.toast('Minimum 8 caractères','error');
  try{const r=await fetch('/api/auth/change-password',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({current_password:cur,new_password:nw})});
    if(!r.ok)throw new Error((await r.json()).error);
    document.getElementById('s_pwd_current').value='';document.getElementById('s_pwd_new').value='';document.getElementById('s_pwd_confirm').value='';
    GendaUI.toast('Mot de passe modifié','success');
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

function copyField(id){
  const el=document.getElementById(id);el.select();navigator.clipboard.writeText(el.value);
  GendaUI.toast('Copié !','success');
}

function confirmDeleteAccount(){
  const name=prompt('Tapez le nom de votre cabinet pour confirmer la suppression :');
  if(!name)return;
  GendaUI.toast('Suppression de compte — contactez support@genda.be','info');
}

// ===== QR Code (simple canvas) =====
function drawQR(data){
  const canvas=document.getElementById('qrCanvas');if(!canvas||!data)return;
  // Minimal QR-like pattern (for real QR use a library like qrcode.js)
  // We'll draw a placeholder with the URL text + a styled square
  const ctx=canvas.getContext('2d');
  const s=160;canvas.width=s;canvas.height=s;
  ctx.fillStyle='#FFF';ctx.fillRect(0,0,s,s);
  // Border
  ctx.strokeStyle='#1A1816';ctx.lineWidth=4;ctx.strokeRect(8,8,s-16,s-16);
  // Corner squares
  [12,s-36].forEach(x=>{[12,s-36].forEach(y=>{
    if(x===s-36&&y===s-36)return; // skip bottom-right
    ctx.fillStyle='#1A1816';ctx.fillRect(x,y,24,24);
    ctx.fillStyle='#FFF';ctx.fillRect(x+4,y+4,16,16);
    ctx.fillStyle='#1A1816';ctx.fillRect(x+8,y+8,8,8);
  });});
  // Simple pattern from data hash
  let hash=0;for(let i=0;i<data.length;i++)hash=((hash<<5)-hash)+data.charCodeAt(i);
  for(let i=0;i<8;i++)for(let j=0;j<8;j++){
    if((hash>>(i*8+j))&1){ctx.fillStyle='#1A1816';ctx.fillRect(40+i*10,40+j*10,8,8);}
  }
  // Center logo
  ctx.fillStyle='var(--primary)';ctx.fillRect(s/2-14,s/2-14,28,28);
  ctx.fillStyle='#FFF';ctx.font='bold 14px sans-serif';ctx.textAlign='center';ctx.fillText('B',s/2,s/2+5);
}

function downloadQR(){
  const canvas=document.getElementById('qrCanvas');if(!canvas)return;
  const link=document.createElement('a');link.download='genda-qr.png';link.href=canvas.toDataURL();link.click();
  GendaUI.toast('QR téléchargé','success');
}

function doLogout(){api.logout();}

// ============================================================
// FACTURATION
// ============================================================
let invoiceFilter='all',invoiceType='all';

async function loadInvoices(){
  const c=document.getElementById('contentArea');
  c.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  try{
    const params=new URLSearchParams();
    if(invoiceFilter!=='all')params.set('status',invoiceFilter);
    if(invoiceType!=='all')params.set('type',invoiceType);
    const data=await api.get(`/api/invoices?${params}`);
    const inv=data.invoices||[];
    const st=data.stats||{};
    let h='';

    // KPIs
    h+=`<div class="stats" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card"><div class="label">Brouillons</div><div class="val">${st.drafts||0}</div></div>
      <div class="stat-card"><div class="label">En attente</div><div class="val" style="color:var(--gold)">${fmtEur(parseInt(st.total_pending||0))}</div><div class="sub">${(parseInt(st.sent||0)+parseInt(st.overdue||0))} factures</div></div>
      <div class="stat-card"><div class="label">Payées</div><div class="val" style="color:var(--green)">${fmtEur(parseInt(st.total_paid||0))}</div><div class="sub">${st.paid||0} factures</div></div>
      <div class="stat-card"><div class="label">En retard</div><div class="val" style="color:var(--red)">${st.overdue||0}</div></div>
    </div>`;

    // Actions bar
    h+=`<div class="card" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:12px 16px">
      <button onclick="openInvoiceModal()" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Nouvelle facture</button>
      <button onclick="openInvoiceModal('quote')" style="padding:8px 16px;background:var(--gold);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Devis</button>
      <div style="flex:1"></div>
      <select onchange="invoiceType=this.value;loadInvoices()" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem">
        <option value="all" ${invoiceType==='all'?'selected':''}>Tous types</option>
        <option value="invoice" ${invoiceType==='invoice'?'selected':''}>Factures</option>
        <option value="quote" ${invoiceType==='quote'?'selected':''}>Devis</option>
        <option value="credit_note" ${invoiceType==='credit_note'?'selected':''}>Notes de crédit</option>
      </select>
      <select onchange="invoiceFilter=this.value;loadInvoices()" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem">
        <option value="all" ${invoiceFilter==='all'?'selected':''}>Tous statuts</option>
        <option value="draft" ${invoiceFilter==='draft'?'selected':''}>Brouillons</option>
        <option value="sent" ${invoiceFilter==='sent'?'selected':''}>Envoyées</option>
        <option value="paid" ${invoiceFilter==='paid'?'selected':''}>Payées</option>
        <option value="overdue" ${invoiceFilter==='overdue'?'selected':''}>En retard</option>
        <option value="cancelled" ${invoiceFilter==='cancelled'?'selected':''}>Annulées</option>
      </select>
    </div>`;

    // Table
    if(inv.length===0){
      h+=`<div class="card"><div class="empty">Aucune facture. Créez votre première facture ou devis !</div></div>`;
    }else{
      h+=`<div class="card" style="padding:0;overflow:auto"><table style="width:100%;border-collapse:collapse;font-size:.82rem">
        <thead><tr style="background:var(--surface);border-bottom:1px solid var(--border)">
          <th style="padding:10px 14px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">N°</th>
          <th style="padding:10px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Type</th>
          <th style="padding:10px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Client</th>
          <th style="padding:10px;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Date</th>
          <th style="padding:10px;text-align:right;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Montant TTC</th>
          <th style="padding:10px;text-align:center;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Statut</th>
          <th style="padding:10px;text-align:right;font-weight:600;font-size:.72rem;text-transform:uppercase;color:var(--text-3)">Actions</th>
        </tr></thead><tbody>`;
      inv.forEach(f=>{
        const statusColors={draft:'var(--text-4)',sent:'var(--gold)',paid:'var(--green)',overdue:'var(--red)',cancelled:'var(--text-4)'};
        const statusLabels={draft:'Brouillon',sent:'Envoyée',paid:'Payée',overdue:'En retard',cancelled:'Annulée'};
        const typeLabels={invoice:'Facture',quote:'Devis',credit_note:'Note crédit'};
        const typeColors={invoice:'var(--primary)',quote:'var(--gold)',credit_note:'var(--text-3)'};
        const sc=statusColors[f.status]||'var(--text-4)';
        const d=new Date(f.issue_date).toLocaleDateString('fr-BE');
        h+=`<tr style="border-bottom:1px solid var(--border-light)">
          <td style="padding:10px 14px;font-weight:600">${esc(f.invoice_number)}</td>
          <td style="padding:10px"><span style="font-size:.7rem;padding:2px 8px;border-radius:10px;background:${typeColors[f.type]}15;color:${typeColors[f.type]};font-weight:600">${typeLabels[f.type]||f.type}</span></td>
          <td style="padding:10px">${esc(f.client_name)}</td>
          <td style="padding:10px;color:var(--text-3)">${d}</td>
          <td style="padding:10px;text-align:right;font-weight:600">${fmtEur(f.total_cents)}</td>
          <td style="padding:10px;text-align:center"><span style="font-size:.72rem;padding:3px 10px;border-radius:10px;background:${sc}12;color:${sc};font-weight:600">${statusLabels[f.status]||f.status}</span></td>
          <td style="padding:10px;text-align:right">
            <button onclick="downloadInvoicePDF('${f.id}')" title="Télécharger PDF" style="background:none;border:none;cursor:pointer;font-size:1rem">📄</button>
            ${f.status==='draft'?`<button onclick="changeInvoiceStatus('${f.id}','sent')" title="Marquer envoyée" style="background:none;border:none;cursor:pointer;font-size:1rem">📨</button>`:''}
            ${f.status==='sent'||f.status==='overdue'?`<button onclick="changeInvoiceStatus('${f.id}','paid')" title="Marquer payée" style="background:none;border:none;cursor:pointer;font-size:1rem">✅</button>`:''}
            ${f.status==='draft'?`<button onclick="deleteInvoice('${f.id}')" title="Supprimer" style="background:none;border:none;cursor:pointer;font-size:1rem">🗑️</button>`:''}
          </td>
        </tr>`;
      });
      h+=`</tbody></table></div>`;
    }

    // IBAN/BIC reminder
    const bizData=api.getBusiness();
    if(!bizData?.settings?.iban){
      h+=`<div class="card" style="background:var(--gold-bg);border:1px solid #E0D4A8;margin-top:14px;padding:14px 18px">
        <p style="font-size:.82rem;color:var(--text-2);margin:0">💡 <strong>Ajoutez votre IBAN</strong> dans Paramètres → Infos cabinet pour l'afficher sur vos factures et générer la communication structurée belge.</p>
      </div>`;
    }

    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function fmtEur(cents){return((cents||0)/100).toFixed(2).replace('.',',')+' €';}

// Invoice creation modal
async function openInvoiceModal(type='invoice'){
  // Fetch clients for dropdown
  let clients=[];
  try{const r=await api.get('/api/clients');clients=r.clients||r||[];}catch(e){}

  const isQuote=type==='quote';
  const title=isQuote?'Nouveau devis':'Nouvelle facture';

  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;display:flex;align-items:center;justify-content:center';
  modal.innerHTML=`<div style="background:var(--white);border-radius:var(--radius);padding:28px;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <h3 style="font-size:1.1rem;font-weight:700;color:var(--text);margin:0">${title}</h3>
      <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer">✕</button>
    </div>

    <div style="display:grid;gap:12px">
      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Client</label>
        <select id="invClient" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
          <option value="">— Sélectionner un client —</option>
          ${clients.map(c=>`<option value="${c.id}">${esc(c.full_name)}${c.email?' ('+esc(c.email)+')':''}</option>`).join('')}
        </select>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Taux TVA (%)</label>
          <select id="invVat" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
            <option value="21">21% (standard)</option>
            <option value="6">6% (réduit)</option>
            <option value="0">0% (exempté)</option>
          </select>
        </div>
        <div>
          <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">${isQuote?'Validité (jours)':'Échéance (jours)'}</label>
          <input id="invDueDays" type="number" value="${isQuote?'30':'30'}" min="0" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
        </div>
      </div>

      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">TVA client (optionnel)</label>
        <input id="invClientBce" placeholder="BE0XXX.XXX.XXX" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
      </div>

      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:6px">Lignes</label>
        <div id="invLines"></div>
        <button onclick="addInvoiceLine()" style="margin-top:6px;padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem;cursor:pointer">+ Ajouter une ligne</button>
      </div>

      <div id="invTotals" style="text-align:right;padding:10px 0;border-top:1px solid var(--border)"></div>

      <div>
        <label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Notes</label>
        <textarea id="invNotes" rows="2" placeholder="Conditions, remarques..." style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem;resize:vertical"></textarea>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
      <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:9px 18px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;cursor:pointer">Annuler</button>
      <button onclick="saveInvoice('${type}')" style="padding:9px 22px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.82rem;font-weight:600;cursor:pointer">${isQuote?'Créer le devis':'Créer la facture'}</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  addInvoiceLine();
  updateInvTotals();
}

function addInvoiceLine(){
  const container=document.getElementById('invLines');
  if(!container)return;
  const idx=container.children.length;
  const row=document.createElement('div');
  row.style.cssText='display:grid;grid-template-columns:1fr 60px 100px 30px;gap:8px;align-items:center;margin-bottom:6px';
  row.innerHTML=`
    <input class="inv-desc" placeholder="Description prestation" style="padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem">
    <input class="inv-qty" type="number" value="1" min="1" onchange="updateInvTotals()" style="padding:8px 6px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;text-align:center">
    <input class="inv-price" type="number" step="0.01" placeholder="Prix €" onchange="updateInvTotals()" style="padding:8px 6px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;text-align:right">
    <button onclick="this.parentElement.remove();updateInvTotals()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:1rem">✕</button>`;
  container.appendChild(row);
}

function updateInvTotals(){
  const container=document.getElementById('invLines');
  const totalsDiv=document.getElementById('invTotals');
  if(!container||!totalsDiv)return;
  const vatRate=parseFloat(document.getElementById('invVat')?.value||21);
  let subtotal=0;
  container.querySelectorAll(':scope > div').forEach(row=>{
    const qty=parseFloat(row.querySelector('.inv-qty')?.value||1);
    const price=parseFloat(row.querySelector('.inv-price')?.value||0);
    subtotal+=qty*price*100;
  });
  const vat=Math.round(subtotal*vatRate/100);
  const total=subtotal+vat;
  totalsDiv.innerHTML=`
    <div style="font-size:.82rem;color:var(--text-3)">Sous-total HT : <strong>${fmtEur(subtotal)}</strong></div>
    <div style="font-size:.82rem;color:var(--text-3)">TVA (${vatRate}%) : <strong>${fmtEur(vat)}</strong></div>
    <div style="font-size:1rem;font-weight:700;color:var(--text);margin-top:4px">Total TTC : ${fmtEur(total)}</div>`;
}

async function saveInvoice(type){
  const clientId=document.getElementById('invClient')?.value;
  if(!clientId){GendaUI.toast('Sélectionnez un client','error');return;}

  const container=document.getElementById('invLines');
  const items=[];
  container.querySelectorAll(':scope > div').forEach(row=>{
    const desc=row.querySelector('.inv-desc')?.value?.trim();
    const qty=parseFloat(row.querySelector('.inv-qty')?.value||1);
    const price=parseFloat(row.querySelector('.inv-price')?.value||0);
    if(desc&&price>0)items.push({description:desc,quantity:qty,unit_price_cents:Math.round(price*100)});
  });
  if(items.length===0){GendaUI.toast('Ajoutez au moins une ligne','error');return;}

  try{
    const body={
      client_id:clientId,
      type:type||'invoice',
      items,
      vat_rate:parseFloat(document.getElementById('invVat')?.value||21),
      due_days:parseInt(document.getElementById('invDueDays')?.value||30),
      client_bce:document.getElementById('invClientBce')?.value?.trim()||undefined,
      notes:document.getElementById('invNotes')?.value?.trim()||undefined
    };
    const r=await api.post('/api/invoices',body);
    document.querySelector('div[style*="position:fixed"][style*="inset:0"]')?.remove();
    GendaUI.toast(type==='quote'?'Devis créé !':'Facture créée !','success');
    loadInvoices();
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

async function changeInvoiceStatus(id,status){
  const labels={sent:'Marquer comme envoyée ?',paid:'Marquer comme payée ?'};
  if(!confirm(labels[status]||`Changer le statut en "${status}" ?`))return;
  try{
    await api.patch(`/api/invoices/${id}/status`,{status});
    GendaUI.toast('Statut mis à jour','success');
    loadInvoices();
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

async function deleteInvoice(id){
  if(!confirm('Supprimer ce brouillon ?'))return;
  try{
    await api.delete(`/api/invoices/${id}`);
    GendaUI.toast('Brouillon supprimé','success');
    loadInvoices();
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

function downloadInvoicePDF(id){
  const token=localStorage.getItem('genda_token');
  window.open(`/api/invoices/${id}/pdf?token=${token}`,'_blank');
}

async function createInvoiceFromBooking(bookingId){
  if(!confirm('Créer une facture pour ce rendez-vous ?'))return;
  try{
    const r=await api.post('/api/invoices',{booking_id:bookingId,type:'invoice'});
    GendaUI.toast('Facture créée ! Retrouvez-la dans Facturation.','success');
    // Switch to invoices section
    document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
    document.querySelector('[data-section="invoices"]')?.classList.add('active');
    document.getElementById('pageTitle').textContent='Facturation';
    loadInvoices();
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

// ============================================================
// DOCUMENTS PRÉ-RDV
// ============================================================

async function loadDocuments(){
  const c=document.getElementById('contentArea');
  c.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  try{
    const[tRes,sRes]=await Promise.all([api.get('/api/documents'),api.get('/api/services')]);
    const templates=tRes.templates||[];
    const services=sRes.services||sRes||[];
    let h='';

    h+=`<div class="card" style="padding:18px 22px;background:var(--primary-light);border:1px solid var(--primary-soft)">
      <p style="font-size:.85rem;color:var(--text-2);margin:0">
        <strong>📋 Documents pré-rendez-vous</strong> — Créez des fiches d'information, formulaires d'anamnèse ou consentements éclairés. Envoi automatique par email J-2 (configurable) aux clients ayant un RDV confirmé.</p>
    </div>`;

    h+=`<div style="display:flex;gap:10px;margin:14px 0;flex-wrap:wrap">
      <button onclick="openDocModal('info')" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Fiche d'info</button>
      <button onclick="openDocModal('form')" style="padding:8px 16px;background:var(--gold);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Formulaire</button>
      <button onclick="openDocModal('consent')" style="padding:8px 16px;background:var(--red);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.8rem;font-weight:600;cursor:pointer">+ Consentement</button>
    </div>`;

    if(templates.length===0){
      h+=`<div class="card"><div class="empty" style="padding:40px">Aucun document configuré. Créez votre premier template !</div></div>`;
    }else{
      h+=`<div style="display:grid;gap:12px">`;
      templates.forEach(t=>{
        const typeLabels={info:'📄 Info',form:'📝 Formulaire',consent:'✍️ Consentement'};
        const typeBg={info:'var(--primary-light)',form:'var(--gold-bg)',consent:'var(--red-bg)'};
        const typeColor={info:'var(--primary)',form:'var(--gold)',consent:'var(--red)'};
        const fields=t.form_fields||[];
        h+=`<div class="card" style="padding:0;overflow:hidden">
          <div style="display:flex;align-items:center;gap:14px;padding:16px 20px">
            <div style="width:42px;height:42px;border-radius:10px;background:${typeBg[t.type]};display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">
              ${t.type==='info'?'📄':t.type==='form'?'📝':'✍️'}
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-size:.92rem;font-weight:700;color:var(--text)">${esc(t.name)}</div>
              <div style="font-size:.75rem;color:var(--text-3);margin-top:2px">
                <span style="padding:2px 6px;border-radius:6px;background:${typeBg[t.type]};color:${typeColor[t.type]};font-weight:600;font-size:.68rem">${typeLabels[t.type]||t.type}</span>
                ${t.service_name?` · ${esc(t.service_name)}`:' · Toutes prestations'}
                · J-${t.send_days_before}
                ${fields.length>0?` · ${fields.length} champ${fields.length>1?'s':''}`:''} 
              </div>
            </div>
            <div style="text-align:right">
              <span style="font-size:.72rem;color:${t.is_active?'var(--green)':'var(--text-4)'};font-weight:600">${t.is_active?'Actif':'Inactif'}</span>
              <div style="font-size:.68rem;color:var(--text-4)">${t.sends_count||0} envois · ${t.completed_count||0} complétés</div>
            </div>
          </div>
          <div style="border-top:1px solid var(--border-light);padding:8px 20px;display:flex;gap:8px;justify-content:flex-end">
            <button onclick="openDocModal('${t.type}','${t.id}')" style="font-size:.78rem;padding:5px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);cursor:pointer">✏️ Modifier</button>
            <button onclick="toggleDocActive('${t.id}',${!t.is_active})" style="font-size:.78rem;padding:5px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);cursor:pointer">${t.is_active?'⏸ Désactiver':'▶️ Activer'}</button>
            <button onclick="deleteDoc('${t.id}')" style="font-size:.78rem;padding:5px 12px;background:var(--red-bg);border:1px solid #F5C6C6;border-radius:var(--radius-xs);cursor:pointer;color:var(--red)">🗑️</button>
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    c.innerHTML=h;
    window._docServices=services;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

async function openDocModal(type,editId){
  let existing=null;
  if(editId){try{const r=await api.get('/api/documents');existing=(r.templates||[]).find(t=>t.id===editId);}catch(e){}}
  const services=window._docServices||[];
  const isEdit=!!existing;
  const title=isEdit?'Modifier le document':type==='info'?"Nouvelle fiche d'info":type==='form'?'Nouveau formulaire':'Nouveau consentement';
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;display:flex;align-items:center;justify-content:center';
  modal.innerHTML=`<div style="background:var(--white);border-radius:var(--radius);padding:28px;width:620px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <h3 style="font-size:1.1rem;font-weight:700;margin:0">${title}</h3>
      <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer">&times;</button>
    </div>
    <div style="display:grid;gap:12px">
      <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Nom du document *</label>
        <input id="docName" value="${esc(existing?.name||'')}" placeholder="Ex: Fiche anamn&egrave;se premi&egrave;re consultation" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Prestation li&eacute;e</label>
          <select id="docService" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
            <option value="">Toutes les prestations</option>
            ${services.map(s=>`<option value="${s.id}" ${existing?.service_id===s.id?'selected':''}>${esc(s.name)}</option>`).join('')}
          </select></div>
        <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Envoyer J-</label>
          <input id="docDays" type="number" min="1" max="14" value="${existing?.send_days_before||2}" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem">
          <div style="font-size:.68rem;color:var(--text-4);margin-top:2px">Jours avant le RDV</div></div>
      </div>
      <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Objet email (optionnel)</label>
        <input id="docSubject" value="${esc(existing?.subject||'')}" placeholder="Par d&eacute;faut: nom du document + nom du cabinet" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem"></div>
      <div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:4px">Contenu *</label>
        <textarea id="docContent" rows="6" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.85rem;resize:vertical;font-family:inherit">${esc(existing?.content_html||'')}</textarea>
        <div style="font-size:.68rem;color:var(--text-4);margin-top:2px">HTML accept&eacute; : h2, p, ul, li, strong</div></div>
      ${type!=='info'?`<div><label style="font-size:.75rem;font-weight:600;color:var(--text-3);text-transform:uppercase;display:block;margin-bottom:6px">Champs du formulaire</label>
        <div id="docFields"></div>
        <button onclick="addDocField()" style="margin-top:6px;padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem;cursor:pointer">+ Ajouter un champ</button></div>`:''}
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
      <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:9px 18px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;cursor:pointer">Annuler</button>
      <button onclick="saveDoc('${type}','${editId||''}')" style="padding:9px 22px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);font-size:.82rem;font-weight:600;cursor:pointer">${isEdit?'Enregistrer':'Cr&eacute;er'}</button>
    </div></div>`;
  document.body.appendChild(modal);
  if(type!=='info'&&existing?.form_fields?.length>0){existing.form_fields.forEach(f=>addDocField(f));}
}

let _docFieldIdx=0;
function addDocField(preset){
  const container=document.getElementById('docFields');if(!container)return;
  const idx=_docFieldIdx++;const fid=preset?.id||('f'+idx);
  const row=document.createElement('div');
  row.style.cssText='display:grid;grid-template-columns:1fr 120px 30px 30px;gap:6px;align-items:center;margin-bottom:6px';
  row.innerHTML=`<input class="df-label" value="${esc(preset?.label||'')}" placeholder="Libell&eacute; du champ" data-fid="${fid}" style="padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem">
    <select class="df-type" style="padding:7px 6px;border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.78rem">
      <option value="text" ${preset?.type==='text'?'selected':''}>Texte</option>
      <option value="textarea" ${preset?.type==='textarea'?'selected':''}>Zone texte</option>
      <option value="checkbox" ${preset?.type==='checkbox'?'selected':''}>Case</option>
      <option value="select" ${preset?.type==='select'?'selected':''}>Choix</option>
      <option value="date" ${preset?.type==='date'?'selected':''}>Date</option>
      <option value="email" ${preset?.type==='email'?'selected':''}>Email</option>
      <option value="phone" ${preset?.type==='phone'?'selected':''}>T&eacute;l</option>
    </select>
    <label style="font-size:.7rem;color:var(--text-4);display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" class="df-req" ${preset?.required?'checked':''} style="width:14px;height:14px">*</label>
    <button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:1rem">&times;</button>`;
  container.appendChild(row);
}

function collectDocFields(){
  const container=document.getElementById('docFields');if(!container)return[];
  const fields=[];
  container.querySelectorAll(':scope > div').forEach(row=>{
    const label=row.querySelector('.df-label')?.value?.trim();
    const type=row.querySelector('.df-type')?.value||'text';
    const required=row.querySelector('.df-req')?.checked||false;
    const fid=row.querySelector('.df-label')?.dataset.fid||('f'+Math.random().toString(36).slice(2,6));
    if(label)fields.push({id:fid,label,type,required});
  });
  return fields;
}

async function saveDoc(type,editId){
  const name=document.getElementById('docName')?.value?.trim();
  const content_html=document.getElementById('docContent')?.value?.trim();
  if(!name){GendaUI.toast('Nom requis','error');return;}
  if(!content_html){GendaUI.toast('Contenu requis','error');return;}
  const body={name,type,service_id:document.getElementById('docService')?.value||null,
    subject:document.getElementById('docSubject')?.value?.trim()||null,content_html,
    send_days_before:parseInt(document.getElementById('docDays')?.value||2),
    form_fields:type!=='info'?collectDocFields():[]};
  try{
    if(editId){await api.patch(`/api/documents/${editId}`,body);}
    else{await api.post('/api/documents',body);}
    document.querySelector('div[style*="position:fixed"][style*="inset:0"]')?.remove();
    GendaUI.toast(editId?'Document modifi&eacute;':'Document cr&eacute;&eacute; !','success');loadDocuments();
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

async function toggleDocActive(id,active){
  try{await api.patch(`/api/documents/${id}`,{is_active:active});GendaUI.toast(active?'Activ&eacute;':'D&eacute;sactiv&eacute;','success');loadDocuments();}catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

async function deleteDoc(id){
  if(!confirm('Supprimer ce document ?'))return;
  try{await api.delete(`/api/documents/${id}`);GendaUI.toast('Supprim&eacute;','success');loadDocuments();}catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

// ============================================================
// CALENDAR SYNC
// ============================================================

async function connectCalendar(provider){
  try{
    const r=await api.get(`/api/calendar/${provider}/connect`);
    if(r.url)window.location.href=r.url;
    else GendaUI.toast('Erreur de connexion','error');
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

async function disconnectCalendar(connId,provider){
  if(!confirm('D\u00e9connecter '+(provider==='google'?'Google Calendar':'Outlook')+' ?'))return;
  try{
    await api.delete(`/api/calendar/connections/${connId}`);
    GendaUI.toast('Calendrier d\u00e9connect\u00e9','success');
    loadSettings();
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

async function syncCalendar(connId){
  try{
    GendaUI.toast('Synchronisation en cours...','info');
    const r=await api.post(`/api/calendar/connections/${connId}/sync`);
    GendaUI.toast('Synchro termin\u00e9e : '+(r.pushed||0)+' pouss\u00e9s, '+(r.pulled||0)+' r\u00e9cup\u00e9r\u00e9s','success');
    loadSettings();
  }catch(e){GendaUI.toast(e.message||'Erreur synchro','error');}
}

async function updateCalSyncDirection(direction){
  try{
    const r=await api.get('/api/calendar/connections');
    const conns=r.connections||[];
    for(const c of conns){await api.patch('/api/calendar/connections/'+c.id,{sync_direction:direction});}
    GendaUI.toast('Direction de synchro mise \u00e0 jour','success');
  }catch(e){GendaUI.toast(e.message||'Erreur','error');}
}

// Handle OAuth callback params on page load
(function(){
  const p=new URLSearchParams(location.search);
  if(p.get('cal_connected')){
    const prov=p.get('cal_connected')==='google'?'Google Calendar':'Outlook';
    setTimeout(function(){GendaUI.toast(prov+' connect\u00e9 !','success');},500);
    history.replaceState(null,'','/dashboard');
    setTimeout(function(){
      document.querySelectorAll('.ni').forEach(function(n){n.classList.remove('active');});
      var el=document.querySelector('[data-section="settings"]');if(el)el.classList.add('active');
      document.getElementById('pageTitle').textContent='Param\u00e8tres';
      loadSettings();
    },600);
  }
  if(p.get('cal_error')){
    setTimeout(function(){GendaUI.toast('Erreur calendrier: '+p.get('cal_error'),'error');},500);
    history.replaceState(null,'','/dashboard');
  }
})();

// ============================================================
// APPELS (CALL FILTER)
// ============================================================
let callTab='logs';
async function loadCalls(){
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div></div>`;
  try{
    const[setR,wlR,logR]=await Promise.all([
      fetch('/api/calls/settings',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/calls/whitelist',{headers:{'Authorization':'Bearer '+api.getToken()}}),
      fetch('/api/calls/logs',{headers:{'Authorization':'Bearer '+api.getToken()}})
    ]);
    const setD=await setR.json(), wlD=await wlR.json(), logD=await logR.json();
    const cs=setD.settings||{};
    const wl=wlD.whitelist||[];
    const logs=logD.logs||[];
    const st=logD.stats||{};

    // KPIs
    let h=`<div class="kpis">`;
    h+=`<div class="kpi"><div class="kpi-val">${st.total||0}</div><div class="kpi-label">Appels ce mois</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:var(--primary)">${st.filtered||0}</div><div class="kpi-label">📱 SMS envoyés</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:#15803d">${st.vip||0}</div><div class="kpi-label">⭐ VIP passés</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:#B45309">${st.urgent||0}</div><div class="kpi-label">🚨 Urgents</div></div>`;
    h+=`<div class="kpi"><div class="kpi-val" style="color:var(--primary)">${st.total>0?Math.round((st.converted||0)/st.total*100):0}%</div><div class="kpi-label">📅 Convertis</div></div>`;
    h+=`</div>`;

    // Tabs
    h+=`<div style="display:flex;gap:6px;margin-bottom:16px">`;
    h+=`<button class="btn-sm ${callTab==='logs'?'active':''}" onclick="callTab='logs';loadCalls()">📋 Journal</button>`;
    h+=`<button class="btn-sm ${callTab==='config'?'active':''}" onclick="callTab='config';loadCalls()">⚙️ Configuration</button>`;
    h+=`<button class="btn-sm ${callTab==='whitelist'?'active':''}" onclick="callTab='whitelist';loadCalls()">⭐ VIP (${wl.length})</button>`;
    h+=`</div>`;

    if(callTab==='logs') h+=renderCallLogs(logs);
    else if(callTab==='config') h+=renderCallConfig(cs);
    else if(callTab==='whitelist') h+=renderCallWhitelist(wl);

    c.innerHTML=h;
  }catch(e){c.innerHTML=`<div class="empty" style="color:var(--red)">Erreur: ${e.message}</div>`;}
}

function renderCallLogs(logs){
  let h=`<div class="card"><div class="card-h"><h3>Journal d'appels</h3><span class="badge badge-teal">${logs.length}</span></div>`;
  if(logs.length===0){
    h+=`<div class="empty">Aucun appel enregistré.<br><span style="font-size:.8rem;color:var(--text-4)">Les appels apparaîtront ici une fois le filtre Twilio activé.</span></div>`;
  }else{
    const actionLabels={'whitelist_pass':'⭐ VIP','played_message':'🔊 Message','forwarded':'📞 Transféré','sent_sms':'📱 SMS','urgent_key':'🚨 Urgent','voicemail':'📝 Messagerie','hung_up':'❌ Raccroché'};
    const resultLabels={'ok':'✅','failed':'❌','no_answer':'⏳'};
    h+=`<div style="overflow-x:auto"><table class="table"><thead><tr><th>Date</th><th>Numéro</th><th>Action</th><th>Résultat</th><th>Durée</th><th>RDV</th></tr></thead><tbody>`;
    logs.forEach(l=>{
      const dt=new Date(l.created_at);
      const dateStr=dt.toLocaleDateString('fr-BE',{day:'numeric',month:'short'})+' '+dt.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
      const durStr=l.duration_sec>0?`${Math.floor(l.duration_sec/60)}:${String(l.duration_sec%60).padStart(2,'0')}`:'—';
      const booking=l.booking_id?'<span style="color:var(--primary)">📅 Oui</span>':'—';
      h+=`<tr><td style="font-size:.78rem;white-space:nowrap">${dateStr}</td><td style="font-family:monospace;font-size:.78rem">${l.from_phone_masked||l.from_phone||'—'}</td><td>${actionLabels[l.action]||l.action}</td><td>${resultLabels[l.result]||l.result}</td><td>${durStr}</td><td>${booking}</td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }
  h+=`</div>`;
  return h;
}

function renderCallConfig(cs){
  const mode=cs.filter_mode||'off';
  const hasNumber=!!cs.twilio_number;
  let h='';

  // Activation panel
  if(!hasNumber){
    h+=`<div class="card" style="border:2px dashed var(--primary);background:linear-gradient(135deg,#f0fdfa,#ecfdf5)">`;
    h+=`<div style="text-align:center;padding:24px">`;
    h+=`<div style="font-size:2.5rem;margin-bottom:12px">📞</div>`;
    h+=`<h3 style="margin-bottom:8px">Activez le filtre d'appels intelligent</h3>`;
    h+=`<p style="font-size:.85rem;color:var(--text-4);max-width:500px;margin:0 auto 20px">Vos patients reçoivent un SMS avec votre lien de réservation. Les VIP passent directement. Fini les appels qui interrompent vos consultations.</p>`;
    h+=`<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:16px">`;
    h+=`<button class="btn-primary" onclick="activateCallFilter('BE')">🇧🇪 Numéro belge</button>`;
    h+=`<button class="btn-outline" onclick="activateCallFilter('FR')">🇫🇷 Numéro français</button>`;
    h+=`<button class="btn-outline" onclick="activateCallFilter('NL')">🇳🇱 Numéro néerlandais</button>`;
    h+=`</div>`;
    h+=`<div style="font-size:.72rem;color:var(--text-4)">Un numéro virtuel est attribué à votre cabinet. Inclus dans l'abonnement Premium.</div>`;
    h+=`</div></div>`;
    return h;
  }

  // Active number banner
  h+=`<div class="card" style="background:linear-gradient(135deg,#f0fdfa,#ecfdf5);margin-bottom:16px">`;
  h+=`<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">`;
  h+=`<div><span style="font-size:.75rem;font-weight:600;color:var(--text-4);text-transform:uppercase;letter-spacing:.5px">Numéro actif</span><div style="font-size:1.3rem;font-weight:700;font-family:monospace;color:var(--primary);margin-top:2px">${formatPhoneDisplay(cs.twilio_number)}</div></div>`;
  h+=`<div style="display:flex;gap:8px;align-items:center">`;
  h+=`<span style="font-size:.78rem;padding:4px 10px;border-radius:20px;font-weight:600;${mode==='off'?'background:#fef2f2;color:#dc2626':mode==='soft'?'background:#fffbeb;color:#B45309':mode==='strict'?'background:#f0fdf4;color:#15803d':'background:#eff6ff;color:#2563eb'}">${{off:'🔴 Désactivé',soft:'🟡 Soft',strict:'🟢 Strict',schedule_based:'📅 Horaires'}[mode]||mode}</span>`;
  h+=`<button class="btn-outline btn-sm btn-danger" onclick="deactivateCallFilter()" style="font-size:.72rem">Désactiver</button>`;
  h+=`</div></div></div>`;

  // Config form
  h+=`<div class="card"><div class="card-h"><h3>⚙️ Configuration</h3></div>`;

  // Mode
  h+=`<div class="field"><label>Mode de filtrage</label><select id="call_mode" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:.88rem">`;
  h+=`<option value="off" ${mode==='off'?'selected':''}>🔴 Désactivé — Les appels passent directement</option>`;
  h+=`<option value="soft" ${mode==='soft'?'selected':''}>🟡 Soft — Message + transfert automatique</option>`;
  h+=`<option value="strict" ${mode==='strict'?'selected':''}>🟢 Strict — SMS seul, pas de transfert</option>`;
  h+=`<option value="schedule_based" ${mode==='schedule_based'?'selected':''}>📅 Horaires — Filtre actif hors disponibilités</option>`;
  h+=`</select></div>`;

  // Explanation
  h+=`<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:.8rem;color:var(--text-4)">`;
  h+=`<strong>Comment ça fonctionne :</strong><br>`;
  h+=`Quand le filtre est actif, les appels entrants entendent un message vocal. Ils reçoivent un SMS avec votre lien de réservation. Les numéros VIP passent directement. En mode Soft, l'appelant peut taper 1 pour une urgence.`;
  h+=`</div>`;

  // Forward phone
  h+=`<div class="field-row"><div class="field"><label>📞 Numéro de transfert</label><input id="call_forward" value="${cs.forward_default_phone||''}" placeholder="+32 470 12 34 56"><div style="font-size:.72rem;color:var(--text-4);margin-top:2px">Où transférer les appels VIP et urgents</div></div>`;
  h+=`<div class="field"><label>🚨 Numéro urgences</label><input id="call_urgent_phone" value="${cs.urgent_target_phone||''}" placeholder="Idem si vide"><div style="font-size:.72rem;color:var(--text-4);margin-top:2px">Où vont les "Tapez 1" (par défaut = transfert)</div></div></div>`;

  // Toggles
  h+=`<div style="display:flex;flex-direction:column;gap:12px;margin:16px 0">`;
  h+=`<label style="display:flex;align-items:center;gap:10px;font-size:.85rem;cursor:pointer"><input type="checkbox" id="call_keypress" ${cs.allow_keypress_urgent!==false?'checked':''}><span><strong>Touche 1 = Urgence</strong><br><span style="font-size:.75rem;color:var(--text-4)">"Si c'est urgent, tapez 1 pour être transféré"</span></span></label>`;
  h+=`<label style="display:flex;align-items:center;gap:10px;font-size:.85rem;cursor:pointer"><input type="checkbox" id="call_sms" ${cs.sms_after_call!==false?'checked':''}><span><strong>SMS automatique</strong><br><span style="font-size:.75rem;color:var(--text-4)">Envoie le lien de réservation par SMS après l'appel</span></span></label>`;
  h+=`<label style="display:flex;align-items:center;gap:10px;font-size:.85rem;cursor:pointer"><input type="checkbox" id="call_voicemail" ${cs.voicemail_enabled?'checked':''} onchange="document.getElementById('call_vm_texts').style.display=this.checked?'block':'none'"><span><strong>Messagerie vocale</strong><br><span style="font-size:.75rem;color:var(--text-4)">Permet de laisser un message vocal</span></span></label>`;
  h+=`</div>`;

  // Voicemail texts
  h+=`<div id="call_vm_texts" style="display:${cs.voicemail_enabled?'block':'none'}">`;
  h+=`<div class="field"><label>🇫🇷 Message vocal FR</label><textarea id="call_vm_fr" rows="2" placeholder="Bonjour, vous êtes bien chez [cabinet]. Nous ne pouvons pas prendre votre appel. Réservez en ligne via le SMS que vous allez recevoir.">${cs.voicemail_text_fr||''}</textarea></div>`;
  h+=`<div class="field"><label>🇳🇱 Message vocal NL</label><textarea id="call_vm_nl" rows="2" placeholder="Goedendag, u bent verbonden met [kabinet]. We kunnen uw oproep niet beantwoorden...">${cs.voicemail_text_nl||''}</textarea></div>`;
  h+=`</div>`;

  h+=`<button class="btn-primary" onclick="saveCallSettings()" style="margin-top:8px">💾 Enregistrer</button>`;
  h+=`</div>`;

  // Instructions card
  h+=`<div class="card" style="margin-top:16px"><div class="card-h"><h3>📋 Instructions</h3></div>`;
  h+=`<div style="font-size:.82rem;color:var(--text-3);line-height:1.6">`;
  h+=`<strong>1.</strong> Communiquez ce numéro à vos patients : carte de visite, site web, Google Business.<br>`;
  h+=`<strong>2.</strong> Renseignez votre vrai numéro en "Numéro de transfert" ci-dessus.<br>`;
  h+=`<strong>3.</strong> Ajoutez vos contacts importants (labo, pharmacie, confrères) dans l'onglet VIP.<br>`;
  h+=`<strong>4.</strong> Choisissez le mode de filtrage adapté à votre pratique.`;
  h+=`</div></div>`;

  return h;
}

function formatPhoneDisplay(phone){
  if(!phone)return '';
  // Format +32470123456 → +32 470 12 34 56
  const p=phone.replace(/\s/g,'');
  if(p.startsWith('+32')&&p.length===12) return `+32 ${p.slice(3,6)} ${p.slice(6,8)} ${p.slice(8,10)} ${p.slice(10)}`;
  if(p.startsWith('+33')&&p.length===12) return `+33 ${p.slice(3,4)} ${p.slice(4,6)} ${p.slice(6,8)} ${p.slice(8,10)} ${p.slice(10)}`;
  return phone;
}

async function activateCallFilter(country){
  if(!confirm(`Activer le filtre d'appels avec un numéro ${country==='BE'?'belge':country==='FR'?'français':'néerlandais'} ?\n\nUn numéro virtuel sera attribué à votre cabinet.`))return;
  const c=document.getElementById('contentArea');
  c.innerHTML=`<div class="loading"><div class="spinner"></div><p style="text-align:center;margin-top:12px;color:var(--text-4)">Recherche d'un numéro disponible...</p></div>`;
  try{
    // First search available numbers
    const searchR=await fetch(`/api/calls/available-numbers?country=${country}`,{headers:{'Authorization':'Bearer '+api.getToken()}});
    const searchD=await searchR.json();
    if(!searchR.ok)throw new Error(searchD.error);
    if(!searchD.numbers||searchD.numbers.length===0)throw new Error('Aucun numéro disponible pour ce pays');

    c.innerHTML=`<div class="loading"><div class="spinner"></div><p style="text-align:center;margin-top:12px;color:var(--text-4)">Attribution du numéro ${searchD.numbers[0].friendly}...</p></div>`;

    // Activate with first available
    const actR=await fetch('/api/calls/activate',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({phone_number:searchD.numbers[0].phone,country})});
    const actD=await actR.json();
    if(!actR.ok)throw new Error(actD.error);

    GendaUI.toast(`Numéro ${actD.number} activé !`,'success');
    callTab='config';
    loadCalls();
  }catch(e){
    GendaUI.toast('Erreur: '+e.message,'error');
    callTab='config';
    loadCalls();
  }
}

async function deactivateCallFilter(){
  if(!confirm('⚠️ Désactiver le filtre d\'appels ?\n\nLe numéro virtuel sera libéré et les appels ne seront plus filtrés. Cette action est irréversible.'))return;
  try{
    const r=await fetch('/api/calls/deactivate',{method:'POST',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    GendaUI.toast('Filtre d\'appels désactivé','success');
    callTab='config';
    loadCalls();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

function renderCallWhitelist(wl){
  let h=`<div class="card"><div class="card-h"><h3>⭐ Numéros VIP</h3><button class="btn-primary btn-sm" onclick="addWhitelistEntry()">+ Ajouter</button></div>`;
  h+=`<div style="font-size:.8rem;color:var(--text-4);margin-bottom:12px">Ces numéros ne sont jamais filtrés — l'appel passe directement sur votre téléphone.</div>`;
  if(wl.length===0){
    h+=`<div class="empty">Aucun numéro VIP configuré</div>`;
  }else{
    h+=`<div style="overflow-x:auto"><table class="table"><thead><tr><th>Numéro</th><th>Label</th><th>Actif</th><th></th></tr></thead><tbody>`;
    wl.forEach(w=>{
      h+=`<tr><td style="font-family:monospace;font-size:.85rem">${w.phone_e164}</td><td>${w.label||'—'}</td><td>${w.is_active?'✅':'❌'}</td>`;
      h+=`<td style="text-align:right"><button class="btn-outline btn-sm" onclick="editWhitelistEntry('${w.id}','${w.phone_e164}','${(w.label||'').replace(/'/g,"\\'")}',${w.is_active})">✏️</button> <button class="btn-outline btn-sm btn-danger" onclick="if(confirm('Supprimer ce numéro VIP ?'))deleteWhitelistEntry('${w.id}')">🗑️</button></td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }
  h+=`</div>`;
  return h;
}

async function saveCallSettings(){
  try{
    const body={
      filter_mode:document.getElementById('call_mode').value,
      forward_default_phone:document.getElementById('call_forward').value||null,
      urgent_target_phone:document.getElementById('call_urgent_phone').value||null,
      allow_keypress_urgent:document.getElementById('call_keypress').checked,
      sms_after_call:document.getElementById('call_sms').checked,
      voicemail_enabled:document.getElementById('call_voicemail').checked,
      voicemail_text_fr:document.getElementById('call_vm_fr')?.value||null,
      voicemail_text_nl:document.getElementById('call_vm_nl')?.value||null
    };
    const r=await fetch('/api/calls/settings',{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    GendaUI.toast('Configuration sauvegardée','success');
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

function addWhitelistEntry(){
  const phone=prompt('Numéro au format international (ex: +32 470 12 34 56):');
  if(!phone)return;
  const label=prompt('Label (ex: Labo, Pharmacie, Urgences):');
  fetch('/api/calls/whitelist',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify({phone_e164:phone.replace(/\s/g,''),label:label||null})})
    .then(r=>{if(!r.ok)throw new Error('Erreur');GendaUI.toast('Numéro VIP ajouté','success');loadCalls();})
    .catch(e=>GendaUI.toast('Erreur: '+e.message,'error'));
}

function editWhitelistEntry(id,phone,label,active){
  let m=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><div class="modal-h"><h3>Modifier numéro VIP</h3><button class="close" onclick="this.closest('.modal-overlay').remove()">✕</button></div><div class="modal-body">`;
  m+=`<div class="field"><label>Numéro</label><input id="wl_phone" value="${phone}"></div>`;
  m+=`<div class="field"><label>Label</label><input id="wl_label" value="${label}"></div>`;
  m+=`<label style="display:flex;align-items:center;gap:8px;margin-top:8px;font-size:.85rem"><input type="checkbox" id="wl_active" ${active?'checked':''}> Actif</label>`;
  m+=`</div><div class="modal-foot"><button class="btn-outline" onclick="this.closest('.modal-overlay').remove()">Annuler</button><button class="btn-primary" onclick="saveWhitelistEntry('${id}')">Enregistrer</button></div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',m);
}

async function saveWhitelistEntry(id){
  try{
    const body={phone_e164:document.getElementById('wl_phone').value.replace(/\s/g,''),label:document.getElementById('wl_label').value||null,is_active:document.getElementById('wl_active').checked};
    const r=await fetch(`/api/calls/whitelist/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':'Bearer '+api.getToken()},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json()).error);
    document.querySelector('.modal-overlay')?.remove();
    GendaUI.toast('Numéro VIP modifié','success');loadCalls();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}

async function deleteWhitelistEntry(id){
  try{
    const r=await fetch(`/api/calls/whitelist/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+api.getToken()}});
    if(!r.ok)throw new Error((await r.json()).error);
    GendaUI.toast('Numéro VIP supprimé','success');loadCalls();
  }catch(e){GendaUI.toast('Erreur: '+e.message,'error');}
}
</script>
</body>
</html>
