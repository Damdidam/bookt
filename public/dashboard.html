<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äî Bookt</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#FAFAF9;--white:#FFF;--surface:#F5F4F1;--surface-2:#EDEBE8;--border:#E0DDD8;--border-light:#ECEAE6;--text:#1A1816;--text-2:#3D3832;--text-3:#6B6560;--text-4:#9C958E;--primary:#0D7377;--primary-hover:#0A5E61;--primary-light:#EFF9F8;--primary-soft:#D5EFEC;--green:#1B7A42;--green-bg:#EEFAF1;--gold:#A68B3C;--gold-bg:#FAF6EC;--red:#DC2626;--red-bg:#FEF2F2;--sidebar-bg:#1C1917;--sidebar-hover:#292524;--serif:'Instrument Serif',Georgia,serif;--sans:'Plus Jakarta Sans',-apple-system,sans-serif;--shadow:0 2px 8px rgba(0,0,0,.05);--radius:14px;--radius-sm:10px;--radius-xs:6px}
body{background:var(--bg);color:var(--text);font-family:var(--sans);-webkit-font-smoothing:antialiased}

.sidebar{position:fixed;top:0;left:0;bottom:0;width:230px;background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;z-index:50}
.sb-logo{padding:18px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-logo .l{width:30px;height:30px;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:.85rem}
.sb-logo .w{font-size:.82rem;font-weight:700;letter-spacing:.5px}
.sb-logo .plan{font-size:.55rem;font-weight:700;background:rgba(255,255,255,.12);padding:1px 5px;border-radius:3px;margin-left:4px;color:rgba(255,255,255,.5)}
.sb-nav{padding:10px 8px;flex:1}
.ni{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.5);cursor:pointer;transition:all .12s;text-decoration:none;margin-bottom:2px}
.ni:hover{background:var(--sidebar-hover);color:rgba(255,255,255,.8)}
.ni.active{background:var(--primary);color:#fff;font-weight:600}
.ni .ic{width:18px;text-align:center;font-size:.9rem}
.sb-foot{padding:14px 16px;border-top:1px solid rgba(255,255,255,.06)}
.sb-foot .nm{font-size:.78rem;font-weight:600}
.sb-foot .rl{font-size:.65rem;color:rgba(255,255,255,.35)}
.sb-foot .logout{font-size:.68rem;color:rgba(255,255,255,.3);cursor:pointer;margin-top:4px;text-decoration:underline}

.main{margin-left:230px;min-height:100vh}
.topbar{position:sticky;top:0;background:rgba(250,250,249,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--border-light);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;z-index:40}
.topbar h1{font-family:var(--serif);font-size:1.3rem;font-weight:400}
.topbar-right{display:flex;align-items:center;gap:10px}

.content{padding:24px 28px;max-width:960px}

/* Stats grid */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:var(--white);border-radius:var(--radius-sm);border:1px solid var(--border-light);padding:16px}
.stat-card .label{font-size:.7rem;font-weight:600;color:var(--text-4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.stat-card .val{font-family:var(--serif);font-size:1.6rem;color:var(--text)}
.stat-card .sub{font-size:.7rem;color:var(--text-4);margin-top:2px}

/* Bookings list */
.card{background:var(--white);border-radius:var(--radius);border:1px solid var(--border-light);overflow:hidden;margin-bottom:16px}
.card-h{padding:14px 18px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between}
.card-h h3{font-size:.9rem;font-weight:700}
.card-h .badge{font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:10px}
.badge-teal{background:var(--primary-light);color:var(--primary)}

.bk-row{display:flex;align-items:center;gap:12px;padding:10px 18px;border-bottom:1px solid var(--border-light)}
.bk-row:last-child{border:none}
.bk-time{font-size:.82rem;font-weight:700;color:var(--primary);min-width:50px}
.bk-info{flex:1}
.bk-info .name{font-size:.85rem;font-weight:600}
.bk-info .svc{font-size:.72rem;color:var(--text-4)}
.bk-status{padding:3px 10px;border-radius:10px;font-size:.68rem;font-weight:600}
.bk-status.confirmed{background:var(--green-bg);color:var(--green)}
.bk-status.pending{background:var(--gold-bg);color:var(--gold)}
.bk-status.completed{background:var(--surface);color:var(--text-3)}
.bk-status.noshow{background:var(--gold-bg);color:var(--gold)}
.bk-status.cancelled{background:var(--red-bg);color:var(--red)}

.empty{padding:40px;text-align:center;color:var(--text-4);font-size:.88rem}

/* Quick link */
.qlink{background:linear-gradient(135deg,var(--primary),#0A5E61);border-radius:var(--radius-sm);padding:16px 20px;color:#fff;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.qlink .info h4{font-size:.9rem;font-weight:600;margin-bottom:2px}
.qlink .info p{font-size:.75rem;opacity:.6}
.qlink a{padding:7px 14px;background:rgba(255,255,255,.15);border-radius:var(--radius-xs);font-size:.78rem;font-weight:600;color:#fff;text-decoration:none;transition:background .15s}
.qlink a:hover{background:rgba(255,255,255,.25)}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--text-4)}
.loading .spinner{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:1000px){.sidebar{width:60px}.sidebar .w,.sidebar .plan,.ni span:not(.ic),.sb-foot .nm,.sb-foot .rl,.sb-foot .logout{display:none}.main{margin-left:60px}.stats{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sb-logo"><div class="l">B</div><span class="w">Bookt</span><span class="plan" id="planBadge">FREE</span></div>
  <nav class="sb-nav">
    <a class="ni active" href="#" data-section="home"><span class="ic">üìä</span><span>Dashboard</span></a>
    <a class="ni" href="#" data-section="bookings"><span class="ic">üìÖ</span><span>Agenda</span></a>
    <a class="ni" href="#" data-section="clients"><span class="ic">üë•</span><span>Clients</span></a>
    <a class="ni" href="#" data-section="services"><span class="ic">üìã</span><span>Prestations</span></a>
    <a class="ni" href="#" data-section="hours"><span class="ic">üïê</span><span>Disponibilit√©s</span></a>
    <a class="ni" href="#" data-section="site"><span class="ic">üåê</span><span>Mon site</span></a>
    <a class="ni" href="#" data-section="calls"><span class="ic">üìû</span><span>Appels</span></a>
    <a class="ni" href="#" data-section="settings"><span class="ic">‚öôÔ∏è</span><span>Param√®tres</span></a>
  </nav>
  <div class="sb-foot">
    <div class="nm" id="userName">‚Äî</div>
    <div class="rl" id="userRole">‚Äî</div>
    <div class="logout" onclick="doLogout()">D√©connexion</div>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <h1 id="pageTitle">Dashboard</h1>
    <div class="topbar-right">
      <span style="font-size:.78rem;color:var(--text-4)" id="todayDate"></span>
    </div>
  </div>
  <div class="content" id="contentArea">
    <div class="loading"><div class="spinner"></div><p style="margin-top:10px">Chargement...</p></div>
  </div>
</div>

<script src="/js/api-client.js"></script>
<script>
const api = new BooktAPI();

// ============================================================
// AUTH CHECK
// ============================================================
if (!api.isLoggedIn()) {
  window.location.href = '/login.html';
}

// ============================================================
// INIT
// ============================================================
const user = api.getUser();
const biz = api.getBusiness();

document.getElementById('userName').textContent = user?.business_name || user?.email || '‚Äî';
document.getElementById('userRole').textContent = user?.role === 'owner' ? 'Propri√©taire' : 'Staff';
document.getElementById('todayDate').textContent = new Date().toLocaleDateString('fr-BE', { weekday: 'long', day: 'numeric', month: 'long' });
if (biz) {
  document.getElementById('planBadge').textContent = (biz.plan || 'free').toUpperCase();
}

// Check if coming from onboarding
if (new URLSearchParams(location.search).get('onboarding')) {
  BooktUI.toast('üéâ Bienvenue sur votre dashboard !', 'success', 5000);
}

// ============================================================
// LOAD DASHBOARD
// ============================================================
loadDashboard();

async function loadDashboard() {
  const content = document.getElementById('contentArea');

  try {
    const [dashData, summaryData] = await Promise.allSettled([
      api.getDashboard(),
      api.get('/api/dashboard/summary')
    ]);

    const dash = dashData.status === 'fulfilled' ? dashData.value : {};
    const summary = summaryData.status === 'fulfilled' ? summaryData.value : null;

    const slug = dash.business?.slug || biz?.slug || '';

    let html = '';

    // Quick link banner
    html += `<div class="qlink">
      <div class="info"><h4>Votre page publique</h4><p>bookt.be/${slug}</p></div>
      <div><a href="/api/public/${slug}" target="_blank">Voir ma page</a></div>
    </div>`;

    // Stats
    if (summary) {
      const m = summary.month || {};
      const c = summary.clients || {};
      const calls = summary.calls || {};
      html += `<div class="stats">
        <div class="stat-card"><div class="label">RDV aujourd'hui</div><div class="val">${summary.today?.count || 0}</div></div>
        <div class="stat-card"><div class="label">CA ce mois</div><div class="val">${m.revenue_formatted || '0 ‚Ç¨'}</div><div class="sub">${m.total_bookings || 0} rendez-vous</div></div>
        <div class="stat-card"><div class="label">Clients actifs</div><div class="val">${c.total || 0}</div></div>
        <div class="stat-card"><div class="label">Appels ‚Üí RDV</div><div class="val">${calls.conversion_rate || 0}%</div><div class="sub">${calls.total || 0} appels ce mois</div></div>
      </div>`;

      // Today's bookings
      html += `<div class="card"><div class="card-h"><h3>Rendez-vous du jour</h3><span class="badge badge-teal">${summary.today?.count || 0} RDV</span></div>`;
      if (summary.today?.bookings?.length > 0) {
        summary.today.bookings.forEach(b => {
          const time = new Date(b.start_at).toLocaleTimeString('fr-BE', { hour: '2-digit', minute: '2-digit' });
          html += `<div class="bk-row">
            <span class="bk-time">${time}</span>
            <div class="bk-info"><div class="name">${b.client_name}</div><div class="svc">${b.service_name} ¬∑ ${b.duration_min}min ¬∑ ${b.practitioner_name}</div></div>
            <span class="bk-status ${b.status}">${b.status === 'confirmed' ? 'Confirm√©' : b.status === 'pending' ? 'En attente' : b.status}</span>
          </div>`;
        });
      } else {
        html += `<div class="empty">Aucun rendez-vous aujourd'hui<br><span style="font-size:.78rem">Partagez votre lien de r√©servation pour recevoir vos premiers RDV</span></div>`;
      }
      html += `</div>`;
    } else {
      // No summary data (fresh account)
      html += `<div class="stats">
        <div class="stat-card"><div class="label">RDV aujourd'hui</div><div class="val">0</div></div>
        <div class="stat-card"><div class="label">CA ce mois</div><div class="val">0 ‚Ç¨</div></div>
        <div class="stat-card"><div class="label">Clients</div><div class="val">0</div></div>
        <div class="stat-card"><div class="label">Appels</div><div class="val">‚Äî</div></div>
      </div>`;

      html += `<div class="card"><div class="card-h"><h3>Rendez-vous du jour</h3></div>
        <div class="empty">Aucun rendez-vous aujourd'hui<br><span style="font-size:.78rem">Partagez votre lien : <strong>bookt.be/${slug}</strong></span></div>
      </div>`;
    }

    // Practitioners
    if (dash.practitioners?.length > 0) {
      html += `<div class="card"><div class="card-h"><h3>√âquipe</h3><span class="badge badge-teal">${dash.practitioners.length} praticien(s)</span></div>`;
      dash.practitioners.forEach(p => {
        const initials = p.display_name?.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2) || '??';
        html += `<div class="bk-row">
          <div style="width:36px;height:36px;border-radius:9px;background:${p.color||'var(--primary)'};color:#fff;display:flex;align-items:center;justify-content:center;font-family:var(--serif);font-size:.8rem">${initials}</div>
          <div class="bk-info"><div class="name">${p.display_name}</div><div class="svc">${p.title || '‚Äî'} ${p.years_experience ? '¬∑ '+p.years_experience+' ans' : ''}</div></div>
        </div>`;
      });
      html += `</div>`;
    }

    content.innerHTML = html;

  } catch (err) {
    content.innerHTML = `<div class="empty" style="color:var(--red)">Erreur de chargement : ${err.message}<br><button onclick="loadDashboard()" style="margin-top:10px;padding:8px 16px;border-radius:6px;border:1px solid var(--border);background:var(--white);cursor:pointer">R√©essayer</button></div>`;
  }
}

// ============================================================
// NAV
// ============================================================
document.querySelectorAll('.ni').forEach(item => {
  item.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
    item.classList.add('active');
    const section = item.dataset.section;
    document.getElementById('pageTitle').textContent = {
      home:'Dashboard', bookings:'Agenda', clients:'Clients', services:'Prestations',
      hours:'Disponibilit√©s', site:'Mon site', calls:'Appels', settings:'Param√®tres'
    }[section] || 'Dashboard';

    if (section === 'home') loadDashboard();
    else if (section === 'bookings') loadAgenda();
    else document.getElementById('contentArea').innerHTML = `<div class="empty">Section "${section}" ‚Äî Bient√¥t disponible</div>`;
  });
});

// ============================================================
// AGENDA
// ============================================================
let agendaDate = new Date();
agendaDate.setHours(0,0,0,0);

const DAYS_FULL = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
const MONTHS_FULL = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];

function fmtAgendaDate(d) {
  const today = new Date(); today.setHours(0,0,0,0);
  const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
  if (d.getTime() === today.getTime()) return "Aujourd'hui";
  if (d.getTime() === tomorrow.getTime()) return "Demain";
  return `${DAYS_FULL[d.getDay()]} ${d.getDate()} ${MONTHS_FULL[d.getMonth()]}`;
}

async function loadAgenda() {
  const content = document.getElementById('contentArea');
  const dateStr = agendaDate.toISOString().split('T')[0];
  const nextDay = new Date(agendaDate); nextDay.setDate(nextDay.getDate()+1);
  const nextStr = nextDay.toISOString().split('T')[0];

  content.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
      <div style="display:flex;align-items:center;gap:10px">
        <button onclick="shiftAgenda(-1)" style="width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.9rem">‚Äπ</button>
        <span style="font-size:1rem;font-weight:600">${fmtAgendaDate(agendaDate)}</span>
        <button onclick="shiftAgenda(1)" style="width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.9rem">‚Ä∫</button>
        <button onclick="agendaDate=new Date();agendaDate.setHours(0,0,0,0);loadAgenda()" style="padding:5px 12px;border-radius:6px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text-3)">Aujourd'hui</button>
      </div>
      <span style="font-size:.78rem;color:var(--text-4)">${dateStr}</span>
    </div>
    <div class="loading"><div class="spinner"></div></div>
  `;

  try {
    const token = api.getToken();
    const res = await fetch(`/api/bookings?from=${dateStr}T00:00:00&to=${nextStr}T00:00:00`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    const bookings = data.bookings || [];

    let html = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
        <div style="display:flex;align-items:center;gap:10px">
          <button onclick="shiftAgenda(-1)" style="width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.9rem">‚Äπ</button>
          <span style="font-size:1rem;font-weight:600">${fmtAgendaDate(agendaDate)}</span>
          <button onclick="shiftAgenda(1)" style="width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.9rem">‚Ä∫</button>
          <button onclick="agendaDate=new Date();agendaDate.setHours(0,0,0,0);loadAgenda()" style="padding:5px 12px;border-radius:6px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text-3)">Aujourd'hui</button>
        </div>
        <span style="font-size:.78rem;color:var(--text-4)">${bookings.length} RDV</span>
      </div>
    `;

    if (bookings.length === 0) {
      html += `<div class="card"><div class="empty">Aucun rendez-vous ${fmtAgendaDate(agendaDate).toLowerCase()}</div></div>`;
    } else {
      html += `<div class="card">`;
      bookings.forEach(b => {
        const start = new Date(b.start_at);
        const end = new Date(b.end_at);
        const time = start.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
        const endTime = end.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'});
        const statusMap = {
          confirmed: {label:'Confirm√©', cls:'confirmed'},
          pending: {label:'En attente', cls:'pending'},
          completed: {label:'Termin√©', cls:'completed'},
          no_show: {label:'No-show', cls:'noshow'},
          cancelled: {label:'Annul√©', cls:'cancelled'}
        };
        const st = statusMap[b.status] || {label:b.status, cls:''};
        const modeMap = {cabinet:'üè¢',visio:'üíª',phone:'üìû'};

        html += `<div class="bk-row" style="flex-wrap:wrap;gap:8px" id="bk-${b.id}">
          <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:200px">
            <div style="min-width:90px">
              <div style="font-size:.9rem;font-weight:700;color:var(--primary)">${time}</div>
              <div style="font-size:.68rem;color:var(--text-4)">${time} ‚Äì ${endTime}</div>
            </div>
            <div style="width:4px;height:36px;border-radius:2px;background:${b.service_color||'var(--primary)'};flex-shrink:0"></div>
            <div style="flex:1">
              <div style="font-size:.88rem;font-weight:600">${b.client_name}</div>
              <div style="font-size:.73rem;color:var(--text-4)">${b.service_name} ¬∑ ${b.duration_min}min ¬∑ ${modeMap[b.appointment_mode]||''} ${b.appointment_mode||''}</div>
              <div style="font-size:.68rem;color:var(--text-4)">${b.practitioner_name} ¬∑ ${b.client_phone||''}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="bk-status ${st.cls}">${st.label}</span>
            ${b.status === 'confirmed' ? `
              <button onclick="updateStatus('${b.id}','completed')" title="Termin√©" style="padding:4px 8px;border-radius:5px;border:1px solid #B8E6C4;background:var(--green-bg);cursor:pointer;font-size:.7rem;color:var(--green);font-weight:600">‚úì Termin√©</button>
              <button onclick="updateStatus('${b.id}','no_show')" title="No-show" style="padding:4px 8px;border-radius:5px;border:1px solid #E8DCBA;background:var(--gold-bg);cursor:pointer;font-size:.7rem;color:var(--gold);font-weight:600">‚úó No-show</button>
              <button onclick="if(confirm('Annuler ce RDV ?'))updateStatus('${b.id}','cancelled')" title="Annuler" style="padding:4px 8px;border-radius:5px;border:1px solid #FECACA;background:var(--red-bg);cursor:pointer;font-size:.7rem;color:var(--red);font-weight:600">Annuler</button>
            ` : ''}
          </div>
        </div>`;
      });
      html += `</div>`;
    }

    content.innerHTML = html;

  } catch (err) {
    content.innerHTML = `<div class="empty" style="color:var(--red)">Erreur : ${err.message}</div>`;
  }
}

function shiftAgenda(dir) {
  agendaDate.setDate(agendaDate.getDate() + dir);
  loadAgenda();
}

async function updateStatus(id, status) {
  try {
    const token = api.getToken();
    const res = await fetch(`/api/bookings/${id}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
      body: JSON.stringify({ status })
    });
    if (!res.ok) { const d = await res.json(); throw new Error(d.error); }
    BooktUI.toast(status==='completed'?'RDV termin√©':status==='no_show'?'Marqu√© no-show':'RDV annul√©', status==='completed'?'success':'warning');
    loadAgenda();
  } catch (err) {
    BooktUI.toast('Erreur : '+err.message, 'error');
  }
}

function doLogout() {
  api.logout();
}
</script>

</body>
</html>
